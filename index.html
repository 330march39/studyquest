<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StudyQuest</title>

    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    
    <meta name="theme-color" content="#1f2937" media="(prefers-color-scheme: dark)">

    <style>
        /* 1. htmlã¨bodyã«æœ€åˆã‹ã‚‰èƒŒæ™¯è‰²ã‚’ã¤ã‘ã‚‹ (ã“ã‚ŒãŒç™½é£›ã³é˜²æ­¢ã®éµ) */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff; /* gray-100 (ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã®èƒŒæ™¯) */
            overscroll-behavior: none;
            touch-action: pan-y;
        }

        /* 2. ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®è¨­å®š */
        #splash-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6; /* æœ¬ä½“ã¨åŒã˜è‰² */
            transition: opacity 0.5s ease;
        }
        
        #splash-screen img {
            width: 16rem;
            height: 16rem;
            object-fit: contain;
            margin-bottom: 1rem;
        }

        /* ãƒ­ã‚´ã®å‡ºã—åˆ†ã‘ */
        #splash-logo-dark { display: none; }
        #splash-logo-light { display: block; }

        /* 3. ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®èƒŒæ™¯è‰²ã‚’OSè¨­å®šã‹ã‚‰å³åº§ã«åæ˜  */
        @media (prefers-color-scheme: dark) {
            html, body {
                background-color: #1f2937; /* ğŸ‘ˆ bg-gray-800 (ãƒ˜ãƒƒãƒ€ãƒ¼ã¨åŒã˜è‰²) ã«å¤‰æ›´ */
            }
            #splash-screen {
                background-color: #111827; /* ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã¯å…ƒã®ã¾ã¾ã§OK */
            }
            #splash-logo-light { display: none; }
            #splash-logo-dark { display: block; }
        }

        /* ã‚¯ãƒ©ã‚¹ã«ã‚ˆã‚‹åˆ¶å¾¡ (JSãƒ­ãƒ¼ãƒ‰å¾Œ) */
        html.dark, html.dark body { background-color: #1f2937; } /* ğŸ‘ˆ ãƒ˜ãƒƒãƒ€ãƒ¼è‰² */
        html.dark #splash-screen { background-color: #111827; } /* ğŸ‘ˆ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è‰² */
        html.dark #splash-logo-light { display: none; }
        html.dark #splash-logo-dark { display: block; }
    </style>

    <script>
        // ç”»é¢æç”»å‰ã«OSã®è¨­å®šã‚’ç¢ºèªã—ã¦ dark ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
    </script>

    <!-- PWAé–¢é€£ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta id="meta-status-bar" name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="StudyQuest">

    <link rel="icon" type="image/png" href="SQ_logo.png">

    <link rel="apple-touch-icon" href="SQ_logo.png">

    <meta property="og:image" content="SQ_logo.png">
    
    <link rel="manifest" href="manifest.json">
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ•ã‚©ãƒ³ãƒˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // OSã®ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã«åˆã‚ã›ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function updateStatusBarStyle() {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const meta = document.getElementById('meta-status-bar');
            if (meta) {
                // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚: 'black-translucent'
                // â†’ èƒŒæ™¯ãŒé€æ˜ã«ãªã‚Šã€bodyã«è¨­å®šã—ãŸè‰²ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã¨åŒã˜è‰²ï¼‰ãŒãã®ã¾ã¾é€ã‘ã¦è¦‹ãˆã¾ã™ã€‚æ–‡å­—ã¯ç™½ã«ãªã‚Šã¾ã™ã€‚
                // ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚: 'default'
                // â†’ æ¨™æº–ã®ç™½èƒŒæ™¯ãƒ»é»’æ–‡å­—ã«ãªã‚Šã¾ã™ã€‚
                meta.content = isDark ? 'black-translucent' : 'default';
            }
        }

        // 1. èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        updateStatusBarStyle();

        // 2. OSã®è¨­å®šå¤‰æ›´ã‚’ç›£è¦–ã—ã¦å®Ÿè¡Œï¼ˆã‚¢ãƒ—ãƒªèµ·å‹•ä¸­ã«ãƒ¢ãƒ¼ãƒ‰ãŒå¤‰ã‚ã£ãŸå ´åˆç”¨ï¼‰
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateStatusBarStyle);
        }
    </script>
    
    <script>
      tailwind.config = {
        darkMode: 'class' // ã“ã“ã§ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®åˆ¶å¾¡æ–¹æ³•ã‚’'class'ã«æŒ‡å®šã—ã¾ã™
      }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        /* â–¼â–¼â–¼ è¿½åŠ : LINE Seed JP ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ â–¼â–¼â–¼ */
        @font-face {
            font-family: 'LINE Seed JP';
            src: url('LINESeedJP_OTF_Rg.woff2') format('woff2'); /* ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆã‚ã›ã‚‹ */
            font-weight: 400; /* é€šå¸¸ */
            font-style: normal;
        }
        @font-face {
            font-family: 'LINE Seed JP';
            src: url('LINESeedJP_OTF_Bd.woff2') format('woff2'); /* ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆã‚ã›ã‚‹ */
            font-weight: 700; /* å¤ªå­— */
            font-style: normal;
        }
        /* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

        :root {
            --primary-color: #4f46e5;
            --primary-color-hover: #4338ca;
        }
        /* â–¼â–¼â–¼ ä¿®æ­£: font-family ã®å…ˆé ­ã« 'LINE Seed JP' ã‚’è¿½åŠ  â–¼â–¼â–¼ */
        body { 
            font-family: 'LINE Seed JP', 'Inter', 'Noto Sans JP', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }
        .page { display: none; }
        .page.active { display: block; }
        #focus-page.page.active { display: flex; }
        #focus-page { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn {
            animation: fadeIn 0.8s ease-out forwards;
        }
        #loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .primary-bg { background-color: var(--primary-color); }
        .primary-bg-hover:hover { background-color: var(--primary-color-hover); }
        .primary-text { color: var(--primary-color); }
        .toggle-checkbox { appearance: none; width: 40px; height: 20px; background: #ccc; border-radius: 20px; position: relative; cursor: pointer; transition: background .3s; }
        .toggle-checkbox:before { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: transform .3s; }
        .toggle-checkbox:checked { background: var(--primary-color); }
        .toggle-checkbox:checked:before { transform: translateX(20px); }
        #theme-purchase-modal, #background-purchase-modal { z-index: 60; }

        /* ãƒŸãƒ‹ã‚¿ã‚¤ãƒãƒ¼ */
        #mini-timer-container {
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s;
            transform: translateY(150%);
            opacity: 0;
            pointer-events: none;
        }
        #mini-timer-container.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #mini-timer-progress-bar {
            transition: width 0.5s linear;
        }
        /* é›†ä¸­ãƒ¢ãƒ¼ãƒ‰èƒŒæ™¯ */
        .focus-view-bg {
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
        }

        #app-container {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨è¨­å®š â–¼â–¼â–¼ */
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            will-change: transform;
            transform-origin: center left;
        }

        /* â–¼â–¼â–¼ è¿½åŠ : ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹æ™‚ã®ãƒ¡ã‚¤ãƒ³ç”»é¢ã®çŠ¶æ…‹ â–¼â–¼â–¼ */
        #app-container.background-pushed {
            transform: translateX(-30%); /* å·¦ã«å°‘ã—ãšã‚Œã‚‹ */
        }
        
        .break-icon-grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 0.5rem; 
            width: 100%;
        }

        .break-content-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: #edfcff;
            padding: 0.75rem; /* ğŸ‘ˆ 16px ã‹ã‚‰ 12px ã«å¤‰æ›´ */
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center; /* ğŸ‘ˆ flex-start ã‹ã‚‰ center ã«å¤‰æ›´ (æœ€é‡è¦) */
            justify-content: flex-start; /* ğŸ‘ˆ center ã‹ã‚‰ flex-start ã«å¤‰æ›´ (ä¸Šã‹ã‚‰é…ç½®) */
            /* font-weight: bold; */ /* ğŸ‘ˆ ã“ã®è¡Œã¯å‰Šé™¤ï¼ˆspanå´ã§æŒ‡å®šï¼‰ */
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            /* é«˜ã•ã‚’å‡ä¸€ã«ã™ã‚‹ãŸã‚ (ä»»æ„) */
            min-height: 100px;
        }
        .break-content-btn span {
            font-size: 0.75rem; /* 12px */
            font-weight: bold;
            line-height: 1.1;
            text-align: center;
            word-break: break-word; /* è‹±èªãªã©ãŒã¯ã¿å‡ºãŸå ´åˆã«å‚™ãˆã‚‹ */
        }
        .break-content-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e2e8f0; /* light gray */
        }
        .dark .sortable-ghost {
            background-color: #374151; /* dark gray */
        }
        .task-item .task-text-input {
            border-bottom: 1px solid transparent;
            transition: all 0.2s;
        }
        .task-item:hover .task-text-input {
            background-color: rgba(0,0,0,0.03);
        }
        .dark .task-item:hover .task-text-input {
            background-color: rgba(255,255,255,0.05);
        }
        /* ä¼‘æ†©è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¢ã‚¤ãƒ†ãƒ  */
        .break-settings-item {
            display: flex;
            align-items: center;
            padding: 0.75rem; /* p-3 */
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e5e7eb; /* text-gray-200 */
        }
        .break-settings-handle {
            cursor: move; /* "cursor-move" */
            margin-right: 0.75rem; /* mr-3 */
            color: #9ca3af; /* text-gray-400 */
        }
        .break-settings-item span {
            flex-grow: 1; /* "flex-grow" */
            text-align: left;
        }
        /* 1. ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç¦æ­¢ */
        body {
            -webkit-user-select: none; /* Safari/Chrome */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE */
            user-select: none;         /* æ¨™æº– */
        }
        
        /* 2. input ã‚„ textarea ã¯é¸æŠã§ãã‚‹ã‚ˆã†ã«è¨±å¯ã™ã‚‹ï¼ˆã‚³ãƒ”ãƒšãªã©ã«å¿…è¦ï¼‰ */
        input, 
        textarea {
            -webkit-user-select: text; /* Safari/Chrome */
            -moz-user-select: text;    /* Firefox */
            -ms-user-select: text;     /* IE */
            user-select: text;         /* æ¨™æº– */
        }

        /* â–¼â–¼â–¼ è¿½åŠ : iOSã®æ—¥ä»˜å…¥åŠ›ã¯ã¿å‡ºã—å¯¾ç­– â–¼â–¼â–¼ */
        input[type="date"] {
            /* iOSç‹¬è‡ªã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ */
            -webkit-appearance: none;
            appearance: none;
            /* è¦ªè¦ç´ ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«æœ€å¤§å¹…ã‚’åˆ¶é™ */
            max-width: 100%;
            /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå°ã•ããªã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆFlexboxå¯¾ç­–ï¼‰ */
            min-width: 0;
            /* ãƒœãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºã®è¨ˆç®—ã‚’ç¢ºå®Ÿã«ã™ã‚‹ */
            box-sizing: border-box;
            /* èƒŒæ™¯è‰²ãŒæ¶ˆãˆãªã„ã‚ˆã†ã«ã™ã‚‹ */
            background-color: inherit; 
        }
        
        /* 3. ç”»åƒã‚„SVGã‚¢ã‚¤ã‚³ãƒ³ã®é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆä¿å­˜ãªã©ï¼‰ã‚’ç¦æ­¢ (ä¸»ã«iOS) */
        img, svg {
            -webkit-touch-callout: none;
        }
        /* --- ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ç”¨CSS --- */
        .swipe-container {
            position: relative;
            overflow: hidden; /* ã¯ã¿å‡ºã—ãŸãƒœã‚¿ãƒ³ã‚’éš ã™ */
            touch-action: pan-y; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯è¨±å¯ã—ã¤ã¤ã€æ¨ªæ“ä½œã‚’JSã§åˆ¶å¾¡ */
        }
        
        /* ãƒœã‚¿ãƒ³ãŒé…ç½®ã•ã‚Œã‚‹èƒŒæ™¯å±¤ */
        .swipe-actions {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            display: flex;
            height: 100%;
            z-index: 1; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ */
        }
        
        .swipe-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            height: 100%;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        
        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å±¤ï¼ˆæŒ‡ã§å‹•ã‹ã™éƒ¨åˆ†ï¼‰ */
        .swipe-content {
            position: relative;
            z-index: 10;
            background-color: inherit; /* è¦ªã®è‰²ã‚’å¼•ãç¶™ã */
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* é›¢ã—ãŸæ™‚ã®ã‚¹ãƒŠãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            will-change: transform; /* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– */
        }
        
        /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚‹ï¼ˆè¿½å¾“æ€§ã‚’è‰¯ãã™ã‚‹ãŸã‚ï¼‰ */
        .is-dragging .swipe-content {
            transition: none;
        }
        
        /* å‰Šé™¤æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .swipe-deleting {
            transition: height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
            opacity: 0;
            margin: 0 !important;
            overflow: hidden;
        }
        /* ä¸¦ã³æ›¿ãˆãƒãƒ³ãƒ‰ãƒ«å‘¨è¾ºã®ã‚¿ãƒƒãƒæ“ä½œã‚’ç¢ºå®Ÿã«ã™ã‚‹ */
        .task-handle, .quest-handle, .break-settings-handle {
            cursor: grab;
            touch-action: none; /* ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ã‚’ç„¡åŠ¹åŒ–ã—ã€JSã§åˆ¶å¾¡ã—ã‚„ã™ãã™ã‚‹ */
            padding: 10px; /* ã‚¿ãƒƒãƒ—åˆ¤å®šã‚’å¤§ããã™ã‚‹ */
            margin: -5px; /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œé˜²æ­¢ */
        }
        
        /* INPUTã‚¿ã‚°ã¯ã‚¹ãƒ¯ã‚¤ãƒ—å¯¾è±¡å¤–ã¨ã—ã¦ã€æ–‡å­—é¸æŠã‚„ã‚«ãƒ¼ã‚½ãƒ«ç§»å‹•ã‚’å„ªå…ˆã•ã›ã‚‹ */
        input[type="text"], input[type="number"] {
            touch-action: manipulation; /* ã‚¹ãƒ¯ã‚¤ãƒ—ã‚„ã‚ºãƒ¼ãƒ ä»¥å¤–ã®æ¨™æº–å‹•ä½œ */
        }
        /* ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã‚„ã€å‰Šé™¤ãƒœã‚¿ãƒ³ãŒå‡ºã¦ã„ã‚‹æ™‚ã¯ã€ãƒãƒ³ãƒ‰ãƒ«ã‚’æ“ä½œä¸èƒ½ã«ã™ã‚‹ï¼ˆã“ã‚Œã§ä¸¦ã³æ›¿ãˆæš´ç™ºã‚’é˜²ãï¼‰ */
        .swipe-container.is-swiping .task-handle,
        .swipe-container.is-swiping .quest-handle,
        .swipe-container.is-swiping .break-settings-handle,
        .swipe-container.swiped-open .task-handle,
        .swipe-container.swiped-open .quest-handle,
        .swipe-container.swiped-open .break-settings-handle {
            pointer-events: none; /* ã‚¿ãƒƒãƒ—ä¸å¯ã«ã™ã‚‹ */
            opacity: 0.2; /* è¦–è¦šçš„ã«ã‚‚ç„¡åŠ¹ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
        }
        /* æ—¢å­˜ã® #iframe-overlay ã‚’ä¿®æ­£ï¼ˆflexã§ä¸­å¤®æƒãˆã§ãã‚‹ã‚ˆã†ã«ï¼‰ */
        #iframe-overlay {
            /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ç¶­æŒã—ã¤ã¤ã€loaderã®é…ç½®ç”¨ã«relativeç­‰ã‚’èª¿æ•´ */
            z-index: 220; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šä¸Šã«æ¥ã‚‹ã‚ˆã†ã«èª¿æ•´ */
        }
        
        /* iframeå†…ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆä¸­å¤®é…ç½®ï¼‰ */
        #iframe-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1; /* iframeãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰éš ã‚Œã‚‹ã‚ˆã†ã«å¾Œã‚ã¸ã€ã‚ã‚‹ã„ã¯JSã§åˆ¶å¾¡ */
        }
        
        /* ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */
        .preview-carousel {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden; 
            touch-action: pan-x;
            scroll-snap-type: x mandatory; /* ã‚¹ãƒŠãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            -webkit-overflow-scrolling: touch;
            gap: 1rem;
            padding: 0 1.5rem; /* ä¸¡ç«¯ã«ä½™ç™½ã‚’è¿½åŠ  */
            margin-bottom: 1rem;
            width: 100%;
            /* â–¼â–¼â–¼ ä¿®æ­£: é«˜ã•ã‚’å¤§ããã™ã‚‹ï¼ˆç¸¦é•·ç”»åƒç”¨ï¼‰ â–¼â–¼â–¼ */
            height: 550px; /* å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„ */
            align-items: center; /* ä¸Šä¸‹ä¸­å¤®æƒãˆ */
        }
        
        .preview-item {
            /* â–¼â–¼â–¼ ä¿®æ­£: å¹…ã‚’100%ã‹ã‚‰å›ºå®šå¹…ã«å¤‰æ›´ï¼ˆã“ã‚Œã§æ¨ªä¸¦ã³ã«ãªã‚Šã¾ã™ï¼‰ â–¼â–¼â–¼ */
            flex: 0 0 280px; /* 1æšã®å¹…ã‚’280pxã«å›ºå®šï¼ˆæ¬¡ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰ */
            width: 280px;
            
            /* é«˜ã•ã‚’è¦ªè¦ç´ ã„ã£ã±ã„ã«ã™ã‚‹ */
            height: 100%;
            scroll-snap-align: center;
            
            border-radius: 1rem; /* è§’ä¸¸ã‚’å¤§ãã */
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* å½±ã‚’ã¤ã‘ã¦æµ®ãå‡ºã•ã›ã‚‹ */
        }
        
        .preview-item img,
        .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦åã‚ã‚‹ */
        }
        .preview-item img {
            pointer-events: none;       /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆé•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼é˜²æ­¢ï¼‰ */
            -webkit-user-drag: none;    /* ãƒ‰ãƒ©ãƒƒã‚°ç¦æ­¢ */
            user-select: none;          /* é¸æŠç¦æ­¢ */
        }
                
        /* è©¦è´ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .playing-icon {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .focus-theme-border:focus {
            border-color: var(--primary-color) !important;
        }  
        
        /* ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠ */
        main {
            position: relative;
            overflow-x: hidden; /* æ¨ªæºã‚Œé˜²æ­¢ */
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© (å¤‰åŒ–é‡ã‚’å°ã•ãã—ã¦ä¸Šå“ã«) */
        @keyframes appZoomIn {
            0% { opacity: 0; transform: scale(0.98); } /* 0.92 -> 0.98 ã«å¤‰æ›´ */
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes appZoomOut {
            0% { opacity: 0; transform: scale(1); }
            100% { opacity: 0; transform: scale(1); } /* 1.05 -> 1.02 ã«å¤‰æ›´ */
        }

        /* â–¼â–¼â–¼ è¿½åŠ : æ´—ç·´ã•ã‚ŒãŸã€Œãµã‚ã£ã€ã¨å‡ºã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â–¼â–¼â–¼ */
        @keyframes slideUpFade {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.98); /* å°‘ã—ä¸‹ã§å°‘ã—å°ã•ã„ */
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1); /* å®šä½ç½®ã§ç­‰å€ */
            }
        }

        .animate-enter-active {
            /* ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°(å‹•ãã®ç·©æ€¥)ã‚’èª¿æ•´ã—ã¦ã€Œé«˜ç´šæ„Ÿã€ã‚’å‡ºã™ */
            animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* â–¼â–¼â–¼ è¿½åŠ : ç”»é¢å…¨ä½“ç”¨ã®æ´—ç·´ã•ã‚ŒãŸå‡ºç¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â–¼â–¼â–¼ */
        @keyframes screenZoomFadeIn {
            0% {
                opacity: 0;
                transform: scale(0.92); /* å°‘ã—ç¸®ã‚“ã çŠ¶æ…‹ã‹ã‚‰ */
            }
            100% {
                opacity: 1;
                transform: scale(1);    /* å…ƒã®ã‚µã‚¤ã‚ºã¸ */
            }
        }

        .animate-screen-enter {
            /* ç”»é¢å…¨ä½“ç”¨ãªã®ã§ã€å°‘ã—ã‚†ã£ãã‚Šã‚ã§é«˜ç´šæ„Ÿã‚’å‡ºã™ */
            animation: screenZoomFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* æ–°ã—ãå…¥ã£ã¦ãã‚‹ãƒšãƒ¼ã‚¸ */
        .page-enter {
            display: block !important;
            animation: appZoomIn 0.25s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; /* æ™‚é–“ã‚’å°‘ã—çŸ­ç¸® */
            z-index: 20;
            will-change: transform, opacity; /* ã€é‡è¦ã€‘æç”»æœ€é©åŒ–ã®ãƒ’ãƒ³ãƒˆ */
            transform-origin: top center;
        }
        #focus-page.page-enter {
            display: flex !important;
        }

        /* æ¶ˆãˆã¦ã„ããƒšãƒ¼ã‚¸ */
        .page-exit {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            animation: appZoomOut 0.25s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            z-index: 10;
            pointer-events: none;
            will-change: transform, opacity; /* ã€é‡è¦ã€‘æç”»æœ€é©åŒ–ã®ãƒ’ãƒ³ãƒˆ */
            height: 0 !important;
            overflow: hidden !important;
        }
        #focus-page.page-exit {
            display: flex !important;
            height: 0 !important;  /* â† ã“ã‚Œã‚’è¿½åŠ  */
            overflow: hidden !important;  /* â† ã“ã‚Œã‚’è¿½åŠ  */
        }        
        /* ä¸‹éƒ¨ã®ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¨ãƒªã‚¢åˆ†ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ  */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼å°‚ç”¨: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸã®é«˜ã•ã‚’ç¶­æŒã—ã¤ã¤ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã§èƒŒæ™¯ã‚’ä¼¸ã°ã™ */
        .nav-safe {
            padding-bottom: env(safe-area-inset-bottom, 10px);
            box-sizing: content-box; /* ã“ã‚ŒãŒé‡è¦: height:64pxã®ä¸­ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚ãªã„è¨­å®š */
        }
        
        /* å›ºå®šé…ç½®ã®è¦ç´ ã‚’ã€ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¨ãƒªã‚¢åˆ†ã ã‘ä¸Šã«æŠ¼ã—ä¸Šã’ã‚‹ */
        /* calc() ã‚’ä½¿ã£ã¦ã€Œå…ƒã®ä½ç½® + ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¨ãƒªã‚¢ã€ã‚’è¨ˆç®— */
        .bottom-safe-20 {
            bottom: calc(5rem + env(safe-area-inset-bottom, 10px)); /* bottom-20 (5rem) + safe-area */
        }
        .bottom-safe-16 {
            bottom: calc(4rem + env(safe-area-inset-bottom, 10px)); /* bottom-16 (4rem) + safe-area */
        }
        .header-safe {
            padding-top: env(safe-area-inset-top, 0px);
            /* é«˜ã•ã‚’ 56px(3.5rem) + å®‰å…¨é ˜åŸŸ ã«å®Œå…¨å›ºå®š */
            height: calc(3.5rem + env(safe-area-inset-top, 0px));
            box-sizing: border-box;
            
            /* Flexboxè¨­å®š */
            display: flex;
            align-items: center;
            justify-content: space-between;
            
            /* â˜…é‡è¦: ã“ã‚Œã§çµ¶å¯¾ã«æ½°ã‚Œãªããªã‚Šã¾ã™ */
            flex-shrink: 0;
            width: 100%;
            z-index: 30;
        }
        /* --- ç”»é¢é·ç§»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (iOSé¢¨) --- */
        .screen-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f3f4f6; /* light bg */
            z-index: 100; /* æœ€å‰é¢ */
            transform: translateX(100%); /* åˆæœŸçŠ¶æ…‹ã¯å³å¤–å´ */
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1); /* iOSé¢¨ã®ã‚¤ãƒ¼ã‚¸ãƒ³ã‚° */
            will-change: transform;
            display: flex;
            flex-direction: column;
        }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        html.dark .screen-layer {
            background-color: #111827; /* dark bg */
        }
        
        /* ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹æ™‚ã®ã‚¯ãƒ©ã‚¹ */
        .screen-layer.active {
            transform: translateX(0);
            box-shadow: -10px 0 25px rgba(0,0,0,0.1); /* å·¦å´ã«å½±ã‚’è½ã¨ã™ */
        }
        
        /* ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã®å½± */
        .screen-layer.is-swiping {
            transition: none; /* æŒ‡ã«è¿½å¾“ã•ã›ã‚‹ãŸã‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚‹ */
            box-shadow: -10px 0 25px rgba(0,0,0,0.1);
        }
        /* â–¼â–¼â–¼ è¿½åŠ : LPç²å¾—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â–¼â–¼â–¼ */
        
        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒå¼¾ã‚€ã‚ˆã†ã«å‡ºç¾ */
        @keyframes popInElastic {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            70% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        /* ã‚³ã‚¤ãƒ³ãŒæµ®éŠã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes coinFloat {
            0%, 100% { transform: translateY(0) rotateY(0deg); }
            50% { transform: translateY(-10px) rotateY(10deg); }
        }

        /* å¾Œã‚ã®å…‰ãŒå›è»¢ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes sunburstRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .animate-pop-elastic {
            animation: popInElastic 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã¯ç«¶åˆã‚’é˜²ããŸã‚ã«transitionã‚’åˆ‡ã‚‹ â–¼â–¼â–¼ */
            transition: none !important;
        }

        .animate-coin-float {
            animation: coinFloat 3s ease-in-out infinite;
        }

        /* å¾Œå…‰ï¼ˆã‚µãƒ³ãƒãƒ¼ã‚¹ãƒˆï¼‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ - ã‚µã‚¤ã‚ºæ‹¡å¤§ãƒ»è–„è‰²åŒ–ç‰ˆ */
        .sunburst {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1200px;
            height: 1200px;
            margin-left: -600px; /* widthã®åŠåˆ† */
            margin-top: -600px;  /* heightã®åŠåˆ† */
            
            background: repeating-conic-gradient(
                from 0deg,
                rgba(255, 215, 0, 0.08) 0deg 20deg,
                transparent 20deg 40deg
            );
            border-radius: 50%;
            animation: sunburstRotate 30s linear infinite; /* å°‘ã—ã‚†ã£ãã‚Šå›ã™ã‚ˆã†ã«å¤‰æ›´(ä»»æ„) */
            z-index: -1;
            pointer-events: none;
        }
        
        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å…‰ã‚ˆã‚Šå‰ã«å‡ºã™ãŸã‚ã®è¨­å®š */
        .popup-content-layer {
            position: relative;
            z-index: 10;
        }
        
        /* æ•°å­—ãŒã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹æ™‚ç”¨ã®ã‚¯ãƒ©ã‚¹ï¼ˆJSåˆ¶å¾¡ç”¨ï¼‰ */
        .lp-amount-text {
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: linear-gradient(45deg, #fbbf24, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* â–¼â–¼â–¼ è¿½åŠ : iOSãƒãƒƒãƒå¯¾ç­– â–¼â–¼â–¼ */

        /* 1. é€šçŸ¥ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆï¼‰ã®ä½ç½®ä¿®æ­£ */
        #toast {
            /* top-5 (1.25rem) ã‚’ä¸Šæ›¸ãã—ã€ãƒãƒƒãƒã®é«˜ã• + ä½™è£•ã‚’æŒãŸã›ã‚‹ */
            top: calc(env(safe-area-inset-top, 20px) + 1rem) !important;
        }

        /* 2. ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ä¿®æ­£ */
        #quiz-modal header {
            /* ä¸Šéƒ¨ã«ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢åˆ†ã®ä½™ç™½ã‚’è¿½åŠ  + å…ƒã®p-3(0.75rem) */
            padding-top: calc(env(safe-area-inset-top, 20px) + 0.75rem);
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’ç¢ºä¿ */
            height: auto;
            /* ä¸‹éƒ¨ã®ä½™ç™½ã¯ç¶­æŒ */
            padding-bottom: 0.75rem;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 overflow-hidden h-[100dvh] antialiased">
    <div id="splash-screen" class="fixed inset-0 z-[300] flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900 transition-opacity duration-500">
        <img id="splash-logo-light" src="SQ_logo2.png" alt="StudyQuest Logo" class="w-64 h-64 mb-4 block dark:hidden">
        
        <img id="splash-logo-dark" src="SQ_logo3.png" alt="StudyQuest Logo Dark" class="w-64 h-64 mb-4 hidden dark:block">
    </div>

    <div id="app-container" class="h-full w-full flex flex-col max-w-lg mx-auto shadow-2xl bg-gray-100 dark:bg-gray-900">
        
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm">
            <h1 id="header-title" class="text-lg font-bold text-gray-900 dark:text-white">ãƒ›ãƒ¼ãƒ </h1>
            
            <button id="lp-button" class="flex items-center space-x-2 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 rounded-full px-3 py-1 hover:bg-yellow-100 dark:hover:bg-yellow-900/50 transition-colors border border-yellow-200 dark:border-yellow-700">
                <img src="coin.png" alt="Coin" class="w-4 h-4 object-contain">
                <span id="lp-display" class="font-bold text-xs">0 LP</span>
            </button>
        </header>

        <main class="flex-grow overflow-y-auto pb-[calc(5rem+env(safe-area-inset-bottom))]">
            <div id="home-page" class="page active p-4 space-y-6">
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm text-center">
                    <p id="today-date" class="text-lg font-semibold text-gray-600 dark:text-gray-300"></p>
                </div>

                 <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3">
                        <i data-lucide="check-square" class="w-5 h-5 mr-2 primary-text"></i> ä»Šæ—¥ã®äºˆå®š
                    </h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <div id="home-task-list" class="space-y-2">
                            <p class="text-center text-sm text-gray-500">ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                        </div>
                        <div class="flex items-center space-x-2 mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                            <span id="new-task-number" class="font-bold w-6 text-center text-gray-500 dark:text-gray-400">1</span>
                            <input type="text" id="new-task-input" placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ  (Enterã§ç¢ºå®š)" class="flex-grow bg-transparent p-1 border-b-2 border-gray-300 dark:border-gray-600 focus-theme-border focus:outline-none transition-colors">
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="calendar-clock" class="w-5 h-5 mr-2 primary-text"></i> ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³</h2>
                        <button id="add-countdown-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="countdown-list" class="space-y-3"></div>
                </div>
                
                 
            </div>

            <div id="study-page" class="page p-4">
                <div class="mb-6">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="pin" class="w-5 h-5 mr-2 primary-text"></i> ãƒ”ãƒ³ç•™ã‚</h2>
                    <div id="pinned-quizzes" class="grid grid-cols-1 gap-3"></div>
                </div>
                <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="book-marked" class="w-5 h-5 mr-2 primary-text"></i> ã™ã¹ã¦ã®ã‚¯ã‚¤ã‚º</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="filter-container" class="flex space-x-2 mb-4 overflow-x-auto pb-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="all-quizzes" class="grid grid-cols-1 gap-3"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div> Â  Â  Â  Â  Â  Â  
            <div id="focus-page" class="page relative flex flex-col h-full">
                
                <div id="focus-main-view" class="flex flex-col h-full p-4">
                    <div class="flex-shrink-0 mb-4 space-y-4">
                        <button id="show-quest-btn" class="w-full p-3 rounded-lg font-bold text-lg shadow-md flex items-center justify-center space-x-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-mode="quest">
                            <i data-lucide="award" class="w-6 h-6"></i>
                            <span>ã‚¯ã‚¨ã‚¹ãƒˆ</span>
                        </button>
                        
                        <div class="flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1">
                            <button class="focus-mode-btn flex-1 p-2 rounded-md text-sm font-semibold" data-mode="timer">ã‚¿ã‚¤ãƒãƒ¼</button>
                            <button class="focus-mode-btn flex-1 p-2 rounded-md text-sm font-semibold" data-mode="stopwatch">ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ</button>
                        </div>
                    </div>
            
                    <div id="timer-view" class="focus-view-bg flex-grow flex flex-col items-center justify-center text-center relative text-white rounded-lg">
                        <div class="absolute inset-0 bg-black/50 rounded-lg"></div>
                        <div class="relative z-10 p-4">
                            <div id="timer-settings-container">
                                <div class="flex items-center justify-center space-x-2 mb-6">
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="60">1åˆ†</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="300">5åˆ†</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="1800">30åˆ†</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="3600">60åˆ†</button>
                                    <button id="timer-reset-btn" class="bg-white/20 hover:bg-white/30 w-10 h-10 rounded-full flex items-center justify-center">
                                        <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="focus-timer-display" class="text-7xl font-bold tabular-nums mb-6">30:00</div>
                            <button id="focus-start-btn" class="primary-bg primary-bg-hover text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center mx-auto"><i data-lucide="play" class="w-6 h-6 mr-2"></i>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <div id="focus-controls" class="hidden flex flex-wrap items-center justify-center gap-4">
                                <button id="focus-pause-btn" class="bg-gray-500/70 hover:bg-gray-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢</button>
                                <button id="focus-end-btn" class="bg-red-500/70 hover:bg-red-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="stop-circle" class="w-6 h-6 mr-2"></i>çµ‚äº†</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="stopwatch-view" class="focus-view-bg hidden flex-grow flex-col items-center justify-center text-center relative text-white rounded-lg">
                        <div class="absolute inset-0 bg-black/50 rounded-lg"></div>
                        <div class="relative z-10 p-4">
                            <div id="stopwatch-display" class="text-7xl font-bold tabular-nums mb-6">00:00</div>
                            <button id="stopwatch-start-btn" class="primary-bg primary-bg-hover text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center mx-auto"><i data-lucide="play" class="w-6 h-6 mr-2"></i>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <div id="stopwatch-controls" class="hidden flex flex-wrap items-center justify-center gap-4">
                                <button id="stopwatch-pause-btn" class="bg-gray-500/70 hover:bg-gray-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢</button>
                                <button id="stopwatch-end-btn" class="bg-red-500/70 hover:bg-red-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="flag" class="w-6 h-6 mr-2"></i>è¨˜éŒ²ã—ã¦çµ‚äº†</button>
                            </div>
                        </div>
                    </div>
                </div>
            
            </div>
            <div id="my-chart-page" class="page p-4 space-y-6">
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-lg shadow text-center">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">ä»Šæ—¥</p>
                        <p class="text-xl font-bold primary-text" id="report-stat-today">0<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span></p>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-lg shadow text-center">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">ä»Šé€±</p>
                        <p class="text-xl font-bold primary-text" id="report-stat-week">0<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span></p>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-lg shadow text-center">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">ç·åˆè¨ˆ</p>
                        <p class="text-xl font-bold primary-text" id="report-stat-total">0<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span></p>
                    </div>
                </div>
            
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 primary-text"></i> é€±é–“ãƒ¬ãƒãƒ¼ãƒˆ
                    </h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                        <canvas id="study-time-chart"></canvas>
                    </div>
                </div>
            
                <div class="flex flex-col h-[75vh]"> <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3">
                        <i data-lucide="calendar" class="w-5 h-5 mr-2 primary-text"></i> å­¦ç¿’ãƒ­ã‚°
                    </h2>
                    
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-t-lg shadow-sm z-10">
                        <div class="flex justify-between items-center mb-4">
                            <button id="cal-prev-btn" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-600 rounded"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <h3 id="cal-month-title" class="font-bold text-lg"></h3>
                            <button id="cal-next-btn" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-600 rounded"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2 text-gray-400">
                            <span>æ—¥</span><span>æœˆ</span><span>ç«</span><span>æ°´</span><span>æœ¨</span><span>é‡‘</span><span>åœŸ</span>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm">
                            </div>
                    </div>
            
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-b-lg shadow p-4 flex-grow overflow-y-auto border-t border-gray-200 dark:border-gray-600">
                        <h4 id="detail-date-title" class="text-sm font-bold mb-3 text-gray-500 dark:text-gray-400 sticky top-0 bg-gray-50 dark:bg-gray-800 py-1">ä»Šæ—¥ã®è©³ç´°</h4>
                        <div id="study-session-list" class="space-y-3">
                            <p class="text-center text-xs text-gray-400 mt-4">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings-page" class="page p-4 space-y-4">
                <div id="notification-settings-card" class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">é€šçŸ¥è¨­å®š</h3>
                    <button id="notification-permission-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mb-4"><i data-lucide="bell-ring" class="w-5 h-5 mr-2"></i>ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¨±å¯</button>
                </div>

                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2 flex items-center justify-between">
                        <span>BGMè¨­å®š (ã‚¯ã‚¨ã‚¹ãƒˆä¸­)</span>
                        <div class="flex items-center">
                            <input type="checkbox" id="bgm-toggle" class="toggle-checkbox">
                        </div>
                    </h3>
                    <p class="text-xs text-gray-500 mb-4">ONã«ã™ã‚‹ã¨ã€ã‚¯ã‚¨ã‚¹ãƒˆã®ã€Œå­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€ä¸­ã«é¸æŠã—ãŸæ›²ãŒãƒ«ãƒ¼ãƒ—å†ç”Ÿã•ã‚Œã¾ã™ã€‚</p>
                    
                    <h4 class="text-sm font-bold mb-2">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h4>
                    <div id="playlist-container" class="space-y-2 mb-4">
                        <p class="text-sm text-gray-400">æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LPã§äº¤æ›ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    
                    <h4 class="text-sm font-bold mb-2">äº¤æ›æ¸ˆã¿ã®æ›² (ã‚¿ãƒƒãƒ—ã§è¿½åŠ )</h4>
                    <div id="unlocked-music-list" class="flex flex-wrap gap-2">
                        </div>
                </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                     <h3 class="font-semibold mb-2">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸æŠ</h3>
                     <div id="theme-selector" class="grid grid-cols-4 gap-4"></div>
                </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">å£ç´™ã‚’é¸æŠ</h3>
                    <div id="background-selector" class="grid grid-cols-3 gap-4"></div>
                    <hr class="my-4 border-gray-200 dark:border-gray-600">
                    <div class="flex items-center justify-between">
                        <p class="font-semibold">å£ç´™ã‚’ã‚¢ãƒ—ãƒªå…¨ä½“ã«é©ç”¨</p>
                        <input type="checkbox" id="background-scope-toggle" class="toggle-checkbox">
                    </div>
                </div>
            </div>
        </main>

        <div id="mini-timer-container" class="bottom-safe-20 fixed left-0 right-0 max-w-lg mx-auto px-4 z-20">
             <div id="mini-timer-bar" class="w-full bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-lg flex items-center p-2 space-x-3 cursor-pointer">
                <div class="flex items-center space-x-3 flex-grow min-w-0">
                    <i data-lucide="timer" class="w-5 h-5 primary-text flex-shrink-0"></i>
                    <span id="mini-timer-text" class="text-sm font-bold tabular-nums text-white truncate"></span>
                </div>
                <div class="w-1/3 h-1.5 bg-gray-600 rounded-full overflow-hidden flex-shrink-0">
                    <div id="mini-timer-progress-bar" class="h-full primary-bg rounded-full"></div>
                </div>
                <button id="close-mini-timer-btn" class="p-1 text-gray-400 hover:text-white flex-shrink-0">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <nav class="nav-safe fixed bottom-0 left-0 right-0 max-w-lg mx-auto h-14 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700 flex justify-around items-center shadow-top z-20">
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full primary-text" data-page="home-page" data-title="ãƒ›ãƒ¼ãƒ "><i data-lucide="home" class="w-6 h-6"></i><span class="text-xs mt-1">ãƒ›ãƒ¼ãƒ </span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="study-page" data-title="å­¦ç¿’"><i data-lucide="book-marked" class="w-6 h-6"></i><span class="text-xs mt-1">å­¦ç¿’</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="focus-page" data-title="é›†ä¸­"><i data-lucide="timer" class="w-6 h-6"></i><span class="text-xs mt-1">é›†ä¸­</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="my-chart-page" data-title="ãƒ¬ãƒãƒ¼ãƒˆ"><i data-lucide="clipboard-list" class="w-6 h-6"></i><span class="text-xs mt-1">ãƒ¬ãƒãƒ¼ãƒˆ</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="settings-page" data-title="è¨­å®š"><i data-lucide="settings" class="w-6 h-6"></i><span class="text-xs mt-1">è¨­å®š</span></button>
        </nav>
    </div>

    <div id="welcome-screen" class="fixed inset-0 z-[200] bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6 hidden">
        <div class="mb-12 animate-fadeIn">
            <img src="SQ_logo4.png" alt="Welcome" class="w-80 h-80 object-contain mx-auto block dark:hidden">

            <img src="SQ_logo5.png" alt="Welcome Dark" class="w-80 h-80 object-contain mx-auto hidden dark:block">
        </div>

        <div class="w-full max-w-xs space-y-4 animate-fadeIn" style="animation-delay: 0.3s; opacity: 0;">
            <button id="btn-start-new" class="w-full primary-bg primary-bg-hover text-white font-bold py-4 rounded-xl shadow-lg transition-transform hover:scale-105">
                åˆã‚ã¦ã®æ–¹ã¯ã“ã¡ã‚‰
            </button>
            <button id="btn-transfer-start" class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 font-bold py-4 rounded-xl shadow transition-colors border border-gray-200 dark:border-gray-700">
                ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ã
            </button>
        </div>
    </div>

    <div id="registration-screen" class="fixed inset-0 z-[200] bg-gray-100 dark:bg-gray-900 flex flex-col p-6 transition-all duration-300 opacity-0 pointer-events-none transform scale-95">
        <header class="flex items-center mb-6">
            <button id="reg-back-btn" class="p-2 -ml-2"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
        </header>
        
        <div class="flex-grow flex flex-col items-center space-y-6 max-w-sm mx-auto w-full">
            <div class="text-center">
                <label class="block text-sm font-bold mb-2 text-gray-500">ã‚¢ã‚¤ã‚³ãƒ³ (çµµæ–‡å­—)</label>
                <div class="relative inline-block">
                    <input type="text" id="reg-icon" class="w-24 h-24 text-center text-6xl border-2 border-dashed border-gray-300 rounded-full focus:outline-none focus:border-indigo-500 bg-white dark:bg-gray-800" value="ğŸ“" readonly>
                    <div class="absolute -bottom-2 -right-2 bg-blue-500 text-white p-2 rounded-full shadow cursor-pointer" id="icon-picker-btn">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">ã‚¿ãƒƒãƒ—ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ å¤‰æ›´</p>
            </div>

            <div class="w-full">
                <label class="block text-sm font-bold mb-2 text-gray-500">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                <input type="text" id="reg-name" class="w-full p-4 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ä¾‹: ã‚¹ã‚¿ãƒ‡ã‚£å‹‡è€…">
            </div>

            <div class="w-full">
                <label class="block text-sm font-bold mb-2 text-gray-500">å­¦å¹´</label>
                <div class="relative">
                    <select id="reg-grade" class="w-full p-4 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 appearance-none focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="å°å­¦1å¹´ç”Ÿ">å°å­¦1å¹´ç”Ÿ</option>
                        <option value="å°å­¦2å¹´ç”Ÿ">å°å­¦2å¹´ç”Ÿ</option>
                        <option value="å°å­¦3å¹´ç”Ÿ">å°å­¦3å¹´ç”Ÿ</option>
                        <option value="å°å­¦4å¹´ç”Ÿ">å°å­¦4å¹´ç”Ÿ</option>
                        <option value="å°å­¦5å¹´ç”Ÿ">å°å­¦5å¹´ç”Ÿ</option>
                        <option value="å°å­¦6å¹´ç”Ÿ">å°å­¦6å¹´ç”Ÿ</option>
                        <option value="ä¸­å­¦1å¹´ç”Ÿ">ä¸­å­¦1å¹´ç”Ÿ</option>
                        <option value="ä¸­å­¦2å¹´ç”Ÿ">ä¸­å­¦2å¹´ç”Ÿ</option>
                        <option value="ä¸­å­¦3å¹´ç”Ÿ">ä¸­å­¦3å¹´ç”Ÿ</option>
                        <option value="é«˜æ ¡1å¹´ç”Ÿ">é«˜æ ¡1å¹´ç”Ÿ</option>
                        <option value="é«˜æ ¡2å¹´ç”Ÿ">é«˜æ ¡2å¹´ç”Ÿ</option>
                        <option value="é«˜æ ¡3å¹´ç”Ÿ">é«˜æ ¡3å¹´ç”Ÿ</option>
                        <option value="å¤§å­¦ãƒ»å°‚é–€å­¦ç”Ÿ">å¤§å­¦ãƒ»å°‚é–€å­¦ç”Ÿ</option>
                        <option value="ç¤¾ä¼šäººãƒ»ãã®ä»–">ç¤¾ä¼šäººãƒ»ãã®ä»–</option>
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                </div>
            </div>
            
            <div class="flex-grow"></div>

            <button id="reg-complete-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-4 rounded-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                æ¬¡ã¸é€²ã‚€
            </button>
        </div>
    </div>

    <div id="tutorial-screen" class="fixed inset-0 z-[200] bg-gray-900 text-white flex flex-col hidden">
        <div class="flex-grow relative overflow-hidden" id="tutorial-slider">
            <div class="flex transition-transform duration-300 h-full" id="tutorial-track">
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center p-6 text-center">
                    <div class="w-full max-w-xs aspect-[9/16] bg-gray-800 rounded-lg mb-6 flex items-center justify-center border-2 border-gray-700">
                        <img src="tutorial_1.png" alt="Tutorial 1" class="w-full h-full object-contain" onerror="this.src='https://placehold.co/300x500/222/fff?text=Tutorial+1'">
                    </div>
                    <h3 class="text-2xl font-bold mb-2">ã‚¯ã‚¨ã‚¹ãƒˆã§å­¦ç¿’</h3>
                    <p class="text-gray-400">ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã£ã¦<br>é›†ä¸­ã—ã¦å­¦ç¿’ã«å–ã‚Šçµ„ã‚‚ã†ã€‚</p>
                </div>
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center p-6 text-center">
                    <div class="w-full max-w-xs aspect-[9/16] bg-gray-800 rounded-lg mb-6 flex items-center justify-center border-2 border-gray-700">
                         <img src="tutorial_2.png" alt="Tutorial 2" class="w-full h-full object-contain" onerror="this.src='https://placehold.co/300x500/222/fff?text=Tutorial+2'">
                    </div>
                    <h3 class="text-2xl font-bold mb-2">ãƒã‚¤ãƒ³ãƒˆã‚’è²¯ã‚ã‚‹</h3>
                    <p class="text-gray-400">å­¦ç¿’æ™‚é–“ã«å¿œã˜ã¦LPã‚’ç²å¾—ã€‚<br>å¥½ããªã‚¢ã‚¤ãƒ†ãƒ ã¨äº¤æ›ã—ã‚ˆã†ã€‚</p>
                </div>
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center p-6 text-center">
                    <div class="w-full max-w-xs aspect-[9/16] bg-gray-800 rounded-lg mb-6 flex items-center justify-center border-2 border-gray-700">
                         <img src="tutorial_3.png" alt="Tutorial 3" class="w-full h-full object-contain" onerror="this.src='https://placehold.co/300x500/222/fff?text=Tutorial+3'">
                    </div>
                    <h3 class="text-2xl font-bold mb-2">æº–å‚™å®Œäº†ï¼</h3>
                    <p class="text-gray-400">ã•ã‚ã€ã‚ãªãŸã ã‘ã®<br>å­¦ç¿’ã®æ—…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚</p>
                </div>
            </div>
        </div>
        
        <div class="p-6 flex justify-between items-center">
            <div class="flex space-x-2" id="tutorial-dots">
                <span class="w-2 h-2 rounded-full bg-white"></span>
                <span class="w-2 h-2 rounded-full bg-gray-600"></span>
                <span class="w-2 h-2 rounded-full bg-gray-600"></span>
            </div>
            <button id="tutorial-next-btn" class="primary-bg px-6 py-2 rounded-full font-bold shadow-lg">æ¬¡ã¸</button>
        </div>
    </div>

    <div id="migration-screen" class="fixed inset-0 z-[300] bg-gray-50 dark:bg-gray-900 flex flex-col transition-all duration-300 opacity-0 pointer-events-none transform scale-95">
        <header class="header-safe px-6 py-4 flex items-center justify-between min-h-[60px]">
            <button id="close-migration-btn" class="p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors text-gray-500 dark:text-gray-400 flex items-center">
                <i data-lucide="x" class="w-6 h-6 mr-1"></i>
                <span class="font-bold text-sm">é–‰ã˜ã‚‹</span>
            </button>
            <div class="flex-1"></div>
        </header>

        <div class="flex-grow flex flex-col items-center justify-center p-6 max-w-md mx-auto w-full relative">
            
            <div id="migration-step-1" class="migration-view w-full flex flex-col items-center space-y-8 animate-fadeIn">
                <div class="text-center space-y-2">
                    <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-600 dark:text-indigo-400">
                        <i data-lucide="smartphone" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">ãƒ‡ãƒ¼ã‚¿å¼•ç¶™ã</h2>
                    <p class="text-gray-500 dark:text-gray-400">å¤ã„ç«¯æœ«ã¨æ–°ã—ã„ç«¯æœ«ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <div class="w-full space-y-4">
                    <button id="migration-mode-send" class="w-full bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border-2 border-transparent hover:border-indigo-500 dark:hover:border-indigo-500 transition-all group text-left relative overflow-hidden">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-50 dark:bg-blue-900/20 text-blue-500 mr-4 group-hover:scale-110 transition-transform">
                                <i data-lucide="upload-cloud" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900 dark:text-white text-lg">ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">å¤ã„ã‚¹ãƒãƒ›ï¼ˆå¼•ç¶™ãå…ƒï¼‰</p>
                            </div>
                        </div>
                    </button>

                    <button id="migration-mode-receive" class="w-full bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border-2 border-transparent hover:border-green-500 dark:hover:border-green-500 transition-all group text-left relative overflow-hidden">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-50 dark:bg-green-900/20 text-green-500 mr-4 group-hover:scale-110 transition-transform">
                                <i data-lucide="download-cloud" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900 dark:text-white text-lg">ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">æ–°ã—ã„ã‚¹ãƒãƒ›ï¼ˆå¼•ç¶™ãå…ˆï¼‰</p>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <div id="migration-sender-view" class="migration-view hidden w-full flex flex-col items-center space-y-6 animate-fadeIn">
                <div class="text-center">
                    <h3 class="text-xl font-bold mb-2">æ¥ç¶šå…ˆã‚’å…¥åŠ›</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">æ–°ã—ã„ã‚¹ãƒãƒ›ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <div class="w-full bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm">
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">Target ID</label>
                    <input type="text" id="migration-target-id" class="w-full text-center text-3xl font-mono font-bold bg-gray-100 dark:bg-gray-900 border-b-2 border-gray-300 dark:border-gray-700 focus:border-indigo-500 focus:outline-none py-2 tracking-widest uppercase rounded-t-md transition-colors" placeholder="XXXX">
                </div>

                <div id="migration-sender-error" class="hidden w-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 p-3 rounded-lg text-sm flex items-center justify-center">
                    <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i>
                    <span id="migration-sender-error-text"></span>
                </div>

                <button id="migration-connect-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition-all hover:-translate-y-1 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>æ¥ç¶šã™ã‚‹</span>
                </button>
                
                <button class="migration-back-step text-gray-400 hover:text-gray-600 text-sm mt-4">
                    æˆ»ã‚‹
                </button>
            </div>

            <div id="migration-receiver-view" class="migration-view hidden w-full flex flex-col items-center space-y-6 animate-fadeIn">
                <div class="text-center">
                    <h3 class="text-xl font-bold mb-2">å¾…æ©Ÿä¸­...</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">ã“ã®IDã‚’å¤ã„ã‚¹ãƒãƒ›ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <div class="relative w-full aspect-video bg-gray-800 rounded-2xl flex flex-col items-center justify-center shadow-inner overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/20 to-purple-500/20 animate-pulse"></div>
                    <p class="text-gray-400 text-xs font-mono mb-2 relative z-10">YOUR ID</p>
                    <p class="text-5xl font-mono font-bold tracking-widest text-white relative z-10 drop-shadow-lg" id="migration-my-id">...</p>
                </div>

                <div class="flex items-center space-x-2 text-yellow-500 bg-yellow-50 dark:bg-yellow-900/20 px-4 py-2 rounded-full transition-colors" id="migration-receiver-status-box">
                    <div class="w-2 h-2 bg-yellow-500 rounded-full animate-ping" id="migration-receiver-indicator"></div>
                    <span class="text-xs font-bold" id="migration-status-receive">æ¥ç¶šå¾…ã¡</span>
                </div>

                <button class="migration-back-step text-gray-400 hover:text-gray-600 text-sm mt-4">
                    æˆ»ã‚‹
                </button>
            </div>

            <div id="migration-confirm-view" class="migration-view hidden w-full flex flex-col items-center space-y-6 animate-fadeIn">
                <div class="w-20 h-20 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center text-yellow-500 mb-2">
                    <i data-lucide="alert-triangle" class="w-10 h-10"></i>
                </div>
                
                <div class="text-center space-y-4">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">æœ¬å½“ã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ</h3>
                    <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl text-left text-sm text-gray-600 dark:text-gray-300">
                        <ul class="list-disc list-inside space-y-2">
                            <li>æ–°ã—ã„ã‚¹ãƒãƒ›ã«ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚</li>
                            <li><strong>é€ä¿¡å¾Œã€ã“ã®ç«¯æœ«ã®ãƒ‡ãƒ¼ã‚¿ã¯åˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚</strong></li>
                        </ul>
                    </div>
                </div>

                <div class="w-full space-y-3 pt-4">
                    <button id="migration-confirm-yes-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95">
                        ã¯ã„ã€é€ä¿¡ã—ã¦åˆæœŸåŒ–ã—ã¾ã™
                    </button>
                    <button id="migration-confirm-no-btn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-bold py-4 rounded-xl transition-colors">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </div>

            <div id="migration-complete-view" class="migration-view hidden w-full flex flex-col items-center justify-center space-y-6 animate-fadeIn text-center">
                <div class="relative">
                    <div id="migration-spinner" class="w-24 h-24 border-4 border-indigo-200 border-t-indigo-500 rounded-full animate-spin"></div>
                    <div id="migration-success-icon" class="hidden absolute inset-0 flex items-center justify-center text-green-500">
                        <i data-lucide="check-circle" class="w-24 h-24 fill-green-100 dark:fill-green-900"></i>
                    </div>
                </div>
                
                <div>
                    <h3 id="migration-complete-title" class="text-2xl font-bold mb-2">å‡¦ç†ä¸­...</h3>
                    <p id="migration-complete-msg" class="text-gray-500 dark:text-gray-400">é€šä¿¡ã‚’åˆ‡æ–­ã—ãªã„ã§ãã ã•ã„</p>
                </div>
            </div>

        </div>
    </div>

    <div id="theme-settings-screen" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-theme-settings-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</h2>
            <div class="flex-1"></div>
        </header>
        <div class="flex-grow overflow-y-auto p-4 pb-safe bg-gray-100 dark:bg-gray-900">
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                <h3 class="font-semibold mb-4">ã‚«ãƒ©ãƒ¼ã‚’é¸æŠ</h3>
                <div id="theme-selector-container" class="grid grid-cols-4 gap-4"></div>
            </div>
        </div>
    </div>

    <div id="background-settings-screen" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-bg-settings-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">å£ç´™è¨­å®š</h2>
            <div class="flex-1"></div>
        </header>
        <div class="flex-grow overflow-y-auto p-4 pb-safe bg-gray-100 dark:bg-gray-900">
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-4">
                <h3 class="font-semibold mb-4">å£ç´™ã‚’é¸æŠ</h3>
                <div id="background-selector-container" class="grid grid-cols-3 gap-4"></div>
            </div>
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow flex items-center justify-between">
                <div>
                    <p class="font-semibold">å£ç´™ã‚’ã‚¢ãƒ—ãƒªå…¨ä½“ã«é©ç”¨</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">OFFã®å ´åˆã€ãƒ›ãƒ¼ãƒ ç”»é¢ä»¥å¤–ã«ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“</p>
                </div>
                <input type="checkbox" id="background-scope-toggle-sub" class="toggle-checkbox">
            </div>
        </div>
    </div>

    <div id="bgm-settings-screen" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-bgm-settings-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">BGMè¨­å®š</h2>
            <div class="flex-1"></div>
        </header>
        <div class="flex-grow overflow-y-auto p-4 pb-safe bg-gray-100 dark:bg-gray-900">
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold flex items-center">
                        <i data-lucide="music" class="w-5 h-5 mr-2 primary-text"></i>
                        <span>BGMæ©Ÿèƒ½</span>
                    </h3>
                    <input type="checkbox" id="bgm-toggle-sub" class="toggle-checkbox">
                </div>
                <p class="text-xs text-gray-500">ONã«ã™ã‚‹ã¨ã€ã‚¯ã‚¨ã‚¹ãƒˆã®ã€Œå­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€ä¸­ã«ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆé †ã§å†ç”Ÿã•ã‚Œã¾ã™ã€‚</p>
            </div>

            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-4">
                <h4 class="text-sm font-bold mb-2 flex items-center"><i data-lucide="list-music" class="w-4 h-4 mr-1"></i> ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h4>
                <div id="playlist-container-sub" class="space-y-2 mb-4 min-h-[50px] bg-gray-50 dark:bg-gray-800/50 rounded-lg p-2"></div>
            </div>

            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                <h4 class="text-sm font-bold mb-2 flex items-center"><i data-lucide="library" class="w-4 h-4 mr-1"></i> è¿½åŠ å¯èƒ½ãªæ›²</h4>
                <div id="unlocked-music-list-sub" class="flex flex-wrap gap-2"></div>
            </div>
        </div>
    </div>

    <div id="quest-view" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="quest-back-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ã‚¯ã‚¨ã‚¹ãƒˆè¨­å®š</h2>
            <div class="flex-1"></div>
        </header>

        <div class="flex-grow overflow-y-auto p-4 pb-36 bg-gray-100 dark:bg-gray-900">
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm mb-4">
                <button id="load-tasks-btn" class="w-full mb-2 primary-bg primary-bg-hover text-white py-2 px-4 rounded-lg font-bold flex items-center justify-center space-x-2">
                    <i data-lucide="check-square" class="w-5 h-5"></i>
                    <span>ã€Œä»Šæ—¥ã®äºˆå®šã€ã‚’èª­ã¿è¾¼ã‚€</span>
                </button>
                <hr class="my-3 border-gray-200 dark:border-gray-600">
                
                <div class="flex items-center space-x-2 text-sm">
                    <input type="number" id="break-interval-input" value="2" class="w-16 p-1 border rounded dark:bg-gray-800 dark:border-gray-600">
                    <span>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«</span>
                    <input type="number" id="break-duration-input" value="5" class="w-16 p-1 border rounded dark:bg-gray-800 dark:border-gray-600">
                    <span>åˆ†ä¼‘æ†©</span>
                </div>
                <button id="add-breaks-btn" class="mt-2 text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">ä¼‘æ†©ã‚’è‡ªå‹•æŒ¿å…¥</button>
            </div>
            
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm"> 
                <div id="quest-plan-list" class="space-y-2">
                    </div>
                
                <div class="flex justify-between mt-4">
                    <button id="add-section-btn" class="text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ </button>
                    <button id="add-break-btn" class="text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">ä¼‘æ†©è¿½åŠ </button>
                </div>
            </div>
        </div>

        <div class="fixed bottom-safe-16 left-0 right-0 max-w-lg mx-auto p-4 z-20 pointer-events-none">
            <button id="start-quest-btn" class="w-full primary-bg primary-bg-hover text-white py-3 px-4 rounded-lg font-bold text-lg shadow-md hover:scale-105 transition-transform transform flex items-center justify-center space-x-2 pointer-events-auto">
                <i data-lucide="play" class="w-6 h-6"></i>
                <span>ã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹</span>
            </button>
        </div>
    </div>

    <div id="quiz-screen" class="screen-layer flex flex-col h-full bg-gray-100 dark:bg-gray-900">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-quiz-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 id="quiz-screen-title" class="text-lg font-bold text-gray-900 dark:text-white truncate max-w-[60%] text-center"></h2>
            <div class="flex-1"></div>
        </header>
        <div id="quiz-container" class="flex-grow relative w-full h-full">
         <div id="quiz-loader" class="absolute inset-0 flex items-center justify-center" style="display: none;"><div id="loader"></div></div>
         </div>
    </div>

    <div id="countdown-screen" class="screen-layer flex flex-col h-full bg-gray-100 dark:bg-gray-900">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-countdown-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 id="countdown-screen-title" class="text-lg font-bold text-gray-900 dark:text-white">ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š</h2>
            <div class="flex-1 text-right">
                <button id="countdown-save-btn" class="primary-text font-bold text-sm px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">ä¿å­˜</button>
            </div>
        </header>

        <div class="flex-grow overflow-y-auto p-4 pb-safe space-y-6">
            <div class="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-sm space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-500 dark:text-gray-400">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                    <input id="countdown-name" type="text" placeholder="ä¾‹: æœŸæœ«ãƒ†ã‚¹ãƒˆ" class="w-full p-3 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-500 dark:text-gray-400">æ—¥ä»˜</label>
                    <input id="countdown-date" type="date" class="w-full p-3 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>

            <div class="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-sm">
                <label class="block text-sm font-bold mb-1 text-gray-500 dark:text-gray-400">ãƒ¡ãƒ¢ (è©³ç´°ãƒšãƒ¼ã‚¸ã®ã¿è¡¨ç¤º)</label>
                <textarea id="countdown-memo" rows="5" placeholder="ç¯„å›²: P.30ã€œP.50\nç›®æ¨™: 80ç‚¹ä»¥ä¸Š" class="w-full p-3 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>
            </div>

            <button id="countdown-delete-btn" class="w-full text-red-500 bg-white dark:bg-gray-700 border border-red-200 dark:border-red-900/30 p-3 rounded-xl font-bold hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center justify-center hidden">
                <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
            </button>
            
            <div class="h-20"></div> </div>
    </div>

    <div id="break-settings-screen" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-break-settings-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ è¨­å®š</h2>
            <div class="flex-1"></div>
        </header>
        
        <div class="flex-grow overflow-y-auto p-4 pb-safe bg-gray-100 dark:bg-gray-900">
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">ä¼‘æ†©ä¸­ã«è¡¨ç¤ºã™ã‚‹ã‚¢ãƒ—ãƒªã‚„Webã‚µã‚¤ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚</p>

            <h4 class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 px-1">è¡¨ç¤ºä¸­ (ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ)</h4>
            <div id="break-active-list" class="w-full space-y-2"></div>

            <h4 class="text-xs font-bold text-gray-500 dark:text-gray-400 mt-6 mb-2 px-1">è¿½åŠ å¯èƒ½</h4>
            <div id="break-inactive-list" class="w-full flex flex-wrap gap-2"></div>
        </div>
    </div>

    <div id="profile-screen" class="screen-layer bg-gray-100 dark:bg-gray-900 flex flex-col">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-profile-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h2>
            <div class="flex-1"></div>
        </header>

        <div class="flex-grow overflow-y-auto p-4 pb-safe space-y-6">
            <div class="flex flex-col items-center">
                <label class="block text-sm font-bold mb-2 text-gray-500">ã‚¢ã‚¤ã‚³ãƒ³</label>
                <div class="relative inline-block">
                    <input type="text" id="edit-profile-icon" class="w-24 h-24 text-center text-6xl border-2 border-dashed border-gray-300 rounded-full focus:outline-none focus:border-indigo-500 bg-white dark:bg-gray-800" readonly>
                    <div id="edit-icon-random-btn" class="absolute -bottom-2 -right-2 bg-blue-500 text-white p-2 rounded-full shadow cursor-pointer">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-sm space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-500 dark:text-gray-400">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                    <input type="text" id="edit-profile-name" class="w-full p-3 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-500 dark:text-gray-400">å­¦å¹´</label>
                    <div class="relative">
                        <select id="edit-profile-grade" class="w-full p-3 rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 appearance-none focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none w-4 h-4"></i>
                    </div>
                </div>
            </div>

            <button id="save-profile-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-3 rounded-xl shadow-lg">
                ä¿å­˜ã™ã‚‹
            </button>

            <hr class="border-gray-200 dark:border-gray-700">

            <button id="open-migration-menu-btn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-bold py-3 rounded-xl flex items-center justify-center">
                <i data-lucide="smartphone" class="w-5 h-5 mr-2"></i>
                æ©Ÿç¨®å¤‰æ›´ãƒ»ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ã
            </button>
            
            <div class="h-10"></div>
        </div>
    </div>

    <!-- ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
    <div id="quiz-modal" class="fixed inset-0 bg-black/70 z-50 flex-col hidden"><div class="w-full h-full max-w-lg mx-auto bg-gray-100 dark:bg-gray-900 flex flex-col"><header class="p-3 flex items-center justify-between shadow-md bg-white dark:bg-gray-800"><h2 id="quiz-modal-title" class="truncate font-bold"></h2><button class="close-modal-btn p-1" data-modal="quiz-modal"><i data-lucide="x"></i></button></header><div class="flex-grow relative"><div class="absolute inset-0 flex items-center justify-center"><div id="loader"></div></div><iframe id="quiz-iframe" class="w-full h-full border-0 invisible" sandbox="allow-scripts allow-forms allow-popups"></iframe></div></div></div>
    <div id="assessment-modal" class="hidden fixed inset-0 bg-black/70 z-[210] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        <div id="assessment-content" class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center transform scale-0 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h2>
            <p class="mb-6 text-gray-600 dark:text-gray-300">ã“ã®ã‚¯ã‚¤ã‚ºã®ç†è§£åº¦ã‚’è¨˜éŒ²ã—ã‚ˆã†</p>
            <div class="flex justify-around">
                <button class="assessment-btn p-2 w-24 flex flex-col items-center hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition" data-level="3"><i data-lucide="award" class="w-10 h-10 text-yellow-400 mb-1 mx-auto"></i><p class="font-bold">å®Œ ç’§</p></button>
                <button class="assessment-btn p-2 w-24 flex flex-col items-center hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition" data-level="2"><i data-lucide="thumbs-up" class="w-10 h-10 text-green-400 mb-1 mx-auto"></i><p class="font-bold">ã¾ã‚ã¾ã‚</p></button>
                <button class="assessment-btn p-2 w-24 flex flex-col items-center hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition" data-level="1"><i data-lucide="book-open-check" class="w-10 h-10 text-blue-400 mb-1 mx-auto"></i><p class="font-bold">è¦å¾©ç¿’</p></button>
            </div>
        </div>
    </div>
    
    <div id="item-detail-screen" class="screen-layer bg-white dark:bg-gray-900 z-[150] flex flex-col">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-item-detail-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ã‚¢ã‚¤ãƒ†ãƒ è©³ç´°</h2>
            
            <div class="flex-1"></div>
        </header>

        <div class="flex-grow overflow-y-auto pb-safe">
            <div class="p-6 pb-0 flex flex-col md:flex-row gap-6">
                <div class="flex-shrink-0 mx-auto md:mx-0">
                    <div id="detail-icon-container" class="w-32 h-32 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden flex items-center justify-center bg-gray-100 dark:bg-gray-800">
                        </div>
                </div>
                
                <div class="flex-grow text-center md:text-left flex flex-col justify-between">
                    <div>
                        <h2 id="detail-title" class="text-2xl font-bold text-gray-900 dark:text-white mb-1">ã‚¢ã‚¤ãƒ†ãƒ å</h2>
                        <p id="detail-subtitle" class="text-sm text-gray-500 dark:text-gray-400 mb-4">ã‚«ãƒ†ã‚´ãƒªå</p>
                    </div>
                    
                    <div class="flex justify-center md:justify-start items-center space-x-4 mb-4">
                        <button id="detail-action-btn" class="primary-bg text-white font-bold py-2 px-8 rounded-full shadow-lg transition-transform active:scale-95 flex items-center min-w-[120px] justify-center">
                            <span>å–å¾—</span>
                        </button>
                        <p id="detail-status-text" class="text-xs text-gray-500 font-bold hidden">äº¤æ›æ¸ˆã¿</p>
                    </div>
                </div>
            </div>

            <hr class="my-6 border-gray-200 dark:border-gray-800 mx-6">

            <div class="px-6 space-y-6">
                <div id="detail-preview-section" class="hidden">
                    <h3 class="font-bold text-lg mb-3 text-gray-900 dark:text-white">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <div id="detail-carousel" class="preview-carousel gap-4 pb-4">
                        </div>
                </div>

                <div>
                    <h3 class="font-bold text-lg mb-2 text-gray-900 dark:text-white">è©³ç´°</h3>
                    <p id="detail-description" class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed">
                        ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å­¦ç¿’ä½“é¨“ãŒã‚ˆã‚Šè±Šã‹ã«ãªã‚Šã¾ã™ã€‚LPã‚’è²¯ã‚ã¦äº¤æ›ã—ã¾ã—ã‚‡ã†ã€‚
                    </p>
                </div>
            </div>
            
            <div class="h-20"></div>
        </div>
    </div>
    
    </div>
</div>
       
    <div id="status-screen" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0">
            <div class="flex items-center flex-1">
                <button id="close-status-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ãƒã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
            
            <div class="flex-1"></div>
        </header>

        <div class="bg-gray-50 dark:bg-gray-800/50 p-6 text-center flex-shrink-0">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">ç¾åœ¨ã®ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ</p>
            
            <div class="flex items-center justify-center space-x-3 mb-1">
                <img src="coin.png" alt="Coin" class="w-12 h-12 object-contain drop-shadow-md">
                <p class="text-5xl font-bold primary-text" id="status-lp-display">0</p>
            </div>
            <p class="text-xs text-gray-400 mt-2">å­¦ç¿’ã—ã¦LPã‚’è²¯ã‚ã€ã‚¢ã‚¤ãƒ†ãƒ ã¨äº¤æ›ã—ã‚ˆã†</p>
        </div>

        <div class="px-4 py-2 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex-shrink-0 overflow-x-auto">
            <div class="flex space-x-2 pb-1" id="status-tabs-container">
                <button class="status-tab-btn active primary-bg text-white px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors" data-target="theme">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</button>
                <button class="status-tab-btn bg-gray-200 dark:bg-gray-600 px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors" data-target="background">å£ç´™</button>
                <button class="status-tab-btn bg-gray-200 dark:bg-gray-600 px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors" data-target="game">ãƒŸãƒ‹ã‚²ãƒ¼ãƒ </button>
                <button class="status-tab-btn bg-gray-200 dark:bg-gray-600 px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors" data-target="music">BGM</button>
            </div>
        </div>
    
        <div class="flex-grow overflow-y-auto p-4 pb-safe bg-gray-100 dark:bg-gray-900">
            
            <div id="status-content-theme" class="status-content-section">
                <div id="status-theme-list" class="grid grid-cols-4 gap-4"></div>
            </div>

            <div id="status-content-background" class="status-content-section hidden">
                <div id="status-background-list" class="grid grid-cols-2 gap-3"></div>
            </div>

            <div id="status-content-game" class="status-content-section hidden">
                <div id="status-game-list" class="grid grid-cols-3 gap-3"></div>
            </div>

            <div id="status-content-music" class="status-content-section hidden">
                <div id="status-music-list" class="grid grid-cols-3 gap-3"></div>
            </div>

        </div>
    </div>

    <div id="lp-popup-modal" class="fixed inset-0 z-[1000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden" style="opacity: 0; transition: opacity 0.3s;">
        
        <div id="lp-popup-content" class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl relative transform scale-0 overflow-hidden border border-yellow-400/30">
            
            <div class="popup-content-layer">
                <h2 id="popup-title" class="text-3xl font-black text-gray-800 dark:text-white mb-6 tracking-widest drop-shadow-sm">GET!</h2>
                
                <div class="relative w-40 h-40 mx-auto mb-6 flex items-center justify-center">
                    
                    <div class="sunburst"></div>

                    <div class="absolute inset-0 bg-yellow-400 blur-[40px] opacity-40 rounded-full animate-pulse"></div>
                    
                    <img id="popup-coin-img" src="coin.png" alt="LP Coin" class="w-full h-full object-contain relative z-10 animate-coin-float drop-shadow-xl">
                    
                    <div id="popup-item-icon" class="relative z-10 hidden w-28 h-28 flex items-center justify-center animate-coin-float"></div>
                </div>

                <div class="mb-8">
                    <span id="lp-popup-reason" class="text-lg font-bold text-gray-500 dark:text-gray-400 block mb-1">ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹</span>
                    
                    <div id="popup-lp-container" class="flex items-baseline justify-center space-x-1">
                        <span class="text-2xl font-bold text-yellow-500">+</span>
                        <span id="lp-popup-amount" class="text-6xl font-black lp-amount-text tabular-nums">0</span>
                        <span class="text-xl font-bold text-yellow-600 dark:text-yellow-500">LP</span>
                    </div>

                    <p id="popup-item-name" class="hidden text-2xl font-bold text-gray-800 dark:text-white mt-2 animate-pulse"></p>
                </div>

                <button id="lp-popup-close-btn" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-600 hover:from-yellow-500 hover:to-yellow-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition active:scale-95 text-xl">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-all duration-300 z-[2000] transform -translate-y-10"></div>
        
    <div id="quest-active-screen" class="focus-view-bg hidden fixed inset-0 bg-gray-900 text-gray-100 z-[200] flex flex-col items-center justify-center transition-all duration-500 bg-cover bg-center">

        <div class="absolute inset-0 bg-black/60 z-0"></div>

        <div class="relative z-10 w-full h-full flex flex-col items-center justify-center">
        
            <div class="absolute right-6 flex items-center space-x-2 z-50" style="top: calc(1.5rem + env(safe-area-inset-top));">
                <button id="end-quest-btn" class="text-gray-300 p-2 rounded-full hover:bg-gray-700 transition-colors">
                    <i data-lucide="x" class="w-7 h-7"></i> 
                </button>
            </div>
                
            <div id="quest-content-area" class="relative w-full h-full overflow-hidden">
            
                <div id="quest-section-view" class="hidden absolute inset-0 w-full h-full flex-col items-center justify-center p-4 z-10 animate-enter-active">
                    <div class="text-center">
                        <h2 id="quest-section-title" class="text-2xl md:text-3xl font-bold mb-2 text-gray-400 tracking-wider"></h2>
                        <p class="text-7xl md:text-9xl tabular-nums font-extrabold tracking-tight" id="quest-timer">25:00</p>
                        <p id="quest-progress" class="mt-4 text-lg text-gray-400 font-medium"></p>
                    </div>
                </div>

                <div id="quest-break-view" class="hidden absolute inset-0 w-full h-full flex-col items-center justify-center p-4 z-10 animate-enter-active">
                    <div class="text-center mb-8 flex-shrink-0">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-400 tracking-wider">â˜• ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ </h2>
                        <p class="text-5xl md:text-7xl tabular-nums font-extrabold tracking-tight" id="break-timer">05:00</p>
                    </div>

                    <div class="w-full max-w-sm overflow-y-auto max-h-[50vh] px-2">
                        <div id="break-icon-grid" class="break-icon-grid-container">
                            </div>
                    </div>
                </div>

                <div id="quest-transition-view" class="hidden fixed inset-0 w-full h-full z-[60] bg-gray-900/95 overflow-y-auto">
                    <div class="min-h-full flex flex-col landscape:flex-row items-center justify-center p-6 gap-8 landscape:gap-16 max-w-5xl mx-auto animate-enter-active">
                        
                        <div class="flex flex-col items-center text-center landscape:w-1/2 landscape:items-end landscape:text-right space-y-4">
                            <i id="transition-icon" data-lucide="arrow-right-circle" class="w-24 h-24 text-white opacity-80"></i>
                            <div>
                                <h2 id="transition-title" class="text-3xl md:text-4xl font-bold text-white mb-2"></h2>
                                <p id="transition-message" class="text-xl text-gray-300"></p>
                            </div>
                        </div>
                        
                        <div class="flex flex-col items-center landscape:items-start landscape:w-1/2 w-full max-w-sm">
                            <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 w-full border border-white/20 mb-8 shadow-xl">
                                <p class="text-sm text-gray-400 mb-1 font-bold tracking-wider">NEXT STEP</p>
                                <p id="transition-next-text" class="text-2xl font-bold text-white truncate my-1"></p>
                                <div class="flex items-center text-gray-300">
                                    <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                                    <p id="transition-next-duration" class="text-sm font-mono"></p>
                                </div>
                            </div>

                            <button id="transition-start-btn" class="primary-bg primary-bg-hover text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center justify-center w-full landscape:w-auto">
                                <i data-lucide="play" class="w-6 h-6 mr-2 fill-current"></i>
                                <span>å§‹ã‚ã‚‹</span>
                            </button>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <div id="iframe-overlay" class="hidden fixed inset-0 bg-gray-900 z-[220] flex flex-col">
        <div class="bg-gray-800 w-full px-2 pb-2 flex justify-between items-center z-10 shadow-md" style="padding-top: calc(0.5rem + env(safe-area-inset-top));">
            <span class="text-white font-bold ml-2">Game</span>
            <button id="close-iframe-btn" class="text-gray-300 p-2 rounded-full hover:bg-gray-700">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div id="game-container" class="relative flex-grow w-full h-full bg-white">
            <div id="iframe-loader" class="flex flex-col items-center justify-center absolute inset-0" style="display: none;">
                <div id="loader"></div> <p class="mt-4 text-gray-500 font-bold">Loading...</p>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black/50 z-[210] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        <div id="confirmation-content" class="bg-white dark:bg-gray-700 rounded-xl shadow-2xl p-6 w-full max-w-sm text-center transform scale-0 transition-transform duration-300">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 dark:text-white mb-4">ã‚¯ã‚¨ã‚¹ãƒˆã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ</h3>
            <div class="flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modal-confirm-btn" class="px-6 py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition">çµ‚äº†</button>
            </div>
        </div>
    </div>

    <div id="resume-quest-modal" class="hidden fixed inset-0 bg-black/80 z-[210] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <div class="mb-4">
                <i data-lucide="alert-circle" class="w-12 h-12 text-yellow-500 mx-auto mb-2"></i>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">ã‚¯ã‚¨ã‚¹ãƒˆã‚’å†é–‹ã—ã¾ã™ã‹ï¼Ÿ</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">å‰å›ã€ã‚¯ã‚¨ã‚¹ãƒˆã®é€”ä¸­ã§ã‚¢ãƒ—ãƒªãŒçµ‚äº†ã—ã¾ã—ãŸã€‚</p>
            </div>
            <div class="flex flex-col space-y-3">
                <button id="resume-quest-yes-btn" class="w-full py-3 rounded-lg primary-bg primary-bg-hover text-white font-bold shadow-lg">
                    å†é–‹ã™ã‚‹
                </button>
                <button id="resume-quest-no-btn" class="w-full py-3 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold">
                    çµ‚äº†ã—ã¦ãƒ›ãƒ¼ãƒ ã¸
                </button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initialData = {
                quizzes: [
                    { id: 'math1', title: "æ•°å­¦ - æ­£è² ã®æ•°", subject: "æ•°å­¦", genre: "ä¸­1", tags: ['english1'], url: "https://docs.google.com/forms/d/e/1FAIpQLScsC0BFa_3gY-f-u4pW8Q22o_l3c0T-t_9c3z-q8pY6X-u8qQ/viewform?usp=sf_link" },
                    { id: 'english1', title: "è‹±èª - beå‹•è©", subject: "è‹±èª", genre: "ä¸­1", tags: ['math1', 'history1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSfvtBwi1Tb1z6YEQOclBi4J7pxOc8lEILZ-OPZ4k6aebFJmTg/viewform" },
                    { id: 'science1', title: "ç†ç§‘ - æ¤ç‰©ã®ã¤ãã‚Š", subject: "ç†ç§‘", genre: "ä¸­1", tags: [], url: "https://docs.google.com/forms/d/e/1FAIpQLSfp-24sW_4xT8d_aK_b_nL5e-pX7a-j8vN-qA9rR_cT_uL-vQ/viewform?usp=sf_link" },
                    { id: 'japanese1', title: "å›½èª - æ•è‰å­", subject: "å›½èª", genre: "å¤å…¸", tags: ['history1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSe-0P7p_L-rT9c-yS_eD-wA9iR_bO8kM-nL-u_V-iE7xS-tQ/viewform?usp=sf_link" },
                    { id: 'history1', title: "ç¤¾ä¼š - éŒå€‰æ™‚ä»£", subject: "ç¤¾ä¼š", genre: "æ­´å²", tags: ['japanese1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSeLprqPbZCZv2ufQ2qYqltnRiUE1FsBYODa_eNwOVO1NqZwBw/viewform?usp=pp_url" },
                ],
                
                themes: {
                    default: { name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', color: '#4f46e5', hover: '#4338ca', cost: 0 },
                    green: { name: 'ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ', color: '#16a34a', hover: '#15803d', cost: 100 },
                    red: { name: 'ã‚µãƒ³ã‚»ãƒƒãƒˆ', color: '#dc2626', hover: '#b91c1c', cost: 150 },
                    orange: { name: 'ãƒ“ã‚¿ãƒŸãƒ³', color: '#f97316', hover: '#ea580c', cost: 200 },
                    purple: { name: 'ãƒŸãƒƒãƒ‰ãƒŠã‚¤ãƒˆ', color: '#7c3aed', hover: '#6d28d9', cost: 250 },
                    pink: { name: 'ãƒã‚§ãƒªãƒ¼', color: '#db2777', hover: '#be185d', cost: 300 },
                    teal: { name: 'ã‚ªãƒ¼ã‚·ãƒ£ãƒ³', color: '#0d9488', hover: '#0f766e', cost: 350 },
                },
                backgrounds: {
                    default: { name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', url: '', cost: 0 , tone: 'system' },
                    sky: { name: 'é’ç©ºã¨æµã‚Œæ˜Ÿ', url: 'okumono_hosisoratate8.png', cost: 500, tone: 'light' },
                    night: { name: 'æ‰‹æ›¸ãã‚†ã‚‹ãƒ‰ãƒƒãƒˆ', url: 'https://sozaino.site/wp-content/uploads/2022/01/yurudot32.png', cost: 700, tone: 'light' },
                    sdotb: { name: 'ã‚·ãƒ£ãƒ¯ãƒ¼ãƒ‰ãƒƒãƒˆ(ãƒ–ãƒ«ãƒ¼)', url: 'https://sozaino.site/wp-content/uploads/2020/11/sai-4.png', cost: 700, tone: 'light' },
                    utyuu: { name: 'å£®å¤§ãªå®‡å®™', url: 'https://sozaino.site/wp-content/uploads/2021/02/utyuu.jpg', cost: 700, tone: 'dark' },
                    jyanguru: { name: 'ã‚¸ãƒ£ãƒ³ã‚°ãƒ«', url: 'https://sozaino.site/wp-content/uploads/2025/07/okumono_jungle1.png', cost: 700, tone: 'dark' },
                    wapop: { name: 'å’Œãƒãƒƒãƒ—ï¼ˆãƒ”ãƒ³ã‚¯ï¼‰', url: 'okumono_wapop3.png', cost: 700, tone: 'dark' },
                },
                
                games: {
                    // ID: { name: 'ã‚²ãƒ¼ãƒ å', url: 'URL', cost: å¿…è¦LP, icon: 'ã‚¢ã‚¤ã‚³ãƒ³å' }
                    // previews: ['ç”»åƒã®URL', 'å‹•ç”»ã®URL', ...] ã®å½¢å¼ã§è¿½åŠ ã—ã¾ã™
                    just100: { 
                        name: 'Just 1.00s', 
                        url: 'https://330march39.github.io/games/just1m_37928/', 
                        cost: 100, 
                        icon: 'gamepad-2',
                        // â–¼â–¼â–¼ ã“ã“ã«è¿½åŠ  â–¼â–¼â–¼
                        previews: [
                            'just100s.png', // ç”»åƒ1
                            'just100s_2.png',
                            'just100s_3.png',
                            // å‹•ç”»ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã«mp4ã®URLã‚’å…¥ã‚Œã‚‹
                            // 'https://www.w3schools.com/html/mov_bbb.mp4' 
                        ]
                    },
                    ColorHunter: { 
                        name: 'Color Hunter', 
                        url: 'https://330march39.github.io/games/color_hunter_24197/', 
                        cost: 300, 
                        icon: 'gamepad-2',
                        previews: [
                            'https://placehold.co/600x400/f97316/fff?text=Color+Hunter+1',
                            'https://placehold.co/600x400/0d9488/fff?text=Color+Hunter+2'
                        ]
                    },
                    MAKE10: { 
                        name: 'MAKE 10', 
                        url: 'https://330march39.github.io/games/make10_26518/', 
                        cost: 300, 
                        icon: 'gamepad-2',
                        previews: [
                            'https://placehold.co/600x400/f97316/fff?text=Color+Hunter+1',
                            'https://placehold.co/600x400/0d9488/fff?text=Color+Hunter+2'
                        ]
                    },
                },

                // â–¼â–¼â–¼ ã€è¿½åŠ ã€‘ã“ã“ã«éŸ³æ¥½ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ â–¼â–¼â–¼
                // éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã¯ã”è‡ªèº«ã§ã‚µãƒ¼ãƒãƒ¼ç­‰ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãã®URLã‚’è²¼ã£ã¦ãã ã•ã„
                // å‹•ä½œç¢ºèªç”¨ã«ãƒ•ãƒªãƒ¼ç´ æã®URLã‚’å…¥ã‚Œã¦ã„ã¾ã™
                music: {
                    // ID: { name: 'æ›²å', url: 'éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®URL', cost: å¿…è¦LP }
                    chill1: { name: 'Chill Beats', url: 'https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3', cost: 150 },
                    piano1: { name: 'Relaxing Piano', url: 'https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3', cost: 200 },
                    
                    // ä¾‹: è‡ªåˆ†ã®æ›²ã‚’è¿½åŠ ã™ã‚‹å ´åˆ
                    // mySong1: { name: 'My Study BGM', url: './music/mysong.mp3', cost: 300 },
                }
            };

            let state;
            let chartInstances = {};
            let breakSortable = null;
            let focusTimer = { interval: null, defaultTime: 0, timeLeft: 0, isRunning: false, isPaused: false };
            let stopwatch = { interval: null, startTime: 0, elapsedTime: 0, isRunning: false, isPaused: false };
            let miniTimerTemporarilyHidden = false;
            let quizTimer = { startTime: null };

            let previewAudio = new Audio(); // è©¦è´ç”¨
            let previewTimeout = null;      // 30ç§’åœæ­¢ç”¨ã‚¿ã‚¤ãƒãƒ¼
            
            const bgmAudio = new Audio();
            bgmAudio.loop = false; // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå†ç”Ÿã®ãŸã‚ãƒ«ãƒ¼ãƒ—ã¯æ‰‹å‹•åˆ¶å¾¡
            let currentTrackIndex = 0;

            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);
            
            let homeTaskListEl, newTaskInput, newTaskNumberEl;

            let quest = {
                plan: [], // { id, type: 'section' | 'break', text?, duration }
                active: false,
                currentIndex: -1,
                timerInterval: null,
                timeLeft: 0,
                breakWindow: null
            };

            // --- ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¶å¾¡ã‚¯ãƒ©ã‚¹ï¼ˆå®Œå…¨ç‰ˆï¼šã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ç›£è¦–å¯¾å¿œï¼‰ ---
            class SwipeHandler {
                constructor(element, options = {}) {
                    this.container = element;
                    this.content = element.querySelector('.swipe-content');
                    this.actionsContainer = element.querySelector('.swipe-actions');
                    
                    this.onComplete = options.onComplete || null;
                    this.onDelete = options.onDelete || null;
                    
                    this.actionsWidth = this.actionsContainer ? this.actionsContainer.offsetWidth : 0;
                    
                    this.startX = 0;
                    this.startY = 0;
                    this.currentX = 0;
                    this.startOffset = 0;
                    
                    this.isDragging = false; 
                    this.isSwiping = false;  
                    this.currentTouchId = null;

                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒã‚¤ãƒ³ãƒ‰ï¼ˆremoveEventListenerç”¨ï¼‰
                    this.handleMove = this.handleMove.bind(this);
                    this.handleEnd = this.handleEnd.bind(this);

                    this.initEvents();
                }
            
                initEvents() {
                    // é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆã ã‘ã¯è¦ç´ è‡ªèº«ã«è¨­å®š
                    this.content.addEventListener('touchstart', (e) => this.handleStart(e), { passive: false });
                    this.content.addEventListener('mousedown', (e) => this.handleStart(e));

                    // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒãƒ–ãƒªãƒ³ã‚°åœæ­¢ç”¨ï¼‰
                    const btns = this.actionsContainer ? this.actionsContainer.querySelectorAll('.swipe-btn') : [];
                    btns.forEach(btn => {
                        // ã‚¿ãƒƒãƒé–‹å§‹æ™‚ã¯ãƒãƒ–ãƒªãƒ³ã‚°ã‚’æ­¢ã‚ã‚‹ã ã‘
                        btn.addEventListener('touchstart', (e) => e.stopPropagation(), { passive: true });
                        
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (btn.classList.contains('btn-complete')) {
                                this.snapToClose();
                                if (this.onComplete) setTimeout(() => this.onComplete(), 300);
                            } else if (btn.classList.contains('btn-delete')) {
                                this.performDelete();
                            }
                        });
                    });
                }

                handleStart(e) {
                    // æ—¢ã«ãƒ‰ãƒ©ãƒƒã‚°ä¸­ãªã‚‰ç„¡è¦–
                    if (this.isDragging) return;

                    // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãªã‚‰ç„¡è¦–
                    if (e.target.tagName === 'INPUT') return;

                    // æ—¢ã«é–‹ã„ã¦ã„ã‚‹çŠ¶æ…‹ã§ä¸­èº«ã‚’è§¦ã£ãŸã‚‰é–‰ã˜ã‚‹
                    if (this.container.classList.contains('swiped-open') && e.target.closest('.swipe-content')) {
                        e.preventDefault(); // ã“ã“é‡è¦ï¼šé–‰ã˜ã‚‹å‹•ä½œã¨èªè­˜ã•ã›ã‚‹
                        this.snapToClose();
                        return;
                    }

                    let clientX, clientY;

                    if (e.type === 'touchstart') {
                        const touch = e.changedTouches[0];
                        this.currentTouchId = touch.identifier;
                        clientX = touch.clientX;
                        clientY = touch.clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }

                    this.isDragging = true;
                    this.isSwiping = false;
                    this.startX = clientX;
                    this.startY = clientY;

                    const style = window.getComputedStyle(this.content);
                    const matrix = new WebKitCSSMatrix(style.transform);
                    this.startOffset = matrix.m41; 

                    this.container.classList.add('is-dragging');

                    // â˜…é‡è¦â˜…: ç§»å‹•ã¨çµ‚äº†ã®ç›£è¦–ã‚’ã€Œwindowã€ã«å¯¾ã—ã¦è¡Œã†
                    // ã“ã‚Œã«ã‚ˆã‚Šã€æŒ‡ãŒè¦ç´ ã®å¤–ã«å‡ºã¦ã‚‚ã€ç”»é¢ç«¯ã«è¡Œã£ã¦ã‚‚è¿½è·¡ã§ãã‚‹
                    window.addEventListener('touchmove', this.handleMove, { passive: false });
                    window.addEventListener('touchend', this.handleEnd);
                    window.addEventListener('touchcancel', this.handleEnd); // ã‚·ã‚¹ãƒ†ãƒ ã®å‰²ã‚Šè¾¼ã¿å¯¾ç­–
                    
                    window.addEventListener('mousemove', this.handleMove);
                    window.addEventListener('mouseup', this.handleEnd);
                }
        
                handleMove(e) {
                    if (!this.isDragging) return;

                    let clientX, clientY;

                    if (e.type === 'touchmove') {
                        // è¿½è·¡ä¸­ã®æŒ‡ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
                        const touch = Array.from(e.changedTouches).find(t => t.identifier === this.currentTouchId);
                        if (!touch) return; 
                        clientX = touch.clientX;
                        clientY = touch.clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }
        
                    const diffX = clientX - this.startX;
                    const diffY = clientY - this.startY;
        
                    if (!this.isSwiping) {
                        // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®š
                        if (Math.abs(diffY) > Math.abs(diffX)) {
                            this.endDrag(); // ãƒ‰ãƒ©ãƒƒã‚°ä¸­æ­¢
                            return;
                        }
                        // éŠã³ï¼ˆä¸æ„Ÿå¸¯ï¼‰
                        if (Math.abs(diffX) < 10) return; 
                        
                        this.isSwiping = true;
                        this.container.classList.add('is-swiping');
                    }

                    // ã‚¹ãƒ¯ã‚¤ãƒ—ç¢ºå®šå¾Œã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ­¢ã‚ã‚‹
                    if (e.cancelable) e.preventDefault();
        
                    let newX = this.startOffset + diffX;
        
                    // æŠµæŠ—ã¨åˆ¶é™
                    if (newX > 0) newX = newX * 0.2; // å³ã¸ã®å¼•ã£å¼µã‚ŠæŠµæŠ—
                    if (newX < -this.actionsWidth - 100) {
                        // å·¦ã¸ã®è¡ŒãéãæŠµæŠ—
                        const extra = newX - (-this.actionsWidth - 100);
                        newX = -this.actionsWidth - 100 + (extra * 0.2);
                    }
        
                    this.currentX = newX;
                    this.content.style.transform = `translateX(${newX}px)`;
                }
        
                handleEnd(e) {
                    if (!this.isDragging) return;

                    if (e.type === 'touchend' || e.type === 'touchcancel') {
                        const touch = Array.from(e.changedTouches).find(t => t.identifier === this.currentTouchId);
                        if (!touch) return; 
                    }

                    this.endDrag(); // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è§£é™¤ç­‰ã®å…±é€šå‡¦ç†

                    // ä½ç½®åˆ¤å®š
                    if (this.currentX < -150) { // æ·±ãã‚¹ãƒ¯ã‚¤ãƒ—ã—ãŸã‚‰å‰Šé™¤
                        if (this.onDelete) {
                            this.content.style.transform = `translateX(-120vw)`; // ç”»é¢å¤–ã¸
                            this.performDelete();
                        } else {
                            this.snapToOpen();
                        }
                    } else if (this.currentX < -(this.actionsWidth / 2)) {
                        this.snapToOpen();
                    } else {
                        this.snapToClose();
                    }
                }

                // çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
                endDrag() {
                    this.isDragging = false;
                    this.isSwiping = false;
                    this.currentTouchId = null;
                    
                    this.container.classList.remove('is-dragging');
                    this.container.classList.remove('is-swiping');

                    // â˜…é‡è¦â˜…: windowã¸ã®ç›£è¦–ã‚’è§£é™¤ã™ã‚‹
                    window.removeEventListener('touchmove', this.handleMove);
                    window.removeEventListener('touchend', this.handleEnd);
                    window.removeEventListener('touchcancel', this.handleEnd);
                    
                    window.removeEventListener('mousemove', this.handleMove);
                    window.removeEventListener('mouseup', this.handleEnd);
                }
        
                snapToOpen() {
                    this.content.style.transform = `translateX(-${this.actionsWidth}px)`;
                    this.container.classList.add('swiped-open');
                }
        
                snapToClose() {
                    this.content.style.transform = `translateX(0px)`;
                    this.container.classList.remove('swiped-open');
                }
        
                performDelete() {
                    this.container.style.height = this.container.offsetHeight + 'px';
                    this.container.classList.add('swipe-deleting');
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾…ã¡
                    requestAnimationFrame(() => {
                        this.container.style.height = '0px';
                        setTimeout(() => {
                            if (this.onDelete) this.onDelete();
                        }, 300);
                    });
                }
            }

            // ==========================================
            // â–¼â–¼â–¼ æ±ç”¨ã‚µãƒ–ãƒšãƒ¼ã‚¸ç®¡ç†ã‚¯ãƒ©ã‚¹ (ã“ã‚Œ1ã¤ã§å…¨ãƒšãƒ¼ã‚¸å¯¾å¿œ) â–¼â–¼â–¼
            // ==========================================
            class SubPage {
                constructor(elementId, options = {}) {
                    this.el = document.getElementById(elementId);
                    this.appContainer = document.getElementById('app-container');
                    this.onOpen = options.onOpen || null;   // é–‹ãã¨ãã«å®Ÿè¡Œã™ã‚‹é–¢æ•°
                    this.onClose = options.onClose || null; // é–‰ã˜ã‚‹ã¨ãã«å®Ÿè¡Œã™ã‚‹é–¢æ•°
                    
                    this.closeTimer = null;

                    // ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¶å¾¡ç”¨å¤‰æ•°
                    this.touchStartX = 0;
                    this.touchStartY = 0;
                    this.touchCurrentX = 0;
                    this.isEdgeSwipe = false;
                    this.swipeTouchId = null;

                    // åˆæœŸåŒ–
                    this.initEvents();
                }

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
                initEvents() {
                    if (!this.el) return;

                    // ã‚¿ãƒƒãƒé–‹å§‹
                    this.el.addEventListener('touchstart', (e) => {
                        if (this.isEdgeSwipe) return;
                        const touch = e.changedTouches[0];
                        this.touchStartX = touch.clientX;
                        this.touchStartY = touch.clientY;

                        // ç”»é¢å·¦ç«¯(50pxä»¥å†…)ã‹ã‚‰ã®æ“ä½œã®ã¿ã‚¹ãƒ¯ã‚¤ãƒ—ãƒãƒƒã‚¯ã¨ã¿ãªã™
                        if (this.touchStartX < 50) {
                            this.isEdgeSwipe = true;
                            this.swipeTouchId = touch.identifier;
                            this.el.classList.add('is-swiping');
                            this.appContainer.style.transition = 'none';
                        }
                    }, { passive: true });

                    // ã‚¿ãƒƒãƒç§»å‹•
                    this.el.addEventListener('touchmove', (e) => {
                        if (!this.isEdgeSwipe) return;
                        
                        const touch = Array.from(e.changedTouches).find(t => t.identifier === this.swipeTouchId);
                        if (!touch) return;

                        this.touchCurrentX = touch.clientX;
                        const currentY = touch.clientY;

                        const diffX = this.touchCurrentX - this.touchStartX;
                        const diffY = currentY - this.touchStartY;

                        // â–¼â–¼â–¼ ç¸¦ç§»å‹•åˆ¤å®š (ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã¯ã‚¹ãƒ¯ã‚¤ãƒ—ãƒãƒƒã‚¯ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«) â–¼â–¼â–¼
                        if (Math.abs(diffY) > Math.abs(diffX)) {
                            this.resetSwipeState();
                            return;
                        }

                        if (diffX > 0) {
                            if (e.cancelable) e.preventDefault();
                            
                            // ãƒšãƒ¼ã‚¸ã®ç§»å‹•
                            this.el.style.transform = `translateX(${diffX}px)`;
                            
                            // èƒŒæ™¯ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ã®ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ç§»å‹•
                            const screenWidth = window.innerWidth;
                            const progress = Math.min(diffX / screenWidth, 1);
                            const startX = -30;
                            const currentMainX = startX + (Math.abs(startX) * progress);
                            this.appContainer.style.transform = `translateX(${currentMainX}%)`;
                        }
                    }, { passive: false });

                    // ã‚¿ãƒƒãƒçµ‚äº†
                    this.el.addEventListener('touchend', (e) => {
                        if (!this.isEdgeSwipe) return;
                        const touch = Array.from(e.changedTouches).find(t => t.identifier === this.swipeTouchId);
                        if (!touch) return;

                        this.el.classList.remove('is-swiping');
                        this.appContainer.style.transition = '';

                        const diff = this.touchCurrentX - this.touchStartX;
                        const threshold = window.innerWidth / 3; // ç”»é¢ã®1/3ä»¥ä¸Šå‹•ã‹ã—ãŸã‚‰é–‰ã˜ã‚‹

                        if (diff > threshold) {
                            this.close(); // é–‰ã˜ã‚‹
                        } else {
                            this.resetPosition(); // å…ƒã«æˆ»ã™
                        }
                        
                        this.isEdgeSwipe = false;
                        this.swipeTouchId = null;
                    });
                }

                // ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­æ–­æ™‚ã®ãƒªã‚»ãƒƒãƒˆ
                resetSwipeState() {
                    this.isEdgeSwipe = false;
                    this.el.classList.remove('is-swiping');
                    this.appContainer.style.transition = '';
                    this.resetPosition();
                }

                // ä½ç½®ã‚’å…ƒã«æˆ»ã™ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ï¼‰
                resetPosition() {
                    this.el.style.transform = '';
                    this.appContainer.style.transform = '';
                    this.appContainer.style.filter = '';
                }

                // ãƒšãƒ¼ã‚¸ã‚’é–‹ã
                open() {
                    if (this.closeTimer) {
                        clearTimeout(this.closeTimer);
                        this.closeTimer = null;
                    }

                    // é–‹ãå‰ã®å‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿ã®æç”»ãªã©ï¼‰
                    if (this.onOpen) this.onOpen();

                    // ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
                    this.resetPosition();
                    
                    // è¡¨ç¤ºï¼†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    this.el.style.display = 'flex';
                    void this.el.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶
                    this.el.classList.add('active');
                    
                    // ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’å¥¥ã¸
                    this.appContainer.classList.add('background-pushed');
                }

                // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹
                close() {
                    this.el.classList.remove('active');
                    
                    // é–‰ã˜ã‚‹å‰ã®å‡¦ç†
                    if (this.onClose) this.onClose();

                    // ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’æˆ»ã™
                    this.appContainer.classList.remove('background-pushed');
                    this.resetPosition();

                    if (this.closeTimer) clearTimeout(this.closeTimer);
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤º
                    this.closeTimer = setTimeout(() => {
                        if (!this.el.classList.contains('active')) {
                            this.el.style.display = 'none';
                        }
                        this.closeTimer = null;
                    }, 500);
                }
            }

            // ã‚¯ã‚¨ã‚¹ãƒˆç”¨ DOMè¦ç´ 
            const questView = $('#quest-view');
            const questPlanListEl = $('#quest-plan-list');
            const breakSettingsListEl = $('#break-settings-list');
            const startQuestBtn = $('#start-quest-btn');
            const addBreaksBtn = $('#add-breaks-btn');
            const addSectionBtn = $('#add-section-btn');
            const addBreakBtn = $('#add-break-btn');
            
            const questActiveScreen = $('#quest-active-screen');
            const questSectionView = $('#quest-section-view');
            const questBreakView = $('#quest-break-view');
            const questSectionTitle = $('#quest-section-title');
            const questTimerEl = $('#quest-timer');
            const breakTimerEl = $('#break-timer');
            const questProgressEl = $('#quest-progress');
            const endQuestBtn = $('#end-quest-btn');

            const confirmationModal = $('#confirmation-modal');
            const modalConfirmBtn = $('#modal-confirm-btn');
            const modalCancelBtn = $('#modal-cancel-btn');

            const iframeOverlay = $('#iframe-overlay');
            const breakIframe = $('#break-iframe');
            const closeIframeBtn = $('#close-iframe-btn');
            const breakIconGrid = $('#break-icon-grid');
            
            const loadState = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const defaultState = {
                    user: {
                        isRegistered: false, // åˆå›ç™»éŒ²å®Œäº†ãƒ•ãƒ©ã‚°
                        name: 'ã‚²ã‚¹ãƒˆ',
                        icon: 'ğŸ™‚',
                        grade: '',
                        id: Math.random().toString(36).substring(2, 9) // ç°¡æ˜“ID
                    },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  profile: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lp: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unlockedThemes: ['default'],Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeTheme: 'default',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unlockedBackgrounds: ['default'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeBackground: 'default',
                        unlockedGames: [], // è§£æ”¾æ¸ˆã¿ã‚²ãƒ¼ãƒ ID
                        unlockedMusic: [], // è§£æ”¾æ¸ˆã¿éŸ³æ¥½ID
                        tasksLastUpdated: null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
                    tasks: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progress: {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pinnedQuizzes: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countdowns: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  focus: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalTime: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mode: 'timer',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isRunning: false, // å®Ÿè¡Œä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startTime: null,Â  // é–‹å§‹æ™‚åˆ»ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration: 0Â  Â  Â  Â // ã‚¿ã‚¤ãƒãƒ¼ã®ç·æ™‚é–“
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  studyLog: {},Â 
                    sessionLog: [],
                    savedQuest: null, // â˜…è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®ä¸­æ–­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settings: { backgroundScopeGlobal: true , 
                                manualDarkMode: false,
                                bgmEnabled: false,      // BGMæ©Ÿèƒ½ã®ON/OFF
                                playlist: [],           // å†ç”Ÿãƒªã‚¹ãƒˆ(IDã®é…åˆ—)
                                bgmVolume: 0.5          // éŸ³é‡ (ä»»æ„)
                              },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastLogin: null,
                    breakIcons: [
                        { id: 'x', name: 'X (Twitter)', icon: 'message-circle', url: 'https://x.com', openMode: 'external', visible: true },
                        { id: 'instagram', name: 'Instagram', icon: 'instagram', url: 'https://www.instagram.com/', openMode: 'external', visible: true },
                        { id: 'youtube', name: 'YouTube', icon: 'youtube', url: 'https://www.youtube.com/', openMode: 'external', visible: true },
                        //{ id: 'scratch1', name: 'ï¾ï¾ï¾—ï¾ï¾ƒï½¨ï½±', icon: 'gamepad-2', url: 'https://scratch.mit.edu/projects/543610448/fullscreen/', openMode: 'external', visible: true },
                        //{ id: 'scratch2', name: 'ï¾Œï¾ï¾˜ï½»ï¾ï½°ï½½ï¾', icon: 'gamepad-2', url: 'https://scratch.mit.edu/projects/415836558/fullscreen/', openMode: 'external', visible: true }
                    ],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼ ---
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 1. èª­ã¿è¾¼ã¿å…ˆã®å¤‰æ•°ã‚’ `let` ã§å®£è¨€
Â  Â  Â  Â  Â  Â  Â  Â  let loaded = {};
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedData = localStorage.getItem('quizAppUltimateV8');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. ãƒ‡ãƒ¼ã‚¿ãŒ null ã‚„ç©ºæ–‡å­—ã§ãªã„å ´åˆã®ã¿ã€JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ï¼ˆè§£æï¼‰ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (savedData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loaded = JSON.parse(savedData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 4. ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒç ´æï¼‰ã—ãŸå ´åˆ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 5. ç ´æã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€`loaded` ã¯ç©ºã®ã¾ã¾ã«ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('quizAppUltimateV8');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 6. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€èª­ã¿è¾¼ã‚“ã å€¤ã§ä¸Šæ›¸ãï¼ˆãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚å®‰å…¨ã«ãƒãƒ¼ã‚¸ï¼‰
Â  Â  Â  Â  Â  Â  Â  Â  // (ã“ã“ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜)
Â  Â  Â  Â  Â  Â  Â  Â  state = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...defaultState,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...loaded,
                    user: { ...defaultState.user, ...(loaded.user || {}) }, // â˜…è¿½åŠ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  profile: { ...defaultState.profile, ...(loaded.profile || {}) },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  focus: { ...defaultState.focus, ...(loaded.focus || {}) },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settings: { ...defaultState.settings, ...(loaded.settings || {}) },
                    breakIcons: loaded.breakIcons || defaultState.breakIcons
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---

Â  Â  Â  Â  Â  Â  Â  Â  // 3. ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹å‡¦ç† (å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãã®ã¾ã¾æµç”¨)
Â  Â  Â  Â  Â  Â  Â  Â  if(state.user.isRegistered && state.lastLogin !== new Date().toDateString()){
                    addLP(10000, 'ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹', true);
                    state.lastLogin = new Date().toDateString();
                    saveState();
                }

                // 4. ä»Šæ—¥ã®äºˆå®šãƒªã‚»ãƒƒãƒˆå‡¦ç†
Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date().toDateString();
Â  Â  Â  Â  Â  Â  Â  Â  if (state.profile.tasksLastUpdated !== today) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸãŸã‚ã€ã‚¿ã‚¹ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.tasks = []; // ã‚¿ã‚¹ã‚¯ã‚’ç©ºã«ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.profile.tasksLastUpdated = today; // æ›´æ–°æ—¥ã‚’ä»Šæ—¥ã«è¨­å®š
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
            
            const saveState = () => localStorage.setItem('quizAppUltimateV8', JSON.stringify(state));
            
           // æ—¢å­˜ã® updateAppearance é–¢æ•°ã‚’ã“ã®ã‚³ãƒ¼ãƒ‰ã§ä¸Šæ›¸ãã—ã¦ãã ã•ã„
            const updateAppearance = () => {
                const appContainer = $('#app-container');
                const activeBgId = state.profile.activeBackground;
                const activeBg = initialData.backgrounds[activeBgId] || initialData.backgrounds['default'];
                const isGlobal = state.settings.backgroundScopeGlobal;
                const hasImage = activeBg && activeBg.url;
                
                // --- 1. ãƒ†ãƒ¼ãƒï¼ˆãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ï¼‰æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ ---
                let effectiveTone = activeBg.tone;
                
                if (effectiveTone === 'system') {
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        effectiveTone = 'dark';
                    } else {
                        effectiveTone = 'light';
                    }
                }
                
                // --- 2. HTMLè¦ç´ ã¸ã®é©ç”¨ ---
                if (effectiveTone === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.setAttribute('data-theme', 'light');
                }
                
                // --- 3. èƒŒæ™¯ç”»åƒã®é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯ ---
                if (isGlobal && hasImage) {
                    appContainer.style.backgroundImage = `url(${activeBg.url})`;
                } else {
                    appContainer.style.backgroundImage = 'none';
                }

                // --- 4. ã€è¿½åŠ ã€‘ãƒãƒƒãƒï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼‰ã®è‰²ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨åŒæœŸã•ã›ã‚‹ ---
                const metaThemeColor = document.getElementById('meta-theme-color');
                if (metaThemeColor) {
                    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®è‰²å®šç¾©ã¨åˆã‚ã›ã‚‹
                    // ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰: bg-white (#ffffff)
                    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: bg-gray-800 (#1f2937 - Tailwindã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤)
                    const headerColor = (effectiveTone === 'dark') ? '#1f2937' : '#ffffff';
                    metaThemeColor.setAttribute('content', headerColor);
                }
            };
            
            const updateLpDisplay = () => {
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã®LPè¡¨ç¤ºã‚’æ›´æ–°
                const headerLp = $('#lp-display');
                if (headerLp) {
                    headerLp.textContent = `${state.profile.lp} LP`;
                }
            
                // æ–°ã—ã„ã€Œãƒã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã€ã®LPè¡¨ç¤ºã‚’æ›´æ–°
                const statusLp = $('#status-lp-display');
                if (statusLp) {
                    statusLp.textContent = state.profile.lp;
                }
            };

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ã®ç¾åœ¨å¹´æœˆ
            let currentCalendarDate = new Date();
            let selectedReportDate = new Date(); // é¸æŠä¸­ã®æ—¥ä»˜

            // â–¼â–¼â–¼ è¿½åŠ : æ±ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡é–¢æ•° â–¼â–¼â–¼
            const openModalWithAnim = (modalId, contentId) => {
                const modal = $(`#${modalId}`);
                const content = $(`#${contentId}`);
                
                modal.classList.remove('hidden');
                // æç”»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ãšã‚‰ã—ã¦CSS transitionã‚’ç™ºç«ã•ã›ã‚‹
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-0');
                    content.classList.add('animate-pop-elastic'); // å¼¾ã‚€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                });
            };

            const closeModalWithAnim = (modalId, contentId) => {
                const modal = $(`#${modalId}`);
                const content = $(`#${contentId}`);
                
                modal.classList.add('opacity-0');
                content.classList.remove('animate-pop-elastic');
                content.classList.add('scale-0'); // ç¸®å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†(300ms)å¾Œã«éè¡¨ç¤º
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            };

            const renderEngine = {
                pages: {
                    'home-page': () => {
                        const today = new Date();
                        $('#today-date').textContent = `${today.getFullYear()}å¹´ ${today.getMonth() + 1}æœˆ ${today.getDate()}æ—¥ (${'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[today.getDay()]})`;

                        // --- â–¼â–¼â–¼ ãƒ›ãƒ¼ãƒ ç”»é¢ãƒªã‚¹ãƒˆæç”»ã®ä¿®æ­£ â–¼â–¼â–¼ ---
                        const countdownContainer = $('#countdown-list');
                        
                        if (state.countdowns.length === 0) {
                            countdownContainer.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">å³ä¸Šã®ã€Œ+ã€ãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆãªã©ã®æ—¥ç¨‹ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</p>`;
                        } else {
                            countdownContainer.innerHTML = state.countdowns.map(cd => {
                                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                                const targetStart = new Date(cd.date);
                                targetStart.setHours(0,0,0,0);
                                const diffTime = targetStart - todayStart;
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                const dayText = diffDays > 0 ? `ã‚ã¨ <span class="text-2xl font-bold primary-text">${diffDays}</span> æ—¥` : diffDays === 0 ? `<span class="text-xl font-bold text-red-500">ä»Šæ—¥ã§ã™ï¼</span>` : `<span class="text-gray-500">çµ‚äº†</span>`;
                                
                                // â˜…å¤‰æ›´ç‚¹: å…¨ä½“ã‚’ button ã‚¿ã‚°ã«ã™ã‚‹ã‹ã€onclick ã‚’è¨­å®šã™ã‚‹
                                // ã“ã“ã§ã¯ div ã« countdown-card ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘ã€è¦ªè¦ç´ ã§ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»ã—ã¾ã™
                                return `
                                    <div class="countdown-card bg-white dark:bg-gray-700 rounded-lg shadow-sm p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors" data-id="${cd.id}">
                                        <div>
                                            <h3 class="font-bold text-gray-800 dark:text-gray-200 text-lg">${cd.name}</h3>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 tabular-nums mt-1">${cd.date.replace(/-/g, '/')}</p>
                                        </div>
                                        <div class="text-right">
                                            ${dayText}
                                        </div>
                                        </div>
                                `;
                            }).join('');

                            // â˜…é‡è¦: ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆæ¯å›å†è¨­å®šï¼‰
                            countdownContainer.querySelectorAll('.countdown-card').forEach(card => {
                                card.addEventListener('click', () => {
                                    openCountdownScreen(card.dataset.id);
                                });
                            });
                        }
                        // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---
                        
                        renderHomeTasks();
                    },
                    'study-page': () => {
                        const pinnedContainer = $('#pinned-quizzes');
                        const pinnedSectionContainer = pinnedContainer.parentElement;
                    
                        if (state.pinnedQuizzes.length > 0) {
                            pinnedSectionContainer.style.display = 'block';
                            const pinnedQuizzes = state.pinnedQuizzes.map(id => initialData.quizzes.find(q => q.id === id)).filter(Boolean);
                            pinnedContainer.innerHTML = pinnedQuizzes.map(q => createQuizCard(q, true)).join('');
                        } else {
                            pinnedSectionContainer.style.display = 'none';
                        }
                    
                        const allContainer = $('#all-quizzes');
                        const subjects = ['all', ...new Set(initialData.quizzes.map(q => q.subject))];
                        const activeFilter = $('#filter-container .active')?.dataset.filter || 'all';
                        $('#filter-container').innerHTML = subjects.map(s => `<button class="filter-btn ${s === activeFilter ? 'active primary-bg text-white' : 'bg-gray-200 dark:bg-gray-600'} px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap" data-filter="${s}">${s === 'all' ? 'ã™ã¹ã¦' : s}</button>`).join('');
                    
                        const quizzes = initialData.quizzes.filter(q => activeFilter === 'all' || q.subject === activeFilter);
                        allContainer.innerHTML = quizzes.map(q => createQuizCard(q, state.pinnedQuizzes.includes(q.id))).join('');
                    },
                    // å¤‰æ›´å¾Œ
                  'focus-page': () => {
                      updateFocusModeUI();
                      updateBackgrounds();
                        const activeBg = initialData.backgrounds[state.profile.activeBackground] || initialData.backgrounds['default'];
                        const hasImage = activeBg && activeBg.url;
                        const isGlobal = state.settings.backgroundScopeGlobal;
                        
                        $$('.focus-view-bg').forEach(el => {
                            // ã€Œå…¨ä½“é©ç”¨ã€ãŒã‚ªãƒ•ã§ã€ã‹ã¤ç”»åƒãŒã‚ã‚‹å ´åˆã®ã¿ã€é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã®è¦ç´ ã«ç›´æ¥èƒŒæ™¯ã‚’è¨­å®š
                            if (!isGlobal && hasImage) {
                                el.style.backgroundImage = `url(${activeBg.url})`;
                            } else {
                                // ã€Œå…¨ä½“é©ç”¨ã€ãŒã‚ªãƒ³ã®å ´åˆã¯ã€#app-containerã®èƒŒæ™¯ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«è‡ªèº«ã®èƒŒæ™¯ã‚’æ¶ˆã™
                                el.style.backgroundImage = 'none';
                            }
                        });
                    },
                    'my-chart-page': () => {
                        // --- 1. çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—ã¨è¡¨ç¤º ---
                        if (!state.sessionLog) state.sessionLog = [];
                        
                        // --- 1. çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—ã¨è¡¨ç¤º ---
                        if (!state.sessionLog) state.sessionLog = [];
                        
                        const now = new Date();
                        // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§ã€Œä»Šæ—¥ã€ã®æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆ
                        const y = now.getFullYear();
                        const mt = String(now.getMonth() + 1).padStart(2, '0');
                        const dt = String(now.getDate()).padStart(2, '0');
                        const todayStr = `${y}-${mt}-${dt}`;
                        
                        // ä»Šé€±ã®æœˆæ›œæ—¥ã‚’è¨ˆç®—
                        const dayOfWeek = now.getDay(); // 0(æ—¥) - 6(åœŸ)
                        const diffToMon = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); 
                        const monday = new Date(now.setDate(diffToMon));
                        monday.setHours(0,0,0,0);
                    
                        // é›†è¨ˆ
                        let todaySec = 0;
                        let weekSec = 0;
                        let totalSec = 0;
                    
                        state.sessionLog.forEach(log => {
                            totalSec += log.duration;
                            if (log.date === todayStr) {
                                todaySec += log.duration;
                            }
                            const logDate = new Date(log.date);
                            if (logDate >= monday) {
                                weekSec += log.duration;
                            }
                        });
                    
                        // ã€Œ59åˆ†ã¯0æ™‚é–“ã€ -> Math.floor(seconds / 3600)
                        $('#report-stat-today').innerHTML = `${Math.floor(todaySec / 3600)}<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span>`;
                        $('#report-stat-week').innerHTML = `${Math.floor(weekSec / 3600)}<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span>`;
                        $('#report-stat-total').innerHTML = `${Math.floor(totalSec / 3600)}<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span>`;
                    
                        // --- 2. é€±é–“ãƒ¬ãƒãƒ¼ãƒˆï¼ˆæ—¢å­˜ã®ã‚°ãƒ©ãƒ•ï¼‰ ---
                        // (ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¯ studyLog ã®ã¾ã¾ã§OKã€ã‚ã‚‹ã„ã¯ sessionLog ã‹ã‚‰å†é›†è¨ˆã—ã¦ã‚‚OK)
                        const activeTheme = initialData.themes[state.profile.activeTheme] || initialData.themes['default'];
                        const rgb = hexToRgb(activeTheme.color);
                        const chartBarColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.5)`;
                        const chartBorderColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)`;
                    
                        const labels = [];
                        const data = [];
                        for (let i = 6; i >= 0; i--) {
                            const d = new Date();
                            d.setDate(d.getDate() - i);
                            // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆ
                            const y = d.getFullYear();
                            const m = String(d.getMonth() + 1).padStart(2, '0');
                            const da = String(d.getDate()).padStart(2, '0');
                            const day = `${y}-${m}-${da}`;
                        
                            labels.push(`${d.getMonth()+1}/${d.getDate()}`);
                            
                            // sessionLogã‹ã‚‰è©²å½“æ—¥ã®åˆè¨ˆã‚’è¨ˆç®—
                            const dayTotal = state.sessionLog
                                .filter(l => l.date === day)
                                .reduce((acc, cur) => acc + cur.duration, 0);
                                
                            data.push(dayTotal / 60); // åˆ†å˜ä½
                        }
                        renderChart('study-time-chart', 'bar', { 
                            labels, 
                            datasets: [{ 
                                label: 'å­¦ç¿’æ™‚é–“', // (å˜ä½ã¯è»¸ã«å‡ºã‚‹ã®ã§ãƒ©ãƒ™ãƒ«ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«)
                                data, 
                                backgroundColor: chartBarColor, 
                                borderColor: chartBorderColor, 
                                borderWidth: 1 
                            }] 
                        }, { 
                            responsive: true,
                            maintainAspectRatio: false, // æ ã«åˆã‚ã›ã¦ãƒªã‚µã‚¤ã‚º
                            scales: { 
                                y: { 
                                    beginAtZero: true,
                                    ticks: {
                                        // â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šæœ€å°å˜ä½ã‚’1(åˆ†)ã«ã™ã‚‹ã€‚ã“ã‚Œã§0.xã®ã‚ˆã†ãªè¡¨ç¤ºã‚’é˜²ã
                                        stepSize: 1, 
                                        autoSkip: true,
                                        // â˜…ãƒ¡ãƒ¢ãƒªã®è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
                                        callback: function(value) {
                                            if (value === 0) return '0';
                                            // 60ã§å‰²ã‚Šåˆ‡ã‚Œã‚‹ï¼ˆ1æ™‚é–“, 2æ™‚é–“...ï¼‰å ´åˆã¯ã€Œæ™‚é–“ã€è¡¨ç¤º
                                            if (value >= 60 && value % 60 === 0) {
                                                return (value / 60) + 'æ™‚é–“';
                                            }
                                            // ãã‚Œä»¥å¤–ã¯ã€Œåˆ†ã€è¡¨ç¤º
                                            return value + 'åˆ†';
                                        }
                                    }
                                } 
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆã‚¿ãƒƒãƒ—ã—ãŸæ™‚ï¼‰ã®è¡¨ç¤ºã‚‚ã€Œâ—¯æ™‚é–“â—¯åˆ†ã€å½¢å¼ã«ã™ã‚‹
                                        label: function(context) {
                                            const val = context.raw; // åˆ†
                                            const h = Math.floor(val / 60);
                                            const m = Math.round(val % 60); // å¿µã®ãŸã‚å››æ¨äº”å…¥
                                            if (h > 0) return ` ${h}æ™‚é–“ ${m}åˆ†`;
                                            return ` ${m}åˆ†`;
                                        }
                                    }
                                }
                            }
                        });
                    
                        // --- 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨è©³ç´°ãƒªã‚¹ãƒˆã®æç”» ---
                        renderCalendar();
                        renderDailyDetails(selectedReportDate);
                        
                        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šï¼ˆé‡è¤‡ç™»éŒ²é˜²æ­¢ã®ãŸã‚æ¯å›ã‚¯ãƒªã‚¢ã™ã‚‹ã‹ã€onclickã‚’ä½¿ã†ï¼‰
                        $('#cal-prev-btn').onclick = () => {
                            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                            renderCalendar();
                        };
                        $('#cal-next-btn').onclick = () => {
                            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                            renderCalendar();
                        };
                    },
                    
                    'settings-page': () => {
                        const settingsPage = $('#settings-page');
                        settingsPage.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢
                    
                        // --- 1. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ (ä¸€ç•ªä¸Šã«è¡¨ç¤º) ---
                        const profileCard = document.createElement('div');
                        profileCard.className = 'bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-6 flex items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition';
                        profileCard.innerHTML = `
                            <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-3xl mr-4 border-2" style="border-color: var(--primary-color);">
                                ${state.user.icon}
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-bold text-lg">${state.user.name}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${state.user.grade || 'å­¦å¹´æœªè¨­å®š'}</p>
                            </div>
                            <i data-lucide="chevron-right" class="text-gray-400"></i>
                        `;
                        profileCard.addEventListener('click', () => { profilePage.open(); });
                        settingsPage.appendChild(profileCard);
                    
                        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
                        const createSectionTitle = (text) => {
                            const h3 = document.createElement('h3');
                            h3.className = 'text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 ml-1 mt-6';
                            h3.textContent = text;
                            return h3;
                        };

                        const createListContainer = () => {
                            const div = document.createElement('div');
                            div.className = 'bg-white dark:bg-gray-700 rounded-lg shadow overflow-hidden';
                            return div;
                        };

                        const createListItem = (icon, title, colorClass, onClick) => {
                            const item = document.createElement('div');
                            item.className = 'flex items-center p-4 border-b border-gray-100 dark:border-gray-600 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition last:border-0';
                            item.innerHTML = `
                                <div class="p-2 rounded-lg ${colorClass} mr-4">
                                    <i data-lucide="${icon}" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="flex-grow font-medium">${title}</span>
                                <i data-lucide="chevron-right" class="text-gray-400 w-5 h-5"></i>
                            `;
                            item.addEventListener('click', onClick);
                            return item;
                        };
                    
                        // --- 2. ã€Œå…¨èˆ¬ã€ã‚°ãƒ«ãƒ¼ãƒ— ---
                        settingsPage.appendChild(createSectionTitle('å…¨èˆ¬'));
                        const generalList = createListContainer();
                    
                        // é€šçŸ¥è¨­å®š (æœªè¨±å¯ã®å ´åˆã®ã¿è¡¨ç¤º)
                        if (!('Notification' in window) || Notification.permission !== 'granted') {
                            generalList.appendChild(createListItem('bell', 'é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹', 'bg-yellow-500', async () => {
                                 if (!('Notification' in window)) { showToast('éå¯¾å¿œã§ã™'); return; }
                                 const permission = await Notification.requestPermission();
                                 if (permission === 'granted') { 
                                     showToast('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼'); 
                                     renderEngine.pages['settings-page'](); 
                                 }
                            }));
                        }

                        // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼è¨­å®š
                        generalList.appendChild(createListItem('palette', 'ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼', 'bg-blue-500', () => {
                            themeSettingsPage.open();
                        }));
                    
                        // å£ç´™è¨­å®š
                        generalList.appendChild(createListItem('image', 'å£ç´™è¨­å®š', 'bg-purple-500', () => {
                            backgroundSettingsPage.open();
                        }));

                        settingsPage.appendChild(generalList);

                        // --- 3. ã€Œã‚¯ã‚¨ã‚¹ãƒˆã€ã‚°ãƒ«ãƒ¼ãƒ— ---
                        settingsPage.appendChild(createSectionTitle('ã‚¯ã‚¨ã‚¹ãƒˆ'));
                        const questList = createListContainer();
                    
                        // BGMè¨­å®š
                        questList.appendChild(createListItem('music', 'BGMè¨­å®š', 'bg-pink-500', () => {
                            bgmSettingsPage.open();
                        }));

                        // â˜…è¿½åŠ : ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ è¨­å®š
                        questList.appendChild(createListItem('coffee', 'ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ è¨­å®š', 'bg-orange-500', () => {
                            breakSettingsPage.open();
                        }));
                        
                        settingsPage.appendChild(questList);

                        // --- ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ ---
                        lucide.createIcons();
                    },
                },
                renderAll: () => {
                    for(const pageId in renderEngine.pages){
                        if($(`#${pageId}`).classList.contains('active')){
                            renderEngine.pages[pageId]();
                        }
                    }
                    updateLpDisplay();
                    const activeTheme = initialData.themes[state.profile.activeTheme] || initialData.themes['default'];
                    document.documentElement.style.setProperty('--primary-color', activeTheme.color);
                    document.documentElement.style.setProperty('--primary-color-hover', activeTheme.hover);
                }
            };

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»é–¢æ•°
            const renderCalendar = () => {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                
                $('#cal-month-title').textContent = `${year}å¹´ ${month + 1}æœˆ`;
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay(); // 0:Sun
                
                const grid = $('#calendar-grid');
                grid.innerHTML = '';
                
                // ç©ºç™½ã‚»ãƒ«
                for(let i=0; i<startDayOfWeek; i++) {
                    grid.innerHTML += `<div></div>`;
                }
                
                // æ—¥ä»˜ã‚»ãƒ«
                for(let d=1; d<=daysInMonth; d++) {
                    // â˜…ä¿®æ­£: toISOStringã‚’ä½¿ã‚ãšã€æ‰‹å‹•ã§ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜æ–‡å­—åˆ—(YYYY-MM-DD)ã‚’ä½œã‚‹
                    const cellMonth = String(month + 1).padStart(2, '0');
                    const cellDay = String(d).padStart(2, '0');
                    const dateStr = `${year}-${cellMonth}-${cellDay}`;
                    
                    // ãƒ­ã‚°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const hasLog = state.sessionLog.some(l => l.date === dateStr);
                    
                    // â˜…ä¿®æ­£: é¸æŠä¸­ã®æ—¥ä»˜æ¯”è¼ƒã‚‚ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§è¡Œã†
                    const selY = selectedReportDate.getFullYear();
                    const selM = String(selectedReportDate.getMonth() + 1).padStart(2, '0');
                    const selD = String(selectedReportDate.getDate()).padStart(2, '0');
                    const selectedDateStr = `${selY}-${selM}-${selD}`;
                    const isSelected = selectedDateStr === dateStr;
    
                    // â˜…ä¿®æ­£: ä»Šæ—¥ã®æ—¥ä»˜æ¯”è¼ƒã‚‚ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§è¡Œã†
                    const now = new Date();
                    const nowY = now.getFullYear();
                    const nowM = String(now.getMonth() + 1).padStart(2, '0');
                    const nowD = String(now.getDate()).padStart(2, '0');
                    const todayStr = `${nowY}-${nowM}-${nowD}`;
                    const isToday = todayStr === dateStr;
    
                    let cellClass = "h-8 w-8 mx-auto flex flex-col items-center justify-center rounded-full cursor-pointer transition text-sm relative ";
                    let styleStr = ""; // â˜…è¿½åŠ : å‹•çš„ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
                    
                    if (isSelected) {
                        cellClass += "primary-bg text-white font-bold shadow-md";
                    } else if (isToday) {
                        cellClass += "border-2 font-bold";
                        styleStr = "border-color: var(--primary-color); color: var(--primary-color);";
                    } else {
                        cellClass += "hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300";
                    }
    
                    // ãƒãƒ¼ã‚«ãƒ¼ï¼ˆãƒ­ã‚°ãŒã‚ã‚‹æ—¥ï¼‰
                    const marker = hasLog && !isSelected ? `<span class="absolute bottom-1 w-1 h-1 rounded-full" style="background-color: var(--primary-color);"></span>` : '';
    
                    const cell = document.createElement('div');
                    cell.className = "text-center";
                    cell.innerHTML = `<div class="${cellClass}" style="${styleStr}">${d}${marker}</div>`;
                    
                    cell.addEventListener('click', () => {
                        selectedReportDate = new Date(year, month, d);
                        renderCalendar(); // é¸æŠçŠ¶æ…‹æ›´æ–°ã®ãŸã‚å†æç”»
                        renderDailyDetails(selectedReportDate);
                    });
                    
                    grid.appendChild(cell);
                }
            };
    
            // æŒ‡å®šã—ãŸæ—¥ã®è©³ç´°ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
            const renderDailyDetails = (targetDate) => {
                // â˜…ä¿®æ­£: ã“ã“ã‚‚toISOStringã‚’ä½¿ã‚ãšã€ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ¤œç´¢ã‚­ãƒ¼ã‚’ä½œã‚‹
                const y = targetDate.getFullYear();
                const m = String(targetDate.getMonth() + 1).padStart(2, '0');
                const d = String(targetDate.getDate()).padStart(2, '0');
                const dateStr = `${y}-${m}-${d}`;
    
                const displayDate = `${targetDate.getMonth()+1}æœˆ${targetDate.getDate()}æ—¥`;
                
                $('#detail-date-title').textContent = `${displayDate} ã®è©³ç´°`;
                
                const sessions = state.sessionLog.filter(l => l.date === dateStr);
                const listContainer = $('#study-session-list');
                
                if (sessions.length === 0) {
                    listContainer.innerHTML = `<div class="flex flex-col items-center justify-center py-8 text-gray-400"><i data-lucide="book-off" class="w-8 h-8 mb-2"></i><p class="text-xs">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
                } else {
                    // çµ‚äº†æ™‚åˆ»ã®é™é †ãªã©ã§è¡¨ç¤ºã™ã‚‹ã¨è¦‹ã‚„ã™ã„ï¼ˆã“ã“ã§ã¯è¨˜éŒ²é †ï¼‰
                    listContainer.innerHTML = sessions.map(s => {
                        // ç§’ã‚’åˆ†ã«å¤‰æ›
                        const min = Math.floor(s.duration / 60);
                        const sec = s.duration % 60;
                        const durationText = min > 0 ? `${min}åˆ†` : `${sec}ç§’`;
                        
                        return `
                            <div class="flex items-center justify-between bg-white dark:bg-gray-700 p-3 rounded-lg shadow-sm border-l-4" style="border-left-color: var(--primary-color);">
                                <div class="flex-grow min-w-0 mr-4">
                                    <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200 truncate">${s.title}</h4>
                                </div>
                                <div class="text-right flex-shrink-0">
                                    <p class="text-lg tabular-nums font-bold primary-text leading-none">${durationText}</p>
                                    <p class="text-xs text-gray-400 mt-1">${s.endTime || '--:--'}</p>
                                </div>
                            </div>
                        `;
                    }).reverse().join(''); // æ–°ã—ã„é †ã«è¡¨ç¤º
                }
                lucide.createIcons();
            };
            
           const createQuizCard = (quiz, isPinned) => {
                if(!quiz) return '';
                const progress = state.progress[quiz.id];
                
                // ã‚¢ã‚¤ã‚³ãƒ³ã®å½¢å®šç¾©
                const levelIcons = { 1: 'book-open-check', 2: 'thumbs-up', 3: 'award'};
                
                // â˜…è‰²å®šç¾©ã‚’è¿½åŠ  (ãƒ¢ãƒ¼ãƒ€ãƒ«ã«åˆã‚ã›ãŸè‰²ç³»çµ±)
                // è¦–èªæ€§ã‚’è‰¯ãã™ã‚‹ãŸã‚ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã®400ç•ªã‚ˆã‚Šå°‘ã—æ¿ƒã„500ç•ªã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™
                const levelColors = { 1: 'text-blue-500', 2: 'text-green-500', 3: 'text-yellow-500'};

                // é€²æ—ãŒã‚ã‚‹å ´åˆã®è‰²ã‚’å–å¾—
                const color = progress ? levelColors[progress.level] : '';

                return `<div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm p-3 flex items-center justify-between quiz-card" data-id="${quiz.id}">
                            <div class="flex items-center min-w-0">
                                <div class="w-5 h-5 mr-3 flex-shrink-0">
                                    ${progress ? `<i data-lucide="${levelIcons[progress.level]}" class="${color}"></i>` : ``}
                                </div>
                                <div class="truncate">
                                    <h3 class="font-semibold text-gray-800 dark:text-gray-200 truncate">${quiz.title}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${quiz.subject} - ${quiz.genre}</p>
                                </div>
                            </div>
                            <button class="pin-btn p-2 -mr-2 flex-shrink-0" data-id="${quiz.id}">
                                <i data-lucide="pin" class="w-5 h-5 ${isPinned ? 'primary-text fill-current' : 'text-gray-400'}"></i>
                            </button>
                        </div>`;
            };
            
            const renderChart = (canvasId, type, data, options) => {
                const ctx = $(`#${canvasId}`).getContext('2d');
                if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
                chartInstances[canvasId] = new Chart(ctx, { type, data, options });
            };

            const showToast = (message) => {
                const toast = $('#toast'); toast.textContent = message; toast.classList.remove('opacity-0', '-translate-y-10');
                setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 2000);
            };

            const addLP = (amount, reason, show = true) => {
                state.profile.lp += amount;
                updateLpDisplay();
                saveState();

                // ä¿®æ­£ç‚¹: amount ãŒ 1ä»¥ä¸Š ã‹ã¤ show ãŒ true ã®æ™‚ã ã‘ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å‡ºã™
                if(show && amount > 0) {
                    showLpPopup(amount, reason);
                }
            };

            // â–¼â–¼â–¼ è¿½åŠ ãƒ»ä¿®æ­£: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ (åˆè¨ˆè¡¨ç¤ºå‰Šé™¤å¯¾å¿œ) â–¼â–¼â–¼
            const lpPopupModal = document.getElementById('lp-popup-modal');
            const lpPopupContent = document.getElementById('lp-popup-content');
            const lpPopupAmount = document.getElementById('lp-popup-amount');
            const lpPopupReason = document.getElementById('lp-popup-reason');
            // const lpPopupTotal ... â†å‰Šé™¤ã—ã¾ã—ãŸ
            const lpPopupCloseBtn = document.getElementById('lp-popup-close-btn');
            
            let popupAutoCloseTimer = null;

            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹é–¢æ•°
            const closeLpPopup = () => {
                if (popupAutoCloseTimer) {
                    clearTimeout(popupAutoCloseTimer);
                    popupAutoCloseTimer = null;
                }

                lpPopupModal.style.opacity = '0';
                lpPopupContent.classList.remove('animate-pop-elastic');
                lpPopupContent.classList.add('scale-0');

                setTimeout(() => {
                    lpPopupModal.classList.add('hidden');
                }, 300);
            };

            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° (LPç”¨)
            const showLpPopup = (amount, reason) => {
                // UIã‚’LPãƒ¢ãƒ¼ãƒ‰ã«ãƒªã‚»ãƒƒãƒˆ
                $('#popup-title').textContent = 'GET!';
                $('#popup-coin-img').classList.remove('hidden');
                $('#popup-lp-container').classList.remove('hidden');
                $('#popup-item-icon').classList.add('hidden');
                $('#popup-item-name').classList.add('hidden');

                $('#lp-popup-reason').textContent = reason;
                
                $('#lp-popup-modal').classList.remove('hidden');
                requestAnimationFrame(() => {
                    $('#lp-popup-modal').style.opacity = '1';
                    $('#lp-popup-content').classList.remove('scale-0');
                    $('#lp-popup-content').classList.add('animate-pop-elastic');
                });

                animateValue($('#lp-popup-amount'), 0, amount, 1000);
                
                lucide.createIcons();

                if (popupAutoCloseTimer) clearTimeout(popupAutoCloseTimer);
                popupAutoCloseTimer = setTimeout(() => {
                    closeLpPopup();
                }, 10000);
            };

            // â–¼â–¼â–¼ è¿½åŠ : ã‚¢ã‚¤ãƒ†ãƒ ç²å¾—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° â–¼â–¼â–¼
            const showItemPopup = (item, type) => {
                // UIã‚’ã‚¢ã‚¤ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
                $('#popup-title').textContent = 'UNLOCK!';
                $('#popup-coin-img').classList.add('hidden');
                $('#popup-lp-container').classList.add('hidden');
                
                $('#popup-item-icon').classList.remove('hidden');
                $('#popup-item-name').classList.remove('hidden');

                // ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
                const categoryName = (type === 'theme' ? 'ãƒ†ãƒ¼ãƒ' : type === 'background' ? 'å£ç´™' : type === 'game' ? 'ã‚²ãƒ¼ãƒ ' : 'BGM');
                $('#lp-popup-reason').textContent = `${categoryName}ã‚’äº¤æ›ã—ã¾ã—ãŸ`;
                $('#popup-item-name').textContent = item.name;

                // ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ
                const iconContainer = $('#popup-item-icon');
                iconContainer.innerHTML = ''; // ã‚¯ãƒªã‚¢

                if (type === 'theme') {
                    iconContainer.innerHTML = `<div class="w-full h-full rounded-full shadow-lg border-4 border-white dark:border-gray-700" style="background-color: ${item.color}"></div>`;
                } else if (type === 'background') {
                    const style = item.url ? `background-image: url(${item.url})` : 'background-color: #6b7280;';
                    iconContainer.innerHTML = `<div class="w-full h-full rounded-xl shadow-lg border-2 border-white dark:border-gray-700 bg-cover bg-center" style="${style}"></div>`;
                } else {
                    // ã‚²ãƒ¼ãƒ ãƒ»éŸ³æ¥½
                    const iconName = item.icon || (type === 'music' ? 'music' : 'gamepad-2');
                    const colorClass = type === 'game' ? 'text-indigo-500' : 'text-pink-500';
                    iconContainer.innerHTML = `<div class="bg-white dark:bg-gray-700 p-4 rounded-2xl shadow-lg"><i data-lucide="${iconName}" class="w-16 h-16 ${colorClass}"></i></div>`;
                }

                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º (å…±é€šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³)
                $('#lp-popup-modal').classList.remove('hidden');
                requestAnimationFrame(() => {
                    $('#lp-popup-modal').style.opacity = '1';
                    $('#lp-popup-content').classList.remove('scale-0');
                    $('#lp-popup-content').classList.add('animate-pop-elastic');
                });
                
                lucide.createIcons(); // ã‚¢ã‚¤ã‚³ãƒ³å†ç”Ÿæˆ

                if (popupAutoCloseTimer) clearTimeout(popupAutoCloseTimer);
                popupAutoCloseTimer = setTimeout(closeLpPopup, 10000);
            };

            // æ•°å­—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¤‰æ›´ãªã—ï¼‰
            const animateValue = (obj, start, end, duration) => {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    obj.innerHTML = Math.floor(progress * (end - start) + start);
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            };

            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
            lpPopupCloseBtn.addEventListener('click', () => {
                // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                lpPopupModal.style.opacity = '0';
                lpPopupContent.classList.remove('animate-pop-elastic');
                lpPopupContent.classList.add('scale-0'); // æ¬¡å›ã®ãŸã‚ã«ç¸®ã‚ã¦ãŠã

                setTimeout(() => {
                    lpPopupModal.classList.add('hidden');
                }, 300); // transitionã®æ™‚é–“ã¨åˆã‚ã›ã‚‹
            });
            
            const formatTime = (s) => {
                const totalSeconds = Math.floor(s);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                if (hours > 0) return `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            };

            // â–¼â–¼â–¼ ã€è¿½åŠ ã€‘BGMåˆ¶å¾¡é–¢æ•°ç¾¤ â–¼â–¼â–¼
            const playBGM = () => {
                if (!state.settings.bgmEnabled || state.settings.playlist.length === 0) return;
                
                // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒç©ºã§ãªã‘ã‚Œã°å†ç”Ÿ
                if (bgmAudio.paused) {
                    const trackId = state.settings.playlist[currentTrackIndex];
                    const track = initialData.music[trackId];
                    if (track) {
                        // ã‚½ãƒ¼ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°è¨­å®š
                        if (!bgmAudio.src || !bgmAudio.src.includes(track.url)) {
                            bgmAudio.src = track.url;
                        }
                        bgmAudio.play().catch(e => console.log('å†ç”Ÿã‚¨ãƒ©ãƒ¼(ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ã‹ã‚‚):', e));
                    }
                }
            };

            const pauseBGM = () => {
                bgmAudio.pause();
            };

            const stopBGM = () => {
                bgmAudio.pause();
                bgmAudio.currentTime = 0;
            };

            // æ›²ãŒçµ‚ã‚ã£ãŸã‚‰æ¬¡ã®æ›²ã¸
            bgmAudio.addEventListener('ended', () => {
                currentTrackIndex++;
                if (currentTrackIndex >= state.settings.playlist.length) {
                    currentTrackIndex = 0; // æœ€åˆã«æˆ»ã‚‹
                }
                const nextTrackId = state.settings.playlist[currentTrackIndex];
                const nextTrack = initialData.music[nextTrackId];
                if (nextTrack) {
                    bgmAudio.src = nextTrack.url;
                    bgmAudio.play();
                }
            });

            // ã€è¿½åŠ ã€‘ã‚¿ã‚¤ãƒãƒ¼ã«æ™‚é–“ã‚’åŠ ç®—ã™ã‚‹é–¢æ•°
            const addTimerTime = (seconds) => {
                if (focusTimer.isRunning) return; // å®Ÿè¡Œä¸­ã¯æ™‚é–“ã‚’å¤‰æ›´ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
                focusTimer.timeLeft += seconds;
                $('#focus-timer-display').textContent = formatTime(focusTimer.timeLeft);
            };
            
            // ã€è¿½åŠ ã€‘ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
            const resetTimerDisplay = () => {
                if (focusTimer.isRunning) return;
                focusTimer.timeLeft = 0;
                $('#focus-timer-display').textContent = formatTime(0);
            };
            
            const formatStopwatchTime = (s) => {
                const totalSeconds = s;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                // const ms = ... ã®è¡Œã‚’å‰Šé™¤
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`; // è¿”ã‚Šå€¤ã‹ã‚‰msã‚’å‰Šé™¤
            };

            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };

            const logStudyTime = (type, seconds) => {
                // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆ
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                const today = `${y}-${m}-${d}`;
            
                if (!state.studyLog[today]) state.studyLog[today] = { focus: 0, quiz: 0 };
                state.studyLog[today][type] += seconds;
            };
            // è©³ç´°ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹é–¢æ•°
            const recordSession = (title, durationSeconds) => {
            const now = new Date();
            
            // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆ
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const dateStr = `${y}-${m}-${d}`;
        
            // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (HH:MM)
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const endTimeStr = `${hours}:${minutes}`;
        
            const newSession = {
                id: Date.now(),
                date: dateStr,
                title: title,
                duration: durationSeconds,
                endTime: endTimeStr
            };
        
            // stateã«è¿½åŠ 
            if (!state.sessionLog) state.sessionLog = [];
            state.sessionLog.push(newSession);
            
            // æ—¢å­˜ã®é›†è¨ˆç”¨ãƒ­ã‚°ã‚‚æ›´æ–°ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
            logStudyTime('focus', durationSeconds); 
            saveState();
        };

            const renderHomeTasks = () => {
                if (!homeTaskListEl) return;

                if (!state.tasks || state.tasks.length === 0) {
                    homeTaskListEl.innerHTML = `<p class="text-center text-sm text-gray-500">ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                } else {
                    homeTaskListEl.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢
                    
                    state.tasks.forEach((task, index) => {
                        const isCompleted = task.completed || false;
                        const textStyle = isCompleted ? 'line-through text-gray-400 dark:text-gray-500' : '';
                        
                        // â˜…ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨æ§‹é€ 
                        const taskEl = document.createElement('div');
                        // ä¸¦ã³æ›¿ãˆæ™‚ã®IDè­˜åˆ¥ç”¨ã« data-id ã‚’è¿½åŠ 
                        taskEl.setAttribute('data-id', task.id); 
                        taskEl.className = `task-item swipe-container relative overflow-hidden rounded-lg mb-2`; 
                        
                        taskEl.innerHTML = `
                            <div class="swipe-actions">
                                <button class="btn-complete swipe-btn bg-gray-400 w-[70px]">
                                    <i data-lucide="check" class="w-6 h-6"></i>
                                    <span>å®Œäº†</span>
                                </button>
                                <button class="btn-delete swipe-btn bg-red-500 w-[70px]">
                                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                                    <span>å‰Šé™¤</span>
                                </button>
                            </div>

                            <div class="swipe-content flex items-center p-2 bg-white dark:bg-gray-800 shadow-sm relative z-10 ${isCompleted ? 'bg-gray-100 dark:bg-gray-900' : ''}">
                                <span class="font-bold w-6 text-center text-gray-600 dark:text-gray-400 shrink-0">${index + 1}</span>
                                
                                <input type="text" value="${task.text}" class="task-text-input flex-grow min-w-0 bg-transparent p-1 focus:outline-none rounded ${textStyle}" ${isCompleted ? 'disabled' : ''}>
                                
                                <button type="button" class="task-handle cursor-grab active:cursor-grabbing text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-opacity p-2 shrink-0 ${isCompleted ? 'invisible' : ''}">
                                    <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                                </button>
                            </div>
                        `;
                        
                        homeTaskListEl.appendChild(taskEl);
                        
                        // â˜…ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ã®é©ç”¨
                        new SwipeHandler(taskEl, {
                            onComplete: () => {
                                const taskToUpdate = state.tasks.find(t => t.id === task.id);
                                if (taskToUpdate) {
                                    taskToUpdate.completed = !taskToUpdate.completed; // ãƒˆã‚°ãƒ«
                                    saveState();
                                    renderHomeTasks(); // å†æç”»
                                }
                            },
                            onDelete: () => {
                                state.tasks = state.tasks.filter(t => t.id !== task.id);
                                saveState();
                                setTimeout(renderHomeTasks, 100); 
                                showToast('ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                            }
                        });
                        
                        // ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
                        taskEl.querySelector('.task-text-input').addEventListener('change', (e) => {
                            const taskToUpdate = state.tasks.find(t => t.id === task.id);
                            if (taskToUpdate) {
                                taskToUpdate.text = e.target.value;
                                saveState();
                            }
                        });
                    });
                }
                
                if(newTaskNumberEl) newTaskNumberEl.textContent = state.tasks.length + 1;

                // â˜…é‡è¦: ç”Ÿæˆã—ãŸãƒªã‚¹ãƒˆã®ä¸­ã«å¯¾ã—ã¦ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆã‚’å®Ÿè¡Œ
                lucide.createIcons({
                    root: homeTaskListEl,
                    nameAttr: 'data-lucide',
                    attrs: {
                        class: "w-5 h-5" // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µã‚¤ã‚ºæŒ‡å®š
                    }
                });
            };

            document.body.addEventListener('click', e => {
                const quizCard = e.target.closest('.quiz-card');
                if (quizCard && !e.target.closest('.pin-btn')) {
                    const quiz = initialData.quizzes.find(q => q.id === quizCard.dataset.id);
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
                    currentQuizId = quiz.id;
                    $('#quiz-screen-title').textContent = quiz.title;
                    
                    // ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’è¡¨ç¤ºã—ã¦iframeã‚’éš ã™
                    $('#quiz-loader').style.display = 'flex';
                    
                    // â˜…ãƒšãƒ¼ã‚¸ã‚’é–‹ã
                    quizPage.open();
                    
                    // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
                    quizTimer.startTime = Date.now();
                    
                    // URLèª­ã¿è¾¼ã¿ (å°‘ã—é…å»¶ã•ã›ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«)
                    const container = $('#quiz-container');
                    const loader = $('#quiz-loader');
                    loader.style.display = 'flex'; // ãƒ­ãƒ¼ãƒ€ãƒ¼è¡¨ç¤º

                    const iframe = document.createElement('iframe');
                    iframe.id = 'quiz-screen-iframe';
                    iframe.className = 'w-full h-full border-0 invisible'; // æœ€åˆã¯éš ã™
                    iframe.sandbox = 'allow-scripts allow-forms allow-popups';
                    iframe.src = quiz.url;

                    iframe.onload = () => {
                        loader.style.display = 'none';
                        iframe.classList.remove('invisible');
                    };

                    container.appendChild(iframe);
                }
                const pinBtn = e.target.closest('.pin-btn');
                if(pinBtn) {
                    const quizId = pinBtn.dataset.id;
                    state.pinnedQuizzes.includes(quizId) ? state.pinnedQuizzes = state.pinnedQuizzes.filter(id => id !== quizId) : state.pinnedQuizzes.push(quizId);
                    saveState(); renderEngine.pages['study-page'](); lucide.createIcons();
                }
                
                const filterBtn = e.target.closest('.filter-btn');
                if(filterBtn) {
                     $$('#filter-container .filter-btn').forEach(b => {
                         b.classList.remove('active', 'primary-bg', 'text-white');
                         b.classList.add('bg-gray-200', 'dark:bg-gray-600');
                     });
                     filterBtn.classList.add('active', 'primary-bg', 'text-white');
                     filterBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                     renderEngine.pages['study-page']();
                     lucide.createIcons();
                }

                const closeModalBtn = e.target.closest('.close-modal-btn');
                if (closeModalBtn) {
                    const modal = $(`#${closeModalBtn.dataset.modal}`);
                    modal.style.display = 'none';
                    if (closeModalBtn.dataset.modal === 'quiz-modal') {
                        $('#assessment-modal').dataset.quizId = modal.dataset.currentQuiz;
                        $('#assessment-modal').style.display = 'flex';
                        if(quizTimer.startTime) {
                            const elapsed = Math.round((Date.now() - quizTimer.startTime) / 1000);
                            const title = $('#quiz-modal-title').textContent || 'ã‚¯ã‚¤ã‚º';
                            recordSession(title, elapsed);
                            quizTimer.startTime = null;
                            saveState();
                        }
                    }
                }
                
                const assessmentBtn = e.target.closest('.assessment-btn');
                if(assessmentBtn) {
                    const level = parseInt(assessmentBtn.dataset.level);
                    const quizId = $('#assessment-modal').dataset.quizId;
                    
                    // 1. é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    state.progress[quizId] = { level, date: new Date().toISOString() };
                    addLP(level * 5, 'ã‚¯ã‚¤ã‚ºè©•ä¾¡');
                    saveState();
                    
                    // 2. â˜…é‡è¦â˜… ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšãƒ¼ã‚¸ã‚’å¼·åˆ¶çš„ã«å†æç”»ã™ã‚‹
                    // renderEngine.renderAll() ã¯ 'active' ã‚¯ãƒ©ã‚¹ãŒã¤ã„ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã ã‘ã‚’æç”»ã™ã‚‹ãŸã‚ã€ã“ã‚Œã§OKã§ã™
                    renderEngine.renderAll();
                    
                    // 3. ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆLucideï¼‰ã‚’å†ç”Ÿæˆã™ã‚‹
                    // HTMLãŒæ›¸ãæ›ã‚ã£ãŸç›´å¾Œã¯ã‚¢ã‚¤ã‚³ãƒ³ãŒ <i> ã‚¿ã‚°ã®ã¾ã¾ãªã®ã§ã€ã“ã‚Œã‚’ <svg> ã«å¤‰æ›ã—ã¾ã™
                    lucide.createIcons();

                    // 4. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    closeModalWithAnim('assessment-modal', 'assessment-content');
                }

                const themeBtn = e.target.closest('.theme-btn');
                if(themeBtn){
                    const themeId = themeBtn.dataset.theme;
                    if(state.profile.unlockedThemes.includes(themeId)) {
                        state.profile.activeTheme = themeId;
                        saveState();
                        renderEngine.renderAll();
                    } else {
                        const theme = initialData.themes[themeId];
                        const confirmBtn = $('#theme-purchase-confirm');
                        
                        $('#theme-purchase-title').textContent = `ã€Œ${theme.name}ã€ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`;
                        $('#theme-purchase-cost').textContent = `å¿…è¦ãªãƒã‚¤ãƒ³ãƒˆ: ${theme.cost} LP`;
                        
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                        $('#theme-preview').style.backgroundColor = theme.color;
                
                        // ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (state.profile.lp >= theme.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = themeId;
                        confirmBtn.dataset.itemType = 'theme';
                        $('#theme-purchase-modal').style.display = 'flex';
                    }
                }

                const backgroundBtn = e.target.closest('.background-btn');
                if(backgroundBtn){
                    const bgId = backgroundBtn.dataset.bg;
                    if(state.profile.unlockedBackgrounds.includes(bgId)) {
                        state.profile.activeBackground = bgId;
                        saveState();
                        updateAppearance();
                        renderEngine.pages['settings-page']();
                        lucide.createIcons();
                    } else {
                        const bg = initialData.backgrounds[bgId];
                        const confirmBtn = $('#background-purchase-confirm');
                
                        $('#background-purchase-title').textContent = `ã€Œ${bg.name}ã€ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`;
                        $('#background-purchase-cost').textContent = `å¿…è¦ãªãƒã‚¤ãƒ³ãƒˆ: ${bg.cost} LP`;
                
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                        const previewEl = $('#background-preview');
                        if (bg.url) {
                            previewEl.style.backgroundImage = `url(${bg.url})`;
                            previewEl.classList.remove('hidden');
                        } else {
                            previewEl.classList.add('hidden'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãªã©ç”»åƒãŒãªã„å ´åˆã¯éè¡¨ç¤º
                        }
                        
                        // ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (state.profile.lp >= bg.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = bgId;
                        confirmBtn.dataset.itemType = 'background';
                        $('#background-purchase-modal').style.display = 'flex';
                    }
                }

                const editCountdownBtn = e.target.closest('.edit-countdown-btn');
                if(editCountdownBtn){
                    const id = editCountdownBtn.dataset.id;
                    openCountdownModal(id);
                }

                // â–¼â–¼â–¼ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚¤ãƒãƒ¼/SWï¼‰ã®ãƒªã‚¹ãƒŠãƒ¼ä¿®æ­£ â–¼â–¼â–¼
Â  Â  Â  Â  Â  Â  Â  Â  const focusModeBtn = e.target.closest('.focus-mode-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if(focusModeBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mode = focusModeBtn.dataset.mode;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.focus.mode = mode; // 'timer' ã‹ 'stopwatch' ãŒå…¥ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateFocusModeUI(); // UIã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

Â  Â  Â  Â  Â  Â  Â  Â  // 1. ã‚¯ã‚¨ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ– (SubPageã‚¯ãƒ©ã‚¹å®šç¾©ã®å¾Œã«è¿½åŠ )
                const questPage = new SubPage('quest-view', {
                    onOpen: () => {
                        // é–‹ã„ãŸã¨ãã«å®Ÿè¡Œã™ã‚‹å‡¦ç†
                        renderQuestPlan();
                        lucide.createIcons();
                    }
                });
                
                // 2. ã€Œã‚¯ã‚¨ã‚¹ãƒˆã€ãƒœã‚¿ãƒ³ï¼ˆFocusãƒšãƒ¼ã‚¸å†…ï¼‰ã®å‡¦ç†ã‚’å¤‰æ›´
                // ï¼ˆæ—¢å­˜ã® showQuestBtn é–¢é€£ã®ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã¾ãŸã¯ä»¥ä¸‹ã«æ›¸ãæ›ãˆï¼‰
                const showQuestBtn = document.getElementById('show-quest-btn'); // å¤‰æ•°å®šç¾©ã‚’ç¢ºèª
                if (showQuestBtn) {
                    showQuestBtn.addEventListener('click', () => {
                        // focus-main-view ã‚’éš ã™å¿…è¦ã¯ãªããªã‚Šã¾ã—ãŸï¼ˆSubPageãŒä¸Šã«é‡ãªã‚‹ãŸã‚ï¼‰
                        questPage.open(); 
                    });
                }
                
                // 3. ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†ã‚’å¤‰æ›´
                // ï¼ˆæ—¢å­˜ã® questBackBtn é–¢é€£ã®ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã¾ãŸã¯ä»¥ä¸‹ã«æ›¸ãæ›ãˆï¼‰
                const questBackBtn = document.getElementById('quest-back-btn');
                if (questBackBtn) {
                    questBackBtn.addEventListener('click', () => {
                        questPage.close();
                        // æˆ»ã‚‹ã¨ãã«Focusç”»é¢ã®UIæ›´æ–°ãŒå¿…è¦ãªã‚‰ã“ã“ã§è¡Œã†
                        updateFocusModeUI(); 
                    });
                }

                // æ™‚é–“åŠ ç®—ãƒœã‚¿ãƒ³ã®å‡¦ç†
                const timeAddBtn = e.target.closest('.time-add-btn');
                if(timeAddBtn) {
                    const time = parseInt(timeAddBtn.dataset.time);
                    addTimerTime(time);
                }
                
                // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†
                const timerResetBtn = e.target.closest('#timer-reset-btn');
                if(timerResetBtn) {
                    resetTimerDisplay();
                }
                // â˜…æ–°è¦è¿½åŠ â˜… ä¼‘æ†©è¨­å®šãƒœã‚¿ãƒ³ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆä¸­ï¼‰
                const breakSettingsBtn = e.target.closest('#break-settings-btn');
                if (breakSettingsBtn) {
                    openBreakSettingsModal();
                }
    
                // â˜…æ–°è¦è¿½åŠ â˜… ä¼‘æ†©è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const breakSettingsCloseBtn = e.target.closest('#break-settings-close-btn');
                if (breakSettingsCloseBtn) {
                    $('#break-settings-modal').style.display = 'none';
                    // å¤‰æ›´ã‚’å³åº§ã«åæ˜ 
                    renderBreakIcons();
                }
            });
            
            /* å¤‰æ›´å¾Œ (æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨ã—ã¦è¿½åŠ ) */
            $('#background-scope-toggle').addEventListener('change', (e) => {
                state.settings.backgroundScopeGlobal = e.target.checked;
                saveState();
                updateAppearance();
                updateBackgrounds();
                // é›†ä¸­ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦å†æç”»
                if ($('#focus-page').classList.contains('active')) {
                    renderEngine.pages['focus-page']();
                }
            });
            
            // --- Focus Page Logic ---
            const updateMiniTimer = () => {
                if (miniTimerTemporarilyHidden) {
                    $('#mini-timer-container').classList.remove('visible');
                    return;
                }
                const container = $('#mini-timer-container');
                const bar = $('#mini-timer-bar');
                if ((focusTimer.isRunning || stopwatch.isRunning) && !$('#focus-page').classList.contains('active')) {
                    container.classList.add('visible');
                    if(focusTimer.isRunning){
                        const progress = (focusTimer.defaultTime - focusTimer.timeLeft) / focusTimer.defaultTime * 100;
                        $('#mini-timer-text').textContent = formatTime(focusTimer.timeLeft);
                        $('#mini-timer-progress-bar').style.width = `${progress}%`;
                    } else { // stopwatch
                         $('#mini-timer-text').textContent = formatStopwatchTime(stopwatch.elapsedTime);
                         $('#mini-timer-progress-bar').style.width = `100%`;
                    }
                } else {
                    container.classList.remove('visible');
                }
            };
            
            const timerTick = () => {
                focusTimer.timeLeft--;
                $('#focus-timer-display').textContent = formatTime(focusTimer.timeLeft);
                updateMiniTimer();
                if (focusTimer.timeLeft <= 0) {
                    clearInterval(focusTimer.interval);
                    // showToast ã¨ new Notification ã¯ Service Worker ãŒæ‹…å½“ã™ã‚‹ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤
                    // showToast('é›†ä¸­ãƒ¢ãƒ¼ãƒ‰å®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
                    // if (Notification.permission === 'granted') { ... }
            
                    const elapsed = focusTimer.defaultTime;
                    logStudyTime('focus', elapsed);
                    addLP(Math.floor(elapsed/60), 'ã‚¿ã‚¤ãƒãƒ¼å®Œäº†');
                    state.focus.totalTime += elapsed;
                    saveState();
                    resetTimerUI();
            
                }
            };
            
            const stopwatchTick = () => {
                stopwatch.elapsedTime = (Date.now() - stopwatch.startTime) / 1000;
                $('#stopwatch-display').textContent = formatStopwatchTime(stopwatch.elapsedTime);
                updateMiniTimer();
            };

            const pauseFocusTimer = () => {
                if (!focusTimer.isRunning || focusTimer.isPaused) return;
                focusTimer.isPaused = true;
                clearInterval(focusTimer.interval);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>å†é–‹`;
                lucide.createIcons();
            };

            const resumeFocusTimer = () => {
                if (!focusTimer.isRunning || !focusTimer.isPaused) return;
                focusTimer.isPaused = false;
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢`;
                lucide.createIcons();
            };

            const pauseStopwatch = () => {
                if (!stopwatch.isRunning || stopwatch.isPaused) return;
                stopwatch.isPaused = true;
                clearInterval(stopwatch.interval);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>å†é–‹`;
                lucide.createIcons();
            };

            const resumeStopwatch = () => {
                if (!stopwatch.isRunning || !stopwatch.isPaused) return;
                stopwatch.isPaused = false;
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢`;
                lucide.createIcons();
            };

            const updateFocusModeUI = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const mode = state.focus.mode;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼å†…ã®è¡¨ç¤ºåˆ‡æ›¿
Â  Â  Â  Â  Â  Â  Â  Â  $('#timer-view').style.display = (mode === 'timer') ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  Â  Â  $('#stopwatch-view').style.display = (mode === 'stopwatch') ? 'flex' : 'none';
Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
Â  Â  Â  Â  Â  Â  Â  Â  const timerBtn = $('.focus-mode-btn[data-mode="timer"]');
Â  Â  Â  Â  Â  Â  Â  Â  const stopwatchBtn = $('.focus-mode-btn[data-mode="stopwatch"]');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (mode === 'timer') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timerBtn.classList.add('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopwatchBtn.classList.remove('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  } else if (mode === 'stopwatch') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timerBtn.classList.remove('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopwatchBtn.classList.add('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

            // â–¼â–¼â–¼ æ–°è¦è¿½åŠ : èƒŒæ™¯ç”»åƒã‚’ focus-view-bg ã‚¯ãƒ©ã‚¹ã‚’æŒã¤è¦ç´ ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆå«ã‚€ï¼‰ã«é©ç”¨ã™ã‚‹é–¢æ•° â–¼â–¼â–¼
            const updateBackgrounds = () => {
                const activeBgId = state.profile.activeBackground;
                const activeBg = initialData.backgrounds[activeBgId] || initialData.backgrounds['default'];
                const isGlobal = state.settings.backgroundScopeGlobal;
                const hasImage = activeBg && activeBg.url;
            
                // .focus-view-bg ã‚¯ãƒ©ã‚¹ã‚’æŒã¤ã™ã¹ã¦ã®è¦ç´ ï¼ˆã‚¿ã‚¤ãƒãƒ¼ç”»é¢ã€ã‚¯ã‚¨ã‚¹ãƒˆç”»é¢ãªã©ï¼‰ã‚’å–å¾—
                $$('.focus-view-bg').forEach(el => {
                    // ã€Œå…¨ä½“é©ç”¨ã€ãŒã‚ªãƒ•ã§ã€ã‹ã¤ç”»åƒãŒã‚ã‚‹å ´åˆã®ã¿ã€å€‹åˆ¥ã«èƒŒæ™¯ã‚’è¨­å®š
                    // â€»ã‚¯ã‚¨ã‚¹ãƒˆç”»é¢ã¯å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãªã®ã§ã€GlobalãŒONã§ã‚‚OFFã§ã‚‚èƒŒæ™¯ç”»åƒã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã¯æ¡ä»¶ã‚’èª¿æ•´
                    // ã“ã“ã§ã¯ã€Œã‚¿ã‚¤ãƒãƒ¼ç”»é¢ã¨åŒã˜æŒ™å‹•ï¼ˆGlobal OFFãªã‚‰å€‹åˆ¥ã«è¡¨ç¤ºï¼‰ã€ã«åŠ ãˆã€
                    // ã€Œã‚¯ã‚¨ã‚¹ãƒˆç”»é¢(#quest-active-screen)ãªã‚‰å¸¸ã«è¡¨ç¤ºã€ã¨ã„ã†ãƒ­ã‚¸ãƒƒã‚¯ã«ã—ã¾ã™ã€‚
                    
                    const isQuestScreen = el.id === 'quest-active-screen';
            
                    if ((!isGlobal && hasImage) || (isQuestScreen && hasImage)) {
                        el.style.backgroundImage = `url(${activeBg.url})`;
                    } else {
                        // å…¨ä½“é©ç”¨ãŒONã®å ´åˆã¯è¦ª(body)ã®èƒŒæ™¯ãŒè¦‹ãˆã‚‹ã®ã§é€æ˜ã«ã™ã‚‹ã€ã¾ãŸã¯ç”»åƒãªã—
                        el.style.backgroundImage = 'none';
                    }
                });
            };

            const resetTimerUI = () => {
                clearInterval(focusTimer.interval);
                focusTimer.isRunning = false; focusTimer.isPaused = false;
                focusTimer.timeLeft = focusTimer.defaultTime; // defaultTimeã‹ã‚‰ãƒªã‚»ãƒƒãƒˆ
                $('#focus-timer-display').textContent = formatTime(focusTimer.defaultTime);
                $('#focus-start-btn').classList.remove('hidden');
                $('#focus-controls').classList.add('hidden');
                $('#timer-settings-container').classList.remove('hidden');
                updateMiniTimer();
            };

            const resetStopwatchUI = () => {
                clearInterval(stopwatch.interval);
                stopwatch.isRunning = false; stopwatch.isPaused = false;
                stopwatch.elapsedTime = 0;
                $('#stopwatch-display').textContent = formatStopwatchTime(0);
                $('#stopwatch-start-btn').classList.remove('hidden');
                $('#stopwatch-controls').classList.add('hidden');
                updateMiniTimer();
            };

            const endFocusTimer = () => {
                if (!focusTimer.isRunning) return;
                const elapsed = focusTimer.defaultTime - focusTimer.timeLeft;
                if (elapsed > 0) { recordSession('ã‚¿ã‚¤ãƒãƒ¼', elapsed); addLP(Math.floor(elapsed / 60), 'ã‚¿ã‚¤ãƒãƒ¼'); state.focus.totalTime += elapsed; saveState(); }
                resetTimerUI();
            
                // ã€è¿½åŠ ã€‘Service Workerã«ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ã‚’é€šçŸ¥
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ command: 'focusTimer_stop' });
                }
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = false;
                state.focus.startTime = null;
                saveState();
                // â–²â–²â–²ã€è¿½åŠ ã€‘ã“ã“ã¾ã§â–²â–²â–²
            };

            const endStopwatch = () => {
                if (!stopwatch.isRunning) return;
                const elapsed = Math.round(stopwatch.elapsedTime);
                if (elapsed > 0) { recordSession('ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ', elapsed); addLP(Math.floor(elapsed / 60), 'ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ'); state.focus.totalTime += elapsed; saveState(); }
                resetStopwatchUI();
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = false;
                state.focus.startTime = null;
                saveState();
                // â–²â–²â–²ã€è¿½åŠ ã€‘ã“ã“ã¾ã§â–²â–²â–²
            };
            
            const setTimer = (seconds) => {
                focusTimer.defaultTime = seconds; // defaultTimeã‚‚æ›´æ–°
                focusTimer.timeLeft = seconds;
                $('#focus-timer-display').textContent = formatTime(seconds);
            };

           $('#focus-start-btn').addEventListener('click', () => {
                if (focusTimer.timeLeft <= 0) {
                    showToast('æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                    return;
                }
                focusTimer.defaultTime = focusTimer.timeLeft;
                focusTimer.isRunning = true;
                focusTimer.isPaused = false;
                state.focus.isRunning = true;
                state.focus.startTime = Date.now(); // ç¾åœ¨æ™‚åˆ»ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜
                state.focus.duration = focusTimer.timeLeft;
                saveState();
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-start-btn').classList.add('hidden');
                $('#focus-controls').classList.remove('hidden');
                $('#timer-settings-container').classList.add('hidden');
                updateMiniTimer();
            
                // ã€è¿½åŠ ã€‘Service Workerã«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã‚’é€šçŸ¥
                if (navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.controller.postMessage({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  command: 'focusTimer_start', // â˜… 'startTimer' ã‹ã‚‰å¤‰æ›´
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeLeft: focusTimer.timeLeft,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'âŒ›ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†', // â˜… é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: 'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ã‚¿ã‚¤ãƒãƒ¼ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚' // â˜… é€šçŸ¥æœ¬æ–‡ã‚’è¿½åŠ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
            });
            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â–¼â–¼â–¼ */

            // ã‚¯ã‚¨ã‚¹ãƒˆè¨­å®šãƒ“ãƒ¥ãƒ¼ã®ãƒœã‚¿ãƒ³
            addSectionBtn.addEventListener('click', () => {
                quest.plan.push({
                    id: Date.now(),
                    type: 'section',
                    text: 'æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³',
                    duration: 25 * 60
                });
                renderQuestPlan();
            });

            addBreakBtn.addEventListener('click', () => {
                quest.plan.push({
                    id: Date.now(),
                    type: 'break',
                    duration: 5 * 60
                });
                renderQuestPlan();
            });

            addBreaksBtn.addEventListener('click', () => {
                const interval = parseInt($('#break-interval-input').value) || 2;
                const duration = parseInt($('#break-duration-input').value) || 5;
                const newPlan = [];
                let sectionCount = 0;
                
                // ä¼‘æ†©ã‚’é™¤ã„ãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã®ãƒªã‚¹ãƒˆã‚’å…ƒã«ã™ã‚‹
                const sections = quest.plan.filter(item => item.type === 'section');

                sections.forEach((item, index) => {
                    newPlan.push(item);
                    sectionCount++;
                    // æœ€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä»¥å¤–ã§ã€intervalã®å€æ•°ç•ªç›®ãªã‚‰ä¼‘æ†©ã‚’è¿½åŠ 
                    if (sectionCount % interval === 0 && index !== sections.length - 1) {
                        newPlan.push({
                            id: Date.now() + Math.random(),
                            type: 'break',
                            duration: duration * 60
                        });
                    }
                });
                
                quest.plan = newPlan;
                renderQuestPlan();
            });

            startQuestBtn.addEventListener('click', startQuest);

            // ã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œç”»é¢ã®ãƒœã‚¿ãƒ³
            endQuestBtn.addEventListener('click', () => {
                openModalWithAnim('confirmation-modal', 'confirmation-content');
            });

            modalConfirmBtn.addEventListener('click', () => endQuest(false));
            modalCancelBtn.addEventListener('click', () => {
                closeModalWithAnim('confirmation-modal', 'confirmation-content');
            });

           // ä¼‘æ†©ä¸­ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (ã‚¢ã‚¤ã‚³ãƒ³ãƒ›ãƒ¼ãƒ ç”»é¢)
Â  Â  Â  Â  Â  Â  if(breakIconGrid) {
Â  Â  Â  Â  Â  Â  Â  Â  breakIconGrid.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = e.target.closest('.break-content-btn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (btn && btn.dataset.url) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // â˜…ã“ã“ã‹ã‚‰å¤‰æ›´â˜…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (btn.dataset.openMode === 'external') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¤–éƒ¨ã‚¿ãƒ–ã§é–‹ã (å¼·åˆ¶ã‚¯ãƒ­ãƒ¼ã‚ºä¸å¯)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(btn.dataset.url, '_blank');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¾“æ¥é€šã‚Šã‚¢ãƒ—ãƒªå†… (iframe) ã§é–‹ã (å¼·åˆ¶ã‚¯ãƒ­ãƒ¼ã‚ºå¯èƒ½)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openIframe(btn.dataset.url);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // â˜…ã“ã“ã¾ã§å¤‰æ›´â˜…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
            closeIframeBtn.addEventListener('click', closeIframe);

            /* â–²â–²â–² è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â–²â–²â–² */
            
            $('#focus-pause-btn').addEventListener('click', () => { if (focusTimer.isPaused) resumeFocusTimer(); else pauseFocusTimer(); });
            $('#focus-end-btn').addEventListener('click', endFocusTimer);

            $('#stopwatch-start-btn').addEventListener('click', () => {
                stopwatch.isRunning = true; stopwatch.isPaused = false;
                // ä¿®æ­£ï¼šä¿å­˜ã•ã‚ŒãŸæ™‚é–“ã§ã¯ãªãã€å¸¸ã«ç¾åœ¨ã®æ™‚åˆ»ã‹ã‚‰é–‹å§‹
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
            
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = true;
                // ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã®å ´åˆã€é–‹å§‹æ™‚åˆ»ã®ã¿ä¿å­˜
                state.focus.startTime = stopwatch.startTime; 
                saveState();
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-start-btn').classList.add('hidden');
                $('#stopwatch-controls').classList.remove('hidden');
                updateMiniTimer();
            });
            $('#stopwatch-pause-btn').addEventListener('click', () => { if (stopwatch.isPaused) resumeStopwatch(); else pauseStopwatch(); });
            $('#stopwatch-end-btn').addEventListener('click', endStopwatch);
            
            $('#notification-permission-btn').addEventListener('click', async () => {
                if (!('Notification' in window)) { showToast('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚'); return; }
                const permission = await Notification.requestPermission();
                if (permission === 'granted') { showToast('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼'); new Notification('StudyQuestã¸ã‚ˆã†ã“ãï¼', { body: 'é€šçŸ¥è¨­å®šãŒã‚ªãƒ³ã«ãªã‚Šã¾ã—ãŸã€‚' }); $('#notification-settings-card').style.display = 'none';} 
                else { showToast('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ç«¯æœ«ã®è¨­å®šã‚¢ãƒ—ãƒªã‹ã‚‰å¤‰æ›´ã§ãã¾ã™ã€‚'); }
            });
            
            // â–¼â–¼â–¼ ä¿®æ­£ç‰ˆ: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†ï¼ˆæç”»é…å»¶å¯¾å¿œï¼‰ â–¼â–¼â–¼
            let isAnimating = false;

            $$('.tab-btn').forEach(btn => btn.addEventListener('click', e => {
                const nextPageId = e.currentTarget.dataset.page;
                const activePage = document.querySelector('.page.active');
                
                if ((activePage && activePage.id === nextPageId) || isAnimating) return;

                const nextPage = $(`#${nextPageId}`);
                if (!nextPage) return;

                $('main').scrollTop = 0;

                // 1. ã¾ãšUIï¼ˆãƒœã‚¿ãƒ³ï¼‰ã‚’å³åº§ã«æ›´æ–°
                $$('.tab-btn').forEach(b => b.classList.replace('primary-text', 'text-gray-500'));
                e.currentTarget.classList.replace('text-gray-500', 'primary-text');
                $('#header-title').textContent = e.currentTarget.dataset.title;

                isAnimating = true;

                // 2. ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãŒã‚ã‚Œã°ã€Œé€€å‡ºã€é–‹å§‹
                if (activePage) {
                    activePage.classList.add('page-exit');
                    activePage.classList.remove('active');
                    
                    activePage.addEventListener('animationend', () => {
                        activePage.classList.remove('page-exit');
                    }, { once: true });
                }

                // 3. æ¬¡ã®ãƒšãƒ¼ã‚¸ã«ã€Œé€²å…¥ã€ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼‰
                nextPage.classList.add('page-enter');

                // 4. ã€é‡è¦ã€‘æç”»å‡¦ç†ã‚’å°‘ã—ã ã‘é…ã‚‰ã›ã‚‹
                // ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒã€Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹ãƒ•ãƒ¬ãƒ¼ãƒ ã€ã‚’æç”»ã—ãã£ã¦ã‹ã‚‰
                // é‡ã„å‡¦ç†ï¼ˆã‚°ãƒ©ãƒ•æç”»ãªã©ï¼‰ãŒèµ°ã‚‹ãŸã‚ã€ã‚¬ã‚¿ã¤ããŒè»½æ¸›ã•ã‚Œã‚‹ã€‚
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        // ãƒšãƒ¼ã‚¸å›ºæœ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆã‚°ãƒ©ãƒ•æç”»ãªã©ï¼‰
                        if (renderEngine.pages[nextPageId]) { 
                            renderEngine.pages[nextPageId](); 
                        }

                        // é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ç­‰ã®UIæ›´æ–°
                        if (nextPageId === 'focus-page') {
                            miniTimerTemporarilyHidden = false;
                        }
                        updateMiniTimer();
                        lucide.createIcons();

                    }, 10); // 10msç¨‹åº¦ã®é…å»¶ã§ååˆ†åŠ¹æœã‚ã‚Š
                });

                // 5. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã®å‡¦ç†
                nextPage.addEventListener('animationend', () => {
                    nextPage.classList.remove('page-enter');
                    nextPage.classList.add('active');
                    isAnimating = false;
                }, { once: true });

            }));
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            $('#mini-timer-bar').addEventListener('click', (e) => {
                if (e.target.closest('#close-mini-timer-btn')) return;
                document.querySelector('.tab-btn[data-page="focus-page"]').click();
            });

            $('#close-mini-timer-btn').addEventListener('click', () => {
                miniTimerTemporarilyHidden = true; // ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                $('#mini-timer-container').classList.remove('visible'); // éè¡¨ç¤ºã«ã™ã‚‹
            });

            // --- Countdown Logic ---
            // 1. ã‚µãƒ–ãƒšãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
            const countdownPage = new SubPage('countdown-screen');
            let editingCountdownId = null; // ç·¨é›†ä¸­ã®IDã‚’ä¿æŒ

            // æˆ»ã‚‹ãƒœã‚¿ãƒ³
            $('#close-countdown-btn').addEventListener('click', () => countdownPage.close());

            // 2. ç”»é¢ã‚’é–‹ãé–¢æ•° (æ–°è¦ãƒ»ç·¨é›†å…±é€š)
            function openCountdownScreen(id = null) {
                editingCountdownId = id;
                const titleEl = $('#countdown-screen-title');
                const nameInput = $('#countdown-name');
                const dateInput = $('#countdown-date');
                const memoInput = $('#countdown-memo'); // â˜…è¿½åŠ 
                const deleteBtn = $('#countdown-delete-btn');

                if (id) {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                    titleEl.textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†';
                    deleteBtn.classList.remove('hidden');
                    
                    const item = state.countdowns.find(c => c.id === id);
                    if (item) {
                        nameInput.value = item.name;
                        dateInput.value = item.date;
                        memoInput.value = item.memo || ''; // â˜…ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã¿ (ãªã‘ã‚Œã°ç©ºæ–‡å­—)
                    }
                } else {
                    // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                    titleEl.textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½åŠ ';
                    deleteBtn.classList.add('hidden');
                    
                    nameInput.value = '';
                    memoInput.value = ''; // â˜…ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªã‚¢
                    
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜: 2é€±é–“å¾Œ
                    const defaultDate = new Date();
                    defaultDate.setDate(defaultDate.getDate() + 14);
                    // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã®YYYY-MM-DDã‚’å–å¾—
                    const y = defaultDate.getFullYear();
                    const m = String(defaultDate.getMonth() + 1).padStart(2, '0');
                    const d = String(defaultDate.getDate()).padStart(2, '0');
                    dateInput.value = `${y}-${m}-${d}`;
                }

                countdownPage.open();
            }

            // 3. ä¿å­˜å‡¦ç†
            function saveCountdown() {
                const name = $('#countdown-name').value.trim();
                const date = $('#countdown-date').value;
                const memo = $('#countdown-memo').value; // â˜…ãƒ¡ãƒ¢ã‚’å–å¾—

                if (!name || !date) {
                    showToast('ã‚¤ãƒ™ãƒ³ãƒˆåã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const newData = {
                    name,
                    date,
                    memo // â˜…ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
                };

                if (editingCountdownId) {
                    // æ›´æ–°
                    const index = state.countdowns.findIndex(c => c.id === editingCountdownId);
                    if (index !== -1) {
                        state.countdowns[index] = { ...state.countdowns[index], ...newData };
                    }
                } else {
                    // æ–°è¦ä½œæˆ
                    newData.id = `cd_${Date.now()}`;
                    state.countdowns.push(newData);
                }

                // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
                state.countdowns.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                saveState();
                renderEngine.pages['home-page'](); // ãƒ›ãƒ¼ãƒ ç”»é¢æ›´æ–°
                countdownPage.close();
                showToast('ä¿å­˜ã—ã¾ã—ãŸ');
            }

            // 4. å‰Šé™¤å‡¦ç†
            function deleteCountdown() {
                if (!confirm('æœ¬å½“ã«ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

                if (editingCountdownId) {
                    state.countdowns = state.countdowns.filter(c => c.id !== editingCountdownId);
                    saveState();
                    renderEngine.pages['home-page']();
                    countdownPage.close();
                    showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
                }
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            $('#add-countdown-btn').addEventListener('click', () => openCountdownScreen()); // æ–°è¦è¿½åŠ 
            $('#countdown-save-btn').addEventListener('click', saveCountdown);
            $('#countdown-delete-btn').addEventListener('click', deleteCountdown);

            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®é–¢æ•°ç¾¤ â–¼â–¼â–¼ */

        // ã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ã®ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        function renderQuestPlan() {
            questPlanListEl.innerHTML = '';
            if (quest.plan.length === 0) {
                questPlanListEl.innerHTML = `<p class="text-center text-sm text-gray-500">ã€Œä»Šæ—¥ã®äºˆå®šã€ã‚’èª­ã¿è¾¼ã‚€ã‹ã€<br>ã€Œã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>`;
            }
            let sectionCounter = 1; 
            
            quest.plan.forEach((item, index) => {
                const itemEl = document.createElement('div');
                // â˜…ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨ã‚¯ãƒ©ã‚¹è¿½åŠ 
                itemEl.className = 'swipe-container relative overflow-hidden rounded-lg mb-2';
                
                let contentHTML = '';
                if (item.type === 'section') {
                    contentHTML = `
                        <span class="font-bold w-6 text-center shrink-0">${sectionCounter}</span>
                        <input type="text" value="${item.text}" data-original-id="${item.originalTaskId || ''}" class="quest-item-text flex-grow bg-transparent p-1 rounded border border-transparent focus:border-gray-400 dark:focus:border-gray-500 focus:outline-none min-w-0 truncate">
                        <input type="number" value="${item.duration / 60}" class="quest-item-duration w-12 p-1 border rounded text-center dark:bg-gray-600 dark:border-gray-500 shrink-0">
                        <span class="text-sm shrink-0">åˆ†</span>
                    `;
                    sectionCounter++;
                } else { // break
                    contentHTML = `
                        <span class="font-bold w-6 text-center shrink-0">â˜•</span>
                        <span class="flex-grow p-1 text-gray-500 dark:text-gray-400 font-semibold">ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ </span>
                        <input type="number" value="${item.duration / 60}" class="quest-item-duration w-12 p-1 border rounded text-center dark:bg-gray-600 dark:border-gray-500 shrink-0">
                        <span class="text-sm shrink-0">åˆ†</span>
                    `;
                }

                itemEl.innerHTML = `
                    <div class="swipe-actions">
                         <div style="width:100%; flex:1;"></div> <button class="btn-delete swipe-btn bg-red-500 w-[70px]">
                            <i data-lucide="trash-2" class="w-6 h-6"></i>
                            <span>å‰Šé™¤</span>
                        </button>
                    </div>

                    <div class="swipe-content flex items-center space-x-2 bg-gray-100 dark:bg-gray-800 p-2 relative z-10 w-full">
                        ${contentHTML}
                        <button class="quest-handle cursor-move text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-opacity shrink-0 p-1">
                            <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                
                questPlanListEl.appendChild(itemEl);

                // â˜…ã‚¹ãƒ¯ã‚¤ãƒ—é©ç”¨
                new SwipeHandler(itemEl, {
                    onDelete: () => {
                        quest.plan = quest.plan.filter(p => p.id !== item.id);
                        // é…åˆ—æ“ä½œå¾Œã«å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†æç”»ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾…ã¡ï¼‰
                        setTimeout(renderQuestPlan, 300);
                    }
                });

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆå¤‰æ›´ãªã—ï¼‰
                itemEl.querySelector('.quest-item-text')?.addEventListener('change', (e) => {
                    item.text = e.target.value;
                    item.originalTaskId = e.target.dataset.originalId || null;
                });
                itemEl.querySelector('.quest-item-duration').addEventListener('change', (e) => {
                    item.duration = parseInt(e.target.value) * 60;
                });
            });
            lucide.createIcons();
        };
            
        // ã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•° (ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è€æ€§å¼·åŒ–ç‰ˆ)
Â  Â  Â  Â  function startQuestTimer(duration, onTick, onEnd) {
Â  Â  Â  Â  Â  Â  // 1. æ—¢å­˜ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
Â  Â  Â  Â  Â  Â  if (quest.timerInterval) {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(quest.timerInterval);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã€Œçµ¶å¯¾çš„ãªçµ‚äº†æ™‚åˆ»ã€ã‚’è¨ˆç®—
Â  Â  Â  Â  Â  Â  const endTime = Date.now() + duration * 1000;

            // 2.5. å‘¼ã³å‡ºã—ç›´å¾Œã«ã€ã¾ãšUIã‚’ç¾åœ¨ã®æ™‚é–“ã§æ›´æ–°ã™ã‚‹
Â  Â  Â  Â  Â  Â  const initialTimeLeft = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
Â  Â  Â  Â  Â  Â  onTick(initialTimeLeft);
Â  Â  Â  Â  Â  Â  quest.timeLeft = initialTimeLeft;

Â  Â  Â  Â  Â  Â  // 3. 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’é–‹å§‹
Â  Â  Â  Â  Â  Â  quest.timerInterval = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  // 4. çµ‚äº†æ™‚åˆ»ã¨ç¾åœ¨æ™‚åˆ»ã‹ã‚‰ã€æœ¬å½“ã®æ®‹ã‚Šæ™‚é–“ã‚’è¨ˆç®— (0ç§’æœªæº€ã«ã¯ã—ãªã„)
Â  Â  Â  Â  Â  Â  Â  Â  const timeLeft = Math.max(0, Math.floor((endTime - now) / 1000));

Â  Â  Â  Â  Â  Â  Â  Â  // 5. ãƒ­ã‚°è¨˜éŒ²ç”¨ã«ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®æ®‹ã‚Šæ™‚é–“ã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  quest.timeLeft = timeLeft; 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 6. UIã‚’æ›´æ–° (onTick)
Â  Â  Â  Â  Â  Â  Â  Â  onTick(timeLeft);

Â  Â  Â  Â  Â  Â  Â  Â  // 7. çµ‚äº†æ™‚åˆ»ã‚’éãã¦ã„ãŸã‚‰ã€ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ onEnd ã‚’å‘¼ã¶
Â  Â  Â  Â  Â  Â  Â  Â  if (now >= endTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(quest.timerInterval);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quest.timerInterval = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onEnd(); // çµ‚äº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 1000); // 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ (å³å¯†ã«ã¯100msç­‰ã®æ–¹ãŒç²¾åº¦ã¯è‰¯ã„ãŒã€1000msã§ã‚‚ååˆ†)
Â  Â  Â  Â  };

        function cancelQuestAlarm() {
Â  Â  Â  Â  Â  Â  if (navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  // 'stopTimer' ã‚³ãƒãƒ³ãƒ‰ã‚’ (é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã¨) å…±æœ‰ã—ã¦ä½¿ç”¨
Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.controller.postMessage({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  command: 'questTimer_stop' 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        function sendQuestAlarm(durationInSeconds, title, body) {
Â  Â  Â  Â  Â  Â  if (Notification.permission === "granted" && navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  // 'startTimer' ã‚³ãƒãƒ³ãƒ‰ã‚’ (é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã¨) å…±æœ‰ã—ã¦ä½¿ç”¨
Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.controller.postMessage({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  command: 'questTimer_start', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeLeft: durationInSeconds,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: title, // é€šçŸ¥ã®ã‚¿ã‚¤ãƒˆãƒ«
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: body Â // é€šçŸ¥ã®æœ¬æ–‡
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        // â–¼â–¼â–¼ æ–°è¦ãƒ»ä¿®æ­£: ã‚¯ã‚¨ã‚¹ãƒˆé€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç¢ºèªç”»é¢ä»˜ãï¼‰ â–¼â–¼â–¼

            const questTransitionView = $('#quest-transition-view');
            const transitionTitle = $('#transition-title');
            const transitionMessage = $('#transition-message');
            const transitionNextText = $('#transition-next-text');
            const transitionNextDuration = $('#transition-next-duration');
            const transitionStartBtn = $('#transition-start-btn');
            const transitionIcon = $('#transition-icon');

            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€æº–å‚™
            function runNextQuestStep() {
                quest.currentIndex++;
                
                // å…¨ã‚¹ãƒ†ãƒƒãƒ—çµ‚äº†æ™‚ã®å‡¦ç†
                if (quest.currentIndex >= quest.plan.length) {
                    endQuest(true);
                    return;
                }

                const nextStep = quest.plan[quest.currentIndex];

                // â˜…è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®çŠ¶æ…‹ã‚’ä¿å­˜ (ç¾åœ¨åœ°ã¨é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²)
                state.savedQuest = {
                    plan: quest.plan,
                    currentIndex: quest.currentIndex,
                    startTime: Date.now(), // ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®é–‹å§‹æ™‚åˆ»ï¼ˆä»®ï¼‰
                    active: true
                };
                saveState();

                // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å³é–‹å§‹ã—ã€ãã‚Œä»¥é™ã¯ç¢ºèªç”»é¢ã‚’å‡ºã™
                if (quest.currentIndex === 0) {
                    executeQuestStep(nextStep);
                } else {
                    showTransitionScreen(nextStep);
                }
            }

            // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ï¼ˆå¾…æ©Ÿï¼‰ç”»é¢ã‚’è¡¨ç¤º
            function showTransitionScreen(step) {
                // å‰ã®ç”»é¢ã‚’éš ã™
                questSectionView.style.display = 'none';
                questBreakView.style.display = 'none';

                // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ç”»é¢ã‚’è¡¨ç¤º
                questTransitionView.style.display = 'flex';
                
                // å†…å®¹ã®ã‚»ãƒƒãƒˆ
                if (step.type === 'section') {
                    transitionTitle.textContent = "å­¦ç¿’ã‚’å§‹ã‚ã¾ã™ã‹ï¼Ÿ";
                    transitionMessage.textContent = "æº–å‚™ãŒã§ããŸã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
                    transitionIcon.setAttribute('data-lucide', 'book-open');
                    transitionNextText.textContent = step.text;
                    transitionNextDuration.textContent = `${step.duration / 60} åˆ†`;
                    transitionStartBtn.className = "primary-bg primary-bg-hover text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center";
                } else {
                    transitionTitle.textContent = "ä¼‘æ†©ã‚¿ã‚¤ãƒ ";
                    transitionMessage.textContent = "ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼å°‘ã—é ­ã‚’ä¼‘ã‚ã¾ã—ã‚‡ã†ã€‚";
                    transitionIcon.setAttribute('data-lucide', 'coffee');
                    transitionNextText.textContent = "ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ ";
                    transitionNextDuration.textContent = `${step.duration / 60} åˆ†`;
                    transitionStartBtn.className = "bg-green-600 hover:bg-green-700 text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center";
                }

                lucide.createIcons();

                // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¸€åº¦ã ã‘ç™ºç«ã™ã‚‹ã‚ˆã†ã«è¨­å®šï¼‰
                transitionStartBtn.onclick = () => {
                    questTransitionView.style.display = 'none';
                    executeQuestStep(step);
                };
            }

            // å®Ÿéš›ã®ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ã‚’è¡¨ç¤ºã—ã¦é–‹å§‹
            function executeQuestStep(currentStep) {
                cancelQuestAlarm();

                // â˜…è¿½åŠ : å®Ÿéš›ã«ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ãã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ­£ç¢ºãªé–‹å§‹æ™‚åˆ»ã‚’ä¿å­˜
                if(state.savedQuest) {
                    state.savedQuest.startTime = Date.now();
                    // currentStepãŒä¼‘æ†©ã‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹åŒºåˆ¥ã—ã¦ä¿å­˜ã—ã¦ã‚‚è‰¯ã„ãŒã€
                    // å¾©å…ƒæ™‚ã«è¨ˆç®—ã™ã‚‹ã®ã§æœ€ä½é™ Date.now() ãŒã‚ã‚Œã°OK
                    saveState();
                }

                // ã‚¢ãƒ—ãƒª2ã®ãƒˆãƒ¼ã‚¹ãƒˆé–¢æ•°ã¨Notification APIã‚’ä½¿ç”¨
                const showQuestNotification = (title, body) => {
                    showToast(body);
                    if (Notification.permission === "granted" && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            command: 'showQuestNotification',
                            title: title,
                            body: body
                        });
                    }
                };

                if (currentStep.type === 'section') {
                    playBGM();
                    questSectionView.style.display = 'flex';
                    questBreakView.style.display = 'none';
                    
                    questSectionTitle.textContent = currentStep.text;
                    // é€²æ—è¡¨ç¤º
                    const totalSections = quest.plan.filter(p => p.type === 'section').length;
                    const currentSectionNumber = quest.plan.slice(0, quest.currentIndex + 1).filter(p => p.type === 'section').length;
                    questProgressEl.textContent = `${currentSectionNumber} / ${totalSections}`;

                    // â˜…ã“ã“ã§SWã«ã€Œäºˆç´„ã€ã‚’å…¥ã‚Œã¦ã„ã‚‹ã®ã§ã€æ™‚é–“ã«ãªã‚Œã°è‡ªå‹•ã§é€šçŸ¥ãŒæ¥ã¾ã™
                    sendQuestAlarm(
                        currentStep.duration,
                        'ğŸ”¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†',
                        'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼'
                    );
                    
                    startQuestTimer(
                        currentStep.duration,
                        (timeLeft) => { questTimerEl.textContent = formatTime(timeLeft); },
                        () => {
                            // --- â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ 1 â–¼â–¼â–¼ ---
                            // ã“ã“ã§ showQuestNotification ã‚’å‘¼ã¶ã¨ã€Œä»Šã™ãé€šçŸ¥ã€ãŒé€ã‚‰ã‚Œã¦é‡è¤‡ã—ã¾ã™ã€‚
                            // ä»£ã‚ã‚Šã« showToast ã ã‘å‘¼ã‚“ã§ã€ç”»é¢å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘è¡¨ç¤ºã—ã¾ã™ã€‚
                            const elapsed = currentStep.duration;
                            if (elapsed > 0) {
                                recordSession(currentStep.text, elapsed);
                                addLP(Math.floor(elapsed / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³');
                                state.focus.totalTime += elapsed;
                                
                                if (currentStep.originalTaskId) {
                                    const taskId = parseInt(currentStep.originalTaskId);
                                    const taskIndex = state.tasks.findIndex(t => t.id === taskId);
                                    if (taskIndex !== -1) {
                                        state.tasks[taskIndex].completed = true;
                                    }
                                }
                                saveState();
                            }
                            // â˜…é€šçŸ¥ã¯SWã®äºˆç´„ã«ä»»ã›ã€ã“ã“ã§ã¯ãƒˆãƒ¼ã‚¹ãƒˆã®ã¿è¡¨ç¤º
                            showToast('ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼'); 
                            // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---

                            runNextQuestStep(); // æ¬¡ï¼ˆãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ç”»é¢ï¼‰ã¸
                        }
                    );
                } else { // break
                    pauseBGM();
                    questSectionView.style.display = 'none';
                    questBreakView.style.display = 'flex';
                    renderBreakIcons();

                    // â˜…ã“ã“ã§SWã«ã€Œäºˆç´„ã€ã‚’å…¥ã‚Œã¦ã„ã¾ã™
                    sendQuestAlarm(
                        currentStep.duration,
                        'â˜•ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ çµ‚äº†',
                        'ä¼‘æ†©æ™‚é–“ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚'
                    );
                    
                    startQuestTimer(
                        currentStep.duration,
                        (timeLeft) => {
                            breakTimerEl.textContent = formatTime(timeLeft);
                            // æ®‹ã‚Š30ç§’ã®é€šçŸ¥ã¯ã€Œäºˆç´„ã€ã—ã¦ã„ãªã„ã®ã§ã€ã“ã“ã‹ã‚‰é€ã£ã¦ã‚‚OKï¼ˆé‡è¤‡ã—ãªã„ï¼‰
                            if (timeLeft === 30) {
                                showQuestNotification('â±ã¾ã‚‚ãªãä¼‘æ†©çµ‚äº†', '30ç§’å¾Œã«çµ‚äº†ã—ã¾ã™ã€‚');
                            }
                        },
                        () => {
                            // --- â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ 2 â–¼â–¼â–¼ ---
                            // ã“ã“ã‚‚åŒæ§˜ã«ä¿®æ­£
                            // showQuestNotification('ä¼‘æ†©çµ‚äº†', 'ä¼‘æ†©ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚'); 
                            showToast('ä¼‘æ†©ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚');
                            // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---

                            closeIframe();
                            runNextQuestStep(); // æ¬¡ï¼ˆãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ç”»é¢ï¼‰ã¸
                        }
                    );
                }
                lucide.createIcons();
            }
            // â–²â–²â–² ã‚¯ã‚¨ã‚¹ãƒˆé€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£å®Œäº† â–²â–²â–²

        // ã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        // ã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹é–¢æ•°ï¼ˆç·¨é›†ç”»é¢ç¶­æŒç‰ˆï¼‰
        function startQuest() {
            if (quest.plan.length === 0) {
                showToast('ã‚¯ã‚¨ã‚¹ãƒˆã®äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            // 1. èƒŒæ™¯ã‚„å¤‰æ•°ã®æº–å‚™
            quest.active = true;
            quest.currentIndex = -1;
            updateBackgrounds();

            // 2. ã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œç”»é¢ã‚’è¡¨ç¤ºï¼ˆã¾ã é€æ˜ãƒ»ç¸®å°çŠ¶æ…‹ï¼‰
            // æœ€å‰é¢(z-200)ã«è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ä¸‹ã®ç·¨é›†ç”»é¢ã¯è¦‹ãˆãªããªã‚Šã¾ã™ãŒã€å­˜åœ¨ã—ç¶šã‘ã¾ã™
            questActiveScreen.style.display = 'flex';
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦é©ç”¨ï¼ˆãµã‚ã£ã¨å‡ºã‚‹æ¼”å‡ºï¼‰
            questActiveScreen.classList.remove('animate-screen-enter');
            void questActiveScreen.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶
            questActiveScreen.classList.add('animate-screen-enter');

            // 3. ã‚¢ãƒ—ãƒª2ã®ãƒ˜ãƒƒãƒ€ãƒ¼ç­‰ã‚’éš ã™
            // (ç·¨é›†ç”»é¢ã‚‚ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éš ã—ã¾ã™ãŒã€å¿µã®ãŸã‚ã“ã“ã§ã‚‚éš ã—ã¦ãŠãã¾ã™)
            $('header').style.display = 'none';
            $('nav').style.display = 'none';
            $('#mini-timer-container').classList.remove('visible');
            document.body.style.overflow = 'hidden';

            // 4. æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‹å§‹
            runNextQuestStep();
        };

        // ã‚¯ã‚¨ã‚¹ãƒˆã‚’çµ‚äº†ã™ã‚‹é–¢æ•°
        function endQuest(completed = false) {
            state.savedQuest = null;
            saveState();
            stopBGM();
            clearInterval(quest.timerInterval);
            quest.timerInterval = null; // å¿˜ã‚Œãšã«ã‚¯ãƒªã‚¢

Â  Â  Â  Â  Â  Â  // --- â˜…è¿½åŠ â˜… ã‚¯ã‚¨ã‚¹ãƒˆçµ‚äº†æ™‚ã«SWã®ã‚¢ãƒ©ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ ---
Â  Â  Â  Â  Â  Â  cancelQuestAlarm();
            if (!completed && quest.currentIndex >= 0 && quest.currentIndex < quest.plan.length) {
                const currentStep = quest.plan[quest.currentIndex];
                // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒ 'section' (å­¦ç¿’ä¸­) ã®å ´åˆã®ã¿è¨˜éŒ²
                if (currentStep.type === 'section') {
                    const elapsed = currentStep.duration - quest.timeLeft; // çµŒéæ™‚é–“
                    if (elapsed > 0) {
                        recordSession(`${currentStep.text} (ä¸­æ–­)`, elapsed);
                        addLP(Math.floor(elapsed / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä¸­æ–­ï¼‰');
                        state.focus.totalTime += elapsed;
                        saveState();
                        showToast(`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® ${formatTime(elapsed)} ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚`);
                    }
                }
            }
            
            quest.active = false;
            questActiveScreen.style.display = 'none';

            // ã‚¢ãƒ—ãƒª2ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚¿ãƒ–ãƒãƒ¼ã‚’å†è¡¨ç¤º
            $('header').style.display = 'flex';
            $('nav').style.display = 'flex';

            document.body.style.overflow = 'auto';
            closeModalWithAnim('confirmation-modal', 'confirmation-content');
            closeIframe();
            if (completed) {
                showToast('ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
            }
        };

        // ä¼‘æ†©ç”¨iframeã‚’é–‹ãé–¢æ•°ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¶å¾¡ä»˜ãï¼‰
            function openIframe(url) {
                const container = $('#game-container');
                const overlay = $('#iframe-overlay');
                const loader = $('#iframe-loader');
                
                overlay.style.display = 'flex';
                loader.style.display = 'flex';

                // iframeã‚’ä½œæˆ
                const iframe = document.createElement('iframe');
                iframe.id = 'break-iframe'; // IDã¯ç¶­æŒ
                iframe.className = 'w-full h-full absolute inset-0 opacity-0 transition-opacity duration-300';
                iframe.sandbox = 'allow-scripts allow-forms allow-popups';
                iframe.style.border = '0';
                iframe.src = url;

                // èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
                iframe.onload = () => {
                    loader.style.display = 'none';
                    iframe.classList.remove('opacity-0');
                    iframe.classList.add('opacity-100');
                };

                container.appendChild(iframe); // ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
                lucide.createIcons();
            };
        
            function closeIframe() {
                const container = $('#game-container');
                const iframe = document.getElementById('break-iframe');
                const overlay = $('#iframe-overlay');
                
                // iframeãŒå­˜åœ¨ã™ã‚Œã°å‰Šé™¤ï¼ˆã“ã‚Œã§å‰å›ã®ç”»é¢ã¯æ¶ˆæ»…ã™ã‚‹ï¼‰
                if (iframe) {
                    iframe.remove();
                }
                
                overlay.style.display = 'none';
            };
            
        // â˜…ä¿®æ­£å¾Œâ˜… ä¼‘æ†©ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        function renderBreakIcons() {
            if (!breakIconGrid) return;

            // 1. è¡¨ç¤ºãŒã‚ªãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã ã‘ã‚’æŠ½å‡º
            const items = state.breakIcons.filter(icon => icon.visible);

            // 2. HTMLã‚’ç”Ÿæˆ
            breakIconGrid.innerHTML = items.map(icon => `
                <button class="break-content-btn" data-url="${icon.url}" data-open-mode="${icon.openMode || 'external'}" data-id="${icon.id}">
                    <i data-lucide="${icon.icon}" class="w-8 h-8 mb-1"></i>
                    <span>${icon.name}</span>
                </button>
            `).join('');
            
            lucide.createIcons();
        }

        // â˜…æ–°è¦è¿½åŠ â˜… è§£ç¦æ¸ˆã¿ã‚²ãƒ¼ãƒ ã‚’breakIconsã«åŒæœŸã•ã›ã‚‹é–¢æ•°
        function syncGamesToBreakIcons() {
            state.profile.unlockedGames.forEach(gameId => {
                // ã™ã§ã«breakIconsã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const exists = state.breakIcons.find(icon => icon.id === gameId);
                
                if (!exists) {
                    const game = initialData.games[gameId];
                    if (game) {
                        // æ–°ã—ãbreakIconsã«è¿½åŠ  (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤ºON)
                        state.breakIcons.push({
                            id: gameId,
                            name: game.name,
                            icon: game.icon,
                            url: game.url,
                            openMode: 'iframe', // ã‚²ãƒ¼ãƒ ã¯iframeã§é–‹ã
                            type: 'game',
                            visible: true
                        });
                    }
                }
            });
            // ä¿å­˜
            saveState();
        }

        // --- 6. ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ è¨­å®šã‚µãƒ–ãƒšãƒ¼ã‚¸ (æ–°è¦è¿½åŠ ) ---
            const breakSettingsPage = new SubPage('break-settings-screen', {
                onOpen: () => {
                    const activeContainer = $('#break-active-list');
                    const inactiveContainer = $('#break-inactive-list');
                    
                    if (!activeContainer || !inactiveContainer) return;
        
                    activeContainer.innerHTML = '';
                    inactiveContainer.innerHTML = '';
        
                    // 1. ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºä¸­ã¨éè¡¨ç¤ºã«åˆ†ã‘ã‚‹
                    const activeIcons = state.breakIcons.filter(i => i.visible);
                    const inactiveIcons = state.breakIcons.filter(i => !i.visible);
        
                    // 2. è¡¨ç¤ºä¸­ãƒªã‚¹ãƒˆã®æç”» (å‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ã)
                    if (activeIcons.length === 0) {
                        activeContainer.innerHTML = '<p class="text-xs text-gray-500 text-center py-4 bg-white dark:bg-gray-700 rounded-lg border border-dashed border-gray-300 dark:border-gray-600">è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    } else {
                        activeContainer.innerHTML = activeIcons.map(icon => `
                            <div class="break-settings-item flex items-center bg-white dark:bg-gray-700 p-3 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600 mb-2 touch-none" data-id="${icon.id}">
                                <div class="break-settings-handle p-2 mr-1 cursor-grab active:cursor-grabbing text-gray-400">
                                     <i data-lucide="grip-vertical" class="w-6 h-6"></i>
                                </div>
                                <div class="flex items-center justify-center w-8 h-8 mr-3 text-gray-600 dark:text-gray-300">
                                    <i data-lucide="${icon.icon}" class="w-6 h-6"></i>
                                </div>
                                <span class="text-gray-800 dark:text-gray-200 flex-grow text-sm font-bold truncate">${icon.name}</span>
                                <button class="remove-break-btn p-2 rounded-full text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 transition flex-shrink-0">
                                    <i data-lucide="minus-circle" class="w-5 h-5"></i>
                                </button>
                            </div>
                        `).join('');
                    }
        
                    // 3. è¿½åŠ å¯èƒ½ãƒªã‚¹ãƒˆã®æç”» (è¿½åŠ ãƒœã‚¿ãƒ³ä»˜ã)
                    if (inactiveIcons.length === 0) {
                        inactiveContainer.innerHTML = '<p class="text-xs text-gray-500 w-full text-center py-2">ã™ã¹ã¦è¿½åŠ æ¸ˆã¿ã§ã™</p>';
                    } else {
                        inactiveContainer.innerHTML = inactiveIcons.map(icon => `
                            <button class="add-break-btn flex items-center space-x-2 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600 px-3 py-2 rounded-full transition shadow-sm" data-id="${icon.id}">
                                <i data-lucide="plus" class="w-4 h-4 text-green-500"></i>
                                <span class="text-sm text-gray-700 dark:text-gray-300">${icon.name}</span>
                            </button>
                        `).join('');
                    }
        
                    // ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ
                    lucide.createIcons({ root: activeContainer });
                    lucide.createIcons({ root: inactiveContainer });
        
                    // 4. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼šå‰Šé™¤ãƒœã‚¿ãƒ³
                    activeContainer.querySelectorAll('.remove-break-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const itemId = e.target.closest('.break-settings-item').dataset.id;
                            const icon = state.breakIcons.find(i => i.id === itemId);
                            if (icon) {
                                icon.visible = false;
                                saveState();
                                breakSettingsPage.onOpen(); // å†æç”» (è‡ªåˆ†è‡ªèº«ã‚’å‘¼ã¶)
                            }
                        });
                    });
        
                    // 5. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼šè¿½åŠ ãƒœã‚¿ãƒ³
                    inactiveContainer.querySelectorAll('.add-break-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const itemId = btn.dataset.id;
                            const icon = state.breakIcons.find(i => i.id === itemId);
                            if (icon) {
                                icon.visible = true;
                                saveState();
                                breakSettingsPage.onOpen(); // å†æç”»
                            }
                        });
                    });
        
                    // 6. Sortable.js ã®é©ç”¨
                    if (breakSortable) breakSortable.destroy();
                    
                    breakSortable = Sortable.create(activeContainer, {
                        handle: '.break-settings-handle',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        delay: 100, 
                        delayOnTouchOnly: true,
                        touchStartThreshold: 5,
                        onEnd: (evt) => {
                            const idOrder = Array.from(activeContainer.children).map(child => child.dataset.id);
                            const sortedActive = idOrder.map(id => state.breakIcons.find(i => i.id === id)).filter(Boolean);
                            const inactive = state.breakIcons.filter(i => !i.visible);
                            
                            state.breakIcons = [...sortedActive, ...inactive];
                            saveState();
                        }
                    });
                }
            });
            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ç´ä»˜ã‘
            $('#close-break-settings-btn').addEventListener('click', () => breakSettingsPage.close());

        /* â–²â–²â–² è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®é–¢æ•°ç¾¤ â–²â–²â–² */
        
            
            const restoreFocusState = () => {
            // ä¿å­˜ã•ã‚ŒãŸå®Ÿè¡Œä¸­ã®ã‚¿ã‚¤ãƒãƒ¼/SWãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
            if (!state.focus.isRunning || !state.focus.startTime) {
                setTimer(1800);
                return;
            }
        
            const elapsed = Math.floor((Date.now() - state.focus.startTime) / 1000); // çµŒéæ™‚é–“ï¼ˆç§’ï¼‰
        
            // å¾©å…ƒã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦UIã‚’æ›´æ–°
            updateFocusModeUI();
        
            if (state.focus.mode === 'timer') {
                const timeLeft = state.focus.duration - elapsed;
        
                if (timeLeft <= 0) {
                    // å¾©å…ƒæ™‚ã«ã¯ã‚¿ã‚¤ãƒãƒ¼ãŒæ—¢ã«çµ‚äº†ã—ã¦ã„ã‚‹å ´åˆ
                    showToast('ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã„ã‚‹é–“ã«ã‚¿ã‚¤ãƒãƒ¼ãŒçµ‚äº†ã—ã¾ã—ãŸ');
                    new Notification('StudyQuest', { body: 'é›†ä¸­ã‚¿ã‚¤ãƒãƒ¼ãŒçµ‚äº†ã—ã¦ã„ã¾ã—ãŸã€‚' }); // é€šçŸ¥ã‚‚å‡ºã™
                    recordSession('ã‚¿ã‚¤ãƒãƒ¼', state.focus.duration);
                    addLP(Math.floor(state.focus.duration / 60), 'ã‚¿ã‚¤ãƒãƒ¼å®Œäº†');
                    resetTimerUI();
                    // çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                    state.focus.isRunning = false;
                    state.focus.startTime = null;
                    saveState();
                    setTimer(1800); // æ¬¡ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
                } else {
                    // ã‚¿ã‚¤ãƒãƒ¼ã‚’å¾©å…ƒ
                    focusTimer.timeLeft = timeLeft;
                    focusTimer.defaultTime = state.focus.duration;
                    focusTimer.isRunning = true;
        
                    $('#focus-timer-display').textContent = formatTime(timeLeft);
                    $('#focus-start-btn').classList.add('hidden');
                    $('#focus-controls').classList.remove('hidden');
                    $('#timer-settings-container').classList.add('hidden');
        
                    focusTimer.interval = setInterval(timerTick, 1000);
                    updateMiniTimer();
                }
            } else { // ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã®å ´åˆ
                stopwatch.elapsedTime = elapsed;
                stopwatch.startTime = state.focus.startTime;
                stopwatch.isRunning = true;
        
                $('#stopwatch-display').textContent = formatStopwatchTime(elapsed);
                $('#stopwatch-start-btn').classList.add('hidden');
                $('#stopwatch-controls').classList.remove('hidden');
        
                stopwatch.interval = setInterval(stopwatchTick, 100);
                updateMiniTimer();
            }
        };

            // ==========================================
            // â–¼â–¼â–¼ æ–°è¦è¿½åŠ : ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
            // ==========================================

            // 1. ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®åˆ†å²å‡¦ç† (inité–¢æ•°ã®æœ€å¾Œã§å‘¼ã¶)
            const checkUserRegistration = () => {
                const splash = document.getElementById('splash-screen');
                
                if (!state.user.isRegistered) {
                    $('#app-container').classList.add('hidden');
                    
                } else {
                    // ç™»éŒ²æ¸ˆã¿ãªã‚‰é€šå¸¸é€šã‚Š
                    $('#app-container').classList.remove('hidden');
                    // æ—¢å­˜ã®ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå‡¦ç†ã«ä»»ã›ã‚‹
                }
            };

            // 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            
            // Welcomeç”»é¢
            $('#btn-start-new').addEventListener('click', () => {
                // Welcomeç”»é¢ã‚’éš ã™
                $('#welcome-screen').classList.add('hidden');
                
                // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                $('#reg-name').value = '';
                $('#reg-grade').value = '';
                $('#reg-complete-btn').disabled = true; // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–

                // ç™»éŒ²ç”»é¢ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
                const regScreen = $('#registration-screen');
                regScreen.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                regScreen.classList.add('opacity-100', 'pointer-events-auto', 'scale-100');
            });
            
            // â˜…ä¿®æ­£: Welcomeç”»é¢ã‹ã‚‰ã€Œå¼•ãç¶™ãã€ã‚’æŠ¼ã—ãŸæ™‚ã®æŒ™å‹•
            $('#btn-transfer-start').addEventListener('click', () => {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                openMigrationModal(true);

                // 1. å³åº§ã«ã€Œå—ä¿¡ç”»é¢ã€ã¸åˆ‡ã‚Šæ›¿ãˆã‚‹
                showMigrationView('migration-receiver-view');

                // 2. ã“ã®ãƒ•ãƒ­ãƒ¼ã®å ´åˆã®ã¿ã€å—ä¿¡ç”»é¢å†…ã®ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                // (é€ä¿¡ç”»é¢ã¸æˆ»ã£ã¦ã‚‚æ„å‘³ãŒãªã„ãŸã‚)
                const backBtn = document.querySelector('#migration-receiver-view .migration-back-step');
                if(backBtn) backBtn.style.display = 'none';

                // 3. PeerJSï¼ˆå—ä¿¡å¾…æ©Ÿï¼‰ã‚’é–‹å§‹ã™ã‚‹
                initPeerReceiver();
            });

            // ç™»éŒ²ç”»é¢
            const emojis = ['ğŸ“','âœï¸','ğŸ”¥','ğŸ±','ğŸ¶','ğŸš€','â­','ğŸ','âš½','ğŸµ','ğŸ¨','ğŸ’»'];
            const getRandomEmoji = () => emojis[Math.floor(Math.random() * emojis.length)];
            
            $('#icon-picker-btn').addEventListener('click', () => {
                $('#reg-icon').value = getRandomEmoji();
            });
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            const checkRegForm = () => {
                const name = $('#reg-name').value.trim();
                const grade = $('#reg-grade').value;
                $('#reg-complete-btn').disabled = !(name && grade);
            };
            $('#reg-name').addEventListener('input', checkRegForm);
            $('#reg-grade').addEventListener('change', checkRegForm);

            $('#reg-complete-btn').addEventListener('click', () => {
                // ä¸€æ™‚ä¿å­˜ã—ã¦ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¸
                state.user.name = $('#reg-name').value.trim();
                state.user.icon = $('#reg-icon').value;
                state.user.grade = $('#reg-grade').value;
                
                $('#registration-screen').classList.add('hidden');
                $('#tutorial-screen').classList.remove('hidden');
                updateTutorialSlide(0);
            });

            $('#reg-back-btn').addEventListener('click', () => {
                const regScreen = $('#registration-screen');
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§éš ã™
                regScreen.classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                regScreen.classList.add('opacity-0', 'pointer-events-none', 'scale-95');

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«Welcomeç”»é¢ã‚’è¡¨ç¤º
                setTimeout(() => {
                    $('#welcome-screen').classList.remove('hidden');
                }, 300);
            });

            // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
            let tutorialIndex = 0;
            const tutorialSlides = 3; 
            
            function updateTutorialSlide(index) {
                tutorialIndex = index;
                const track = document.getElementById('tutorial-track');
                track.style.transform = `translateX(-${index * 100}%)`;
                
                // ãƒ‰ãƒƒãƒˆæ›´æ–°
                const dots = document.getElementById('tutorial-dots').children;
                Array.from(dots).forEach((dot, i) => {
                    dot.className = `w-2 h-2 rounded-full ${i === index ? 'bg-white' : 'bg-gray-600'}`;
                });
                
                const btn = $('#tutorial-next-btn');
                btn.textContent = index === tutorialSlides - 1 ? 'å§‹ã‚ã‚‹' : 'æ¬¡ã¸';
            }

            $('#tutorial-next-btn').addEventListener('click', () => {
                if (tutorialIndex < tutorialSlides - 1) {
                    updateTutorialSlide(tutorialIndex + 1);
                } else {
                    // å®Œäº†å‡¦ç†
                    state.user.isRegistered = true;

                    // â–¼â–¼â–¼ è¿½åŠ : åˆå›ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ã‚’ä»˜ä¸ã—ã¦ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º â–¼â–¼â–¼
                    addLP(10000, 'åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹', true);
                    state.lastLogin = new Date().toDateString();
                    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

                    saveState();
                    
                    $('#tutorial-screen').classList.add('hidden');
                    $('#app-container').classList.remove('hidden');
                    
                    // ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’æ›´æ–°
                    renderEngine.pages['home-page']();
                    showToast(`ã‚ˆã†ã“ãã€${state.user.name}ã•ã‚“ï¼`);
                }
            });

            // â–¼â–¼â–¼ ã€è¿½åŠ ã€‘ã‚¯ã‚¨ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã®å®šç¾©ï¼ˆã“ã‚ŒãŒæŠœã‘ã¦ã„ã¾ã—ãŸï¼‰ â–¼â–¼â–¼
            const questPage = new SubPage('quest-view', {
                onOpen: () => {
                    renderQuestPlan();
                    lucide.createIcons();
                }
            });

            // ã‚¯ã‚¨ã‚¹ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆFocusãƒšãƒ¼ã‚¸å†…ï¼‰
            const showQuestBtn = document.getElementById('show-quest-btn');
            if (showQuestBtn) {
                showQuestBtn.addEventListener('click', (e) => {
                    // bodyã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¨é‡è¤‡ã—ãªã„ã‚ˆã†ã«ä¼æ’­ã‚’æ­¢ã‚ã‚‹
                    e.stopPropagation(); 
                    questPage.open();
                });
            }

            // ã‚¯ã‚¨ã‚¹ãƒˆæˆ»ã‚‹ãƒœã‚¿ãƒ³
            const questBackBtn = document.getElementById('quest-back-btn');
            if (questBackBtn) {
                questBackBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    questPage.close();
                    updateFocusModeUI(); 
                });
            }
            // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

            // ==========================================
            // â–¼â–¼â–¼ å„ãƒšãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ– (ã“ã“ã ã‘ã§ç®¡ç†ã§ãã¾ã™) â–¼â–¼â–¼
            // ==========================================

            // 1. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢
            const profilePage = new SubPage('profile-screen', {
                onOpen: () => {
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ç‰¹æœ‰ã®æç”»å‡¦ç†
                    $('#edit-profile-icon').value = state.user.icon;
                    $('#edit-profile-name').value = state.user.name;
                    
                    const gradeSelect = $('#edit-profile-grade');
                    // é¸æŠè‚¢ãŒç©ºãªã‚‰ç™»éŒ²ç”»é¢ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ãã‚‹ï¼ˆæœªåˆæœŸåŒ–å¯¾ç­–ï¼‰
                    if (gradeSelect.children.length <= 1) { 
                        const originalOptions = document.getElementById('reg-grade').innerHTML;
                        gradeSelect.innerHTML = originalOptions;
                    }
                    gradeSelect.value = state.user.grade;
                }
            });
            $('#close-profile-btn').addEventListener('click', () => profilePage.close());

            // ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´ãƒœã‚¿ãƒ³ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
            const editIconBtn = document.getElementById('edit-icon-random-btn');
            if (editIconBtn) {
                editIconBtn.addEventListener('click', () => {
                    const emojis = ['ğŸ“','âœï¸','ğŸ”¥','ğŸ±','ğŸ¶','ğŸš€','â­','ğŸ','âš½','ğŸµ','ğŸ¨','ğŸ’»'];
                    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                    document.getElementById('edit-profile-icon').value = randomEmoji;
                });
            }

            // ä¿å­˜ãƒœã‚¿ãƒ³
            const saveProfileBtn = document.getElementById('save-profile-btn');
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', () => {
                    const nameInput = document.getElementById('edit-profile-name');
                    const gradeInput = document.getElementById('edit-profile-grade');
                    const iconInput = document.getElementById('edit-profile-icon');

                    const newName = nameInput.value.trim();
                    const newGrade = gradeInput.value;

                    if (!newName || !newGrade) {
                        showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨å­¦å¹´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        return;
                    }

                    // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                    state.user.name = newName;
                    state.user.grade = newGrade;
                    state.user.icon = iconInput.value;
                    saveState();

                    // è¨­å®šç”»é¢ï¼ˆè¦ªç”»é¢ï¼‰ã®è¡¨ç¤ºã‚’æ›´æ–°
                    // â€»renderEngineãŒå®šç¾©æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’å‰æ
                    if (typeof renderEngine !== 'undefined' && renderEngine.pages['settings-page']) {
                        renderEngine.pages['settings-page']();
                    }

                    showToast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                    profilePage.close();
                });
            }

            // 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢
            const statusPage = new SubPage('status-screen', {
                onOpen: () => {
                    renderStatusPageContent(); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã®æç”»
                }
            });

            const openMigrationBtn = $('#open-migration-menu-btn');
            if (openMigrationBtn) {
                openMigrationBtn.addEventListener('click', () => {
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ã‚’é–‰ã˜ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                    profilePage.close(); 
                    setTimeout(() => openMigrationModal(), 300);
                });
            }

            $$('.status-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.currentTarget.dataset.target; // theme, background, game, music ã®ã„ãšã‚Œã‹

                    // 1. å…¨ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã«ã™ã‚‹ï¼ˆè‰²ã¯ã‚°ãƒ¬ãƒ¼ã«æˆ»ã™ï¼‰
                    $$('.status-tab-btn').forEach(b => {
                        b.classList.remove('active', 'primary-bg', 'text-white');
                        b.classList.add('bg-gray-200', 'dark:bg-gray-600'); 
                    });

                    // 2. ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã«ã™ã‚‹ï¼ˆè‰²ã¯ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼‰
                    e.currentTarget.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                    e.currentTarget.classList.add('active', 'primary-bg', 'text-white');

                    // 3. å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã‚’éš ã™
                    $$('.status-content-section').forEach(section => {
                        section.classList.add('hidden');
                    });

                    // 4. é¸æŠã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã ã‘ã‚’è¡¨ç¤ºã™ã‚‹
                    const targetSection = $(`#status-content-${target}`);
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                    }
                    
                    // ã‚¢ã‚¤ã‚³ãƒ³ã®å†ç”Ÿæˆï¼ˆå¿µã®ãŸã‚ï¼‰
                    lucide.createIcons();
                });
            });
            
            // LPãƒœã‚¿ãƒ³ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã®æ˜Ÿãƒãƒ¼ã‚¯ï¼‰ã‚’æŠ¼ã—ãŸã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã‚’é–‹ã
            $('#lp-button').addEventListener('click', () => statusPage.open());

            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã‚’é–‰ã˜ã‚‹
            $('#close-status-btn').addEventListener('click', () => statusPage.close());

            // ==========================================
            // â–¼â–¼â–¼ PeerJS ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯ (UIå®Œå…¨çµ±åˆç‰ˆ) â–¼â–¼â–¼
            // ==========================================
            
            let peer = null;
            let conn = null;

            // ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
            function showMigrationView(viewId) {
                $$('.migration-view').forEach(el => el.classList.add('hidden'));
                $(`#${viewId}`).classList.remove('hidden');
                lucide.createIcons();
            }

            // å…¨ç”»é¢è¡¨ç¤ºã‚’é–‹ã
            function openMigrationModal(fromWelcomeScreen = false) {
                const screen = $('#migration-screen');
                const closeBtn = $('#close-migration-btn');

                // 1. ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
                // â˜…ä¿®æ­£: ã©ã¡ã‚‰ã®å ´åˆã§ã‚‚ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã¯å¸¸ã«è¡¨ç¤ºã™ã‚‹
                closeBtn.style.visibility = 'visible';
                
                // â˜…è¿½åŠ : ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆé€šå¸¸ã¯è¡¨ç¤ºï¼‰
                $$('.migration-back-step').forEach(btn => btn.style.display = '');

                // 2. è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                screen.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                screen.classList.add('opacity-100', 'pointer-events-auto', 'scale-100');
                
                // 3. åˆæœŸçŠ¶æ…‹ã¸ãƒªã‚»ãƒƒãƒˆ
                showMigrationView('migration-step-1');
                $('#migration-sender-error').classList.add('hidden');
                $('#migration-target-id').value = "";

                $('#migration-my-id').textContent = "...";
                
                if(peer) { peer.destroy(); peer = null; }
            }

            // å…¨ç”»é¢è¡¨ç¤ºã‚’é–‰ã˜ã‚‹
            function closeMigrationModal() {
                const screen = $('#migration-screen');
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§éš ã™
                screen.classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                screen.classList.add('opacity-0', 'pointer-events-none', 'scale-95');

                // æ¥ç¶šç ´æ£„
                if(peer) { peer.destroy(); peer = null; }
                if(conn) { conn.close(); conn = null; }
            }

            $('#close-migration-btn').addEventListener('click', closeMigrationModal);

            // ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒ†ãƒƒãƒ—å†…ï¼‰
            $$('.migration-back-step').forEach(btn => {
                btn.addEventListener('click', () => {
                    if(peer) { peer.destroy(); peer = null; }
                    showMigrationView('migration-step-1');
                });
            });

            // --- ãƒ¢ãƒ¼ãƒ‰é¸æŠ ---
            $('#migration-mode-send').addEventListener('click', () => {
                showMigrationView('migration-sender-view');
                initPeerSender();
            });

            $('#migration-mode-receive').addEventListener('click', () => {
                showMigrationView('migration-receiver-view');
                initPeerReceiver();
            });

            // --- PeerJS ãƒ­ã‚¸ãƒƒã‚¯ ---

            function initPeerSender() {
                peer = new Peer(); 
                peer.on('error', (err) => {
                    console.error(err);
                    showSenderError("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err.type);
                });
            }

            function showSenderError(msg) {
                const errBox = $('#migration-sender-error');
                const errText = $('#migration-sender-error-text');
                errText.textContent = msg;
                errBox.classList.remove('hidden');
            }
            
            // æ¥ç¶šãƒœã‚¿ãƒ³ (é€ä¿¡å´)
            $('#migration-connect-btn').addEventListener('click', () => {
                const targetId = $('#migration-target-id').value.trim().toUpperCase();
                if(!targetId) {
                    showSenderError("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                    return;
                }
                
                const btn = $('#migration-connect-btn');
                btn.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mr-2"></div>æ¥ç¶šä¸­...`;
                btn.disabled = true;
                $('#migration-sender-error').classList.add('hidden'); // ã‚¨ãƒ©ãƒ¼æ¶ˆå»
                
                conn = peer.connect(targetId);
                
                conn.on('open', () => {
                    // æ¥ç¶šæˆåŠŸ -> ç¢ºèªç”»é¢ã¸é·ç§»
                    showMigrationView('migration-confirm-view');
                    btn.innerHTML = `<span>æ¥ç¶šã™ã‚‹</span>`;
                    btn.disabled = false;
                });
                
                conn.on('error', (err) => {
                     btn.innerHTML = `<span>æ¥ç¶šã™ã‚‹</span>`;
                     btn.disabled = false;
                     showSenderError("æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ");
                });

                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–
                setTimeout(() => {
                    if(!conn.open) {
                        btn.innerHTML = `<span>æ¥ç¶šã™ã‚‹</span>`;
                        btn.disabled = false;
                        showSenderError("å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    }
                }, 5000);
            });

            // ç¢ºèªç”»é¢ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«
            $('#migration-confirm-no-btn').addEventListener('click', () => {
                if(conn) conn.close();
                showMigrationView('migration-sender-view');
            });

            // ç¢ºèªç”»é¢ï¼šå®Ÿè¡Œï¼ˆé€ä¿¡ï¼‰
            $('#migration-confirm-yes-btn').addEventListener('click', () => {
                // å‡¦ç†ä¸­ç”»é¢ã¸
                showMigrationView('migration-complete-view');
                $('#migration-complete-title').textContent = "é€ä¿¡ä¸­...";
                $('#migration-complete-msg').textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€ã—ã¦ã„ã¾ã™";

                const dataToSend = JSON.stringify(state);
                conn.send(dataToSend);
                
                // é€ä¿¡å®Œäº†æ¼”å‡º
                setTimeout(() => {
                    $('#migration-spinner').classList.add('hidden');
                    $('#migration-success-icon').classList.remove('hidden');
                    $('#migration-complete-title').textContent = "é€ä¿¡å®Œäº†";
                    $('#migration-complete-msg').textContent = "ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ã—ã¾ã™...";
                    
                    setTimeout(() => {
                        localStorage.removeItem('quizAppUltimateV8');
                        location.reload();
                    }, 2000);
                }, 1000);
            });

            function initPeerReceiver() {
                const myPeerId = Math.random().toString(36).substring(2, 6).toUpperCase(); 
                
                peer = new Peer(myPeerId);
                
                peer.on('open', (id) => {
                    $('#migration-my-id').textContent = id;
                    $('#migration-status-receive').textContent = "æ¥ç¶šå¾…æ©Ÿä¸­...";
                    $('#migration-receiver-indicator').className = "w-2 h-2 bg-yellow-500 rounded-full animate-ping";
                    $('#migration-receiver-status-box').className = "flex items-center space-x-2 text-yellow-500 bg-yellow-50 dark:bg-yellow-900/20 px-4 py-2 rounded-full transition-colors";
                });
                
                peer.on('connection', (c) => {
                    $('#migration-status-receive').textContent = "ãƒ‡ãƒ¼ã‚¿å—ä¿¡ä¸­...";
                    $('#migration-receiver-indicator').className = "w-2 h-2 bg-green-500 rounded-full animate-bounce";
                    $('#migration-receiver-status-box').className = "flex items-center space-x-2 text-green-500 bg-green-50 dark:bg-green-900/20 px-4 py-2 rounded-full transition-colors";
                    
                    c.on('data', (data) => {
                        try {
                            const receivedState = JSON.parse(data);
                            if(receivedState.profile && receivedState.user) {
                                // å—ä¿¡å®Œäº†ç”»é¢ã¸
                                showMigrationView('migration-complete-view');
                                $('#migration-spinner').classList.add('hidden');
                                $('#migration-success-icon').classList.remove('hidden');
                                $('#migration-complete-title').textContent = "å¼•ç¶™ãå®Œäº†ï¼";
                                $('#migration-complete-msg').textContent = "ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¾ã™...";

                                localStorage.setItem('quizAppUltimateV8', data);
                                setTimeout(() => location.reload(), 2000);
                            }
                        } catch(e) {
                            console.error(e);
                            alert('ãƒ‡ãƒ¼ã‚¿ç ´æã‚¨ãƒ©ãƒ¼'); // ã“ã“ã ã‘ã¯è‡´å‘½çš„ãªã®ã§alertã§OKï¼ˆã‚ã‚‹ã„ã¯ã‚¨ãƒ©ãƒ¼ç”»é¢ã‚’ä½œã‚‹ï¼‰
                            showMigrationView('migration-step-1');
                        }
                    });
                });
                
                peer.on('error', (err) => {
                     if(err.type === 'unavailable-id') {
                         initPeerReceiver(); 
                     } else {
                         $('#migration-status-receive').textContent = "ã‚¨ãƒ©ãƒ¼: " + err.type;
                         $('#migration-receiver-indicator').className = "w-2 h-2 bg-red-500 rounded-full";
                     }
                });
            }

            // ==========================================
            // â–²â–²â–² æ–°è¦è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯çµ‚äº† â–²â–²â–²
            // ==========================================

            // â˜…æ–°è¦è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®å¾©å…ƒãƒã‚§ãƒƒã‚¯é–¢æ•°
            const checkQuestResume = () => {
                if (state.savedQuest && state.savedQuest.active) {
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                    const modal = $('#resume-quest-modal');
                    modal.classList.remove('hidden');
                    
                    // ã€Œå†é–‹ã™ã‚‹ã€ãƒœã‚¿ãƒ³
                    $('#resume-quest-yes-btn').onclick = () => {
                        modal.classList.add('hidden');
                        resumeQuestProcess();
                    };

                    // ã€Œçµ‚äº†ã—ã¦ãƒ›ãƒ¼ãƒ ã¸ã€ãƒœã‚¿ãƒ³
                    $('#resume-quest-no-btn').onclick = () => {
                        modal.classList.add('hidden');

                        // â˜…è¿½åŠ : ä¸­æ–­ã¨ã—ã¦ãƒ­ã‚°ã«è¨˜éŒ²ã™ã‚‹å‡¦ç†
                        const saved = state.savedQuest;
                        const currentStep = saved.plan[saved.currentIndex];
                        
                        // å®Ÿéš›ã«çµŒéã—ãŸæ™‚é–“ï¼ˆé–‹å§‹ã€œç¾åœ¨ï¼‰ã‚’è¨ˆç®—
                        const now = Date.now();
                        const elapsedSeconds = Math.floor((now - saved.startTime) / 1000);
                        
                        // ã‚‚ã—ã‚¹ãƒ†ãƒƒãƒ—ã®äºˆå®šæ™‚é–“ã‚’è¶…ãˆã¦ã„ãŸã‚‰ã€äºˆå®šæ™‚é–“åˆ†ã ã‘è¨˜éŒ²ï¼ˆå®Œäº†æ‰±ã„ï¼‰
                        // è¶…ãˆã¦ã„ãªã‘ã‚Œã°ã€çµŒéæ™‚é–“åˆ†ã ã‘è¨˜éŒ²ï¼ˆä¸­æ–­æ‰±ã„ï¼‰
                        const actualDuration = Math.min(elapsedSeconds, currentStep.duration);

                        if (currentStep.type === 'section' && actualDuration > 0) {
                            const statusText = (elapsedSeconds >= currentStep.duration) ? '(ä¸åœ¨ä¸­å®Œäº†)' : '(ä¸­æ–­)';
                            recordSession(currentStep.text + statusText, actualDuration);
                            
                            // å°‘ã—ã ã‘LPã‚’ã‚ã’ã‚‹ï¼ˆä»»æ„ï¼‰
                            if (actualDuration > 60) {
                                addLP(Math.floor(actualDuration / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆçµ‚äº†');
                            }
                        }
                        
                        state.savedQuest = null;
                        saveState();
                        showToast('ã‚¯ã‚¨ã‚¹ãƒˆã‚’ç ´æ£„ã—ã¾ã—ãŸ');
                    };
                }
            };

            // â˜…æ–°è¦è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆå¾©å…ƒå®Ÿè¡Œãƒ—ãƒ­ã‚»ã‚¹
            const resumeQuestProcess = () => {
                const saved = state.savedQuest;
                quest.plan = saved.plan;
                quest.currentIndex = saved.currentIndex;
                quest.active = true;
                updateBackgrounds();

                // UIåˆ‡ã‚Šæ›¿ãˆ
                $('header').style.display = 'none';
                $('nav').style.display = 'none';
                $('#mini-timer-container').classList.remove('visible');
                $('#quest-active-screen').style.display = 'flex';
                document.body.style.overflow = 'hidden';

                const currentStep = quest.plan[quest.currentIndex];
                
                // çµŒéæ™‚é–“ã‚’è¨ˆç®—
                const now = Date.now();
                const elapsedSinceStart = Math.floor((now - saved.startTime) / 1000);
                const remaining = currentStep.duration - elapsedSinceStart;

                if (remaining <= 0) {
                    // è£ã§çµ‚ã‚ã£ã¦ã„ãŸå ´åˆ
                    showToast('é–‰ã˜ã¦ã„ã‚‹é–“ã«ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚');
                    // ãƒ­ã‚°è¨˜éŒ²ãªã©ã¯çœç•¥ã—ã¦ã€å¼·åˆ¶çš„ã«æ¬¡ã¸é€²ã‚ã‚‹ã‹ã€å®Œäº†æ‰±ã„ã«ã™ã‚‹
                    // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œå®Œäº†ã€ã¨ã—ã¦æ¬¡ã¸
                    if (currentStep.type === 'section') {
                        // ãƒ­ã‚°ã ã‘è¨˜éŒ²ã—ã¦ãŠã
                        recordSession(currentStep.text + '(ä¸­æ–­)', currentStep.duration);
                        state.focus.totalTime += currentStep.duration;
                        addLP(Math.floor(currentStep.duration / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³');
                        saveState();
                    }
                    // æ¬¡ã¸
                    runNextQuestStep();
                } else {
                    // ã¾ã ç¶šã„ã¦ã„ã‚‹å ´åˆ -> ãã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é€”ä¸­ã‹ã‚‰å†é–‹
                    // executeQuestStepã‚’å‘¼ã¶ã¨ã‚¿ã‚¤ãƒãƒ¼ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã®ã§ã€
                    // æ‰‹å‹•ã§UIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ startQuestTimer ã‚’å‘¼ã¶
                    setupResumedStep(currentStep, remaining);
                }
            };

            // â˜…æ–°è¦è¿½åŠ : é€”ä¸­ã‹ã‚‰ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‹å§‹ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
            const setupResumedStep = (step, timeLeft) => {
                cancelQuestAlarm(); // å¿µã®ãŸã‚

                if (step.type === 'section') {
                    playBGM();
                    questSectionView.style.display = 'flex';
                    questBreakView.style.display = 'none';
                    questSectionTitle.textContent = step.text;
                    const totalSections = quest.plan.filter(p => p.type === 'section').length;
                    const currentSectionNumber = quest.plan.slice(0, quest.currentIndex + 1).filter(p => p.type === 'section').length;
                    questProgressEl.textContent = `${currentSectionNumber} / ${totalSections}`;
                    
                    // ã‚¿ã‚¤ãƒãƒ¼å†é–‹
                    startQuestTimer(
                        timeLeft, // æ®‹ã‚Šæ™‚é–“ã§é–‹å§‹
                        (t) => { questTimerEl.textContent = formatTime(t); },
                        () => {
                            // çµ‚äº†æ™‚ã®å‡¦ç†ï¼ˆexecuteQuestStepã®ä¸­èº«ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ï¼‰
                            // ç°¡ç•¥åŒ–ã®ãŸã‚å…±é€šéƒ¨åˆ†ã‚’é–¢æ•°åŒ–ã™ã‚‹ã‹ã€ã“ã“ã«ã‚³ãƒ”ãƒ¼
                            const elapsed = step.duration; // æº€äº†æ‰±ã„
                            recordSession(step.text, elapsed);
                            addLP(Math.floor(elapsed / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³');
                            state.focus.totalTime += elapsed;
                            if (step.originalTaskId) {
                                const tIndex = state.tasks.findIndex(t => t.id === parseInt(step.originalTaskId));
                                if (tIndex !== -1) state.tasks[tIndex].completed = true;
                            }
                            saveState();
                            showToast('ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
                            runNextQuestStep();
                        }
                    );
                } else {
                    // ä¼‘æ†©ã®å ´åˆ
                    pauseBGM();
                    questSectionView.style.display = 'none';
                    questBreakView.style.display = 'flex';
                    renderBreakIcons();
                    
                    startQuestTimer(
                        timeLeft,
                        (t) => { breakTimerEl.textContent = formatTime(t); },
                        () => {
                            showToast('ä¼‘æ†©ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚');
                            closeIframe();
                            runNextQuestStep();
                        }
                    );
                }
                lucide.createIcons();
            };

            const init = () => {
                if (window.Chart) {
                    Chart.defaults.font.family = "'LINE Seed JP', 'Inter', 'Noto Sans JP', sans-serif";
                }
Â  Â  Â  Â  Â  Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.register('sw.js')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(registration => console.log('Service Workerç™»éŒ²æˆåŠŸ:', registration))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => console.log('Service Workerç™»éŒ²å¤±æ•—:', error));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â // â˜…è¿½åŠ : ç”»é¢ã®ä»–ã®å ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰é–‹ã„ã¦ã„ã‚‹ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹å‡¦ç†
                document.addEventListener('touchstart', (e) => {
                    // ã‚¿ãƒƒãƒ—ã•ã‚ŒãŸè¦ç´ ãŒã€Œé–‹ã„ã¦ã„ã‚‹ã‚¹ãƒ¯ã‚¤ãƒ—ã‚³ãƒ³ãƒ†ãƒŠã€ã®å†…éƒ¨ã§ãªã‘ã‚Œã°é–‰ã˜ã‚‹
                    const openContainers = document.querySelectorAll('.swipe-container.swiped-open');
                    
                    openContainers.forEach(container => {
                        // ã‚³ãƒ³ãƒ†ãƒŠè‡ªèº«ã‚„ãã®å­è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒœã‚¿ãƒ³æ“ä½œãªã©ã®ãŸã‚ï¼‰
                        if (container.contains(e.target)) return;

                        // ãã‚Œä»¥å¤–ï¼ˆå¤–å´ï¼‰ã‚’ã‚¿ãƒƒãƒ—ã—ãŸå ´åˆã¯é–‰ã˜ã‚‹
                        const content = container.querySelector('.swipe-content');
                        if (content) {
                            content.style.transform = 'translateX(0px)';
                            container.classList.remove('swiped-open');
                        }
                    });
                }, { passive: true });
                
Â  Â  Â  Â  Â  Â  Â  Â  loadState();

                syncGamesToBreakIcons();

                // 1. æ–°ã—ã„DOMè¦ç´ ã‚’å¤‰æ•°ã«å‰²ã‚Šå½“ã¦
                homeTaskListEl = $('#home-task-list');
                newTaskInput = $('#new-task-input');
                newTaskNumberEl = $('#new-task-number');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒšãƒ¼ã‚¸æç”»ã®å‰ã«ã‚¿ã‚¤ãƒãƒ¼ã®çŠ¶æ…‹ã‚’å¾©å…ƒãƒ»è¨­å®šã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  restoreFocusState();
                checkQuestResume();  // â˜…è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®å¾©å…ƒãƒã‚§ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // å…¨ã¦ã®ãƒšãƒ¼ã‚¸ã‚’æç”»
Â  Â  Â  Â  Â  Â  Â  Â  renderEngine.renderAll();
                
                // 2. Sortable.js ã®åˆæœŸåŒ– (ä»Šæ—¥ã®äºˆå®š)
                if (homeTaskListEl) {
                    Sortable.create(homeTaskListEl, {
                        handle: '.task-handle', 
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        delay: 200, // â˜…é‡è¦: 200msé•·æŠ¼ã—ã—ãªã„ã¨ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã—ãªã„
                        delayOnTouchOnly: true, // ã‚¿ãƒƒãƒæ“ä½œã®æ™‚ã ã‘é…å»¶ã•ã›ã‚‹ï¼ˆãƒã‚¦ã‚¹ã¯å³æ™‚ï¼‰
                        touchStartThreshold: 5, // 5pxä»¥ä¸Šå‹•ã„ãŸã‚‰ã‚¿ãƒƒãƒ—ã§ã¯ãªããƒ‰ãƒ©ãƒƒã‚°åˆ¤å®šï¼ˆèª¤å‹•ä½œé˜²æ­¢ï¼‰
                        filter: '.swiped-open, .is-swiping, .swipe-deleting', // â˜…è¿½åŠ : ã“ã‚Œã‚‰ãŒä»˜ã„ã¦ã„ã‚‹è¦ç´ ã¯ä¸¦ã³æ›¿ãˆä¸å¯
                        onEnd: (evt) => { /* ä¸­èº«ã¯å¤‰æ›´ãªã— */
                            const item = state.tasks.splice(evt.oldIndex, 1)[0];
                            state.tasks.splice(evt.newIndex, 0, item);
                            saveState();
                            renderHomeTasks(); 
                        }
                    });

                    // 3. ã‚¿ã‚¹ã‚¯å‰Šé™¤ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»)
                    homeTaskListEl.addEventListener('click', (e) => {
                        const deleteBtn = e.target.closest('.delete-task-btn');
                        if (deleteBtn) {
                            const taskItem = deleteBtn.closest('.task-item');
                            const taskId = parseInt(taskItem.dataset.id);
                            state.tasks = state.tasks.filter(t => t.id !== taskId);
                            saveState();
                            renderHomeTasks();
                        }
                    });
                }

                // 4. æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ  (Enterã‚­ãƒ¼)
                if (newTaskInput) {
                    newTaskInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && e.target.value.trim() !== '') {
                            state.tasks.push({ id: Date.now(), text: e.target.value.trim() });
                            e.target.value = '';
                            saveState();
                            renderHomeTasks();
                        }
                    });
                }

                 // Sortable.js ã®åˆæœŸåŒ– (ã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ©ãƒ³)
                    if (questPlanListEl) { // questPlanListEl ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©æ¸ˆã¿
                        Sortable.create(questPlanListEl, {
                            handle: '.quest-handle', // ã‚¯ã‚¨ã‚¹ãƒˆã®ãƒãƒ³ãƒ‰ãƒ«
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            delay: 200, // â˜…è¿½åŠ 
                            delayOnTouchOnly: true, // â˜…è¿½åŠ 
                            touchStartThreshold: 5, // â˜…è¿½åŠ 
                            filter: '.swiped-open, .is-swiping, .swipe-deleting', // â˜…è¿½åŠ 
                            onEnd: (evt) => {
                                // quest.plan é…åˆ—ã‚’ä¸¦ã³æ›¿ãˆ
                                // (quest.plan ã¯ state ã«ä¿å­˜ã•ã‚Œãªã„ä¸€æ™‚çš„ãªã‚‚ã®)
                                const item = quest.plan.splice(evt.oldIndex, 1)[0];
                                quest.plan.splice(evt.newIndex, 0, item);
                                renderQuestPlan(); // ç•ªå·ã‚’æŒ¯ã‚Šç›´ã™ãŸã‚ã«å†æç”»
                            }
                        });
                    }
                
                // 5. ã€Œä»Šæ—¥ã®äºˆå®šã€èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
Â  Â  Â  Â  Â  Â  Â  Â  const loadTasksBtn = $('#load-tasks-btn');
                if (loadTasksBtn) {
                    loadTasksBtn.addEventListener('click', () => {
                        // å®Œäº†ã—ã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦èª­ã¿è¾¼ã‚€
                        const activeTasks = state.tasks.filter(t => !t.completed);

                        if (activeTasks.length === 0) {
                            showToast('ã€Œä»Šæ—¥ã®äºˆå®šã€ã«æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                            // quest.plan = []; // æ—¢å­˜ã®ãƒ—ãƒ©ãƒ³ã‚’æ¶ˆã—ãŸããªã„å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
                        } else {
                            // state.tasks ã‚’ quest.plan ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                            quest.plan = activeTasks.map(task => ({
                                id: Date.now() + Math.random(),
                                type: 'section',
                                text: task.text,
                                duration: 25 * 60,
                                originalTaskId: task.id
                            }));
                            showToast(`${activeTasks.length} ä»¶ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
                        }
                        renderQuestPlan();
                    });
                }
                
Â  Â  Â  Â  Â  Â  Â  Â  // æœ€å¾Œã«å¤–è¦³ã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  $('#background-scope-toggle').checked = state.settings.backgroundScopeGlobal;
Â  Â  Â  Â  Â  Â  Â  Â  updateAppearance();

                checkUserRegistration();
                
                // â–¼â–¼â–¼ å¤‰æ›´ï¼ˆinitã®æœ€å¾Œã«lucideã‚’1å›å®Ÿè¡Œï¼‰ â–¼â–¼â–¼
                lucide.createIcons();
                    setTimeout(() => {
                        // ã‚‚ã—æœªç™»éŒ²ãªã‚‰ã€ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ãŒæ¶ˆãˆã‚‹ç›´å‰ã«ã€Œã‚ˆã†ã“ãç”»é¢ã€ã‚’è£ã§è¡¨ç¤ºçŠ¶æ…‹ã«ã™ã‚‹
                        if (!state.user.isRegistered) {
                            $('#welcome-screen').classList.remove('hidden');
                        }
                    
                        const splash = document.getElementById('splash-screen');
                        if (splash) {
                            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹
                            splash.classList.add('opacity-0');
                            
                            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤º
                            setTimeout(() => {
                                splash.style.display = 'none';
                            }, 500);
                        }
                    }, 1500); // 1.5ç§’å¾…ã£ã¦ã‹ã‚‰ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹
Â  Â  Â  Â  Â  Â  };

            // â–¼â–¼â–¼ ä¿®æ­£: ç¬¬4å¼•æ•°ã« onSuccess (æˆåŠŸæ™‚ã®å‡¦ç†) ã‚’è¿½åŠ  â–¼â–¼â–¼
            const purchaseItem = (id, type, cost, onSuccess) => {
                if (state.profile.lp < cost) {
                    showToast('LPãŒè¶³ã‚Šã¾ã›ã‚“');
                    return;
                }
                state.profile.lp -= cost;
                
                let itemData = null;

                if (type === 'theme') {
                    state.profile.unlockedThemes.push(id);
                    itemData = initialData.themes[id];
                } 
                else if (type === 'background') {
                    state.profile.unlockedBackgrounds.push(id);
                    itemData = initialData.backgrounds[id];
                } 
                else if (type === 'game') {
                    state.profile.unlockedGames.push(id);
                    itemData = initialData.games[id];
                } 
                else if (type === 'music') {
                    state.profile.unlockedMusic.push(id);
                    itemData = initialData.music[id];
                }
                
                saveState();
                updateLpDisplay();
                
                if(type === 'game') syncGamesToBreakIcons();

                renderStatusPageContent();
                
                if (itemData) {
                    showItemPopup(itemData, type);
                }

                // â–¼â–¼â–¼ è¿½åŠ : è³¼å…¥æˆåŠŸæ™‚ã«ã€æ¸¡ã•ã‚ŒãŸé–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ â–¼â–¼â–¼
                if (onSuccess) {
                    onSuccess();
                }
            };

                const applyItem = (id, type) => {
                    if (type === 'theme') {
                        state.profile.activeTheme = id;
                        // è‰²ã‚’å³åº§ã«åæ˜ ã•ã›ã‚‹å‡¦ç†
                        const theme = initialData.themes[id];
                        if (theme) {
                            document.documentElement.style.setProperty('--primary-color', theme.color);
                            document.documentElement.style.setProperty('--primary-color-hover', theme.hover);
                        }
                    } else if (type === 'background') {
                        state.profile.activeBackground = id;
                        updateAppearance();  // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç­‰ã®æ›´æ–°
                        updateBackgrounds(); // èƒŒæ™¯ç”»åƒã®æ›´æ–°
                    }
                    saveState();
                    renderStatusPageContent(); // å†æç”»ã—ã¦ã€Œé©ç”¨ä¸­ã€è¡¨ç¤ºã«ã™ã‚‹
                    showToast('é©ç”¨ã—ã¾ã—ãŸ');
                };
            
            const renderStatusPageContent = () => {
                // LPè¡¨ç¤ºæ›´æ–°
                $('#status-lp-display').textContent = state.profile.lp;

                // å…±é€šã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©
                const createItemHTML = (id, item, type, isUnlocked, isActive) => {
                    let iconHTML = '';
                    let statusBadge = '';
                    // é¸æŠä¸­ï¼ˆé©ç”¨ä¸­ï¼‰ã®æ ç·šã‚¹ã‚¿ã‚¤ãƒ«
                    let activeClass = isActive ? 'border-blue-500 ring-2 ring-blue-500 ring-offset-2 dark:ring-offset-gray-900' : 'border-transparent';

                    // â–¼â–¼â–¼ ä¿®æ­£: è§£æ”¾æ¸ˆã¿ãƒãƒƒã‚¸ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’çµ±ä¸€ï¼ˆãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ï¼‰ â–¼â–¼â–¼
                    // bg-white/90 (èƒŒæ™¯) + primary-text (ãƒ†ãƒ¼ãƒè‰²ã®ã‚¢ã‚¤ã‚³ãƒ³)
                    const checkMarkBadge = `<div class="absolute top-1 right-1 bg-white/90 dark:bg-gray-800/90 rounded-full p-1 shadow-sm z-10"><i data-lucide="check" class="w-3 h-3 primary-text"></i></div>`;

                    // ã‚¿ã‚¤ãƒ—ã”ã¨ã®è¦‹ãŸç›®è¨­å®š
                    if (type === 'theme') {
                        iconHTML = `<div class="w-full h-full rounded-full" style="background-color: ${item.color}"></div>`;
                        if (isUnlocked) statusBadge = `<div class="absolute -bottom-1 -right-1 bg-white dark:bg-gray-800 rounded-full p-1 shadow"><i data-lucide="check" class="w-4 h-4 text-green-500"></i></div>`;
                    } else if (type === 'background') {
                        const style = item.url ? `background-image: url(${item.url})` : 'background-color: #6b7280;';
                        iconHTML = `<div class="w-full h-full bg-cover bg-center rounded-lg" style="${style}"></div>`;
                        activeClass = isActive ? 'ring-4 ring-blue-500' : ''; 
                        if (isUnlocked) statusBadge = checkMarkBadge; // å£ç´™ã‚‚çµ±ä¸€
                    } else if (type === 'game') {
                        iconHTML = `<i data-lucide="${item.icon}" class="w-8 h-8 text-indigo-500"></i>`;
                        if (isUnlocked) statusBadge = checkMarkBadge; // ã‚²ãƒ¼ãƒ : ä¿®æ­£
                    } else if (type === 'music') {
                        iconHTML = `<i data-lucide="music" class="w-8 h-8 text-pink-500"></i>`;
                        if (isUnlocked) statusBadge = checkMarkBadge; // éŸ³æ¥½: ä¿®æ­£
                    }

                    // ã‚³ãƒ³ãƒ†ãƒŠã®å½¢çŠ¶
                    const containerClass = (type === 'theme') ? 'w-16 h-16 rounded-full' : 'w-full aspect-square rounded-xl';
                    const wrapperClass = (type === 'background') ? 'w-full aspect-[9/16]' : '';

                    // ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®è¡¨ç¤º
                    const overlayShape = (type === 'theme') ? 'rounded-full' : 'rounded-xl';
                    const lockOverlay = !isUnlocked ? `<div class="absolute inset-0 bg-black/40 flex flex-col items-center justify-center ${overlayShape} text-white"><i data-lucide="lock" class="w-5 h-5 mb-1"></i><span class="text-xs font-bold">${item.cost}</span></div>` : '';
                    
                    return `
                        <div class="text-center cursor-pointer item-btn group relative" data-id="${id}" data-type="${type}">
                            <div class="${containerClass} ${wrapperClass} mx-auto relative ${activeClass} transition-transform active:scale-95 bg-gray-200 dark:bg-gray-700 flex items-center justify-center border-2 border-transparent">
                                ${iconHTML}
                                ${lockOverlay}
                                ${statusBadge}
                            </div>
                            <p class="text-xs mt-2 font-bold truncate px-1">${item.name}</p>
                        </div>
                    `;
                };

                // å„ãƒªã‚¹ãƒˆã®æç”»
                $('#status-theme-list').innerHTML = Object.entries(initialData.themes).map(([id, theme]) => {
                    return createItemHTML(id, theme, 'theme', state.profile.unlockedThemes.includes(id), state.profile.activeTheme === id);
                }).join('');

                $('#status-background-list').innerHTML = Object.entries(initialData.backgrounds).map(([id, bg]) => {
                    return createItemHTML(id, bg, 'background', state.profile.unlockedBackgrounds.includes(id), state.profile.activeBackground === id);
                }).join('');

                $('#status-game-list').innerHTML = Object.entries(initialData.games).map(([id, game]) => {
                    return createItemHTML(id, game, 'game', state.profile.unlockedGames.includes(id), false);
                }).join('');

                $('#status-music-list').innerHTML = Object.entries(initialData.music).map(([id, music]) => {
                    return createItemHTML(id, music, 'music', state.profile.unlockedMusic.includes(id), false);
                }).join('');

                lucide.createIcons();

                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                $$('.item-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const { id, type } = btn.dataset;
                        openItemDetailScreen(id, type);
                    });
                });
            };

            // ==========================================
            // â–¼â–¼â–¼ ã‚¢ã‚¤ãƒ†ãƒ è©³ç´°ç”»é¢ã®åˆ¶å¾¡ (SubPageã‚¯ãƒ©ã‚¹é©ç”¨ç‰ˆ) â–¼â–¼â–¼
            // ==========================================

            // 1. ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ– (å¿…ãšé–¢æ•°ã®å‰ã«æ›¸ã)
            const itemDetailPage = new SubPage('item-detail-screen', {
                onClose: () => {
                    stopMusicPreview(); // é–‰ã˜ã‚‹ã¨ãã«éŸ³æ¥½ã‚’æ­¢ã‚ã‚‹
                }
            });

            // â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¤ã‚ºç”»é¢ã®åˆ¶å¾¡ â–¼â–¼â–¼
            let currentQuizId = null;

            // â–¼â–¼â–¼ ä¿®æ­£: ã‚¯ã‚¤ã‚ºç”»é¢ã‚‚iframeã‚’å‹•çš„ç”Ÿæˆãƒ»å‰Šé™¤ã™ã‚‹ â–¼â–¼â–¼
            const quizPage = new SubPage('quiz-screen', {
                onClose: () => {
                    // 1. iframeã‚’å‰Šé™¤
                    const container = $('#quiz-container');
                    const iframe = document.getElementById('quiz-screen-iframe');
                    if (iframe) {
                        iframe.remove();
                    }
                    
                    // ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
                    $('#quiz-loader').style.display = 'none';

                    // 2. è©•ä¾¡ãƒ¢ãƒ¼ãƒ€ãƒ«ç­‰ã®å‡¦ç† (æ—¢å­˜ã‚³ãƒ¼ãƒ‰ç¶­æŒ)
                    if (currentQuizId) {
                         $('#assessment-modal').dataset.quizId = currentQuizId;
                         openModalWithAnim('assessment-modal', 'assessment-content');
                         
                         if(quizTimer.startTime) {
                            const elapsed = Math.round((Date.now() - quizTimer.startTime) / 1000);
                            const title = $('#quiz-screen-title').textContent || 'ã‚¯ã‚¤ã‚º';
                            recordSession(title, elapsed);
                            quizTimer.startTime = null;
                            saveState();
                        }
                        currentQuizId = null;
                    }
                }
            });
            
            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            $('#close-quiz-btn').addEventListener('click', () => quizPage.close());

            // 2. è©³ç´°ç”»é¢ã‚’é–‹ãé–¢æ•°
            const openItemDetailScreen = (id, type) => {
                // --- åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨è¡¨ç¤º ---
                const screen = $('#item-detail-screen');
                let itemData;
                let categoryName = '';

                if (type === 'theme') {
                    itemData = initialData.themes[id];
                    categoryName = 'ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼';
                } else if (type === 'background') {
                    itemData = initialData.backgrounds[id];
                    categoryName = 'å£ç´™';
                } else if (type === 'game') {
                    itemData = initialData.games[id];
                    categoryName = 'ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ';
                } else if (type === 'music') {
                    itemData = initialData.music[id];
                    categoryName = 'BGM';
                }

                $('#detail-title').textContent = itemData.name;
                $('#detail-subtitle').textContent = categoryName;
                
                // ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®åˆæœŸåŒ–ã¨æç”» (å¤‰æ›´ãªã—)
                const iconContainer = $('#detail-icon-container');
                iconContainer.innerHTML = '';
                
                if (type === 'theme') {
                    iconContainer.style.backgroundColor = itemData.color;
                    iconContainer.className = "w-32 h-32 rounded-full shadow-lg border-4 border-white dark:border-gray-700 mx-auto";
                } else if (type === 'background') {
                    iconContainer.className = "w-32 h-56 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden mx-auto";
                    const bgStyle = itemData.url ? `background-image: url(${itemData.url}); background-size: cover; background-position: center;` : 'background-color: #6b7280;';
                    iconContainer.innerHTML = `<div class="w-full h-full" style="${bgStyle}"></div>`;
                } else {
                    iconContainer.style.backgroundColor = ''; 
                    iconContainer.className = "w-32 h-32 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden flex items-center justify-center bg-gray-100 dark:bg-gray-800 relative mx-auto"; 
                    
                    const iconName = itemData.icon || (type === 'music' ? 'music' : 'gamepad-2');
                    const iconColor = type === 'game' ? 'text-indigo-500' : 'text-pink-500';
                    let innerContent = `<i data-lucide="${iconName}" class="w-16 h-16 ${iconColor}"></i>`;

                    if (type === 'music') {
                        innerContent += `
                            <button id="detail-music-play-btn" class="absolute inset-0 flex items-center justify-center bg-black/5 hover:bg-black/20 transition-colors z-10 group">
                                <div class="bg-white/90 dark:bg-gray-800/90 p-3 rounded-full shadow-lg transform transition-transform group-hover:scale-110">
                                    <i id="detail-play-icon" data-lucide="play" class="w-6 h-6 text-pink-500 fill-current ml-0.5"></i>
                                </div>
                            </button>
                        `;
                    }
                    iconContainer.innerHTML = innerContent;

                    if (type === 'music') {
                        setTimeout(() => {
                            const playBtn = $('#detail-music-play-btn');
                            const playIcon = $('#detail-play-icon');
                            if (playBtn) {
                                playBtn.onclick = (e) => {
                                    e.stopPropagation();
                                    if (!previewAudio.paused && previewAudio.src === itemData.url) {
                                        stopMusicPreview();
                                    } else {
                                        stopMusicPreview();
                                        previewAudio.src = itemData.url;
                                        previewAudio.volume = 0.5;
                                        previewAudio.play();
                                        playIcon.setAttribute('data-lucide', 'square');
                                        playIcon.classList.remove('ml-0.5');
                                        lucide.createIcons();
                                        previewTimeout = setTimeout(stopMusicPreview, 30000);
                                    }
                                };
                            }
                        }, 0);
                    }
                }

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆã‚²ãƒ¼ãƒ ç”¨ãƒ»å¤‰æ›´ãªã—ï¼‰
                const previewSection = $('#detail-preview-section');
                const carousel = $('#detail-carousel');
                
                if (type === 'game' && itemData.previews && itemData.previews.length > 0) {
                    previewSection.classList.remove('hidden');
                    renderGamePreviews(itemData); // æ—¢å­˜ã®é–¢æ•°ã‚’ä½¿ç”¨
                } else {
                    previewSection.classList.add('hidden');
                }

                // --- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ â–¼â–¼â–¼ ---
                
                // ãƒœã‚¿ãƒ³æç”»ãƒ­ã‚¸ãƒƒã‚¯ã‚’é–¢æ•°åŒ–
                const renderActionButton = () => {
                    const actionBtn = $('#detail-action-btn');
                    const statusText = $('#detail-status-text');
                    
                    // æœ€æ–°ã®çŠ¶æ…‹ã‚’stateã‹ã‚‰å†å–å¾—ã™ã‚‹ (ã“ã“ãŒé‡è¦)
                    let isUnlocked = false;
                    let isActive = false;

                    if (type === 'theme') {
                        isUnlocked = state.profile.unlockedThemes.includes(id);
                        isActive = state.profile.activeTheme === id;
                    } else if (type === 'background') {
                        isUnlocked = state.profile.unlockedBackgrounds.includes(id);
                        isActive = state.profile.activeBackground === id;
                    } else if (type === 'game') {
                        isUnlocked = state.profile.unlockedGames.includes(id);
                    } else if (type === 'music') {
                        isUnlocked = state.profile.unlockedMusic.includes(id);
                    }

                    // ãƒœã‚¿ãƒ³ã‚’è¤‡è£½ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                    const newBtn = actionBtn.cloneNode(true);
                    actionBtn.parentNode.replaceChild(newBtn, actionBtn);

                    statusText.classList.add('hidden');
                    newBtn.className = "font-bold py-3 px-8 rounded-full shadow-lg transition-transform active:scale-95 flex items-center min-w-[140px] justify-center text-lg";

                    if (!isUnlocked) {
                        // æœªè³¼å…¥çŠ¶æ…‹
                        newBtn.innerHTML = `<span class="mr-1">${itemData.cost}</span> <span class="text-sm">LP ã§äº¤æ›</span>`;
                        
                        if (state.profile.lp >= itemData.cost) {
                            newBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                            newBtn.classList.add('primary-bg', 'text-white');
                            newBtn.onclick = () => {
                                if(confirm(`ã€Œ${itemData.name}ã€ã‚’ ${itemData.cost} LPã§äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`)){
                                    // ç¬¬4å¼•æ•°ã«æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯(è‡ªåˆ†è‡ªèº«ã‚’å†æç”»)ã‚’æ¸¡ã™
                                    purchaseItem(id, type, itemData.cost, () => {
                                        renderActionButton(); // â˜…ã“ã“ã§è³¼å…¥å¾Œã«ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°ï¼
                                    });
                                }
                            };
                        } else {
                            newBtn.classList.remove('primary-bg', 'text-white');
                            newBtn.classList.add('bg-gray-400', 'text-gray-100', 'cursor-not-allowed');
                            newBtn.onclick = () => showToast('LPãŒè¶³ã‚Šã¾ã›ã‚“');
                        }
                    } else {
                        // è³¼å…¥æ¸ˆã¿çŠ¶æ…‹
                        if (type === 'theme' || type === 'background') {
                            if (isActive) {
                                newBtn.innerHTML = `<span>é©ç”¨ä¸­</span>`;
                                newBtn.className = "bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-bold py-3 px-8 rounded-full shadow-none cursor-default min-w-[140px]";
                                newBtn.onclick = null;
                            } else {
                                newBtn.innerHTML = `<span>é©ç”¨ã™ã‚‹</span>`;
                                newBtn.className = "primary-bg text-white font-bold py-3 px-8 rounded-full shadow-lg active:scale-95 cursor-pointer min-w-[140px]";
                                newBtn.onclick = () => {
                                    applyItem(id, type);
                                    renderActionButton(); // é©ç”¨å¾Œã‚‚ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
                                };
                            }
                        } else {
                            newBtn.innerHTML = `<span>è§£æ”¾æ¸ˆã¿</span>`;
                            newBtn.className = "bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-bold py-3 px-8 rounded-full shadow-none cursor-default min-w-[140px]";
                            newBtn.onclick = null;
                        }
                        statusText.classList.remove('hidden');
                    }
                };

                // åˆå›æç”»å®Ÿè¡Œ
                renderActionButton();

                // --- â–²â–²â–² ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³å¤‰æ›´ã“ã“ã¾ã§ â–²â–²â–² ---

                lucide.createIcons();
                itemDetailPage.open();
            };

            // --- 3. ãƒ†ãƒ¼ãƒè¨­å®šã‚µãƒ–ãƒšãƒ¼ã‚¸ ---
            const themeSettingsPage = new SubPage('theme-settings-screen', {
                onOpen: () => {
                    const container = $('#theme-selector-container');
                    
                    // æç”»é–¢æ•°
                    const renderThemes = () => {
                        container.innerHTML = state.profile.unlockedThemes.map(id => {
                            const theme = initialData.themes[id];
                            const isActive = state.profile.activeTheme === id;
                            // â˜…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³(active:scale-90)ã¨ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                            return `<div class="text-center">
                                <button class="theme-btn w-16 h-16 rounded-full border-4 ${isActive ? 'border-blue-500 ring-2 ring-blue-300 dark:ring-blue-800' : 'border-transparent'} relative mx-auto block transition-transform active:scale-90 shadow-md" style="background-color: ${theme.color}" data-theme="${id}">
                                    ${isActive ? '<div class="absolute inset-0 flex items-center justify-center"><i data-lucide="check" class="text-white w-8 h-8 drop-shadow-md"></i></div>' : ''}
                                </button>
                                <p class="text-xs mt-2 font-bold">${theme.name}</p>
                            </div>`;
                        }).join('');
                        lucide.createIcons();

                        // â˜…ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                        container.querySelectorAll('.theme-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const themeId = btn.dataset.theme;
                                state.profile.activeTheme = themeId; // çŠ¶æ…‹ã‚’æ›´æ–°
                                saveState();        // ä¿å­˜
                                updateAppearance(); // è¦‹ãŸç›®ã‚’å³åº§ã«åæ˜ 
                                const theme = initialData.themes[themeId];
                                if (theme) {
                                    document.documentElement.style.setProperty('--primary-color', theme.color);
                                    document.documentElement.style.setProperty('--primary-color-hover', theme.hover);
                                    
                                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼ˆãƒãƒƒãƒéƒ¨åˆ†ï¼‰ã®è‰²ã‚‚æ›´æ–°ï¼ˆãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿åæ˜ ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ï¼‰
                                    const metaThemeColor = document.getElementById('meta-theme-color');
                                    if (metaThemeColor && !document.documentElement.classList.contains('dark')) {
                                        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ãªã‘ã‚Œã°ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é©ç”¨ï¼ˆãŠå¥½ã¿ã§ï¼‰
                                        // metaThemeColor.setAttribute('content', theme.color); 
                                    }
                                }
                                renderThemes();     // é¸æŠæ ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«å†æç”»
                            });
                        });
                    };

                    renderThemes(); // åˆå›æç”»
                }
            });
            $('#close-theme-settings-btn').addEventListener('click', () => themeSettingsPage.close());

            // --- 4. å£ç´™è¨­å®šã‚µãƒ–ãƒšãƒ¼ã‚¸ ---
            const backgroundSettingsPage = new SubPage('background-settings-screen', {
                onOpen: () => {
                    const container = $('#background-selector-container');
                    
                    // æç”»é–¢æ•°
                    const renderBackgrounds = () => {
                        container.innerHTML = state.profile.unlockedBackgrounds.map(id => {
                            const bg = initialData.backgrounds[id];
                            const isActive = state.profile.activeBackground === id;
                            // â˜…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³(active:scale-95)ã‚’è¿½åŠ 
                            return `<div class="text-center">
                                <button class="background-btn w-full h-24 rounded-lg border-4 ${isActive ? 'border-blue-500 ring-2 ring-blue-300 dark:ring-blue-800' : 'border-transparent'} relative bg-gray-500 bg-cover bg-center transition-transform active:scale-95 shadow-md" style="background-image: ${bg.url ? `url(${bg.url})` : 'none'}" data-bg="${id}">
                                    ${isActive ? '<div class="absolute inset-0 flex items-center justify-center bg-black/20"><i data-lucide="check" class="text-white w-8 h-8 drop-shadow-md"></i></div>' : ''}
                                </button>
                                <p class="text-xs mt-2 font-bold truncate">${bg.name}</p>
                            </div>`;
                        }).join('');
                        lucide.createIcons();

                        // â˜…ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                        container.querySelectorAll('.background-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const bgId = btn.dataset.bg;
                                state.profile.activeBackground = bgId; // çŠ¶æ…‹ã‚’æ›´æ–°
                                saveState();        // ä¿å­˜
                                updateAppearance(); // å…¨ä½“ãƒ†ãƒ¼ãƒï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç­‰ï¼‰æ›´æ–°
                                updateBackgrounds();// èƒŒæ™¯ç”»åƒæ›´æ–°
                                renderBackgrounds();// é¸æŠæ æ›´æ–°ã®ãŸã‚å†æç”»
                            });
                        });
                    };

                    renderBackgrounds(); // åˆå›æç”»

                    // ã‚¹ã‚¤ãƒƒãƒã®çŠ¶æ…‹åæ˜ 
                    const toggle = $('#background-scope-toggle-sub');
                    if (toggle) {
                        toggle.checked = state.settings.backgroundScopeGlobal;
                        
                        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (é‡è¤‡ç™»éŒ²é˜²æ­¢ã®ãŸã‚onclickä½¿ç”¨)
                        toggle.onclick = (e) => {
                            state.settings.backgroundScopeGlobal = e.target.checked;
                            saveState();
                            updateAppearance();
                            updateBackgrounds();
                        };
                    }
                }
            });
            $('#close-bg-settings-btn').addEventListener('click', () => backgroundSettingsPage.close());

            // --- 5. BGMè¨­å®šã‚µãƒ–ãƒšãƒ¼ã‚¸ ---
            const bgmSettingsPage = new SubPage('bgm-settings-screen', {
                onOpen: () => {
                    // ãƒˆã‚°ãƒ«è¨­å®š
                    const toggle = $('#bgm-toggle-sub');
                    toggle.checked = state.settings.bgmEnabled;
                    toggle.onclick = (e) => {
                        state.settings.bgmEnabled = e.target.checked;
                        saveState();
                    };

                    // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæç”»é–¢æ•°
                    const renderBgmPageList = () => {
                        const container = $('#playlist-container-sub');
                        if (state.settings.playlist.length === 0) {
                            container.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                        } else {
                            container.innerHTML = '';
                            state.settings.playlist.forEach((id, index) => {
                                const track = initialData.music[id];
                                if(!track) return;
                                const itemEl = document.createElement('div');
                                itemEl.className = 'bg-white dark:bg-gray-600 rounded-lg p-2 flex items-center shadow-sm border border-gray-100 dark:border-gray-500';
                                itemEl.setAttribute('data-id', id);
                                itemEl.innerHTML = `
                                    <div class="playlist-handle text-gray-400 cursor-grab active:cursor-grabbing p-2 mr-1">
                                        <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-grow min-w-0">
                                        <p class="font-bold text-sm truncate text-gray-800 dark:text-gray-100">${track.name}</p>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <button class="preview-bgm-btn p-2 rounded-full text-indigo-500 hover:bg-indigo-50 dark:hover:bg-gray-500 transition">
                                            <i data-lucide="play-circle" class="w-5 h-5"></i>
                                        </button>
                                        <button class="remove-bgm-btn p-2 rounded-full text-red-500 hover:bg-red-50 dark:hover:bg-gray-500 transition">
                                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                `;
                                
                                // è©¦è´ãƒœã‚¿ãƒ³
                                const previewBtn = itemEl.querySelector('.preview-bgm-btn');
                                previewBtn.addEventListener('click', () => toggleMusicPreview(track.url, previewBtn));

                                // å‰Šé™¤ãƒœã‚¿ãƒ³
                                itemEl.querySelector('.remove-bgm-btn').addEventListener('click', () => {
                                    stopMusicPreview();
                                    state.settings.playlist.splice(index, 1);
                                    saveState();
                                    renderBgmPageList(); // å†æç”»
                                });

                                container.appendChild(itemEl);
                            });

                            // Sortableé©ç”¨
                            if(Sortable) {
                                Sortable.create(container, {
                                    handle: '.playlist-handle',
                                    animation: 150,
                                    ghostClass: 'sortable-ghost',
                                    delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5,
                                    onEnd: (evt) => {
                                        const item = state.settings.playlist.splice(evt.oldIndex, 1)[0];
                                        state.settings.playlist.splice(evt.newIndex, 0, item);
                                        saveState();
                                    }
                                });
                            }
                        }

                        // è¿½åŠ å¯èƒ½ãƒªã‚¹ãƒˆã®æç”»
                        const unlockedContainer = $('#unlocked-music-list-sub');
                        const availableMusic = state.profile.unlockedMusic.filter(id => !state.settings.playlist.includes(id));
                        
                        if (availableMusic.length === 0) {
                            unlockedContainer.innerHTML = '<span class="text-xs text-gray-400">è¿½åŠ ã§ãã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“</span>';
                        } else {
                            unlockedContainer.innerHTML = availableMusic.map(id => {
                                const track = initialData.music[id];
                                return `<button class="add-to-playlist-btn bg-gray-50 dark:bg-gray-800 border dark:border-gray-600 px-3 py-2 rounded-full text-xs font-bold transition flex items-center hover:bg-gray-100 dark:hover:bg-gray-700" data-id="${id}" style="color: var(--primary-color); border-color: var(--primary-color);">
                                    <i data-lucide="plus" class="w-3 h-3 mr-1"></i>${track.name}
                                </button>`;
                            }).join('');

                            unlockedContainer.querySelectorAll('.add-to-playlist-btn').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    state.settings.playlist.push(btn.dataset.id);
                                    saveState();
                                    renderBgmPageList();
                                });
                            });
                        }
                        lucide.createIcons();
                    };

                    renderBgmPageList();
                },
                onClose: () => {
                    stopMusicPreview(); // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ãŸã‚‰è©¦è´åœæ­¢
                }
            });
            $('#close-bgm-settings-btn').addEventListener('click', () => bgmSettingsPage.close());

            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ç´ä»˜ã‘
            $('#close-item-detail-btn').addEventListener('click', () => itemDetailPage.close());

            // â€» å¤ã„ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¶å¾¡ã‚³ãƒ¼ãƒ‰ã‚„ closeItemDetailScreen é–¢æ•°ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ
            // ==========================================

            // è³¼å…¥ãƒœã‚¿ãƒ³ã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const attachPurchaseEvents = () => {
                // ã‚²ãƒ¼ãƒ è³¼å…¥
                $$('.game-purchase-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.id;
                        const item = initialData.games[id];
                        $('#game-purchase-title').textContent = item.name;
                        $('#game-purchase-cost').textContent = `å¿…è¦ãƒã‚¤ãƒ³ãƒˆ: ${item.cost} LP`;
                        renderGamePreviews(item);
                        
                        const confirmBtn = $('#game-purchase-confirm');
                        confirmBtn.dataset.itemId = id;
                        confirmBtn.dataset.itemType = 'game';
                        confirmBtn.disabled = state.profile.lp < item.cost;
                        
                        lucide.createIcons();
                        $('#game-purchase-modal').style.display = 'flex';
                    });
                });

                // éŸ³æ¥½è³¼å…¥
                $$('.music-purchase-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.id;
                        const item = initialData.music[id];
                        $('#music-purchase-title').textContent = item.name;
                        $('#music-purchase-cost').textContent = `å¿…è¦ãƒã‚¤ãƒ³ãƒˆ: ${item.cost} LP`;
                        
                        const previewBtn = $('#music-preview-btn');
                        const newPreviewBtn = previewBtn.cloneNode(true);
                        previewBtn.parentNode.replaceChild(newPreviewBtn, previewBtn);
                        
                        newPreviewBtn.addEventListener('click', () => {
                            toggleMusicPreview(item.url, newPreviewBtn);
                        });
                        
                        const confirmBtn = $('#music-purchase-confirm');
                        confirmBtn.dataset.itemId = id;
                        confirmBtn.dataset.itemType = 'music';
                        confirmBtn.disabled = state.profile.lp < item.cost;
                        
                        $('#music-purchase-modal').style.display = 'flex';
                        lucide.createIcons();
                    });
                });
            };
            
        /* â–¼â–¼â–¼ è¿½åŠ æ©Ÿèƒ½ç”¨é–¢æ•° â–¼â–¼â–¼ */
        
        // ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç”»åƒãƒ»å‹•ç”»ï¼‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        const renderGamePreviews = (game) => {
            const container = $('#detail-carousel'); // â˜…IDå¤‰æ›´: game-preview-container -> detail-carousel
            if(!container) return; // ã‚¨ãƒ©ãƒ¼ã‚¬ãƒ¼ãƒ‰
            container.innerHTML = ''; // ã‚¯ãƒªã‚¢
        
            if (!game.previews || game.previews.length === 0) {
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒãªã„å ´åˆã®ãƒ€ãƒŸãƒ¼
                container.innerHTML = `
                    <div class="preview-item w-full aspect-video bg-gray-100 dark:bg-gray-800 rounded-xl flex flex-col items-center justify-center text-gray-400 border border-gray-200 dark:border-gray-700">
                        <i data-lucide="image-off" class="w-12 h-12 mb-2"></i>
                        <span>No Preview</span>
                    </div>`;
                return;
            }
        
            game.previews.forEach(url => {
                const item = document.createElement('div');
                // â˜…ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´: å¤§ããè¡¨ç¤ºã—ã€ã‚¹ãƒŠãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«å¯¾å¿œã•ã›ã‚‹
                // w-[85vw]: ç”»é¢å¹…ã®85% (æ¨ªã«è¦‹åˆ‡ã‚Œã•ã›ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¿ƒã™)
                // aspect-[9/16]: ã‚¹ãƒãƒ›ç¸¦ç”»é¢æ¯”ç‡
                // flex-shrink-0: ç¸®å°ã•ã›ãªã„
                item.className = 'preview-item w-[70vw] md:w-[300px] aspect-[9/16] flex-shrink-0 bg-gray-100 dark:bg-gray-800 rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700 snap-center shadow-sm';
                
                // æ‹¡å¼µå­ã§ç”»åƒã‹å‹•ç”»ã‹ç°¡æ˜“åˆ¤å®š
                const isVideo = url.endsWith('.mp4') || url.endsWith('.webm');
                
                if (isVideo) {
                    item.innerHTML = `<video src="${url}" controls playsinline muted class="w-full h-full object-cover pointer-events-auto"></video>`;
                } else {
                    item.innerHTML = `<img src="${url}" alt="preview" class="w-full h-full object-cover">`;
                }
                container.appendChild(item);
            });
            
            // â˜…ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š (æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¼·åˆ¶)
            container.className = "flex overflow-x-auto gap-4 pb-4 px-6 snap-x snap-mandatory scroll-smooth no-scrollbar";
            // â€» no-scrollbar ã¯Tailwindæ¨™æº–ã«ã¯ãªã„ã®ã§ã€CSSã§éš ã™ã‹ã€ã‚ã‚‹ã„ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ãŒå‡ºã¦ã‚‚è¨±å®¹ã™ã‚‹ã‹
        };
        
        // BGMè©¦è´ã®å†ç”Ÿãƒ»åœæ­¢åˆ¶å¾¡
        const toggleMusicPreview = (url, btnElement) => {
            // ã™ã§ã«å†ç”Ÿä¸­ã§ã€ã‹ã¤åŒã˜URLãªã‚‰ã€Œåœæ­¢ã€ã¨ã¿ãªã™
            if (!previewAudio.paused && previewAudio.src === url) {
                stopMusicPreview();
                return;
            }

            // åˆ¥ã®æ›²ã‚’å†ç”Ÿã™ã‚‹å ´åˆã€ã¾ãŸã¯æ–°è¦å†ç”Ÿã®å ´åˆ
            // ã¾ãšç¾åœ¨å†ç”Ÿä¸­ã®ã‚‚ã®ã‚’å®Œå…¨ã«åœæ­¢ãƒ»ãƒªã‚»ãƒƒãƒˆã™ã‚‹
            stopMusicPreview();

            // æ–°ã—ãå†ç”Ÿ
            previewAudio.src = url;
            previewAudio.volume = 0.5;
            
            previewAudio.play().then(() => {
                // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã€Œåœæ­¢(square)ã€ã«å¤‰æ›´
                if (btnElement) {
                    btnElement.innerHTML = '<i data-lucide="square" class="w-5 h-5 fill-current"></i>';
                    btnElement.classList.add('playing-icon'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ä»˜ä¸
                    
                    // ã‚¢ã‚¤ã‚³ãƒ³å†ç”Ÿæˆ
                    lucide.createIcons({ root: btnElement });
                }
                
                // 30ç§’å¾Œã«è‡ªå‹•åœæ­¢
                previewTimeout = setTimeout(() => {
                    stopMusicPreview();
                }, 30000); 

            }).catch(e => console.error("è©¦è´ã‚¨ãƒ©ãƒ¼", e));
        };
        
        const stopMusicPreview = () => {
                previewAudio.pause();
                previewAudio.currentTime = 0;
                if (previewTimeout) clearTimeout(previewTimeout);
                
                // 1. ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå†…ã®ãƒœã‚¿ãƒ³(.preview-bgm-btn)ã®ãƒªã‚»ãƒƒãƒˆ
                document.querySelectorAll('.preview-bgm-btn').forEach(btn => {
                     btn.innerHTML = '<i data-lucide="play-circle" class="w-5 h-5"></i>';
                     btn.classList.remove('playing-icon');
                });
                
                // 2. â–¼â–¼â–¼ è©³ç´°ç”»é¢ã®ãƒœã‚¿ãƒ³ã®ãƒªã‚»ãƒƒãƒˆ â–¼â–¼â–¼
                const detailIcon = document.getElementById('detail-play-icon');
                if (detailIcon) {
                    detailIcon.setAttribute('data-lucide', 'play');
                    detailIcon.classList.add('ml-0.5'); // ä½ç½®èª¿æ•´ç”¨ã‚¯ãƒ©ã‚¹ã‚’æˆ»ã™
                }
                
                lucide.createIcons();
            }; 
            
            init();
        });
    </script>
</body>
</html>
