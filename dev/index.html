<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StudyQuest</title>

    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1f2937" media="(prefers-color-scheme: dark)">

    <style>
        /* 1. htmlã¨bodyã«æœ€åˆã‹ã‚‰èƒŒæ™¯è‰²ã‚’ã¤ã‘ã‚‹ (ã“ã‚ŒãŒç™½é£›ã³é˜²æ­¢ã®éµ) */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #f3f4f6; /* gray-100 (ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã®èƒŒæ™¯) */
        }

        /* 2. ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®è¨­å®š */
        #splash-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6; /* æœ¬ä½“ã¨åŒã˜è‰² */
            transition: opacity 0.5s ease;
        }
        
        #splash-screen img {
            width: 16rem;
            height: 16rem;
            object-fit: contain;
            margin-bottom: 1rem;
        }

        /* ãƒ­ã‚´ã®å‡ºã—åˆ†ã‘ */
        #splash-logo-dark { display: none; }
        #splash-logo-light { display: block; }

        /* 3. ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®èƒŒæ™¯è‰²ã‚’OSè¨­å®šã‹ã‚‰å³åº§ã«åæ˜  */
        @media (prefers-color-scheme: dark) {
            html, body, #splash-screen {
                background-color: #111827; /* gray-900 (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®èƒŒæ™¯) */
            }
            #splash-logo-light { display: none; }
            #splash-logo-dark { display: block; }
        }

        /* ã‚¯ãƒ©ã‚¹ã«ã‚ˆã‚‹åˆ¶å¾¡ (JSãƒ­ãƒ¼ãƒ‰å¾Œ) */
        html.dark, html.dark body, html.dark #splash-screen { background-color: #111827; }
        html.dark #splash-logo-light { display: none; }
        html.dark #splash-logo-dark { display: block; }
    </style>

    <script>
        // ç”»é¢æç”»å‰ã«OSã®è¨­å®šã‚’ç¢ºèªã—ã¦ dark ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
    </script>

    <!-- PWAé–¢é€£ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="StudyQuest">

    <link rel="icon" type="image/png" href="SQ_logo.png">

    <link rel="apple-touch-icon" href="SQ_logo.png">

    <meta property="og:image" content="SQ_logo.png">
    
    <link rel="manifest" href="manifest.json">
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ•ã‚©ãƒ³ãƒˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class' // ã“ã“ã§ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®åˆ¶å¾¡æ–¹æ³•ã‚’'class'ã«æŒ‡å®šã—ã¾ã™
      }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        /* â–¼â–¼â–¼ è¿½åŠ : LINE Seed JP ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ â–¼â–¼â–¼ */
        @font-face {
            font-family: 'LINE Seed JP';
            src: url('LINESeedJP_OTF_Rg.woff2') format('woff2'); /* ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆã‚ã›ã‚‹ */
            font-weight: 400; /* é€šå¸¸ */
            font-style: normal;
        }
        @font-face {
            font-family: 'LINE Seed JP';
            src: url('LINESeedJP_OTF_Bd.woff2') format('woff2'); /* ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆã‚ã›ã‚‹ */
            font-weight: 700; /* å¤ªå­— */
            font-style: normal;
        }
        /* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

        :root {
            --primary-color: #4f46e5;
            --primary-color-hover: #4338ca;
        }
        /* â–¼â–¼â–¼ ä¿®æ­£: font-family ã®å…ˆé ­ã« 'LINE Seed JP' ã‚’è¿½åŠ  â–¼â–¼â–¼ */
        body { 
            font-family: 'LINE Seed JP', 'Inter', 'Noto Sans JP', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }
        .page { display: none; }
        .page.active { display: block; }
        #focus-page.page.active { display: flex; }
        #focus-page { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn {
            animation: fadeIn 0.8s ease-out forwards;
        }
        #loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .primary-bg { background-color: var(--primary-color); }
        .primary-bg-hover:hover { background-color: var(--primary-color-hover); }
        .primary-text { color: var(--primary-color); }
        .toggle-checkbox { appearance: none; width: 40px; height: 20px; background: #ccc; border-radius: 20px; position: relative; cursor: pointer; transition: background .3s; }
        .toggle-checkbox:before { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: transform .3s; }
        .toggle-checkbox:checked { background: var(--primary-color); }
        .toggle-checkbox:checked:before { transform: translateX(20px); }
        #theme-purchase-modal, #background-purchase-modal { z-index: 60; }

        /* ãƒŸãƒ‹ã‚¿ã‚¤ãƒãƒ¼ */
        #mini-timer-container {
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s;
            transform: translateY(150%);
            opacity: 0;
            pointer-events: none;
        }
        #mini-timer-container.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #mini-timer-progress-bar {
            transition: width 0.5s linear;
        }
        /* é›†ä¸­ãƒ¢ãƒ¼ãƒ‰èƒŒæ™¯ */
        .focus-view-bg {
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
        }
        
        #app-container {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .break-icon-grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 0.5rem; 
            width: 100%;
        }

        .break-content-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: #edfcff;
            padding: 0.75rem; /* ğŸ‘ˆ 16px ã‹ã‚‰ 12px ã«å¤‰æ›´ */
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center; /* ğŸ‘ˆ flex-start ã‹ã‚‰ center ã«å¤‰æ›´ (æœ€é‡è¦) */
            justify-content: flex-start; /* ğŸ‘ˆ center ã‹ã‚‰ flex-start ã«å¤‰æ›´ (ä¸Šã‹ã‚‰é…ç½®) */
            /* font-weight: bold; */ /* ğŸ‘ˆ ã“ã®è¡Œã¯å‰Šé™¤ï¼ˆspanå´ã§æŒ‡å®šï¼‰ */
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            /* é«˜ã•ã‚’å‡ä¸€ã«ã™ã‚‹ãŸã‚ (ä»»æ„) */
            min-height: 100px;
        }
        .break-content-btn span {
            font-size: 0.75rem; /* 12px */
            font-weight: bold;
            line-height: 1.1;
            text-align: center;
            word-break: break-word; /* è‹±èªãªã©ãŒã¯ã¿å‡ºãŸå ´åˆã«å‚™ãˆã‚‹ */
        }
        .break-content-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e2e8f0; /* light gray */
        }
        .dark .sortable-ghost {
            background-color: #374151; /* dark gray */
        }
        .task-item .task-text-input {
            border-bottom: 1px solid transparent;
            transition: all 0.2s;
        }
        .task-item:hover .task-text-input {
            background-color: rgba(0,0,0,0.03);
        }
        .dark .task-item:hover .task-text-input {
            background-color: rgba(255,255,255,0.05);
        }
        /* ä¼‘æ†©è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¢ã‚¤ãƒ†ãƒ  */
        .break-settings-item {
            display: flex;
            align-items: center;
            padding: 0.75rem; /* p-3 */
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e5e7eb; /* text-gray-200 */
        }
        .break-settings-handle {
            cursor: move; /* "cursor-move" */
            margin-right: 0.75rem; /* mr-3 */
            color: #9ca3af; /* text-gray-400 */
        }
        .break-settings-item span {
            flex-grow: 1; /* "flex-grow" */
            text-align: left;
        }
        /* 1. ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç¦æ­¢ */
        body {
            -webkit-user-select: none; /* Safari/Chrome */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE */
            user-select: none;         /* æ¨™æº– */
        }
        
        /* 2. input ã‚„ textarea ã¯é¸æŠã§ãã‚‹ã‚ˆã†ã«è¨±å¯ã™ã‚‹ï¼ˆã‚³ãƒ”ãƒšãªã©ã«å¿…è¦ï¼‰ */
        input, 
        textarea {
            -webkit-user-select: text; /* Safari/Chrome */
            -moz-user-select: text;    /* Firefox */
            -ms-user-select: text;     /* IE */
            user-select: text;         /* æ¨™æº– */
        }
        
        /* 3. ç”»åƒã‚„SVGã‚¢ã‚¤ã‚³ãƒ³ã®é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆä¿å­˜ãªã©ï¼‰ã‚’ç¦æ­¢ (ä¸»ã«iOS) */
        img, svg {
            -webkit-touch-callout: none;
        }
        /* --- ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ç”¨CSS --- */
        .swipe-container {
            position: relative;
            overflow: hidden; /* ã¯ã¿å‡ºã—ãŸãƒœã‚¿ãƒ³ã‚’éš ã™ */
            touch-action: pan-y; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯è¨±å¯ã—ã¤ã¤ã€æ¨ªæ“ä½œã‚’JSã§åˆ¶å¾¡ */
        }
        
        /* ãƒœã‚¿ãƒ³ãŒé…ç½®ã•ã‚Œã‚‹èƒŒæ™¯å±¤ */
        .swipe-actions {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            display: flex;
            height: 100%;
            z-index: 1; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ */
        }
        
        .swipe-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            height: 100%;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        
        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å±¤ï¼ˆæŒ‡ã§å‹•ã‹ã™éƒ¨åˆ†ï¼‰ */
        .swipe-content {
            position: relative;
            z-index: 10;
            background-color: inherit; /* è¦ªã®è‰²ã‚’å¼•ãç¶™ã */
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* é›¢ã—ãŸæ™‚ã®ã‚¹ãƒŠãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            will-change: transform; /* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– */
        }
        
        /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚‹ï¼ˆè¿½å¾“æ€§ã‚’è‰¯ãã™ã‚‹ãŸã‚ï¼‰ */
        .is-dragging .swipe-content {
            transition: none;
        }
        
        /* å‰Šé™¤æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .swipe-deleting {
            transition: height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
            opacity: 0;
            margin: 0 !important;
            overflow: hidden;
        }
        /* ä¸¦ã³æ›¿ãˆãƒãƒ³ãƒ‰ãƒ«å‘¨è¾ºã®ã‚¿ãƒƒãƒæ“ä½œã‚’ç¢ºå®Ÿã«ã™ã‚‹ */
        .task-handle, .quest-handle, .break-settings-handle {
            cursor: grab;
            touch-action: none; /* ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ã‚’ç„¡åŠ¹åŒ–ã—ã€JSã§åˆ¶å¾¡ã—ã‚„ã™ãã™ã‚‹ */
            padding: 10px; /* ã‚¿ãƒƒãƒ—åˆ¤å®šã‚’å¤§ããã™ã‚‹ */
            margin: -5px; /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œé˜²æ­¢ */
        }
        
        /* INPUTã‚¿ã‚°ã¯ã‚¹ãƒ¯ã‚¤ãƒ—å¯¾è±¡å¤–ã¨ã—ã¦ã€æ–‡å­—é¸æŠã‚„ã‚«ãƒ¼ã‚½ãƒ«ç§»å‹•ã‚’å„ªå…ˆã•ã›ã‚‹ */
        input[type="text"], input[type="number"] {
            touch-action: manipulation; /* ã‚¹ãƒ¯ã‚¤ãƒ—ã‚„ã‚ºãƒ¼ãƒ ä»¥å¤–ã®æ¨™æº–å‹•ä½œ */
        }
        /* ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã‚„ã€å‰Šé™¤ãƒœã‚¿ãƒ³ãŒå‡ºã¦ã„ã‚‹æ™‚ã¯ã€ãƒãƒ³ãƒ‰ãƒ«ã‚’æ“ä½œä¸èƒ½ã«ã™ã‚‹ï¼ˆã“ã‚Œã§ä¸¦ã³æ›¿ãˆæš´ç™ºã‚’é˜²ãï¼‰ */
        .swipe-container.is-swiping .task-handle,
        .swipe-container.is-swiping .quest-handle,
        .swipe-container.is-swiping .break-settings-handle,
        .swipe-container.swiped-open .task-handle,
        .swipe-container.swiped-open .quest-handle,
        .swipe-container.swiped-open .break-settings-handle {
            pointer-events: none; /* ã‚¿ãƒƒãƒ—ä¸å¯ã«ã™ã‚‹ */
            opacity: 0.2; /* è¦–è¦šçš„ã«ã‚‚ç„¡åŠ¹ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
        }
        /* æ—¢å­˜ã® #iframe-overlay ã‚’ä¿®æ­£ï¼ˆflexã§ä¸­å¤®æƒãˆã§ãã‚‹ã‚ˆã†ã«ï¼‰ */
        #iframe-overlay {
            /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ç¶­æŒã—ã¤ã¤ã€loaderã®é…ç½®ç”¨ã«relativeç­‰ã‚’èª¿æ•´ */
            z-index: 70; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šä¸Šã«æ¥ã‚‹ã‚ˆã†ã«èª¿æ•´ */
        }
        
        /* iframeå†…ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆä¸­å¤®é…ç½®ï¼‰ */
        #iframe-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1; /* iframeãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰éš ã‚Œã‚‹ã‚ˆã†ã«å¾Œã‚ã¸ã€ã‚ã‚‹ã„ã¯JSã§åˆ¶å¾¡ */
        }
        
        /* ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—å¯¾å¿œï¼‰ */
        .preview-carousel {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden; 
            touch-action: pan-x;
            scroll-snap-type: x mandatory; /* ã‚¹ãƒŠãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            -webkit-overflow-scrolling: touch;
            gap: 1rem;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            width: 100%;
            height: 60vh;
        }
        
        .preview-item {
            flex: 0 0 100%; /* 1ã¤ã§å¹…100%ã‚’ä½¿ã† */
            scroll-snap-align: center;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .preview-item img,
        .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦åã‚ã‚‹ */
        }
        .preview-item img {
            pointer-events: none;       /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆé•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼é˜²æ­¢ï¼‰ */
            -webkit-user-drag: none;    /* ãƒ‰ãƒ©ãƒƒã‚°ç¦æ­¢ */
            user-select: none;          /* é¸æŠç¦æ­¢ */
        }
                
        /* è©¦è´ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .playing-icon {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .focus-theme-border:focus {
            border-color: var(--primary-color) !important;
        }  
        
        /* ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠ */
        main {
            position: relative;
            overflow-x: hidden; /* æ¨ªæºã‚Œé˜²æ­¢ */
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© (å¤‰åŒ–é‡ã‚’å°ã•ãã—ã¦ä¸Šå“ã«) */
        @keyframes appZoomIn {
            0% { opacity: 0; transform: scale(0.98); } /* 0.92 -> 0.98 ã«å¤‰æ›´ */
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes appZoomOut {
            0% { opacity: 0; transform: scale(1); }
            100% { opacity: 0; transform: scale(1); } /* 1.05 -> 1.02 ã«å¤‰æ›´ */
        }

        /* æ–°ã—ãå…¥ã£ã¦ãã‚‹ãƒšãƒ¼ã‚¸ */
        .page-enter {
            display: block !important;
            animation: appZoomIn 0.25s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; /* æ™‚é–“ã‚’å°‘ã—çŸ­ç¸® */
            z-index: 20;
            will-change: transform, opacity; /* ã€é‡è¦ã€‘æç”»æœ€é©åŒ–ã®ãƒ’ãƒ³ãƒˆ */
            transform-origin: top center;
        }
        #focus-page.page-enter {
            display: flex !important;
        }

        /* æ¶ˆãˆã¦ã„ããƒšãƒ¼ã‚¸ */
        .page-exit {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            animation: appZoomOut 0.25s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            z-index: 10;
            pointer-events: none;
            will-change: transform, opacity; /* ã€é‡è¦ã€‘æç”»æœ€é©åŒ–ã®ãƒ’ãƒ³ãƒˆ */
            height: 0 !important;
            overflow: hidden !important;
        }
        #focus-page.page-exit {
            display: flex !important;
            height: 0 !important;  /* â† ã“ã‚Œã‚’è¿½åŠ  */
            overflow: hidden !important;  /* â† ã“ã‚Œã‚’è¿½åŠ  */
        }        
        /* ä¸‹éƒ¨ã®ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¨ãƒªã‚¢åˆ†ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ  */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼å°‚ç”¨: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸã®é«˜ã•ã‚’ç¶­æŒã—ã¤ã¤ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã§èƒŒæ™¯ã‚’ä¼¸ã°ã™ */
        .nav-safe {
            padding-bottom: env(safe-area-inset-bottom, 10px);
            box-sizing: content-box; /* ã“ã‚ŒãŒé‡è¦: height:64pxã®ä¸­ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚ãªã„è¨­å®š */
        }
        
        /* å›ºå®šé…ç½®ã®è¦ç´ ã‚’ã€ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¨ãƒªã‚¢åˆ†ã ã‘ä¸Šã«æŠ¼ã—ä¸Šã’ã‚‹ */
        /* calc() ã‚’ä½¿ã£ã¦ã€Œå…ƒã®ä½ç½® + ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¨ãƒªã‚¢ã€ã‚’è¨ˆç®— */
        .bottom-safe-20 {
            bottom: calc(5rem + env(safe-area-inset-bottom, 10px)); /* bottom-20 (5rem) + safe-area */
        }
        .bottom-safe-16 {
            bottom: calc(4rem + env(safe-area-inset-bottom, 10px)); /* bottom-16 (4rem) + safe-area */
        }
        /* å³ã‹ã‚‰å…¥ã£ã¦ãã‚‹ (é€²ã‚€) */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 1; }
            to { transform: translateX(0); opacity: 1; }
        }
        /* å·¦ã¸æ¶ˆãˆã‚‹ (é€²ã‚€) */
        @keyframes slideOutLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-30%); opacity: 0; } /* å°‘ã—æš—ãã—ãªãŒã‚‰æ¶ˆãˆã‚‹ */
        }
        /* å·¦ã‹ã‚‰å…¥ã£ã¦ãã‚‹ (æˆ»ã‚‹) */
        @keyframes slideInLeft {
            from { transform: translateX(-30%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        /* å³ã¸æ¶ˆãˆã‚‹ (æˆ»ã‚‹) */
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; z-index: 50; }
            to { transform: translateX(100%); opacity: 1; z-index: 50; }
        }

        /* ã‚¯ãƒ©ã‚¹å®šç¾© */
        .page-enter-forward { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; z-index: 20; }
        .page-exit-forward { animation: slideOutLeft 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; z-index: 10; }
        .page-enter-back { animation: slideInLeft 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; z-index: 10; }
        .page-exit-back { animation: slideOutRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; z-index: 20; }

        /* â–¼â–¼â–¼ ä¿®æ­£: ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒãƒƒãƒå¯¾å¿œ â–¼â–¼â–¼ */
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’å›ºå®šã›ãšã€paddingã§èª¿æ•´ */
        header {
            padding-top: env(safe-area-inset-top, 20px); /* ãƒãƒƒãƒåˆ†ã®ä½™ç™½ */
            height: auto;
            min-height: calc(3.5rem + env(safe-area-inset-top, 20px));
        }
        
        /* ã‚µãƒ–ãƒšãƒ¼ã‚¸ç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .sub-page-header {
            padding-top: env(safe-area-inset-top, 20px);
            background-color: white;
            position: sticky;
            top: 0;
            z-index: 40;
        }
        .dark .sub-page-header { background-color: #1f2937; }

        /* ãƒšãƒ¼ã‚¸è‡ªä½“ã‚’å…¨ç”»é¢çµ¶å¯¾é…ç½®ã«ã—ã¦é‡ã­åˆã‚ã›ã‚‹ */
        .page {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            overflow-y: auto;
            background-color: #f3f4f6; /* bodyã¨åŒã˜è‰² */
            display: none; /* åˆæœŸçŠ¶æ…‹ */
            -webkit-overflow-scrolling: touch;
        }
        .dark .page { background-color: #111827; }
        
        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšãƒ¼ã‚¸ã ã‘è¡¨ç¤º */
        .page.active { display: block; }
        
        /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒšãƒ¼ã‚¸ã¯flexåˆ¶å¾¡ãŒå¿…è¦ãªã®ã§å€‹åˆ¥æŒ‡å®š */
        #focus-page.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 overflow-hidden h-[100dvh] antialiased">

    <div id="splash-screen" class="fixed inset-0 z-[300] flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900 transition-opacity duration-500">
        <img id="splash-logo-light" src="SQ_logo2.png" alt="StudyQuest Logo" class="w-64 h-64 mb-4 block dark:hidden">
        
        <img id="splash-logo-dark" src="SQ_logo3.png" alt="StudyQuest Logo Dark" class="w-64 h-64 mb-4 hidden dark:block">
    </div>

    <div id="app-container" class="h-full w-full relative overflow-hidden bg-gray-100 dark:bg-gray-900">
        
        <div id="tab-layer" class="w-full h-full relative">
        <header id="main-header" class="bg-white dark:bg-gray-800 z-30 px-4 pb-2 flex items-center justify-between border-b border-gray-200 dark:border-gray-700 absolute top-0 left-0 right-0">
            <h1 id="header-title" class="text-xl font-bold text-gray-900 dark:text-white">ãƒ›ãƒ¼ãƒ </h1>
            <button id="lp-button" class="flex items-center space-x-2 bg-yellow-400/20 text-yellow-600 dark:text-yellow-400 rounded-full px-3 py-1 hover:bg-yellow-400/30 transition-colors">
                <i data-lucide="star" class="w-4 h-4 fill-current"></i>
                <span id="lp-display" class="font-bold text-sm">0 LP</span>
            </button>
        </header>

        <main id="main-content" class="absolute top-0 bottom-0 left-0 right-0 pt-[calc(4rem+env(safe-area-inset-top))] pb-[calc(4rem+env(safe-area-inset-bottom))] overflow-y-auto overflow-x-hidden">
            <div id="home-page" class="page active p-4 space-y-6">
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm text-center">
                    <p id="today-date" class="text-lg font-semibold text-gray-600 dark:text-gray-300"></p>
                </div>

                 <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3">
                        <i data-lucide="check-square" class="w-5 h-5 mr-2 primary-text"></i> ä»Šæ—¥ã®äºˆå®š
                    </h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <div id="home-task-list" class="space-y-2">
                            <p class="text-center text-sm text-gray-500">ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                        </div>
                        <div class="flex items-center space-x-2 mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                            <span id="new-task-number" class="font-bold w-6 text-center text-gray-500 dark:text-gray-400">1</span>
                            <input type="text" id="new-task-input" placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ  (Enterã§ç¢ºå®š)" class="flex-grow bg-transparent p-1 border-b-2 border-gray-300 dark:border-gray-600 focus-theme-border focus:outline-none transition-colors">
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="calendar-clock" class="w-5 h-5 mr-2 primary-text"></i> ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³</h2>
                        <button id="add-countdown-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="countdown-list" class="space-y-3"></div>
                </div>
                
                 
            </div>

            <div id="study-page" class="page p-4">
                <div class="mb-6">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="pin" class="w-5 h-5 mr-2 primary-text"></i> ãƒ”ãƒ³ç•™ã‚</h2>
                    <div id="pinned-quizzes" class="grid grid-cols-1 gap-3"></div>
                </div>
                <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="book-marked" class="w-5 h-5 mr-2 primary-text"></i> ã™ã¹ã¦ã®ã‚¯ã‚¤ã‚º</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="filter-container" class="flex space-x-2 mb-4 overflow-x-auto pb-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="all-quizzes" class="grid grid-cols-1 gap-3"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div> Â  Â  Â  Â  Â  Â  
            <div id="focus-page" class="page relative flex flex-col h-full">
                
                <div id="focus-main-view" class="flex flex-col h-full p-4">
                    <div class="flex-shrink-0 mb-4 space-y-4">
                        <button id="show-quest-btn" class="w-full p-3 rounded-lg font-bold text-lg shadow-md flex items-center justify-center space-x-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-mode="quest">
                            <i data-lucide="award" class="w-6 h-6"></i>
                            <span>ã‚¯ã‚¨ã‚¹ãƒˆ</span>
                        </button>
                        
                        <div class="flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1">
                            <button class="focus-mode-btn flex-1 p-2 rounded-md text-sm font-semibold" data-mode="timer">ã‚¿ã‚¤ãƒãƒ¼</button>
                            <button class="focus-mode-btn flex-1 p-2 rounded-md text-sm font-semibold" data-mode="stopwatch">ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ</button>
                        </div>
                    </div>
            
                    <div id="timer-view" class="focus-view-bg flex-grow flex flex-col items-center justify-center text-center relative text-white rounded-lg">
                        <div class="absolute inset-0 bg-black/50 rounded-lg"></div>
                        <div class="relative z-10 p-4">
                            <div id="timer-settings-container">
                                <div class="flex items-center justify-center space-x-2 mb-6">
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="60">1åˆ†</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="300">5åˆ†</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="1800">30åˆ†</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="3600">60åˆ†</button>
                                    <button id="timer-reset-btn" class="bg-white/20 hover:bg-white/30 w-10 h-10 rounded-full flex items-center justify-center">
                                        <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="focus-timer-display" class="text-7xl font-bold tabular-nums mb-6">30:00</div>
                            <button id="focus-start-btn" class="primary-bg primary-bg-hover text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center mx-auto"><i data-lucide="play" class="w-6 h-6 mr-2"></i>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <div id="focus-controls" class="hidden flex flex-wrap items-center justify-center gap-4">
                                <button id="focus-pause-btn" class="bg-gray-500/70 hover:bg-gray-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢</button>
                                <button id="focus-end-btn" class="bg-red-500/70 hover:bg-red-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="stop-circle" class="w-6 h-6 mr-2"></i>çµ‚äº†</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="stopwatch-view" class="focus-view-bg hidden flex-grow flex-col items-center justify-center text-center relative text-white rounded-lg">
                        <div class="absolute inset-0 bg-black/50 rounded-lg"></div>
                        <div class="relative z-10 p-4">
                            <div id="stopwatch-display" class="text-7xl font-bold tabular-nums mb-6">00:00</div>
                            <button id="stopwatch-start-btn" class="primary-bg primary-bg-hover text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center mx-auto"><i data-lucide="play" class="w-6 h-6 mr-2"></i>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <div id="stopwatch-controls" class="hidden flex flex-wrap items-center justify-center gap-4">
                                <button id="stopwatch-pause-btn" class="bg-gray-500/70 hover:bg-gray-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢</button>
                                <button id="stopwatch-end-btn" class="bg-red-500/70 hover:bg-red-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="flag" class="w-6 h-6 mr-2"></i>è¨˜éŒ²ã—ã¦çµ‚äº†</button>
                            </div>
                        </div>
                    </div>
                </div>
            
                <div id="quest-view" class="hidden absolute inset-0 z-10 flex-col p-4">
                    
                    <div class="flex-shrink-0 flex items-center justify-between mb-4">
                        <button id="quest-back-btn" class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full">
                            <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        </button>
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">ã‚¯ã‚¨ã‚¹ãƒˆè¨­å®š</h2>
                        <div class="w-10"></div> 
                    </div>
                    
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm mb-4 flex-shrink-0">
                        <button id="load-tasks-btn" class="w-full mb-2 primary-bg primary-bg-hover text-white py-2 px-4 rounded-lg font-bold flex items-center justify-center space-x-2">
                            <i data-lucide="check-square" class="w-5 h-5"></i>
                            <span>ã€Œä»Šæ—¥ã®äºˆå®šã€ã‚’èª­ã¿è¾¼ã‚€</span>
                        </button>
                        <hr class="my-3 border-gray-200 dark:border-gray-600">
                        
                        <div class="flex items-center space-x-2 text-sm">
                            <input type="number" id="break-interval-input" value="2" class="w-16 p-1 border rounded dark:bg-gray-800 dark:border-gray-600">
                            <span>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«</span>
                            <input type="number" id="break-duration-input" value="5" class="w-16 p-1 border rounded dark:bg-gray-800 dark:border-gray-600">
                            <span>åˆ†ä¼‘æ†©</span>
                        </div>
                        <button id="add-breaks-btn" class="mt-2 text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">ä¼‘æ†©ã‚’è‡ªå‹•æŒ¿å…¥</button>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm flex-grow overflow-y-auto pb-36"> 
                        <div id="quest-plan-list" class="space-y-2">
                            </div>
                        
                        <div class="flex justify-between mt-4">
                            <button id="add-section-btn" class="text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ </button>
                            <button id="add-break-btn" class="text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">ä¼‘æ†©è¿½åŠ </button>
                        </div>
                    </div>
                    
                    <div class="fixed bottom-safe-16 left-0 right-0 max-w-lg mx-auto p-4 z-20 pointer-events-none">
                        <button id="start-quest-btn" class="w-full primary-bg primary-bg-hover text-white py-3 px-4 rounded-lg font-bold text-lg shadow-md hover:scale-105 transition-transform transform flex items-center justify-center space-x-2 pointer-events-auto">
                            <i data-lucide="play" class="w-6 h-6"></i>
                            <span>ã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹</span>
                        </button>
                    </div>
            
                </div>
            </div>
            <div id="my-chart-page" class="page p-4 space-y-6">
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-lg shadow text-center">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">ä»Šæ—¥</p>
                        <p class="text-xl font-bold primary-text" id="report-stat-today">0<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span></p>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-lg shadow text-center">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">ä»Šé€±</p>
                        <p class="text-xl font-bold primary-text" id="report-stat-week">0<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span></p>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-lg shadow text-center">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">ç·åˆè¨ˆ</p>
                        <p class="text-xl font-bold primary-text" id="report-stat-total">0<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span></p>
                    </div>
                </div>
            
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 primary-text"></i> é€±é–“ãƒ¬ãƒãƒ¼ãƒˆ
                    </h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                        <canvas id="study-time-chart"></canvas>
                    </div>
                </div>
            
                <div class="flex flex-col h-[75vh]"> <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3">
                        <i data-lucide="calendar" class="w-5 h-5 mr-2 primary-text"></i> å­¦ç¿’ãƒ­ã‚°
                    </h2>
                    
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-t-lg shadow-sm z-10">
                        <div class="flex justify-between items-center mb-4">
                            <button id="cal-prev-btn" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-600 rounded"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <h3 id="cal-month-title" class="font-bold text-lg"></h3>
                            <button id="cal-next-btn" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-600 rounded"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2 text-gray-400">
                            <span>æ—¥</span><span>æœˆ</span><span>ç«</span><span>æ°´</span><span>æœ¨</span><span>é‡‘</span><span>åœŸ</span>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm">
                            </div>
                    </div>
            
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-b-lg shadow p-4 flex-grow overflow-y-auto border-t border-gray-200 dark:border-gray-600">
                        <h4 id="detail-date-title" class="text-sm font-bold mb-3 text-gray-500 dark:text-gray-400 sticky top-0 bg-gray-50 dark:bg-gray-800 py-1">ä»Šæ—¥ã®è©³ç´°</h4>
                        <div id="study-session-list" class="space-y-3">
                            <p class="text-center text-xs text-gray-400 mt-4">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings-page" class="page p-4 space-y-4">
                <div id="notification-settings-card" class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">é€šçŸ¥è¨­å®š</h3>
                    <button id="notification-permission-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mb-4"><i data-lucide="bell-ring" class="w-5 h-5 mr-2"></i>ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¨±å¯</button>
                </div>

                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2 flex items-center justify-between">
                        <span>BGMè¨­å®š (ã‚¯ã‚¨ã‚¹ãƒˆä¸­)</span>
                        <div class="flex items-center">
                            <input type="checkbox" id="bgm-toggle" class="toggle-checkbox">
                        </div>
                    </h3>
                    <p class="text-xs text-gray-500 mb-4">ONã«ã™ã‚‹ã¨ã€ã‚¯ã‚¨ã‚¹ãƒˆã®ã€Œå­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€ä¸­ã«é¸æŠã—ãŸæ›²ãŒãƒ«ãƒ¼ãƒ—å†ç”Ÿã•ã‚Œã¾ã™ã€‚</p>
                    
                    <h4 class="text-sm font-bold mb-2">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h4>
                    <div id="playlist-container" class="space-y-2 mb-4">
                        <p class="text-sm text-gray-400">æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LPã§äº¤æ›ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    
                    <h4 class="text-sm font-bold mb-2">äº¤æ›æ¸ˆã¿ã®æ›² (ã‚¿ãƒƒãƒ—ã§è¿½åŠ )</h4>
                    <div id="unlocked-music-list" class="flex flex-wrap gap-2">
                        </div>
                </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                     <h3 class="font-semibold mb-2">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸æŠ</h3>
                     <div id="theme-selector" class="grid grid-cols-4 gap-4"></div>
                </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">å£ç´™ã‚’é¸æŠ</h3>
                    <div id="background-selector" class="grid grid-cols-3 gap-4"></div>
                    <hr class="my-4 border-gray-200 dark:border-gray-600">
                    <div class="flex items-center justify-between">
                        <p class="font-semibold">å£ç´™ã‚’ã‚¢ãƒ—ãƒªå…¨ä½“ã«é©ç”¨</p>
                        <input type="checkbox" id="background-scope-toggle" class="toggle-checkbox">
                    </div>
                </div>
            </div>
        </main>

        <div id="mini-timer-container" class="bottom-safe-20 fixed left-0 right-0 max-w-lg mx-auto px-4 z-20">
             <div id="mini-timer-bar" class="w-full bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-lg flex items-center p-2 space-x-3 cursor-pointer">
                <div class="flex items-center space-x-3 flex-grow min-w-0">
                    <i data-lucide="timer" class="w-5 h-5 primary-text flex-shrink-0"></i>
                    <span id="mini-timer-text" class="text-sm font-bold tabular-nums text-white truncate"></span>
                </div>
                <div class="w-1/3 h-1.5 bg-gray-600 rounded-full overflow-hidden flex-shrink-0">
                    <div id="mini-timer-progress-bar" class="h-full primary-bg rounded-full"></div>
                </div>
                <button id="close-mini-timer-btn" class="p-1 text-gray-400 hover:text-white flex-shrink-0">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <nav class="nav-safe fixed bottom-0 left-0 right-0 max-w-lg mx-auto h-14 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700 flex justify-around items-center shadow-top z-20">
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full primary-text" data-page="home-page" data-title="ãƒ›ãƒ¼ãƒ "><i data-lucide="home" class="w-6 h-6"></i><span class="text-xs mt-1">ãƒ›ãƒ¼ãƒ </span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="study-page" data-title="å­¦ç¿’"><i data-lucide="book-marked" class="w-6 h-6"></i><span class="text-xs mt-1">å­¦ç¿’</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="focus-page" data-title="é›†ä¸­"><i data-lucide="timer" class="w-6 h-6"></i><span class="text-xs mt-1">é›†ä¸­</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="my-chart-page" data-title="ãƒ¬ãƒãƒ¼ãƒˆ"><i data-lucide="clipboard-list" class="w-6 h-6"></i><span class="text-xs mt-1">ãƒ¬ãƒãƒ¼ãƒˆ</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="settings-page" data-title="è¨­å®š"><i data-lucide="settings" class="w-6 h-6"></i><span class="text-xs mt-1">è¨­å®š</span></button>
        </nav>
    </div>

      <div id="status-page" class="page z-40 bg-gray-100 dark:bg-gray-900">
        <div class="sub-page-header px-4 pb-3 flex items-center shadow-sm">
            <button class="back-btn p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">ãƒã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
        </div>
        <div class="p-4 space-y-6 pb-20">
            <div class="text-center">
                <p class="text-sm text-gray-500">ç¾åœ¨ã®å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ</p>
                <p class="text-5xl font-bold primary-text mt-2" id="status-lp-display">0</p>
            </div>
            <div>
                <h3 class="font-semibold mb-2">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</h3>
                <div id="modal-theme-selector" class="grid grid-cols-4 gap-4"></div>
            </div>
            <div>
                <h3 class="font-semibold mb-2">å£ç´™</h3>
                <div id="modal-background-selector" class="grid grid-cols-3 gap-2"></div>
            </div>
            </div>
    </div>

    <div id="countdown-edit-page" class="page z-40 bg-gray-100 dark:bg-gray-900">
        <div class="sub-page-header px-4 pb-3 flex items-center justify-between shadow-sm">
            <div class="flex items-center">
                <button class="back-btn p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                <h2 class="text-xl font-bold ml-2">ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨­å®š</h2>
            </div>
            <button id="countdown-save-btn" class="primary-text font-bold px-2">ä¿å­˜</button>
        </div>
        <div class="p-6 space-y-6">
            <div>
                <label class="block text-sm font-bold text-gray-500 mb-1">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                <input id="countdown-name" type="text" placeholder="ä¾‹: æœŸæœ«ãƒ†ã‚¹ãƒˆ" class="w-full p-4 rounded-xl border-none shadow-sm dark:bg-gray-800 focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-500 mb-1">æ—¥ä»˜</label>
                <input id="countdown-date" type="date" class="w-full p-4 rounded-xl border-none shadow-sm dark:bg-gray-800 focus:ring-2 focus:ring-indigo-500">
            </div>
            <button id="countdown-delete-btn" class="w-full py-4 text-red-500 bg-white dark:bg-gray-800 rounded-xl shadow-sm font-bold mt-8 hidden">
                ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
            </button>
        </div>
    </div>

    <div id="profile-edit-page" class="page z-40 bg-gray-100 dark:bg-gray-900">
        <div class="sub-page-header px-4 pb-3 flex items-center justify-between shadow-sm">
             <div class="flex items-center">
                <button class="back-btn p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                <h2 class="text-xl font-bold ml-2">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h2>
            </div>
            <button id="save-profile-btn-page" class="primary-text font-bold px-2">å®Œäº†</button>
        </div>
        <div class="p-6 flex flex-col items-center space-y-6">
             <div class="relative">
                 <input type="text" id="edit-profile-icon" class="w-24 h-24 text-center text-6xl border-2 border-dashed rounded-full bg-white dark:bg-gray-800" readonly>
                 <button id="edit-icon-random-btn" class="absolute bottom-0 right-0 bg-blue-500 text-white p-2 rounded-full"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
             </div>
             <div class="w-full">
                 <label class="block text-sm font-bold mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                 <input type="text" id="edit-profile-name" class="w-full p-3 rounded-xl dark:bg-gray-800">
             </div>
             </div>
    </div>

    </div>

    <div id="welcome-screen" class="fixed inset-0 z-[200] bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6 hidden">
        <div class="mb-12 animate-fadeIn">
            <img src="SQ_logo4.png" alt="Welcome" class="w-80 h-80 object-contain mx-auto block dark:hidden">

            <img src="SQ_logo5.png" alt="Welcome Dark" class="w-80 h-80 object-contain mx-auto hidden dark:block">
        </div>

        <div class="w-full max-w-xs space-y-4 animate-fadeIn" style="animation-delay: 0.3s; opacity: 0;">
            <button id="btn-start-new" class="w-full primary-bg primary-bg-hover text-white font-bold py-4 rounded-xl shadow-lg transition-transform hover:scale-105">
                åˆã‚ã¦ã®æ–¹ã¯ã“ã¡ã‚‰
            </button>
            <button id="btn-transfer-start" class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 font-bold py-4 rounded-xl shadow transition-colors border border-gray-200 dark:border-gray-700">
                ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ã
            </button>
        </div>
    </div>

    <div id="registration-screen" class="fixed inset-0 z-[200] bg-gray-100 dark:bg-gray-900 flex flex-col p-6 hidden">
        <header class="flex items-center mb-6">
            <button id="reg-back-btn" class="p-2 -ml-2"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
        </header>
        
        <div class="flex-grow flex flex-col items-center space-y-6 max-w-sm mx-auto w-full">
            <div class="text-center">
                <label class="block text-sm font-bold mb-2 text-gray-500">ã‚¢ã‚¤ã‚³ãƒ³ (çµµæ–‡å­—)</label>
                <div class="relative inline-block">
                    <input type="text" id="reg-icon" class="w-24 h-24 text-center text-6xl border-2 border-dashed border-gray-300 rounded-full focus:outline-none focus:border-indigo-500 bg-white dark:bg-gray-800" value="ğŸ“" readonly>
                    <div class="absolute -bottom-2 -right-2 bg-blue-500 text-white p-2 rounded-full shadow cursor-pointer" id="icon-picker-btn">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">ã‚¿ãƒƒãƒ—ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ å¤‰æ›´</p>
            </div>

            <div class="w-full">
                <label class="block text-sm font-bold mb-2 text-gray-500">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                <input type="text" id="reg-name" class="w-full p-4 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ä¾‹: ã‚¹ã‚¿ãƒ‡ã‚£å‹‡è€…">
            </div>

            <div class="w-full">
                <label class="block text-sm font-bold mb-2 text-gray-500">å­¦å¹´</label>
                <div class="relative">
                    <select id="reg-grade" class="w-full p-4 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 appearance-none focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="å°å­¦1å¹´ç”Ÿ">å°å­¦1å¹´ç”Ÿ</option>
                        <option value="å°å­¦2å¹´ç”Ÿ">å°å­¦2å¹´ç”Ÿ</option>
                        <option value="å°å­¦3å¹´ç”Ÿ">å°å­¦3å¹´ç”Ÿ</option>
                        <option value="å°å­¦4å¹´ç”Ÿ">å°å­¦4å¹´ç”Ÿ</option>
                        <option value="å°å­¦5å¹´ç”Ÿ">å°å­¦5å¹´ç”Ÿ</option>
                        <option value="å°å­¦6å¹´ç”Ÿ">å°å­¦6å¹´ç”Ÿ</option>
                        <option value="ä¸­å­¦1å¹´ç”Ÿ">ä¸­å­¦1å¹´ç”Ÿ</option>
                        <option value="ä¸­å­¦2å¹´ç”Ÿ">ä¸­å­¦2å¹´ç”Ÿ</option>
                        <option value="ä¸­å­¦3å¹´ç”Ÿ">ä¸­å­¦3å¹´ç”Ÿ</option>
                        <option value="é«˜æ ¡1å¹´ç”Ÿ">é«˜æ ¡1å¹´ç”Ÿ</option>
                        <option value="é«˜æ ¡2å¹´ç”Ÿ">é«˜æ ¡2å¹´ç”Ÿ</option>
                        <option value="é«˜æ ¡3å¹´ç”Ÿ">é«˜æ ¡3å¹´ç”Ÿ</option>
                        <option value="å¤§å­¦ãƒ»å°‚é–€å­¦ç”Ÿ">å¤§å­¦ãƒ»å°‚é–€å­¦ç”Ÿ</option>
                        <option value="ç¤¾ä¼šäººãƒ»ãã®ä»–">ç¤¾ä¼šäººãƒ»ãã®ä»–</option>
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                </div>
            </div>
            
            <div class="flex-grow"></div>

            <button id="reg-complete-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-4 rounded-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                æ¬¡ã¸é€²ã‚€
            </button>
        </div>
    </div>

    <div id="tutorial-screen" class="fixed inset-0 z-[200] bg-gray-900 text-white flex flex-col hidden">
        <div class="flex-grow relative overflow-hidden" id="tutorial-slider">
            <div class="flex transition-transform duration-300 h-full" id="tutorial-track">
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center p-6 text-center">
                    <div class="w-full max-w-xs aspect-[9/16] bg-gray-800 rounded-lg mb-6 flex items-center justify-center border-2 border-gray-700">
                        <img src="tutorial_1.png" alt="Tutorial 1" class="w-full h-full object-contain" onerror="this.src='https://placehold.co/300x500/222/fff?text=Tutorial+1'">
                    </div>
                    <h3 class="text-2xl font-bold mb-2">ã‚¯ã‚¨ã‚¹ãƒˆã§å­¦ç¿’</h3>
                    <p class="text-gray-400">ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã£ã¦<br>é›†ä¸­ã—ã¦å­¦ç¿’ã«å–ã‚Šçµ„ã‚‚ã†ã€‚</p>
                </div>
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center p-6 text-center">
                    <div class="w-full max-w-xs aspect-[9/16] bg-gray-800 rounded-lg mb-6 flex items-center justify-center border-2 border-gray-700">
                         <img src="tutorial_2.png" alt="Tutorial 2" class="w-full h-full object-contain" onerror="this.src='https://placehold.co/300x500/222/fff?text=Tutorial+2'">
                    </div>
                    <h3 class="text-2xl font-bold mb-2">ãƒã‚¤ãƒ³ãƒˆã‚’è²¯ã‚ã‚‹</h3>
                    <p class="text-gray-400">å­¦ç¿’æ™‚é–“ã«å¿œã˜ã¦LPã‚’ç²å¾—ã€‚<br>å¥½ããªã‚¢ã‚¤ãƒ†ãƒ ã¨äº¤æ›ã—ã‚ˆã†ã€‚</p>
                </div>
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center p-6 text-center">
                    <div class="w-full max-w-xs aspect-[9/16] bg-gray-800 rounded-lg mb-6 flex items-center justify-center border-2 border-gray-700">
                         <img src="tutorial_3.png" alt="Tutorial 3" class="w-full h-full object-contain" onerror="this.src='https://placehold.co/300x500/222/fff?text=Tutorial+3'">
                    </div>
                    <h3 class="text-2xl font-bold mb-2">æº–å‚™å®Œäº†ï¼</h3>
                    <p class="text-gray-400">ã•ã‚ã€ã‚ãªãŸã ã‘ã®<br>å­¦ç¿’ã®æ—…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚</p>
                </div>
            </div>
        </div>
        
        <div class="p-6 flex justify-between items-center">
            <div class="flex space-x-2" id="tutorial-dots">
                <span class="w-2 h-2 rounded-full bg-white"></span>
                <span class="w-2 h-2 rounded-full bg-gray-600"></span>
                <span class="w-2 h-2 rounded-full bg-gray-600"></span>
            </div>
            <button id="tutorial-next-btn" class="primary-bg px-6 py-2 rounded-full font-bold shadow-lg">æ¬¡ã¸</button>
        </div>
    </div>

    <div id="migration-modal" class="fixed inset-0 z-[210] bg-black/90 text-white flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-gray-800 rounded-xl p-6 relative">
            <button id="close-migration-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            
            <h2 class="text-xl font-bold mb-4 flex items-center"><i data-lucide="smartphone" class="mr-2"></i> ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ã</h2>
            
            <div id="migration-step-1" class="space-y-4">
                <p class="text-sm text-gray-300">å¤ã„ã‚¹ãƒãƒ›ã¨æ–°ã—ã„ã‚¹ãƒãƒ›ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="grid grid-cols-2 gap-4">
                    <button id="migration-mode-send" class="p-4 bg-gray-700 rounded-lg hover:bg-gray-600 transition flex flex-col items-center">
                        <i data-lucide="upload-cloud" class="w-8 h-8 mb-2 text-blue-400"></i>
                        <span class="font-bold">é€ã‚‹</span>
                        <span class="text-xs text-gray-400 mt-1">(å¤ã„ã‚¹ãƒãƒ›)</span>
                    </button>
                    <button id="migration-mode-receive" class="p-4 bg-gray-700 rounded-lg hover:bg-gray-600 transition flex flex-col items-center">
                        <i data-lucide="download-cloud" class="w-8 h-8 mb-2 text-green-400"></i>
                        <span class="font-bold">å—ã‘å–ã‚‹</span>
                        <span class="text-xs text-gray-400 mt-1">(æ–°ã—ã„ã‚¹ãƒãƒ›)</span>
                    </button>
                </div>
            </div>

            <div id="migration-sender-view" class="hidden text-center space-y-4">
                <p class="text-sm">æ–°ã—ã„ã‚¹ãƒãƒ›ã§ã€Œå—ã‘å–ã‚‹ã€ã‚’é¸æŠã—ã€<br>è¡¨ç¤ºã•ã‚Œã‚‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="bg-black/50 p-4 rounded text-center">
                    <p class="text-xs text-gray-400 mb-1">ç›¸æ‰‹ã®IDã‚’å…¥åŠ›:</p>
                    <input type="text" id="migration-target-id" class="bg-gray-700 text-white p-2 rounded w-full text-center font-mono text-lg tracking-widest uppercase" placeholder="ç›¸æ‰‹ã®ID">
                </div>
                <button id="migration-connect-btn" class="w-full primary-bg py-3 rounded-lg font-bold">ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡</button>
                <p id="migration-status-send" class="text-xs text-yellow-400 h-4"></p>
            </div>

            <div id="migration-receiver-view" class="hidden text-center space-y-4">
                <p class="text-sm">ã“ã®IDã‚’å¤ã„ã‚¹ãƒãƒ›ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="bg-black/50 p-6 rounded text-center">
                    <p class="text-5xl font-mono font-bold tracking-widest text-green-400" id="migration-my-id">...</p>
                </div>
                <p class="text-xs text-gray-400 animate-pulse">æ¥ç¶šå¾…æ©Ÿä¸­...</p>
                <p id="migration-status-receive" class="text-xs text-yellow-400"></p>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 z-[60] bg-gray-100 dark:bg-gray-900 flex flex-col hidden">
         <header class="bg-white dark:bg-gray-800 p-4 flex items-center justify-between shadow-sm">
             <button class="close-profile-btn p-2"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
             <h2 class="font-bold">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h2>
             <div class="w-8"></div>
         </header>
         <div class="p-6 flex flex-col items-center space-y-6">
             <div class="relative">
                 <input type="text" id="edit-profile-icon" class="w-24 h-24 text-center text-6xl border-2 border-dashed rounded-full bg-white dark:bg-gray-800" readonly>
                 <button id="edit-icon-random-btn" class="absolute bottom-0 right-0 bg-blue-500 text-white p-2 rounded-full"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
             </div>
             <div class="w-full">
                 <label class="block text-sm font-bold mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                 <input type="text" id="edit-profile-name" class="w-full p-3 rounded border dark:bg-gray-800 dark:border-gray-600">
             </div>
             <div class="w-full">
                 <label class="block text-sm font-bold mb-1">å­¦å¹´</label>
                 <select id="edit-profile-grade" class="w-full p-3 rounded border dark:bg-gray-800 dark:border-gray-600">
                    </select>
             </div>
             <button id="save-profile-btn" class="w-full primary-bg text-white py-3 rounded-xl font-bold mt-auto">ä¿å­˜ã™ã‚‹</button>

             <hr class="w-full border-gray-300 dark:border-gray-700 my-4">
             
             <button id="open-migration-menu-btn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 py-3 rounded-xl font-bold flex items-center justify-center">
                <i data-lucide="smartphone" class="w-5 h-5 mr-2"></i> ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ã (æ©Ÿç¨®å¤‰æ›´)
             </button>
         </div>
    </div>

    <!-- ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
    <div id="quiz-modal" class="fixed inset-0 bg-black/70 z-50 flex-col hidden"><div class="w-full h-full max-w-lg mx-auto bg-gray-100 dark:bg-gray-900 flex flex-col"><header class="p-3 flex items-center justify-between shadow-md bg-white dark:bg-gray-800"><h2 id="quiz-modal-title" class="truncate font-bold"></h2><button class="close-modal-btn p-1" data-modal="quiz-modal"><i data-lucide="x"></i></button></header><div class="flex-grow relative"><div class="absolute inset-0 flex items-center justify-center"><div id="loader"></div></div><iframe id="quiz-iframe" class="w-full h-full border-0 invisible" sandbox="allow-scripts allow-forms allow-popups"></iframe></div></div></div>
    <div id="assessment-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4">
            <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
                <h2 class="text-xl font-bold mb-4">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h2>
                <p class="mb-6">ã“ã®ã‚¯ã‚¤ã‚ºã®ç†è§£åº¦ã‚’è¨˜éŒ²ã—ã‚ˆã†</p>
                <div class="flex justify-around">
                    <button class="assessment-btn p-2 w-24 flex flex-col items-center" data-level="3"><i data-lucide="award" class="w-10 h-10 text-yellow-400 mb-1 mx-auto"></i><p>å®Œ ç’§</p></button>
                    <button class="assessment-btn p-2 w-24 flex flex-col items-center" data-level="2"><i data-lucide="thumbs-up" class="w-10 h-10 text-green-400 mb-1 mx-auto"></i><p>ã¾ã‚ã¾ã‚</p></button>
                    <button class="assessment-btn p-2 w-24 flex flex-col items-center" data-level="1"><i data-lucide="book-open-check" class="w-10 h-10 text-blue-400 mb-1 mx-auto"></i><p>è¦å¾©ç¿’</p></button>
                </div>
            </div>    </div><div id="theme-purchase-modal" class="fixed inset-0 bg-black/70 z-[60] items-center justify-center hidden p-4">
    <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="theme-purchase-title" class="text-xl font-bold mb-2"></h2>
        <div id="theme-preview" class="w-20 h-20 rounded-full mx-auto my-4 border-4 border-gray-200 dark:border-gray-600 shadow-inner"></div>
        <p id="theme-purchase-cost" class="mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button id="theme-purchase-cancel" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">ã‚„ã‚ã‚‹</button>
            <button id="theme-purchase-confirm" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg transition-colors disabled:bg-gray-400 dark:disabled:bg-gray-500 disabled:cursor-not-allowed">äº¤æ›ã™ã‚‹</button>
        </div>
    </div>
</div>

<div id="background-purchase-modal" class="fixed inset-0 bg-black/70 z-[60] items-center justify-center hidden p-4">
    <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="background-purchase-title" class="text-xl font-bold mb-2"></h2>
        <div id="background-preview" class="w-1/2 aspect-[9/16] rounded-lg mx-auto my-4 bg-gray-200 dark:bg-gray-800 bg-cover bg-center shadow-inner"></div>
        <p id="background-purchase-cost" class="mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button id="background-purchase-cancel" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">ã‚„ã‚ã‚‹</button>
            <button id="background-purchase-confirm" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg transition-colors disabled:bg-gray-400 dark:disabled:bg-gray-500 disabled:cursor-not-allowed">äº¤æ›ã™ã‚‹</button>
        </div>
    </div>
</div>

<div id="game-purchase-modal" class="fixed inset-0 bg-black/70 z-[60] items-center justify-center hidden p-4">
    <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="game-purchase-title" class="text-xl font-bold mb-4"></h2>
        
        <div id="game-preview-container" class="preview-carousel bg-gray-100 dark:bg-gray-800 rounded-lg">
            </div>
        <p id="game-purchase-cost" class="mb-6 font-bold text-lg primary-text"></p>
        <div class="flex justify-center space-x-4">
            <button id="game-purchase-cancel" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">ã‚„ã‚ã‚‹</button>
            <button id="game-purchase-confirm" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg transition-colors shadow-lg">äº¤æ›ã™ã‚‹</button>
        </div>
    </div>
</div>

<div id="music-purchase-modal" class="fixed inset-0 bg-black/70 z-[60] items-center justify-center hidden p-4">
    <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="music-purchase-title" class="text-xl font-bold mb-2"></h2>
        
        <div class="mx-auto my-6 text-primary relative inline-block">
             <div class="w-24 h-24 bg-gray-100 dark:bg-gray-600 rounded-full flex items-center justify-center mx-auto">
                 <i data-lucide="music" class="w-10 h-10 text-gray-400"></i>
             </div>
             <button id="music-preview-btn" class="absolute -bottom-2 -right-2 bg-pink-500 hover:bg-pink-600 text-white p-3 rounded-full shadow-lg transition-transform hover:scale-110">
                <i data-lucide="play" class="w-6 h-6 fill-current"></i>
             </button>
        </div>

        <p id="music-purchase-cost" class="mb-6 font-bold text-lg primary-text"></p>

        <div class="flex justify-center space-x-4">
            <button id="music-purchase-cancel" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">ã‚„ã‚ã‚‹</button>
            <button id="music-purchase-confirm" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg transition-colors shadow-lg">äº¤æ›ã™ã‚‹</button>
        </div>
    </div>
</div>
    
    <div id="countdown-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4"><div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6"><h2 id="countdown-modal-title" class="text-xl font-bold mb-4">ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨­å®š</h2><div class="space-y-4"><input id="countdown-name" type="text" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå (ä¾‹: æœŸæœ«ãƒ†ã‚¹ãƒˆ)" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 appearance-none min-w-0"><input id="countdown-date" type="date" class="w-full block p-2 border rounded dark:bg-gray-800 dark:border-gray-600 appearance-none min-w-0"></div><div class="flex justify-between items-center mt-6"><button id="countdown-delete-btn" class="text-red-500 hover:text-red-700 font-semibold p-2 hidden"><i data-lucide="trash-2" class="w-5 h-5 inline-block mr-1"></i>å‰Šé™¤</button><div class="flex space-x-2"><button id="countdown-cancel-btn" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button id="countdown-save-btn" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg">ä¿å­˜</button></div></div></div></div>
   
    <div id="point-details-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4"><div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-4 flex-shrink-0"><h2 class="text-xl font-bold">ãƒã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2><button id="close-point-modal-btn" class="p-1"><i data-lucide="x"></i></button></div><div class="space-y-6 overflow-y-auto"><div class="text-center"><p class="text-sm text-gray-500">ç¾åœ¨ã®å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ</p><p class="text-4xl font-bold primary-text" id="modal-lp-display"></p></div><div><h3 class="font-semibold mb-2">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</h3><div id="modal-theme-selector" class="grid grid-cols-4 gap-4"></div></div><div><h3 class="font-semibold mb-2">å£ç´™</h3><div id="modal-background-selector" class="grid grid-cols-3 gap-2"></div></div></div></div></div>
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-all duration-300 z-50 transform -translate-y-10"></div>
        
    <div id="quest-active-screen" class="focus-view-bg hidden fixed inset-0 bg-gray-900 text-gray-100 z-50 flex flex-col items-center justify-center p-4 transition-all duration-500 bg-cover bg-center">

        <div class="absolute inset-0 bg-black/60 z-0"></div>
        <div class="relative z-10 w-full h-full flex flex-col items-center justify-center">
        
        <div class="absolute top-6 right-6 flex items-center space-x-2 z-50">
            <button id="break-settings-btn" class="text-gray-400 p-2 rounded-full hover:bg-gray-700 transition-colors hidden">
                <i data-lucide="settings" class="w-7 h-7"></i>
            </button>
            <button id="end-quest-btn" class="text-gray-300 p-2 rounded-full hover:bg-gray-700 transition-colors">
                <i data-lucide="x" class="w-7 h-7"></i> </button>
        </div>
                
        <div id="quest-content-area" class="relative w-full h-full overflow-hidden">
            
            <div id="quest-section-view" class="hidden absolute inset-0 w-full h-full flex-col items-center justify-center p-4 z-10">
                <div class="text-center">
                    <h2 id="quest-section-title" class="text-2xl md:text-3xl font-bold mb-2 text-gray-400"></h2>
                    <p class="text-7xl md:text-9xl font-mono font-extrabold" id="quest-timer">25:00</p>
                    <p id="quest-progress" class="mt-4 text-lg text-gray-400"></p>
                </div>
            </div>

            <div id="quest-break-view" class="hidden absolute inset-0 w-full h-full flex-col items-center justify-center p-4 z-10">
                <div class="text-center mb-8 flex-shrink-0">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-400">â˜• ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ </h2>
                    <p class="text-5xl md:text-7xl font-mono font-extrabold" id="break-timer">05:00</p>
                </div>

                <div class="w-full max-w-sm overflow-y-auto max-h-[50vh]">
                    <div id="break-icon-grid" class="break-icon-grid-container">
                        </div>
                </div>
            </div>

            <div id="quest-transition-view" class="hidden absolute inset-0 w-full h-full flex-col items-center justify-center p-6 text-center z-20 animate-fadeIn bg-gray-900/95">
                <div class="mb-8">
                    <i id="transition-icon" data-lucide="arrow-right-circle" class="w-24 h-24 text-white opacity-80 mx-auto mb-4"></i>
                    <h2 id="transition-title" class="text-3xl md:text-4xl font-bold text-white mb-2"></h2>
                    <p id="transition-message" class="text-xl text-gray-300"></p>
                </div>
                
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 w-full max-w-sm border border-white/20 mb-8">
                    <p class="text-sm text-gray-400 mb-1">NEXT</p>
                    <p id="transition-next-text" class="text-xl font-bold text-white truncate"></p>
                    <p id="transition-next-duration" class="text-sm text-gray-400 font-mono mt-1"></p>
                </div>

                <button id="transition-start-btn" class="primary-bg primary-bg-hover text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center">
                    <i data-lucide="play" class="w-6 h-6 mr-2"></i>
                    å§‹ã‚ã‚‹
                </button>
            </div>

        </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  </div>
        </div>
    
    <div id="iframe-overlay" class="hidden fixed inset-0 bg-gray-900 z-[80] flex flex-col">
        <div class="bg-gray-800 p-2 flex justify-between items-center z-10 shadow-md">
            <span class="text-white font-bold ml-2">Game</span>
            <button id="close-iframe-btn" class="text-gray-300 p-2 rounded-full hover:bg-gray-700">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div class="relative flex-grow w-full h-full bg-white">
            <div id="iframe-loader" class="flex flex-col items-center justify-center">
                <div id="loader"></div> <p class="mt-4 text-gray-500 font-bold">Loading...</p>
            </div>
            <iframe id="break-iframe" class="w-full h-full absolute inset-0 opacity-0 transition-opacity duration-300" src="about:blank"></iframe>
        </div>
    </div>
    
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-700 rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 dark:text-white mb-4">ã‚¯ã‚¨ã‚¹ãƒˆã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ</h3>
            <div class="flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modal-confirm-btn" class="px-6 py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition">çµ‚äº†</button>
            </div>
        </div>
    </div>

    <div id="resume-quest-modal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <div class="mb-4">
                <i data-lucide="alert-circle" class="w-12 h-12 text-yellow-500 mx-auto mb-2"></i>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">ã‚¯ã‚¨ã‚¹ãƒˆã‚’å†é–‹ã—ã¾ã™ã‹ï¼Ÿ</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">å‰å›ã€ã‚¯ã‚¨ã‚¹ãƒˆã®é€”ä¸­ã§ã‚¢ãƒ—ãƒªãŒçµ‚äº†ã—ã¾ã—ãŸã€‚</p>
            </div>
            <div class="flex flex-col space-y-3">
                <button id="resume-quest-yes-btn" class="w-full py-3 rounded-lg primary-bg primary-bg-hover text-white font-bold shadow-lg">
                    å†é–‹ã™ã‚‹
                </button>
                <button id="resume-quest-no-btn" class="w-full py-3 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold">
                    çµ‚äº†ã—ã¦ãƒ›ãƒ¼ãƒ ã¸
                </button>
            </div>
        </div>
    </div>
    
    <div id="break-settings-modal" class="hidden fixed inset-0 bg-black/70 z-[70] flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm flex flex-col items-center max-h-[80vh]">
            <h3 class="text-lg font-bold text-white mb-4 text-center flex-shrink-0">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç·¨é›†</h3>
            
            <div class="w-full flex-grow overflow-y-auto mb-4">
                <h4 class="text-xs font-bold text-gray-400 mb-2 px-1">è¡¨ç¤ºä¸­ (ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ)</h4>
                <div id="break-active-list" class="w-full space-y-2"></div>
    
                <h4 class="text-xs font-bold text-gray-400 mt-6 mb-2 px-1">è¿½åŠ å¯èƒ½</h4>
                <div id="break-inactive-list" class="w-full flex flex-wrap gap-2"></div>
            </div>
    
            <button id="break-settings-close-btn" class="mt-2 px-6 py-2 rounded-lg primary-bg primary-bg-hover text-white font-semibold transition flex-shrink-0">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initialData = {
                quizzes: [
                    { id: 'math1', title: "æ•°å­¦ - æ­£è² ã®æ•°", subject: "æ•°å­¦", genre: "ä¸­1", tags: ['english1'], url: "https://docs.google.com/forms/d/e/1FAIpQLScsC0BFa_3gY-f-u4pW8Q22o_l3c0T-t_9c3z-q8pY6X-u8qQ/viewform?usp=sf_link" },
                    { id: 'english1', title: "è‹±èª - beå‹•è©", subject: "è‹±èª", genre: "ä¸­1", tags: ['math1', 'history1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSfvtBwi1Tb1z6YEQOclBi4J7pxOc8lEILZ-OPZ4k6aebFJmTg/viewform" },
                    { id: 'science1', title: "ç†ç§‘ - æ¤ç‰©ã®ã¤ãã‚Š", subject: "ç†ç§‘", genre: "ä¸­1", tags: [], url: "https://docs.google.com/forms/d/e/1FAIpQLSfp-24sW_4xT8d_aK_b_nL5e-pX7a-j8vN-qA9rR_cT_uL-vQ/viewform?usp=sf_link" },
                    { id: 'japanese1', title: "å›½èª - æ•è‰å­", subject: "å›½èª", genre: "å¤å…¸", tags: ['history1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSe-0P7p_L-rT9c-yS_eD-wA9iR_bO8kM-nL-u_V-iE7xS-tQ/viewform?usp=sf_link" },
                    { id: 'history1', title: "ç¤¾ä¼š - éŒå€‰æ™‚ä»£", subject: "ç¤¾ä¼š", genre: "æ­´å²", tags: ['japanese1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSeLprqPbZCZv2ufQ2qYqltnRiUE1FsBYODa_eNwOVO1NqZwBw/viewform?usp=pp_url" },
                ],
                
                themes: {
                    default: { name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', color: '#4f46e5', hover: '#4338ca', cost: 0 },
                    green: { name: 'ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ', color: '#16a34a', hover: '#15803d', cost: 100 },
                    red: { name: 'ã‚µãƒ³ã‚»ãƒƒãƒˆ', color: '#dc2626', hover: '#b91c1c', cost: 150 },
                    orange: { name: 'ãƒ“ã‚¿ãƒŸãƒ³', color: '#f97316', hover: '#ea580c', cost: 200 },
                    purple: { name: 'ãƒŸãƒƒãƒ‰ãƒŠã‚¤ãƒˆ', color: '#7c3aed', hover: '#6d28d9', cost: 250 },
                    pink: { name: 'ãƒã‚§ãƒªãƒ¼', color: '#db2777', hover: '#be185d', cost: 300 },
                    teal: { name: 'ã‚ªãƒ¼ã‚·ãƒ£ãƒ³', color: '#0d9488', hover: '#0f766e', cost: 350 },
                },
                backgrounds: {
                    default: { name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', url: '', cost: 0 , tone: 'system' },
                    sky: { name: 'é’ç©ºã¨æµã‚Œæ˜Ÿ', url: 'okumono_hosisoratate8.png', cost: 500, tone: 'light' },
                    night: { name: 'æ‰‹æ›¸ãã‚†ã‚‹ãƒ‰ãƒƒãƒˆ', url: 'https://sozaino.site/wp-content/uploads/2022/01/yurudot32.png', cost: 700, tone: 'light' },
                    sdotb: { name: 'ã‚·ãƒ£ãƒ¯ãƒ¼ãƒ‰ãƒƒãƒˆ(ãƒ–ãƒ«ãƒ¼)', url: 'https://sozaino.site/wp-content/uploads/2020/11/sai-4.png', cost: 700, tone: 'light' },
                    utyuu: { name: 'å£®å¤§ãªå®‡å®™', url: 'https://sozaino.site/wp-content/uploads/2021/02/utyuu.jpg', cost: 700, tone: 'dark' },
                    jyanguru: { name: 'ã‚¸ãƒ£ãƒ³ã‚°ãƒ«', url: 'https://sozaino.site/wp-content/uploads/2025/07/okumono_jungle1.png', cost: 700, tone: 'dark' },
                    wapop: { name: 'å’Œãƒãƒƒãƒ—ï¼ˆãƒ”ãƒ³ã‚¯ï¼‰', url: 'okumono_wapop3.png', cost: 700, tone: 'dark' },
                },
                
                games: {
                    // ID: { name: 'ã‚²ãƒ¼ãƒ å', url: 'URL', cost: å¿…è¦LP, icon: 'ã‚¢ã‚¤ã‚³ãƒ³å' }
                    // previews: ['ç”»åƒã®URL', 'å‹•ç”»ã®URL', ...] ã®å½¢å¼ã§è¿½åŠ ã—ã¾ã™
                    just100: { 
                        name: 'Just 1.00s', 
                        url: 'https://330march39.github.io/games/just1m_37928/', 
                        cost: 100, 
                        icon: 'gamepad-2',
                        // â–¼â–¼â–¼ ã“ã“ã«è¿½åŠ  â–¼â–¼â–¼
                        previews: [
                            'just100s.png', // ç”»åƒ1
                            'just100s_2.png',
                            'just100s_3.png',
                            // å‹•ç”»ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã«mp4ã®URLã‚’å…¥ã‚Œã‚‹
                            // 'https://www.w3schools.com/html/mov_bbb.mp4' 
                        ]
                    },
                    ColorHunter: { 
                        name: 'Color Hunter', 
                        url: 'https://330march39.github.io/games/color_hunter_24197/', 
                        cost: 300, 
                        icon: 'gamepad-2',
                        previews: [
                            'https://placehold.co/600x400/f97316/fff?text=Color+Hunter+1',
                            'https://placehold.co/600x400/0d9488/fff?text=Color+Hunter+2'
                        ]
                    },
                    MAKE10: { 
                        name: 'MAKE 10', 
                        url: 'https://330march39.github.io/games/make10_26518/', 
                        cost: 300, 
                        icon: 'gamepad-2',
                        previews: [
                            'https://placehold.co/600x400/f97316/fff?text=Color+Hunter+1',
                            'https://placehold.co/600x400/0d9488/fff?text=Color+Hunter+2'
                        ]
                    },
                },

                // â–¼â–¼â–¼ ã€è¿½åŠ ã€‘ã“ã“ã«éŸ³æ¥½ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ â–¼â–¼â–¼
                // éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã¯ã”è‡ªèº«ã§ã‚µãƒ¼ãƒãƒ¼ç­‰ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãã®URLã‚’è²¼ã£ã¦ãã ã•ã„
                // å‹•ä½œç¢ºèªç”¨ã«ãƒ•ãƒªãƒ¼ç´ æã®URLã‚’å…¥ã‚Œã¦ã„ã¾ã™
                music: {
                    // ID: { name: 'æ›²å', url: 'éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®URL', cost: å¿…è¦LP }
                    chill1: { name: 'Chill Beats', url: 'https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3', cost: 150 },
                    piano1: { name: 'Relaxing Piano', url: 'https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3', cost: 200 },
                    
                    // ä¾‹: è‡ªåˆ†ã®æ›²ã‚’è¿½åŠ ã™ã‚‹å ´åˆ
                    // mySong1: { name: 'My Study BGM', url: './music/mysong.mp3', cost: 300 },
                }
            };

            let state;
            let chartInstances = {};
            let breakSortable = null;
            let focusTimer = { interval: null, defaultTime: 0, timeLeft: 0, isRunning: false, isPaused: false };
            let stopwatch = { interval: null, startTime: 0, elapsedTime: 0, isRunning: false, isPaused: false };
            let miniTimerTemporarilyHidden = false;
            let quizTimer = { startTime: null };

            let previewAudio = new Audio(); // è©¦è´ç”¨
            let previewTimeout = null;      // 30ç§’åœæ­¢ç”¨ã‚¿ã‚¤ãƒãƒ¼
            
            const bgmAudio = new Audio();
            bgmAudio.loop = false; // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå†ç”Ÿã®ãŸã‚ãƒ«ãƒ¼ãƒ—ã¯æ‰‹å‹•åˆ¶å¾¡
            let currentTrackIndex = 0;

            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);
            
            let homeTaskListEl, newTaskInput, newTaskNumberEl;

            let quest = {
                plan: [], // { id, type: 'section' | 'break', text?, duration }
                active: false,
                currentIndex: -1,
                timerInterval: null,
                timeLeft: 0,
                breakWindow: null
            };

            // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¿½åŠ  ---
            const historyStack = []; // ãƒšãƒ¼ã‚¸å±¥æ­´ ['home-page', 'status-page'] ã®ã‚ˆã†ã«IDã‚’ä¿å­˜
            
            // --- ãƒšãƒ¼ã‚¸é·ç§»é–¢æ•° (Router) ---
            function navigateTo(pageId, direction = 'forward') {
                const currentPageId = historyStack.length > 0 ? historyStack[historyStack.length - 1] : 'home-page';
                const currentPage = document.getElementById(currentPageId);
                const nextPage = document.getElementById(pageId);
            
                if (!nextPage || currentPageId === pageId) return;
            
                // 1. å±¥æ­´ã®æ›´æ–°
                if (direction === 'forward') {
                    historyStack.push(pageId);
                } else {
                    // 'back' ã®å ´åˆã¯å‘¼ã³å‡ºã—å…ƒã§ pop æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’æƒ³å®šã€ã¾ãŸã¯ã“ã“ã§èª¿æ•´
                }
            
                // 2. ã‚¯ãƒ©ã‚¹ã®ä»˜ã‘æ›¿ãˆï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                nextPage.style.display = (pageId === 'focus-page') ? 'flex' : 'block';
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã®æ±ºå®š
                let enterClass, exitClass;
                if (direction === 'forward') {
                    enterClass = 'page-enter-forward';
                    exitClass = 'page-exit-forward';
                } else {
                    enterClass = 'page-enter-back';
                    exitClass = 'page-exit-back';
                }
            
                nextPage.classList.add(enterClass);
                if (currentPage) currentPage.classList.add(exitClass);
            
                // 3. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã®æƒé™¤
                setTimeout(() => {
                    nextPage.classList.remove(enterClass);
                    nextPage.classList.add('active');
                    
                    if (currentPage) {
                        currentPage.classList.remove(exitClass, 'active');
                        currentPage.style.display = 'none';
                    }
                    
                    // ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ä»¥å¤–ãªã‚‰ã‚¿ãƒ–ãƒãƒ¼ã‚’éš ã™ãªã©ã®å‡¦ç†ãŒã‚ã‚Œã°ã“ã“
                }, 300); // CSSã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã¨åˆã‚ã›ã‚‹
            
                // 4. ãƒšãƒ¼ã‚¸ã”ã¨ã®æç”»å‡¦ç†ã‚’å®Ÿè¡Œ
                if (renderEngine.pages[pageId]) {
                    renderEngine.pages[pageId]();
                }
            }
            
            // --- æˆ»ã‚‹æ©Ÿèƒ½ ---
            function goBack() {
                if (historyStack.length <= 1) return; // ãƒ›ãƒ¼ãƒ ã‚ˆã‚Šå‰ã«ã¯æˆ»ã‚Œãªã„
            
                const currentPageId = historyStack.pop(); // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’æ¨ã¦ã‚‹
                const prevPageId = historyStack[historyStack.length - 1]; // å‰ã®ãƒšãƒ¼ã‚¸
            
                navigateTo(prevPageId, 'back');
            }
            
            // --- ã‚¹ãƒ¯ã‚¤ãƒ—ãƒãƒƒã‚¯æ©Ÿèƒ½ (Gesture) ---
            let touchStartX = 0;
            let touchStartY = 0;
            
            document.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;
            
                // å·¦ç«¯(0-30px)ã‹ã‚‰é–‹å§‹ã€å³ã¸50pxä»¥ä¸Šã‚¹ãƒ¯ã‚¤ãƒ—ã€ã‹ã¤ç¸¦ç§»å‹•ãŒå°‘ãªã„å ´åˆ
                if (touchStartX < 30 && diffX > 50 && Math.abs(diffY) < 50) {
                    // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§ãªã‘ã‚Œã°æˆ»ã‚‹
                    if (historyStack.length > 1) {
                        goBack();
                    }
                }
            }, { passive: true });

            // --- ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¶å¾¡ã‚¯ãƒ©ã‚¹ï¼ˆä¿®æ­£ç‰ˆ: ãƒ‡ãƒƒãƒ‰ã‚¾ãƒ¼ãƒ³ï¼†ãƒœã‚¿ãƒ³ä¿®æ­£ï¼‰ ---
            class SwipeHandler {
                constructor(element, options = {}) {
                    this.container = element;
                    this.content = element.querySelector('.swipe-content');
                    this.actionsContainer = element.querySelector('.swipe-actions');
                    
                    this.onComplete = options.onComplete || null;
                    this.onDelete = options.onDelete || null;
                    
                    this.actionsWidth = this.actionsContainer ? this.actionsContainer.offsetWidth : 0;
                    
                    this.startX = 0;
                    this.startY = 0;
                    this.currentX = 0;
                    this.startOffset = 0;
                    
                    this.isDragging = false; // æŒ‡ãŒç”»é¢ã«è§¦ã‚Œã¦ã„ã‚‹ã‹
                    this.isSwiping = false;  // å®Ÿéš›ã«ã‚¹ãƒ¯ã‚¤ãƒ—å‹•ä½œï¼ˆæ¨ªç§»å‹•ï¼‰ãŒç¢ºå®šã—ãŸã‹
                    
                    this.initEvents();
                }
            
                initEvents() {
                    const start = (x, y, target) => {
                        // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã¯é™¤å¤–
                        if (target.tagName === 'INPUT') return;
                        
                        // æ—¢ã«é–‹ã„ã¦ã„ã‚‹çŠ¶æ…‹ã§ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰é–‰ã˜ã‚‹å‹•ä½œã‚’å„ªå…ˆ
                        if (this.container.classList.contains('swiped-open') && target.closest('.swipe-content')) {
                             this.snapToClose();
                             return;
                        }

                        this.isDragging = true;
                        this.isSwiping = false; // ãƒªã‚»ãƒƒãƒˆ
                        this.startX = x;
                        this.startY = y;
                        
                        const style = window.getComputedStyle(this.content);
                        const matrix = new WebKitCSSMatrix(style.transform);
                        this.startOffset = matrix.m41; 
                        
                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸€æ™‚åœæ­¢
                        this.container.classList.add('is-dragging');
                    };
            
                    const move = (e, x, y) => {
                        if (!this.isDragging) return;
            
                        const diffX = x - this.startX;
                        const diffY = y - this.startY;
            
                        // --- â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: ä¸æ„Ÿå¸¯ï¼ˆãƒ‡ãƒƒãƒ‰ã‚¾ãƒ¼ãƒ³ï¼‰ã®è¨­å®š ---
                        // ã¾ã ã‚¹ãƒ¯ã‚¤ãƒ—ãŒç¢ºå®šã—ã¦ã„ãªã„å ´åˆ
                        if (!this.isSwiping) {
                            // ç¸¦ç§»å‹•ã®æ–¹ãŒå¤§ãã„å ´åˆã¯ã‚¹ãƒ¯ã‚¤ãƒ—ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆï¼‰
                            if (Math.abs(diffY) > Math.abs(diffX)) {
                                this.isDragging = false;
                                this.container.classList.remove('is-dragging');
                                return;
                            }
                            
                            // â˜…ã“ã“ãŒé‡è¦: æ¨ªç§»å‹•ãŒ15pxã‚’è¶…ãˆã‚‹ã¾ã§ã¯ç”»é¢ã‚’å‹•ã‹ã•ãªã„
                            // ã“ã‚Œã«ã‚ˆã‚Šã€ä¸¦ã³æ›¿ãˆã®é•·æŠ¼ã—ä¸­ã®å¾®ç´°ãªæºã‚Œã§å‰Šé™¤ãƒœã‚¿ãƒ³ãŒå‡ºã‚‹ã®ã‚’é˜²ã
                            if (Math.abs(diffX) < 15) {
                                return; 
                            }
                            
                            // 15pxä»¥ä¸Šå‹•ã„ãŸã‚‰ã‚¹ãƒ¯ã‚¤ãƒ—ç¢ºå®š
                            this.isSwiping = true;
                            this.container.classList.add('is-swiping');
                        }

                        // ã“ã“ã‹ã‚‰ä¸‹ã¯ã‚¹ãƒ¯ã‚¤ãƒ—ç¢ºå®šå¾Œã®å‡¦ç†
                        e.preventDefault(); // ç”»é¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ­¢ã‚ã‚‹
            
                        let newX = this.startOffset + diffX;
            
                        // å³ç«¯åˆ¶é™
                        if (newX > 0) newX = 0;
                        // å·¦ç«¯åˆ¶é™
                        if (newX < -this.actionsWidth - 150) newX = -this.actionsWidth - 150;
            
                        this.currentX = newX;
                        this.content.style.transform = `translateX(${newX}px)`;
                    };
            
                    const end = () => {
                        if (!this.isDragging) return;
                        this.isDragging = false;
                        this.isSwiping = false;
                        this.container.classList.remove('is-dragging');
                        this.container.classList.remove('is-swiping');
            
                        // é–¾å€¤åˆ¤å®š
                        if (this.currentX < -200) { // ãƒ•ãƒ«ã‚¹ãƒ¯ã‚¤ãƒ—å‰Šé™¤
                            if (this.onDelete) {
                                this.content.style.transform = `translateX(-120vw)`;
                                this.performDelete();
                            } else {
                                this.snapToOpen();
                            }
                        } else if (this.currentX < -(this.actionsWidth / 2)) {
                            this.snapToOpen();
                        } else {
                            this.snapToClose();
                        }
                    };
            
                    // Touch Events
                    this.content.addEventListener('touchstart', (e) => start(e.touches[0].clientX, e.touches[0].clientY, e.target), { passive: true });
                    this.content.addEventListener('touchmove', (e) => move(e, e.touches[0].clientX, e.touches[0].clientY), { passive: false });
                    this.content.addEventListener('touchend', end);
            
                    // Mouse Events
                    this.content.addEventListener('mousedown', (e) => start(e.clientX, e.clientY, e.target));
                    window.addEventListener('mousemove', (e) => { if(this.isDragging) move(e, e.clientX, e.clientY); });
                    window.addEventListener('mouseup', () => { if(this.isDragging) end(); });
                    
                    // --- â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®ç¢ºå®Ÿãªç™ºç« ---
                    const completeBtn = this.actionsContainer ? this.actionsContainer.querySelector('.btn-complete') : null;
                    if (completeBtn) {
                        // touchstartã§ã‚‚åå¿œã™ã‚‹ã‚ˆã†ã«ã—ã€ãƒãƒ–ãƒªãƒ³ã‚°ã‚’æ­¢ã‚ã‚‹
                        completeBtn.addEventListener('touchstart', (e) => e.stopPropagation(), { passive: true });
                        completeBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); // è¦ªè¦ç´ ã¸ã®ä¼æ’­ã‚’æ­¢ã‚ã‚‹
                            this.snapToClose();
                            if (this.onComplete) setTimeout(() => this.onComplete(), 300);
                        });
                    }
            
                    const deleteBtn = this.actionsContainer ? this.actionsContainer.querySelector('.btn-delete') : null;
                    if (deleteBtn) {
                        deleteBtn.addEventListener('touchstart', (e) => e.stopPropagation(), { passive: true });
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); // è¦ªè¦ç´ ã¸ã®ä¼æ’­ã‚’æ­¢ã‚ã‚‹
                            this.performDelete();
                        });
                    }
                }
            
                snapToOpen() {
                    this.content.style.transform = `translateX(-${this.actionsWidth}px)`;
                    this.container.classList.add('swiped-open');
                }
            
                snapToClose() {
                    this.content.style.transform = `translateX(0px)`;
                    this.container.classList.remove('swiped-open');
                }
            
                performDelete() {
                    this.container.style.height = this.container.offsetHeight + 'px';
                    this.container.classList.add('swipe-deleting');
                    
                    requestAnimationFrame(() => {
                        this.container.style.height = '0px';
                        setTimeout(() => {
                            if (this.onDelete) this.onDelete();
                        }, 300);
                    });
                }
            }

            // ã‚¯ã‚¨ã‚¹ãƒˆç”¨ DOMè¦ç´ 
            const questView = $('#quest-view');
            const questPlanListEl = $('#quest-plan-list');
            const breakSettingsListEl = $('#break-settings-list');
            const startQuestBtn = $('#start-quest-btn');
            const addBreaksBtn = $('#add-breaks-btn');
            const addSectionBtn = $('#add-section-btn');
            const addBreakBtn = $('#add-break-btn');
            
            const questActiveScreen = $('#quest-active-screen');
            const questSectionView = $('#quest-section-view');
            const questBreakView = $('#quest-break-view');
            const questSectionTitle = $('#quest-section-title');
            const questTimerEl = $('#quest-timer');
            const breakTimerEl = $('#break-timer');
            const questProgressEl = $('#quest-progress');
            const endQuestBtn = $('#end-quest-btn');

            const confirmationModal = $('#confirmation-modal');
            const modalConfirmBtn = $('#modal-confirm-btn');
            const modalCancelBtn = $('#modal-cancel-btn');

            const iframeOverlay = $('#iframe-overlay');
            const breakIframe = $('#break-iframe');
            const closeIframeBtn = $('#close-iframe-btn');
            const breakIconGrid = $('#break-icon-grid');
            
            const loadState = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const defaultState = {
                    user: {
                        isRegistered: false, // åˆå›ç™»éŒ²å®Œäº†ãƒ•ãƒ©ã‚°
                        name: 'ã‚²ã‚¹ãƒˆ',
                        icon: 'ğŸ™‚',
                        grade: '',
                        id: Math.random().toString(36).substring(2, 9) // ç°¡æ˜“ID
                    },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  profile: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lp: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unlockedThemes: ['default'],Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeTheme: 'default',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unlockedBackgrounds: ['default'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeBackground: 'default',
                        unlockedGames: [], // è§£æ”¾æ¸ˆã¿ã‚²ãƒ¼ãƒ ID
                        unlockedMusic: [], // è§£æ”¾æ¸ˆã¿éŸ³æ¥½ID
                        tasksLastUpdated: null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
                    tasks: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progress: {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pinnedQuizzes: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countdowns: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  focus: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalTime: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mode: 'timer',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isRunning: false, // å®Ÿè¡Œä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startTime: null,Â  // é–‹å§‹æ™‚åˆ»ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration: 0Â  Â  Â  Â // ã‚¿ã‚¤ãƒãƒ¼ã®ç·æ™‚é–“
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  studyLog: {},Â 
                    sessionLog: [],
                    savedQuest: null, // â˜…è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®ä¸­æ–­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settings: { backgroundScopeGlobal: true , 
                                manualDarkMode: false,
                                bgmEnabled: false,      // BGMæ©Ÿèƒ½ã®ON/OFF
                                playlist: [],           // å†ç”Ÿãƒªã‚¹ãƒˆ(IDã®é…åˆ—)
                                bgmVolume: 0.5          // éŸ³é‡ (ä»»æ„)
                              },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastLogin: null,
                    breakIcons: [
                        { id: 'x', name: 'X (Twitter)', icon: 'message-circle', url: 'https://x.com', openMode: 'external', visible: true },
                        { id: 'instagram', name: 'Instagram', icon: 'instagram', url: 'https://www.instagram.com/', openMode: 'external', visible: true },
                        { id: 'youtube', name: 'YouTube', icon: 'youtube', url: 'https://www.youtube.com/', openMode: 'external', visible: true },
                        //{ id: 'scratch1', name: 'ï¾ï¾ï¾—ï¾ï¾ƒï½¨ï½±', icon: 'gamepad-2', url: 'https://scratch.mit.edu/projects/543610448/fullscreen/', openMode: 'external', visible: true },
                        //{ id: 'scratch2', name: 'ï¾Œï¾ï¾˜ï½»ï¾ï½°ï½½ï¾', icon: 'gamepad-2', url: 'https://scratch.mit.edu/projects/415836558/fullscreen/', openMode: 'external', visible: true }
                    ],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼ ---
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 1. èª­ã¿è¾¼ã¿å…ˆã®å¤‰æ•°ã‚’ `let` ã§å®£è¨€
Â  Â  Â  Â  Â  Â  Â  Â  let loaded = {};
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedData = localStorage.getItem('quizAppUltimateV8');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. ãƒ‡ãƒ¼ã‚¿ãŒ null ã‚„ç©ºæ–‡å­—ã§ãªã„å ´åˆã®ã¿ã€JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ï¼ˆè§£æï¼‰ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (savedData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loaded = JSON.parse(savedData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 4. ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒç ´æï¼‰ã—ãŸå ´åˆ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 5. ç ´æã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€`loaded` ã¯ç©ºã®ã¾ã¾ã«ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('quizAppUltimateV8');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 6. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€èª­ã¿è¾¼ã‚“ã å€¤ã§ä¸Šæ›¸ãï¼ˆãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚å®‰å…¨ã«ãƒãƒ¼ã‚¸ï¼‰
Â  Â  Â  Â  Â  Â  Â  Â  // (ã“ã“ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜)
Â  Â  Â  Â  Â  Â  Â  Â  state = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...defaultState,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...loaded,
                    user: { ...defaultState.user, ...(loaded.user || {}) }, // â˜…è¿½åŠ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  profile: { ...defaultState.profile, ...(loaded.profile || {}) },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  focus: { ...defaultState.focus, ...(loaded.focus || {}) },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settings: { ...defaultState.settings, ...(loaded.settings || {}) },
                    breakIcons: loaded.breakIcons || defaultState.breakIcons
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---

Â  Â  Â  Â  Â  Â  Â  Â  // 3. ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹å‡¦ç† (å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãã®ã¾ã¾æµç”¨)
Â  Â  Â  Â  Â  Â  Â  Â  if(state.lastLogin !== new Date().toDateString()){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addLP(10000, 'ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹', false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.lastLogin = new Date().toDateString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveState(); // stateãŒå®Œå…¨ã«æ§‹ç¯‰ã•ã‚ŒãŸå¾Œã«ä¿å­˜
Â  Â  Â  Â  Â  Â  Â  Â  }

                // 4. ä»Šæ—¥ã®äºˆå®šãƒªã‚»ãƒƒãƒˆå‡¦ç†
Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date().toDateString();
Â  Â  Â  Â  Â  Â  Â  Â  if (state.profile.tasksLastUpdated !== today) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸãŸã‚ã€ã‚¿ã‚¹ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.tasks = []; // ã‚¿ã‚¹ã‚¯ã‚’ç©ºã«ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.profile.tasksLastUpdated = today; // æ›´æ–°æ—¥ã‚’ä»Šæ—¥ã«è¨­å®š
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
            
            const saveState = () => localStorage.setItem('quizAppUltimateV8', JSON.stringify(state));
            
           // æ—¢å­˜ã® updateAppearance é–¢æ•°ã‚’ã€ã“ã®æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã§å®Œå…¨ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
            
            const updateAppearance = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const appContainer = $('#app-container');
Â  Â  Â  Â  Â  Â  Â  Â  const activeBgId = state.profile.activeBackground;
Â  Â  Â  Â  Â  Â  Â  Â  const activeBg = initialData.backgrounds[activeBgId] || initialData.backgrounds['default'];
Â  Â  Â  Â  Â  Â  Â  Â  const isGlobal = state.settings.backgroundScopeGlobal;
Â  Â  Â  Â  Â  Â  Â  Â  const hasImage = activeBg && activeBg.url;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- 1. ãƒ†ãƒ¼ãƒæ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ ---
Â  Â  Â  Â  Â  Â  Â  Â  let effectiveTone = activeBg.tone;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (effectiveTone === 'system') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  effectiveTone = 'dark';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  effectiveTone = 'light';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- 2. æ±ºå®šã—ãŸãƒ†ãƒ¼ãƒã‚’HTMLè¦ç´ ã«é©ç”¨ (ä¿®æ­£æ¸ˆã¿ã®ãƒ­ã‚¸ãƒƒã‚¯) ---
Â  Â  Â  Â  Â  Â  Â  Â  if (effectiveTone === 'dark') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.classList.add('dark');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.setAttribute('data-theme', 'dark');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.classList.remove('dark');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.setAttribute('data-theme', 'light');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- 3. èƒŒæ™¯ç”»åƒã®é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯ ---
Â  Â  Â  Â  Â  Â  Â  Â  if (isGlobal && hasImage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appContainer.style.backgroundImage = `url(${activeBg.url})`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appContainer.style.backgroundImage = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

            const updateLpDisplay = () => {
                $('#lp-display').textContent = `${state.profile.lp} LP`;
                if ($('#point-details-modal').style.display === 'flex') {
                    $('#modal-lp-display').textContent = state.profile.lp;
                }
            };

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ã®ç¾åœ¨å¹´æœˆ
            let currentCalendarDate = new Date();
            let selectedReportDate = new Date(); // é¸æŠä¸­ã®æ—¥ä»˜

            const renderEngine = {
                pages: {
                    'home-page': () => {
                        const today = new Date();
                        $('#today-date').textContent = `${today.getFullYear()}å¹´ ${today.getMonth() + 1}æœˆ ${today.getDate()}æ—¥ (${'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[today.getDay()]}æ›œæ—¥)`;

                        const countdownContainer = $('#countdown-list');
                        countdownContainer.innerHTML = state.countdowns.length ? state.countdowns.map(cd => {
                            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                            const targetStart = new Date(cd.date);
                            targetStart.setHours(0,0,0,0);
                            const diffTime = targetStart - todayStart;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            const dayText = diffDays > 0 ? `ã‚ã¨ <span class="text-2xl font-bold primary-text">${diffDays}</span> æ—¥` : diffDays === 0 ? `<span class="text-xl font-bold text-red-500">ä»Šæ—¥ã§ã™ï¼</span>` : `<span class="text-gray-500">çµ‚äº†</span>`;
                            return `<div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm p-3 flex items-center justify-between"><div><h3 class="font-semibold text-gray-800 dark:text-gray-200">${cd.name}</h3><p class="text-sm text-gray-500 dark:text-gray-400">${cd.date.replace(/-/g, '/')}</p></div><div class="flex items-center"><div class="mr-4">${dayText}</div><button class="edit-countdown-btn p-2 text-gray-400 hover:text-gray-600" data-id="${cd.id}"><i data-lucide="edit" class="w-4 h-4"></i></button></div></div>`;
                        }).join('') : `<p class="text-sm text-gray-500 text-center">å³ä¸Šã®ã€Œ+ã€ãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆãªã©ã®æ—¥ç¨‹ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</p>`;
                        
                        renderHomeTasks();
                    },
                    'study-page': () => {
                        const pinnedContainer = $('#pinned-quizzes');
                        const pinnedSectionContainer = pinnedContainer.parentElement;
                    
                        if (state.pinnedQuizzes.length > 0) {
                            pinnedSectionContainer.style.display = 'block';
                            const pinnedQuizzes = state.pinnedQuizzes.map(id => initialData.quizzes.find(q => q.id === id)).filter(Boolean);
                            pinnedContainer.innerHTML = pinnedQuizzes.map(q => createQuizCard(q, true)).join('');
                        } else {
                            pinnedSectionContainer.style.display = 'none';
                        }
                    
                        const allContainer = $('#all-quizzes');
                        const subjects = ['all', ...new Set(initialData.quizzes.map(q => q.subject))];
                        const activeFilter = $('#filter-container .active')?.dataset.filter || 'all';
                        $('#filter-container').innerHTML = subjects.map(s => `<button class="filter-btn ${s === activeFilter ? 'active primary-bg text-white' : 'bg-gray-200 dark:bg-gray-600'} px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap" data-filter="${s}">${s === 'all' ? 'ã™ã¹ã¦' : s}</button>`).join('');
                    
                        const quizzes = initialData.quizzes.filter(q => activeFilter === 'all' || q.subject === activeFilter);
                        allContainer.innerHTML = quizzes.map(q => createQuizCard(q, state.pinnedQuizzes.includes(q.id))).join('');
                    },
                    // å¤‰æ›´å¾Œ
                  'focus-page': () => {
                      updateFocusModeUI();
                      updateBackgrounds();
                        const activeBg = initialData.backgrounds[state.profile.activeBackground] || initialData.backgrounds['default'];
                        const hasImage = activeBg && activeBg.url;
                        const isGlobal = state.settings.backgroundScopeGlobal;
                        
                        $$('.focus-view-bg').forEach(el => {
                            // ã€Œå…¨ä½“é©ç”¨ã€ãŒã‚ªãƒ•ã§ã€ã‹ã¤ç”»åƒãŒã‚ã‚‹å ´åˆã®ã¿ã€é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã®è¦ç´ ã«ç›´æ¥èƒŒæ™¯ã‚’è¨­å®š
                            if (!isGlobal && hasImage) {
                                el.style.backgroundImage = `url(${activeBg.url})`;
                            } else {
                                // ã€Œå…¨ä½“é©ç”¨ã€ãŒã‚ªãƒ³ã®å ´åˆã¯ã€#app-containerã®èƒŒæ™¯ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«è‡ªèº«ã®èƒŒæ™¯ã‚’æ¶ˆã™
                                el.style.backgroundImage = 'none';
                            }
                        });
                    },
                    'my-chart-page': () => {
                        // --- 1. çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—ã¨è¡¨ç¤º ---
                        if (!state.sessionLog) state.sessionLog = [];
                        
                        // --- 1. çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—ã¨è¡¨ç¤º ---
                        if (!state.sessionLog) state.sessionLog = [];
                        
                        const now = new Date();
                        // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§ã€Œä»Šæ—¥ã€ã®æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆ
                        const y = now.getFullYear();
                        const mt = String(now.getMonth() + 1).padStart(2, '0');
                        const dt = String(now.getDate()).padStart(2, '0');
                        const todayStr = `${y}-${mt}-${dt}`;
                        
                        // ä»Šé€±ã®æœˆæ›œæ—¥ã‚’è¨ˆç®—
                        const dayOfWeek = now.getDay(); // 0(æ—¥) - 6(åœŸ)
                        const diffToMon = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); 
                        const monday = new Date(now.setDate(diffToMon));
                        monday.setHours(0,0,0,0);
                    
                        // é›†è¨ˆ
                        let todaySec = 0;
                        let weekSec = 0;
                        let totalSec = 0;
                    
                        state.sessionLog.forEach(log => {
                            totalSec += log.duration;
                            if (log.date === todayStr) {
                                todaySec += log.duration;
                            }
                            const logDate = new Date(log.date);
                            if (logDate >= monday) {
                                weekSec += log.duration;
                            }
                        });
                    
                        // ã€Œ59åˆ†ã¯0æ™‚é–“ã€ -> Math.floor(seconds / 3600)
                        $('#report-stat-today').innerHTML = `${Math.floor(todaySec / 3600)}<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span>`;
                        $('#report-stat-week').innerHTML = `${Math.floor(weekSec / 3600)}<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span>`;
                        $('#report-stat-total').innerHTML = `${Math.floor(totalSec / 3600)}<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span>`;
                    
                        // --- 2. é€±é–“ãƒ¬ãƒãƒ¼ãƒˆï¼ˆæ—¢å­˜ã®ã‚°ãƒ©ãƒ•ï¼‰ ---
                        // (ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¯ studyLog ã®ã¾ã¾ã§OKã€ã‚ã‚‹ã„ã¯ sessionLog ã‹ã‚‰å†é›†è¨ˆã—ã¦ã‚‚OK)
                        const activeTheme = initialData.themes[state.profile.activeTheme] || initialData.themes['default'];
                        const rgb = hexToRgb(activeTheme.color);
                        const chartBarColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.5)`;
                        const chartBorderColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)`;
                    
                        const labels = [];
                        const data = [];
                        for (let i = 6; i >= 0; i--) {
                            const d = new Date();
                            d.setDate(d.getDate() - i);
                            // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆ
                            const y = d.getFullYear();
                            const m = String(d.getMonth() + 1).padStart(2, '0');
                            const da = String(d.getDate()).padStart(2, '0');
                            const day = `${y}-${m}-${da}`;
                        
                            labels.push(`${d.getMonth()+1}/${d.getDate()}`);
                            
                            // sessionLogã‹ã‚‰è©²å½“æ—¥ã®åˆè¨ˆã‚’è¨ˆç®—
                            const dayTotal = state.sessionLog
                                .filter(l => l.date === day)
                                .reduce((acc, cur) => acc + cur.duration, 0);
                                
                            data.push(dayTotal / 60); // åˆ†å˜ä½
                        }
                        renderChart('study-time-chart', 'bar', { 
                            labels, 
                            datasets: [{ 
                                label: 'å­¦ç¿’æ™‚é–“', // (å˜ä½ã¯è»¸ã«å‡ºã‚‹ã®ã§ãƒ©ãƒ™ãƒ«ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«)
                                data, 
                                backgroundColor: chartBarColor, 
                                borderColor: chartBorderColor, 
                                borderWidth: 1 
                            }] 
                        }, { 
                            responsive: true,
                            maintainAspectRatio: false, // æ ã«åˆã‚ã›ã¦ãƒªã‚µã‚¤ã‚º
                            scales: { 
                                y: { 
                                    beginAtZero: true,
                                    ticks: {
                                        // â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šæœ€å°å˜ä½ã‚’1(åˆ†)ã«ã™ã‚‹ã€‚ã“ã‚Œã§0.xã®ã‚ˆã†ãªè¡¨ç¤ºã‚’é˜²ã
                                        stepSize: 1, 
                                        autoSkip: true,
                                        // â˜…ãƒ¡ãƒ¢ãƒªã®è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
                                        callback: function(value) {
                                            if (value === 0) return '0';
                                            // 60ã§å‰²ã‚Šåˆ‡ã‚Œã‚‹ï¼ˆ1æ™‚é–“, 2æ™‚é–“...ï¼‰å ´åˆã¯ã€Œæ™‚é–“ã€è¡¨ç¤º
                                            if (value >= 60 && value % 60 === 0) {
                                                return (value / 60) + 'æ™‚é–“';
                                            }
                                            // ãã‚Œä»¥å¤–ã¯ã€Œåˆ†ã€è¡¨ç¤º
                                            return value + 'åˆ†';
                                        }
                                    }
                                } 
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆã‚¿ãƒƒãƒ—ã—ãŸæ™‚ï¼‰ã®è¡¨ç¤ºã‚‚ã€Œâ—¯æ™‚é–“â—¯åˆ†ã€å½¢å¼ã«ã™ã‚‹
                                        label: function(context) {
                                            const val = context.raw; // åˆ†
                                            const h = Math.floor(val / 60);
                                            const m = Math.round(val % 60); // å¿µã®ãŸã‚å››æ¨äº”å…¥
                                            if (h > 0) return ` ${h}æ™‚é–“ ${m}åˆ†`;
                                            return ` ${m}åˆ†`;
                                        }
                                    }
                                }
                            }
                        });
                    
                        // --- 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨è©³ç´°ãƒªã‚¹ãƒˆã®æç”» ---
                        renderCalendar();
                        renderDailyDetails(selectedReportDate);
                        
                        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šï¼ˆé‡è¤‡ç™»éŒ²é˜²æ­¢ã®ãŸã‚æ¯å›ã‚¯ãƒªã‚¢ã™ã‚‹ã‹ã€onclickã‚’ä½¿ã†ï¼‰
                        $('#cal-prev-btn').onclick = () => {
                            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                            renderCalendar();
                        };
                        $('#cal-next-btn').onclick = () => {
                            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                            renderCalendar();
                        };
                    },
                    'settings-page': () => {
                        const settingsPage = $('#settings-page');
                        settingsPage.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢

                        // --- 1. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ (ä¸€ç•ªä¸Š) ---
                        const profileCard = document.createElement('div');
                        profileCard.id = 'settings-profile-card';
                        profileCard.className = 'bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-4 flex items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition';
                        profileCard.innerHTML = `
                            <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-3xl mr-4 border-2" style="border-color: var(--primary-color);">
                                ${state.user.icon}
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-bold text-lg">${state.user.name}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${state.user.grade || 'å­¦å¹´æœªè¨­å®š'}</p>
                            </div>
                            <i data-lucide="chevron-right" class="text-gray-400"></i>
                        `;
                        profileCard.addEventListener('click', () => { openProfileModal(); });
                        settingsPage.appendChild(profileCard);

                        // --- 2. é€šçŸ¥è¨­å®š ---
                        const notifCard = document.createElement('div');
                        notifCard.id = 'notification-settings-card';
                        notifCard.className = 'bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-4';
                        notifCard.innerHTML = `
                            <h3 class="font-semibold mb-2">é€šçŸ¥è¨­å®š</h3>
                            <button id="notification-permission-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mb-4"><i data-lucide="bell-ring" class="w-5 h-5 mr-2"></i>ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¨±å¯</button>
                        `;
                        // é€šçŸ¥è¨±å¯æ¸ˆã¿ãªã‚‰éš ã™
                        if ('Notification' in window && Notification.permission === 'granted') {
                            notifCard.style.display = 'none';
                        }
                        settingsPage.appendChild(notifCard);
                        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§è¨­å®šæ¸ˆã¿ã ãŒã€å‹•çš„ç”Ÿæˆãªã®ã§å†åº¦ç´ä»˜ã‘ã‚‹ã‹ã€ã‚ã‚‹ã„ã¯IDãƒ™ãƒ¼ã‚¹ã®æ—¢å­˜ãƒªã‚¹ãƒŠãƒ¼ãŒå‹•ãã‚ˆã†ã«IDã‚’ç¶­æŒ

                        // --- 3. ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼è¨­å®š ---
                        const themeCard = document.createElement('div');
                        themeCard.className = 'bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-4';
                        themeCard.innerHTML = `
                             <h3 class="font-semibold mb-2">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸æŠ</h3>
                             <div id="theme-selector" class="grid grid-cols-4 gap-4">
                                ${state.profile.unlockedThemes.map(id => {
                                    const theme = initialData.themes[id];
                                    const isActive = state.profile.activeTheme === id;
                                    return `<div class="text-center">
                                        <button class="theme-btn w-12 h-12 rounded-full border-4 ${isActive ? 'border-blue-500' : 'border-transparent'} relative" style="background-color: ${theme.color}" data-theme="${id}"></button>
                                        <p class="text-xs mt-1">${theme.name}</p>
                                    </div>`;
                                }).join('')}
                             </div>
                        `;
                        settingsPage.appendChild(themeCard);

                        // --- 4. å£ç´™è¨­å®š ---
                        const bgCard = document.createElement('div');
                        bgCard.className = 'bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-4';
                        bgCard.innerHTML = `
                            <h3 class="font-semibold mb-2">å£ç´™ã‚’é¸æŠ</h3>
                            <div id="background-selector" class="grid grid-cols-3 gap-4">
                                ${state.profile.unlockedBackgrounds.map(id => {
                                    const bg = initialData.backgrounds[id];
                                    const isActive = state.profile.activeBackground === id;
                                    return `<div class="text-center">
                                        <button class="background-btn w-full h-20 rounded-lg border-4 ${isActive ? 'border-blue-500' : 'border-transparent'} relative bg-gray-500 bg-cover bg-center" style="background-image: ${bg.url ? `url(${bg.url})` : 'none'}" data-bg="${id}"></button>
                                        <p class="text-xs mt-1">${bg.name}</p>
                                    </div>`;
                                }).join('')}
                            </div>
                            <hr class="my-4 border-gray-200 dark:border-gray-600">
                            <div class="flex items-center justify-between">
                                <p class="font-semibold">å£ç´™ã‚’ã‚¢ãƒ—ãƒªå…¨ä½“ã«é©ç”¨</p>
                                <input type="checkbox" id="background-scope-toggle" class="toggle-checkbox" ${state.settings.backgroundScopeGlobal ? 'checked' : ''}>
                            </div>
                        `;
                        settingsPage.appendChild(bgCard);

                        // --- 5. BGMè¨­å®š (ä¸€ç•ªä¸‹ã«ç§»å‹•ï¼†ãƒ‡ã‚¶ã‚¤ãƒ³åˆ·æ–°) ---
                        const bgmCard = document.createElement('div');
                        bgmCard.className = 'bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-20'; // pbç¢ºä¿
                        
                        // BGMã‚«ãƒ¼ãƒ‰ã®ä¸­èº«ã‚’æ§‹ç¯‰
                        bgmCard.innerHTML = `
                            <h3 class="font-semibold mb-2 flex items-center justify-between">
                                <div class="flex items-center">
                                    <i data-lucide="music" class="w-5 h-5 mr-2 primary-text"></i>
                                    <span>BGMè¨­å®š (ã‚¯ã‚¨ã‚¹ãƒˆä¸­)</span>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="bgm-toggle" class="toggle-checkbox" ${state.settings.bgmEnabled ? 'checked' : ''}>
                                </div>
                            </h3>
                            <p class="text-xs text-gray-500 mb-4">ONã«ã™ã‚‹ã¨ã€ã‚¯ã‚¨ã‚¹ãƒˆã®ã€Œå­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€ä¸­ã«ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆé †ã§å†ç”Ÿã•ã‚Œã¾ã™ã€‚</p>
                            
                            <h4 class="text-sm font-bold mb-2 flex items-center"><i data-lucide="list-music" class="w-4 h-4 mr-1"></i> ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h4>
                            <div id="playlist-container" class="space-y-2 mb-6 min-h-[50px] bg-gray-50 dark:bg-gray-800/50 rounded-lg p-2">
                                </div>
                            
                            <h4 class="text-sm font-bold mb-2 flex items-center"><i data-lucide="library" class="w-4 h-4 mr-1"></i> è¿½åŠ å¯èƒ½ãªæ›²</h4>
                            <div id="unlocked-music-list" class="flex flex-wrap gap-2">
                                </div>
                        `;
                        settingsPage.appendChild(bgmCard);

                        // --- BGMãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£… ---

                        // 1. ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ
                        const bgmToggle = bgmCard.querySelector('#bgm-toggle');
                        bgmToggle.addEventListener('change', (e) => {
                            state.settings.bgmEnabled = e.target.checked;
                            saveState();
                        });

                        // 2. ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæç”»é–¢æ•°
                        const renderPlaylist = () => {
                            const container = bgmCard.querySelector('#playlist-container');
                            if (state.settings.playlist.length === 0) {
                                container.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                            } else {
                                container.innerHTML = '';
                                state.settings.playlist.forEach((id, index) => {
                                    const track = initialData.music[id];
                                    if(!track) return; 

                                    const itemEl = document.createElement('div');
                                    itemEl.className = 'bg-white dark:bg-gray-600 rounded-lg p-2 flex items-center shadow-sm border border-gray-100 dark:border-gray-500';
                                    itemEl.setAttribute('data-id', id);
                                    
                                    itemEl.innerHTML = `
                                        <div class="playlist-handle text-gray-400 cursor-grab active:cursor-grabbing p-2 mr-1">
                                            <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                                        </div>
                                        <div class="flex-grow min-w-0">
                                            <p class="font-bold text-sm truncate text-gray-800 dark:text-gray-100">${track.name}</p>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <button class="preview-bgm-btn p-2 rounded-full text-indigo-500 hover:bg-indigo-50 dark:hover:bg-gray-500 transition" title="è©¦ã—èã">
                                                <i data-lucide="play-circle" class="w-5 h-5"></i>
                                            </button>
                                            <button class="remove-bgm-btn p-2 rounded-full text-red-500 hover:bg-red-50 dark:hover:bg-gray-500 transition" title="ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤">
                                                <i data-lucide="x-circle" class="w-5 h-5"></i>
                                            </button>
                                        </div>
                                    `;

                                    // è©¦è´ãƒœã‚¿ãƒ³
                                    const previewBtn = itemEl.querySelector('.preview-bgm-btn');
                                    previewBtn.addEventListener('click', () => {
                                        toggleMusicPreview(track.url, previewBtn);
                                    });

                                    // å‰Šé™¤ãƒœã‚¿ãƒ³
                                    const removeBtn = itemEl.querySelector('.remove-bgm-btn');
                                    removeBtn.addEventListener('click', () => {
                                        stopMusicPreview(); // å‰Šé™¤æ™‚ã¯åœæ­¢
                                        state.settings.playlist.splice(index, 1);
                                        saveState();
                                        renderPlaylist();
                                        renderUnlockedList();
                                    });

                                    container.appendChild(itemEl);
                                });

                                // Sortable.js é©ç”¨ (â˜…ã“ã“ã‚’ä¿®æ­£)
                                Sortable.create(container, {
                                    handle: '.playlist-handle',
                                    animation: 150,
                                    ghostClass: 'sortable-ghost',
                                    delay: 200, // â˜…é•·æŠ¼ã—200msã§ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                                    delayOnTouchOnly: true, // â˜…ã‚¿ãƒƒãƒæ“ä½œã®ã¿é…å»¶æœ‰åŠ¹
                                    touchStartThreshold: 5, // â˜…5pxä»¥ä¸Šã®ç§»å‹•ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®š
                                    onEnd: (evt) => {
                                        const item = state.settings.playlist.splice(evt.oldIndex, 1)[0];
                                        state.settings.playlist.splice(evt.newIndex, 0, item);
                                        saveState();
                                    }
                                });
                            }
                            lucide.createIcons();
                        };

                        // 3. è¿½åŠ å¯èƒ½ãƒªã‚¹ãƒˆæç”»é–¢æ•° (é‡è¤‡æ’é™¤ãƒ­ã‚¸ãƒƒã‚¯å…¥ã‚Š)
                        const renderUnlockedList = () => {
                            const container = bgmCard.querySelector('#unlocked-music-list');
                            // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ãªã„æ›²ã ã‘ã‚’æŠ½å‡º
                            const availableMusic = state.profile.unlockedMusic.filter(id => !state.settings.playlist.includes(id));

                            if (availableMusic.length === 0) {
                                container.innerHTML = '<span class="text-xs text-gray-400">è¿½åŠ ã§ãã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“</span>';
                            } else {
                                container.innerHTML = availableMusic.map(id => {
                                    const track = initialData.music[id];
                                    return `<button class="add-to-playlist-btn bg-gray-50 dark:bg-gray-800 border dark:border-gray-600 px-3 py-2 rounded-full text-xs font-bold transition flex items-center hover:bg-gray-100 dark:hover:bg-gray-700" data-id="${id}" style="color: var(--primary-color); border-color: var(--primary-color);">
                                        <i data-lucide="plus" class="w-3 h-3 mr-1"></i>${track.name}
                                    </button>`;
                                }).join('');

                                // è¿½åŠ ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
                                container.querySelectorAll('.add-to-playlist-btn').forEach(btn => {
                                    btn.addEventListener('click', (e) => {
                                        const id = btn.dataset.id;
                                        state.settings.playlist.push(id);
                                        saveState();
                                        renderPlaylist();
                                        renderUnlockedList();
                                    });
                                });
                            }
                            lucide.createIcons();
                        };

                        // åˆå›æç”»å®Ÿè¡Œ
                        renderPlaylist();
                        renderUnlockedList();

                        // å£ç´™ã‚¹ã‚¤ãƒƒãƒã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å†è¨­å®š (innerHTMLæ›¸ãæ›ãˆã§æ¶ˆãˆã‚‹ãŸã‚)
                        const bgScopeToggle = settingsPage.querySelector('#background-scope-toggle');
                        if(bgScopeToggle) {
                            bgScopeToggle.addEventListener('change', (e) => {
                                state.settings.backgroundScopeGlobal = e.target.checked;
                                saveState();
                                updateAppearance();
                            });
                        }
                        
                        // é€šçŸ¥è¨±å¯ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆå†è¨­å®š
                        const notifBtn = settingsPage.querySelector('#notification-permission-btn');
                        if(notifBtn){
                            notifBtn.addEventListener('click', async () => {
                                if (!('Notification' in window)) { showToast('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚'); return; }
                                const permission = await Notification.requestPermission();
                                if (permission === 'granted') { 
                                    showToast('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼'); 
                                    new Notification('StudyQuestã¸ã‚ˆã†ã“ãï¼', { body: 'é€šçŸ¥è¨­å®šãŒã‚ªãƒ³ã«ãªã‚Šã¾ã—ãŸã€‚' }); 
                                    notifCard.style.display = 'none';
                                } else { 
                                    showToast('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚'); 
                                }
                            });
                        }

                        lucide.createIcons();
                    },
                },
                renderAll: () => {
                    for(const pageId in renderEngine.pages){
                        if($(`#${pageId}`).classList.contains('active')){
                            renderEngine.pages[pageId]();
                        }
                    }
                    updateLpDisplay();
                    const activeTheme = initialData.themes[state.profile.activeTheme] || initialData.themes['default'];
                    document.documentElement.style.setProperty('--primary-color', activeTheme.color);
                    document.documentElement.style.setProperty('--primary-color-hover', activeTheme.hover);
                }
            };

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»é–¢æ•°
            const renderCalendar = () => {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                
                $('#cal-month-title').textContent = `${year}å¹´ ${month + 1}æœˆ`;
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay(); // 0:Sun
                
                const grid = $('#calendar-grid');
                grid.innerHTML = '';
                
                // ç©ºç™½ã‚»ãƒ«
                for(let i=0; i<startDayOfWeek; i++) {
                    grid.innerHTML += `<div></div>`;
                }
                
                // æ—¥ä»˜ã‚»ãƒ«
                for(let d=1; d<=daysInMonth; d++) {
                    // â˜…ä¿®æ­£: toISOStringã‚’ä½¿ã‚ãšã€æ‰‹å‹•ã§ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜æ–‡å­—åˆ—(YYYY-MM-DD)ã‚’ä½œã‚‹
                    const cellMonth = String(month + 1).padStart(2, '0');
                    const cellDay = String(d).padStart(2, '0');
                    const dateStr = `${year}-${cellMonth}-${cellDay}`;
                    
                    // ãƒ­ã‚°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const hasLog = state.sessionLog.some(l => l.date === dateStr);
                    
                    // â˜…ä¿®æ­£: é¸æŠä¸­ã®æ—¥ä»˜æ¯”è¼ƒã‚‚ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§è¡Œã†
                    const selY = selectedReportDate.getFullYear();
                    const selM = String(selectedReportDate.getMonth() + 1).padStart(2, '0');
                    const selD = String(selectedReportDate.getDate()).padStart(2, '0');
                    const selectedDateStr = `${selY}-${selM}-${selD}`;
                    const isSelected = selectedDateStr === dateStr;
    
                    // â˜…ä¿®æ­£: ä»Šæ—¥ã®æ—¥ä»˜æ¯”è¼ƒã‚‚ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§è¡Œã†
                    const now = new Date();
                    const nowY = now.getFullYear();
                    const nowM = String(now.getMonth() + 1).padStart(2, '0');
                    const nowD = String(now.getDate()).padStart(2, '0');
                    const todayStr = `${nowY}-${nowM}-${nowD}`;
                    const isToday = todayStr === dateStr;
    
                    let cellClass = "h-8 w-8 mx-auto flex flex-col items-center justify-center rounded-full cursor-pointer transition text-sm relative ";
                    let styleStr = ""; // â˜…è¿½åŠ : å‹•çš„ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
                    
                    if (isSelected) {
                        cellClass += "primary-bg text-white font-bold shadow-md";
                    } else if (isToday) {
                        cellClass += "border-2 font-bold";
                        styleStr = "border-color: var(--primary-color); color: var(--primary-color);";
                    } else {
                        cellClass += "hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300";
                    }
    
                    // ãƒãƒ¼ã‚«ãƒ¼ï¼ˆãƒ­ã‚°ãŒã‚ã‚‹æ—¥ï¼‰
                    const marker = hasLog && !isSelected ? `<span class="absolute bottom-1 w-1 h-1 rounded-full" style="background-color: var(--primary-color);"></span>` : '';
    
                    const cell = document.createElement('div');
                    cell.className = "text-center";
                    cell.innerHTML = `<div class="${cellClass}" style="${styleStr}">${d}${marker}</div>`;
                    
                    cell.addEventListener('click', () => {
                        selectedReportDate = new Date(year, month, d);
                        renderCalendar(); // é¸æŠçŠ¶æ…‹æ›´æ–°ã®ãŸã‚å†æç”»
                        renderDailyDetails(selectedReportDate);
                    });
                    
                    grid.appendChild(cell);
                }
            };
    
            // æŒ‡å®šã—ãŸæ—¥ã®è©³ç´°ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
            const renderDailyDetails = (targetDate) => {
                // â˜…ä¿®æ­£: ã“ã“ã‚‚toISOStringã‚’ä½¿ã‚ãšã€ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ¤œç´¢ã‚­ãƒ¼ã‚’ä½œã‚‹
                const y = targetDate.getFullYear();
                const m = String(targetDate.getMonth() + 1).padStart(2, '0');
                const d = String(targetDate.getDate()).padStart(2, '0');
                const dateStr = `${y}-${m}-${d}`;
    
                const displayDate = `${targetDate.getMonth()+1}æœˆ${targetDate.getDate()}æ—¥`;
                
                $('#detail-date-title').textContent = `${displayDate} ã®è©³ç´°`;
                
                const sessions = state.sessionLog.filter(l => l.date === dateStr);
                const listContainer = $('#study-session-list');
                
                if (sessions.length === 0) {
                    listContainer.innerHTML = `<div class="flex flex-col items-center justify-center py-8 text-gray-400"><i data-lucide="book-off" class="w-8 h-8 mb-2"></i><p class="text-xs">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
                } else {
                    // çµ‚äº†æ™‚åˆ»ã®é™é †ãªã©ã§è¡¨ç¤ºã™ã‚‹ã¨è¦‹ã‚„ã™ã„ï¼ˆã“ã“ã§ã¯è¨˜éŒ²é †ï¼‰
                    listContainer.innerHTML = sessions.map(s => {
                        // ç§’ã‚’åˆ†ã«å¤‰æ›
                        const min = Math.floor(s.duration / 60);
                        const sec = s.duration % 60;
                        const durationText = min > 0 ? `${min}åˆ†` : `${sec}ç§’`;
                        
                        return `
                            <div class="flex items-center justify-between bg-white dark:bg-gray-700 p-3 rounded-lg shadow-sm border-l-4" style="border-left-color: var(--primary-color);">
                                <div class="flex-grow min-w-0 mr-4">
                                    <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200 truncate">${s.title}</h4>
                                </div>
                                <div class="text-right flex-shrink-0">
                                    <p class="text-lg font-mono font-bold primary-text leading-none">${durationText}</p>
                                    <p class="text-xs text-gray-400 mt-1">${s.endTime || '--:--'}</p>
                                </div>
                            </div>
                        `;
                    }).reverse().join(''); // æ–°ã—ã„é †ã«è¡¨ç¤º
                }
                lucide.createIcons();
            };
            
           const createQuizCard = (quiz, isPinned) => {
                if(!quiz) return '';
                const progress = state.progress[quiz.id];
                
                // ã‚¢ã‚¤ã‚³ãƒ³ã®å½¢å®šç¾©
                const levelIcons = { 1: 'book-open-check', 2: 'thumbs-up', 3: 'award'};
                
                // â˜…è‰²å®šç¾©ã‚’è¿½åŠ  (ãƒ¢ãƒ¼ãƒ€ãƒ«ã«åˆã‚ã›ãŸè‰²ç³»çµ±)
                // è¦–èªæ€§ã‚’è‰¯ãã™ã‚‹ãŸã‚ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã®400ç•ªã‚ˆã‚Šå°‘ã—æ¿ƒã„500ç•ªã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™
                const levelColors = { 1: 'text-blue-500', 2: 'text-green-500', 3: 'text-yellow-500'};

                // é€²æ—ãŒã‚ã‚‹å ´åˆã®è‰²ã‚’å–å¾—
                const color = progress ? levelColors[progress.level] : '';

                return `<div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm p-3 flex items-center justify-between quiz-card" data-id="${quiz.id}">
                            <div class="flex items-center min-w-0">
                                <div class="w-5 h-5 mr-3 flex-shrink-0">
                                    ${progress ? `<i data-lucide="${levelIcons[progress.level]}" class="${color}"></i>` : ``}
                                </div>
                                <div class="truncate">
                                    <h3 class="font-semibold text-gray-800 dark:text-gray-200 truncate">${quiz.title}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${quiz.subject} - ${quiz.genre}</p>
                                </div>
                            </div>
                            <button class="pin-btn p-2 -mr-2 flex-shrink-0" data-id="${quiz.id}">
                                <i data-lucide="pin" class="w-5 h-5 ${isPinned ? 'primary-text fill-current' : 'text-gray-400'}"></i>
                            </button>
                        </div>`;
            };
            
            const renderChart = (canvasId, type, data, options) => {
                const ctx = $(`#${canvasId}`).getContext('2d');
                if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
                chartInstances[canvasId] = new Chart(ctx, { type, data, options });
            };

            const showToast = (message) => {
                const toast = $('#toast'); toast.textContent = message; toast.classList.remove('opacity-0', '-translate-y-10');
                setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 2000);
            };

            const addLP = (amount, reason, show = true) => {
                state.profile.lp += amount;
                if(show) showToast(`${reason}ã§ ${amount} LP ç²å¾—ï¼`);
                updateLpDisplay();
            };
            
            const formatTime = (s) => {
                const totalSeconds = Math.floor(s);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                if (hours > 0) return `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            };

            // â–¼â–¼â–¼ ã€è¿½åŠ ã€‘BGMåˆ¶å¾¡é–¢æ•°ç¾¤ â–¼â–¼â–¼
            const playBGM = () => {
                if (!state.settings.bgmEnabled || state.settings.playlist.length === 0) return;
                
                // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒç©ºã§ãªã‘ã‚Œã°å†ç”Ÿ
                if (bgmAudio.paused) {
                    const trackId = state.settings.playlist[currentTrackIndex];
                    const track = initialData.music[trackId];
                    if (track) {
                        // ã‚½ãƒ¼ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°è¨­å®š
                        if (!bgmAudio.src || !bgmAudio.src.includes(track.url)) {
                            bgmAudio.src = track.url;
                        }
                        bgmAudio.play().catch(e => console.log('å†ç”Ÿã‚¨ãƒ©ãƒ¼(ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ã‹ã‚‚):', e));
                    }
                }
            };

            const pauseBGM = () => {
                bgmAudio.pause();
            };

            const stopBGM = () => {
                bgmAudio.pause();
                bgmAudio.currentTime = 0;
            };

            // æ›²ãŒçµ‚ã‚ã£ãŸã‚‰æ¬¡ã®æ›²ã¸
            bgmAudio.addEventListener('ended', () => {
                currentTrackIndex++;
                if (currentTrackIndex >= state.settings.playlist.length) {
                    currentTrackIndex = 0; // æœ€åˆã«æˆ»ã‚‹
                }
                const nextTrackId = state.settings.playlist[currentTrackIndex];
                const nextTrack = initialData.music[nextTrackId];
                if (nextTrack) {
                    bgmAudio.src = nextTrack.url;
                    bgmAudio.play();
                }
            });

            // ã€è¿½åŠ ã€‘ã‚¿ã‚¤ãƒãƒ¼ã«æ™‚é–“ã‚’åŠ ç®—ã™ã‚‹é–¢æ•°
            const addTimerTime = (seconds) => {
                if (focusTimer.isRunning) return; // å®Ÿè¡Œä¸­ã¯æ™‚é–“ã‚’å¤‰æ›´ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
                focusTimer.timeLeft += seconds;
                $('#focus-timer-display').textContent = formatTime(focusTimer.timeLeft);
            };
            
            // ã€è¿½åŠ ã€‘ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
            const resetTimerDisplay = () => {
                if (focusTimer.isRunning) return;
                focusTimer.timeLeft = 0;
                $('#focus-timer-display').textContent = formatTime(0);
            };
            
            const formatStopwatchTime = (s) => {
                const totalSeconds = s;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                // const ms = ... ã®è¡Œã‚’å‰Šé™¤
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`; // è¿”ã‚Šå€¤ã‹ã‚‰msã‚’å‰Šé™¤
            };

            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };

            const logStudyTime = (type, seconds) => {
                // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆ
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                const today = `${y}-${m}-${d}`;
            
                if (!state.studyLog[today]) state.studyLog[today] = { focus: 0, quiz: 0 };
                state.studyLog[today][type] += seconds;
            };
            // è©³ç´°ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹é–¢æ•°
            const recordSession = (title, durationSeconds) => {
            const now = new Date();
            
            // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆ
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const dateStr = `${y}-${m}-${d}`;
        
            // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (HH:MM)
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const endTimeStr = `${hours}:${minutes}`;
        
            const newSession = {
                id: Date.now(),
                date: dateStr,
                title: title,
                duration: durationSeconds,
                endTime: endTimeStr
            };
        
            // stateã«è¿½åŠ 
            if (!state.sessionLog) state.sessionLog = [];
            state.sessionLog.push(newSession);
            
            // æ—¢å­˜ã®é›†è¨ˆç”¨ãƒ­ã‚°ã‚‚æ›´æ–°ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
            logStudyTime('focus', durationSeconds); 
            saveState();
        };

            const renderHomeTasks = () => {
                if (!homeTaskListEl) return;

                if (!state.tasks || state.tasks.length === 0) {
                    homeTaskListEl.innerHTML = `<p class="text-center text-sm text-gray-500">ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                } else {
                    homeTaskListEl.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢
                    
                    state.tasks.forEach((task, index) => {
                        const isCompleted = task.completed || false;
                        const textStyle = isCompleted ? 'line-through text-gray-400 dark:text-gray-500' : '';
                        
                        // â˜…ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨æ§‹é€ 
                        const taskEl = document.createElement('div');
                        // ä¸¦ã³æ›¿ãˆæ™‚ã®IDè­˜åˆ¥ç”¨ã« data-id ã‚’è¿½åŠ 
                        taskEl.setAttribute('data-id', task.id); 
                        taskEl.className = `task-item swipe-container relative overflow-hidden rounded-lg mb-2`; 
                        
                        taskEl.innerHTML = `
                            <div class="swipe-actions">
                                <button class="btn-complete swipe-btn bg-gray-400 w-[70px]">
                                    <i data-lucide="check" class="w-6 h-6"></i>
                                    <span>å®Œäº†</span>
                                </button>
                                <button class="btn-delete swipe-btn bg-red-500 w-[70px]">
                                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                                    <span>å‰Šé™¤</span>
                                </button>
                            </div>

                            <div class="swipe-content flex items-center p-2 bg-white dark:bg-gray-800 shadow-sm relative z-10 ${isCompleted ? 'bg-gray-100 dark:bg-gray-900' : ''}">
                                <span class="font-bold w-6 text-center text-gray-600 dark:text-gray-400 shrink-0">${index + 1}</span>
                                
                                <input type="text" value="${task.text}" class="task-text-input flex-grow min-w-0 bg-transparent p-1 focus:outline-none rounded ${textStyle}" ${isCompleted ? 'disabled' : ''}>
                                
                                <button type="button" class="task-handle cursor-grab active:cursor-grabbing text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-opacity p-2 shrink-0 ${isCompleted ? 'invisible' : ''}">
                                    <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                                </button>
                            </div>
                        `;
                        
                        homeTaskListEl.appendChild(taskEl);
                        
                        // â˜…ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ã®é©ç”¨
                        new SwipeHandler(taskEl, {
                            onComplete: () => {
                                const taskToUpdate = state.tasks.find(t => t.id === task.id);
                                if (taskToUpdate) {
                                    taskToUpdate.completed = !taskToUpdate.completed; // ãƒˆã‚°ãƒ«
                                    saveState();
                                    renderHomeTasks(); // å†æç”»
                                }
                            },
                            onDelete: () => {
                                state.tasks = state.tasks.filter(t => t.id !== task.id);
                                saveState();
                                setTimeout(renderHomeTasks, 100); 
                                showToast('ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                            }
                        });
                        
                        // ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
                        taskEl.querySelector('.task-text-input').addEventListener('change', (e) => {
                            const taskToUpdate = state.tasks.find(t => t.id === task.id);
                            if (taskToUpdate) {
                                taskToUpdate.text = e.target.value;
                                saveState();
                            }
                        });
                    });
                }
                
                if(newTaskNumberEl) newTaskNumberEl.textContent = state.tasks.length + 1;

                // â˜…é‡è¦: ç”Ÿæˆã—ãŸãƒªã‚¹ãƒˆã®ä¸­ã«å¯¾ã—ã¦ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆã‚’å®Ÿè¡Œ
                lucide.createIcons({
                    root: homeTaskListEl,
                    nameAttr: 'data-lucide',
                    attrs: {
                        class: "w-5 h-5" // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µã‚¤ã‚ºæŒ‡å®š
                    }
                });
            };

            document.body.addEventListener('click', e => {
                const quizCard = e.target.closest('.quiz-card');
                if (quizCard && !e.target.closest('.pin-btn')) {
                    const quiz = initialData.quizzes.find(q => q.id === quizCard.dataset.id);
                    $('#quiz-modal-title').textContent = quiz.title;
                    
                    // â˜…â˜…â˜… ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å†è¡¨ç¤ºã™ã‚‹å‡¦ç†ã‚’è¿½åŠ  â˜…â˜…â˜…
                    $('#loader').parentElement.style.display = 'flex'; 
                
                    $('#quiz-iframe').classList.add('invisible');
                    $('#quiz-modal').dataset.currentQuiz = quiz.id;
                    $('#quiz-modal').style.display = 'flex';
                    quizTimer.startTime = Date.now();
                    setTimeout(() => {
                        $('#quiz-iframe').src = quiz.url;
                        $('#quiz-iframe').onload = () => {
                            $('#loader').parentElement.style.display = 'none'; 
                            $('#quiz-iframe').classList.remove('invisible');
                        };
                    }, 100);
                }
                const pinBtn = e.target.closest('.pin-btn');
                if(pinBtn) {
                    const quizId = pinBtn.dataset.id;
                    state.pinnedQuizzes.includes(quizId) ? state.pinnedQuizzes = state.pinnedQuizzes.filter(id => id !== quizId) : state.pinnedQuizzes.push(quizId);
                    saveState(); renderEngine.pages['study-page'](); lucide.createIcons();
                }
                
                const filterBtn = e.target.closest('.filter-btn');
                if(filterBtn) {
                     $$('#filter-container .filter-btn').forEach(b => {
                         b.classList.remove('active', 'primary-bg', 'text-white');
                         b.classList.add('bg-gray-200', 'dark:bg-gray-600');
                     });
                     filterBtn.classList.add('active', 'primary-bg', 'text-white');
                     filterBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                     renderEngine.pages['study-page']();
                     lucide.createIcons();
                }

                const closeModalBtn = e.target.closest('.close-modal-btn');
                if (closeModalBtn) {
                    const modal = $(`#${closeModalBtn.dataset.modal}`);
                    modal.style.display = 'none';
                    if (closeModalBtn.dataset.modal === 'quiz-modal') {
                        $('#assessment-modal').dataset.quizId = modal.dataset.currentQuiz;
                        $('#assessment-modal').style.display = 'flex';
                        if(quizTimer.startTime) {
                            const elapsed = Math.round((Date.now() - quizTimer.startTime) / 1000);
                            const title = $('#quiz-modal-title').textContent || 'ã‚¯ã‚¤ã‚º';
                            recordSession(title, elapsed);
                            quizTimer.startTime = null;
                            saveState();
                        }
                    }
                }
                
                const assessmentBtn = e.target.closest('.assessment-btn');
                if(assessmentBtn) {
                    const level = parseInt(assessmentBtn.dataset.level);
                    const quizId = $('#assessment-modal').dataset.quizId;
                    
                    // 1. é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    state.progress[quizId] = { level, date: new Date().toISOString() };
                    addLP(level * 5, 'ã‚¯ã‚¤ã‚ºè©•ä¾¡');
                    saveState();
                    
                    // 2. â˜…é‡è¦â˜… ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšãƒ¼ã‚¸ã‚’å¼·åˆ¶çš„ã«å†æç”»ã™ã‚‹
                    // renderEngine.renderAll() ã¯ 'active' ã‚¯ãƒ©ã‚¹ãŒã¤ã„ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã ã‘ã‚’æç”»ã™ã‚‹ãŸã‚ã€ã“ã‚Œã§OKã§ã™
                    renderEngine.renderAll();
                    
                    // 3. ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆLucideï¼‰ã‚’å†ç”Ÿæˆã™ã‚‹
                    // HTMLãŒæ›¸ãæ›ã‚ã£ãŸç›´å¾Œã¯ã‚¢ã‚¤ã‚³ãƒ³ãŒ <i> ã‚¿ã‚°ã®ã¾ã¾ãªã®ã§ã€ã“ã‚Œã‚’ <svg> ã«å¤‰æ›ã—ã¾ã™
                    lucide.createIcons();

                    // 4. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    $('#assessment-modal').style.display = 'none';
                }

                const themeBtn = e.target.closest('.theme-btn');
                if(themeBtn){
                    const themeId = themeBtn.dataset.theme;
                    if(state.profile.unlockedThemes.includes(themeId)) {
                        state.profile.activeTheme = themeId;
                        saveState();
                        renderEngine.renderAll();
                    } else {
                        const theme = initialData.themes[themeId];
                        const confirmBtn = $('#theme-purchase-confirm');
                        
                        $('#theme-purchase-title').textContent = `ã€Œ${theme.name}ã€ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`;
                        $('#theme-purchase-cost').textContent = `å¿…è¦ãªãƒã‚¤ãƒ³ãƒˆ: ${theme.cost} LP`;
                        
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                        $('#theme-preview').style.backgroundColor = theme.color;
                
                        // ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (state.profile.lp >= theme.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = themeId;
                        confirmBtn.dataset.itemType = 'theme';
                        $('#theme-purchase-modal').style.display = 'flex';
                    }
                }

                const backgroundBtn = e.target.closest('.background-btn');
                if(backgroundBtn){
                    const bgId = backgroundBtn.dataset.bg;
                    if(state.profile.unlockedBackgrounds.includes(bgId)) {
                        state.profile.activeBackground = bgId;
                        saveState();
                        updateAppearance();
                        renderEngine.pages['settings-page']();
                        lucide.createIcons();
                    } else {
                        const bg = initialData.backgrounds[bgId];
                        const confirmBtn = $('#background-purchase-confirm');
                
                        $('#background-purchase-title').textContent = `ã€Œ${bg.name}ã€ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`;
                        $('#background-purchase-cost').textContent = `å¿…è¦ãªãƒã‚¤ãƒ³ãƒˆ: ${bg.cost} LP`;
                
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                        const previewEl = $('#background-preview');
                        if (bg.url) {
                            previewEl.style.backgroundImage = `url(${bg.url})`;
                            previewEl.classList.remove('hidden');
                        } else {
                            previewEl.classList.add('hidden'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãªã©ç”»åƒãŒãªã„å ´åˆã¯éè¡¨ç¤º
                        }
                        
                        // ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (state.profile.lp >= bg.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = bgId;
                        confirmBtn.dataset.itemType = 'background';
                        $('#background-purchase-modal').style.display = 'flex';
                    }
                }

                const editCountdownBtn = e.target.closest('.edit-countdown-btn');
                if(editCountdownBtn){
                    const id = editCountdownBtn.dataset.id;
                    openCountdownModal(id);
                }

                // â–¼â–¼â–¼ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚¤ãƒãƒ¼/SWï¼‰ã®ãƒªã‚¹ãƒŠãƒ¼ä¿®æ­£ â–¼â–¼â–¼
Â  Â  Â  Â  Â  Â  Â  Â  const focusModeBtn = e.target.closest('.focus-mode-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if(focusModeBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mode = focusModeBtn.dataset.mode;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.focus.mode = mode; // 'timer' ã‹ 'stopwatch' ãŒå…¥ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateFocusModeUI(); // UIã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

Â  Â  Â  Â  Â  Â  Â  Â  // â–¼â–¼â–¼ ã‚¯ã‚¨ã‚¹ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ã€Œæ–°è¦è¿½åŠ ã€ â–¼â–¼â–¼
Â  Â  Â  Â  Â  Â  Â  Â  const showQuestBtn = e.target.closest('#show-quest-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if (showQuestBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#focus-main-view').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#quest-view').style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderQuestPlan();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // â–¼â–¼â–¼ ã‚¯ã‚¨ã‚¹ãƒˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ã€Œæ–°è¦è¿½åŠ ã€ â–¼â–¼â–¼
Â  Â  Â  Â  Â  Â  Â  Â  const questBackBtn = e.target.closest('#quest-back-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if (questBackBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#focus-main-view').style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#quest-view').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¿µã®ãŸã‚ã‚¿ã‚¤ãƒãƒ¼/SWã®è¡¨ç¤ºã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateFocusModeUI();
Â  Â  Â  Â  Â  Â  Â  Â  }

                // æ™‚é–“åŠ ç®—ãƒœã‚¿ãƒ³ã®å‡¦ç†
                const timeAddBtn = e.target.closest('.time-add-btn');
                if(timeAddBtn) {
                    const time = parseInt(timeAddBtn.dataset.time);
                    addTimerTime(time);
                }
                
                // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†
                const timerResetBtn = e.target.closest('#timer-reset-btn');
                if(timerResetBtn) {
                    resetTimerDisplay();
                }
                // â˜…æ–°è¦è¿½åŠ â˜… ä¼‘æ†©è¨­å®šãƒœã‚¿ãƒ³ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆä¸­ï¼‰
                const breakSettingsBtn = e.target.closest('#break-settings-btn');
                if (breakSettingsBtn) {
                    openBreakSettingsModal();
                }
    
                // â˜…æ–°è¦è¿½åŠ â˜… ä¼‘æ†©è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const breakSettingsCloseBtn = e.target.closest('#break-settings-close-btn');
                if (breakSettingsCloseBtn) {
                    $('#break-settings-modal').style.display = 'none';
                    // å¤‰æ›´ã‚’å³åº§ã«åæ˜ 
                    renderBreakIcons();
                }
            });
            
            /* å¤‰æ›´å¾Œ (æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨ã—ã¦è¿½åŠ ) */
            $('#background-scope-toggle').addEventListener('change', (e) => {
                state.settings.backgroundScopeGlobal = e.target.checked;
                saveState();
                updateAppearance();
                updateBackgrounds();
                // é›†ä¸­ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦å†æç”»
                if ($('#focus-page').classList.contains('active')) {
                    renderEngine.pages['focus-page']();
                }
            });
            
            $('#lp-button').addEventListener('click', () => {
                // 1. LPãƒã‚¤ãƒ³ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
                $('#modal-lp-display').textContent = state.profile.lp;
                
                // 2. ãƒ†ãƒ¼ãƒã¨å£ç´™ã®ãƒªã‚¹ãƒˆã‚’æç”»ï¼ˆé–¢æ•°å‘¼ã³å‡ºã—ï¼‰
                renderPointModalContent(); 
                
                // 3. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                $('#point-details-modal').style.display = 'flex';
                lucide.createIcons();
            });

            function handlePurchase(e) {
                const { itemId, itemType } = e.target.dataset;
                
                // itemTypeã¯ 'theme', 'background', 'game', 'music' ã®ã„ãšã‚Œã‹
                let dataList;
                let unlockList;

                if (itemType === 'theme') {
                    dataList = initialData.themes;
                    unlockList = state.profile.unlockedThemes;
                } else if (itemType === 'background') {
                    dataList = initialData.backgrounds;
                    unlockList = state.profile.unlockedBackgrounds;
                } else if (itemType === 'game') {
                    dataList = initialData.games;
                    unlockList = state.profile.unlockedGames;
                } else if (itemType === 'music') {
                    dataList = initialData.music;
                    unlockList = state.profile.unlockedMusic;
                }

                const itemData = dataList[itemId];
            
                if (state.profile.lp >= itemData.cost) {
                    addLP(-itemData.cost, `ã‚¢ã‚¤ãƒ†ãƒ ã€Œ${itemData.name}ã€äº¤æ›`, false); // ãƒˆãƒ¼ã‚¹ãƒˆé‡è¤‡å›é¿ã®ãŸã‚false
                    unlockList.push(itemId);
                    showToast(`ã€Œ${itemData.name}ã€ã‚’è§£æ”¾ã—ã¾ã—ãŸï¼`);
                    saveState();
                    if (itemType === 'game') {
                        syncGamesToBreakIcons();
                    }
                    renderPointModalContent(); // ãƒ¢ãƒ¼ãƒ€ãƒ«å†æç”»
                    
                    // è¨­å®šãƒšãƒ¼ã‚¸ãŒé–‹ã‹ã‚Œã¦ã„ã‚Œã°å†æç”»
                    if ($('#settings-page').classList.contains('active')) {
                        renderEngine.pages['settings-page']();
                    }
                } else {
                    showToast('LPãŒè¶³ã‚Šã¾ã›ã‚“ï¼');
                }
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                $(`#${itemType}-purchase-modal`).style.display = 'none';
            }
            
            // --- Focus Page Logic ---
            const updateMiniTimer = () => {
                if (miniTimerTemporarilyHidden) {
                    $('#mini-timer-container').classList.remove('visible');
                    return;
                }
                const container = $('#mini-timer-container');
                const bar = $('#mini-timer-bar');
                if ((focusTimer.isRunning || stopwatch.isRunning) && !$('#focus-page').classList.contains('active')) {
                    container.classList.add('visible');
                    if(focusTimer.isRunning){
                        const progress = (focusTimer.defaultTime - focusTimer.timeLeft) / focusTimer.defaultTime * 100;
                        $('#mini-timer-text').textContent = formatTime(focusTimer.timeLeft);
                        $('#mini-timer-progress-bar').style.width = `${progress}%`;
                    } else { // stopwatch
                         $('#mini-timer-text').textContent = formatStopwatchTime(stopwatch.elapsedTime);
                         $('#mini-timer-progress-bar').style.width = `100%`;
                    }
                } else {
                    container.classList.remove('visible');
                }
            };
            
            const timerTick = () => {
                focusTimer.timeLeft--;
                $('#focus-timer-display').textContent = formatTime(focusTimer.timeLeft);
                updateMiniTimer();
                if (focusTimer.timeLeft <= 0) {
                    clearInterval(focusTimer.interval);
                    // showToast ã¨ new Notification ã¯ Service Worker ãŒæ‹…å½“ã™ã‚‹ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤
                    // showToast('é›†ä¸­ãƒ¢ãƒ¼ãƒ‰å®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
                    // if (Notification.permission === 'granted') { ... }
            
                    const elapsed = focusTimer.defaultTime;
                    logStudyTime('focus', elapsed);
                    addLP(Math.floor(elapsed/60), 'ã‚¿ã‚¤ãƒãƒ¼å®Œäº†');
                    state.focus.totalTime += elapsed;
                    saveState();
                    resetTimerUI();
            
                }
            };
            
            const stopwatchTick = () => {
                stopwatch.elapsedTime = (Date.now() - stopwatch.startTime) / 1000;
                $('#stopwatch-display').textContent = formatStopwatchTime(stopwatch.elapsedTime);
                updateMiniTimer();
            };

            const pauseFocusTimer = () => {
                if (!focusTimer.isRunning || focusTimer.isPaused) return;
                focusTimer.isPaused = true;
                clearInterval(focusTimer.interval);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>å†é–‹`;
                lucide.createIcons();
            };

            const resumeFocusTimer = () => {
                if (!focusTimer.isRunning || !focusTimer.isPaused) return;
                focusTimer.isPaused = false;
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢`;
                lucide.createIcons();
            };

            const pauseStopwatch = () => {
                if (!stopwatch.isRunning || stopwatch.isPaused) return;
                stopwatch.isPaused = true;
                clearInterval(stopwatch.interval);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>å†é–‹`;
                lucide.createIcons();
            };

            const resumeStopwatch = () => {
                if (!stopwatch.isRunning || !stopwatch.isPaused) return;
                stopwatch.isPaused = false;
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢`;
                lucide.createIcons();
            };

            const updateFocusModeUI = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const mode = state.focus.mode;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼å†…ã®è¡¨ç¤ºåˆ‡æ›¿
Â  Â  Â  Â  Â  Â  Â  Â  $('#timer-view').style.display = (mode === 'timer') ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  Â  Â  $('#stopwatch-view').style.display = (mode === 'stopwatch') ? 'flex' : 'none';
Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
Â  Â  Â  Â  Â  Â  Â  Â  const timerBtn = $('.focus-mode-btn[data-mode="timer"]');
Â  Â  Â  Â  Â  Â  Â  Â  const stopwatchBtn = $('.focus-mode-btn[data-mode="stopwatch"]');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (mode === 'timer') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timerBtn.classList.add('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopwatchBtn.classList.remove('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  } else if (mode === 'stopwatch') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timerBtn.classList.remove('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopwatchBtn.classList.add('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

            // â–¼â–¼â–¼ æ–°è¦è¿½åŠ : èƒŒæ™¯ç”»åƒã‚’ focus-view-bg ã‚¯ãƒ©ã‚¹ã‚’æŒã¤è¦ç´ ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆå«ã‚€ï¼‰ã«é©ç”¨ã™ã‚‹é–¢æ•° â–¼â–¼â–¼
            const updateBackgrounds = () => {
                const activeBgId = state.profile.activeBackground;
                const activeBg = initialData.backgrounds[activeBgId] || initialData.backgrounds['default'];
                const isGlobal = state.settings.backgroundScopeGlobal;
                const hasImage = activeBg && activeBg.url;
            
                // .focus-view-bg ã‚¯ãƒ©ã‚¹ã‚’æŒã¤ã™ã¹ã¦ã®è¦ç´ ï¼ˆã‚¿ã‚¤ãƒãƒ¼ç”»é¢ã€ã‚¯ã‚¨ã‚¹ãƒˆç”»é¢ãªã©ï¼‰ã‚’å–å¾—
                $$('.focus-view-bg').forEach(el => {
                    // ã€Œå…¨ä½“é©ç”¨ã€ãŒã‚ªãƒ•ã§ã€ã‹ã¤ç”»åƒãŒã‚ã‚‹å ´åˆã®ã¿ã€å€‹åˆ¥ã«èƒŒæ™¯ã‚’è¨­å®š
                    // â€»ã‚¯ã‚¨ã‚¹ãƒˆç”»é¢ã¯å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãªã®ã§ã€GlobalãŒONã§ã‚‚OFFã§ã‚‚èƒŒæ™¯ç”»åƒã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã¯æ¡ä»¶ã‚’èª¿æ•´
                    // ã“ã“ã§ã¯ã€Œã‚¿ã‚¤ãƒãƒ¼ç”»é¢ã¨åŒã˜æŒ™å‹•ï¼ˆGlobal OFFãªã‚‰å€‹åˆ¥ã«è¡¨ç¤ºï¼‰ã€ã«åŠ ãˆã€
                    // ã€Œã‚¯ã‚¨ã‚¹ãƒˆç”»é¢(#quest-active-screen)ãªã‚‰å¸¸ã«è¡¨ç¤ºã€ã¨ã„ã†ãƒ­ã‚¸ãƒƒã‚¯ã«ã—ã¾ã™ã€‚
                    
                    const isQuestScreen = el.id === 'quest-active-screen';
            
                    if ((!isGlobal && hasImage) || (isQuestScreen && hasImage)) {
                        el.style.backgroundImage = `url(${activeBg.url})`;
                    } else {
                        // å…¨ä½“é©ç”¨ãŒONã®å ´åˆã¯è¦ª(body)ã®èƒŒæ™¯ãŒè¦‹ãˆã‚‹ã®ã§é€æ˜ã«ã™ã‚‹ã€ã¾ãŸã¯ç”»åƒãªã—
                        el.style.backgroundImage = 'none';
                    }
                });
            };

            const resetTimerUI = () => {
                clearInterval(focusTimer.interval);
                focusTimer.isRunning = false; focusTimer.isPaused = false;
                focusTimer.timeLeft = focusTimer.defaultTime; // defaultTimeã‹ã‚‰ãƒªã‚»ãƒƒãƒˆ
                $('#focus-timer-display').textContent = formatTime(focusTimer.defaultTime);
                $('#focus-start-btn').classList.remove('hidden');
                $('#focus-controls').classList.add('hidden');
                $('#timer-settings-container').classList.remove('hidden');
                updateMiniTimer();
            };

            const resetStopwatchUI = () => {
                clearInterval(stopwatch.interval);
                stopwatch.isRunning = false; stopwatch.isPaused = false;
                stopwatch.elapsedTime = 0;
                $('#stopwatch-display').textContent = formatStopwatchTime(0);
                $('#stopwatch-start-btn').classList.remove('hidden');
                $('#stopwatch-controls').classList.add('hidden');
                updateMiniTimer();
            };

            const endFocusTimer = () => {
                if (!focusTimer.isRunning) return;
                const elapsed = focusTimer.defaultTime - focusTimer.timeLeft;
                if (elapsed > 0) { recordSession('ã‚¿ã‚¤ãƒãƒ¼', elapsed); addLP(Math.floor(elapsed / 60), 'ã‚¿ã‚¤ãƒãƒ¼'); state.focus.totalTime += elapsed; saveState(); }
                resetTimerUI();
            
                // ã€è¿½åŠ ã€‘Service Workerã«ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ã‚’é€šçŸ¥
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ command: 'focusTimer_stop' });
                }
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = false;
                state.focus.startTime = null;
                saveState();
                // â–²â–²â–²ã€è¿½åŠ ã€‘ã“ã“ã¾ã§â–²â–²â–²
            };

            const endStopwatch = () => {
                if (!stopwatch.isRunning) return;
                const elapsed = Math.round(stopwatch.elapsedTime);
                if (elapsed > 0) { recordSession('ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ', elapsed); addLP(Math.floor(elapsed / 60), 'ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ'); state.focus.totalTime += elapsed; saveState(); }
                resetStopwatchUI();
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = false;
                state.focus.startTime = null;
                saveState();
                // â–²â–²â–²ã€è¿½åŠ ã€‘ã“ã“ã¾ã§â–²â–²â–²
            };
            
            const setTimer = (seconds) => {
                focusTimer.defaultTime = seconds; // defaultTimeã‚‚æ›´æ–°
                focusTimer.timeLeft = seconds;
                $('#focus-timer-display').textContent = formatTime(seconds);
            };

           $('#focus-start-btn').addEventListener('click', () => {
                if (focusTimer.timeLeft <= 0) {
                    showToast('æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                    return;
                }
                focusTimer.defaultTime = focusTimer.timeLeft;
                focusTimer.isRunning = true;
                focusTimer.isPaused = false;
                state.focus.isRunning = true;
                state.focus.startTime = Date.now(); // ç¾åœ¨æ™‚åˆ»ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜
                state.focus.duration = focusTimer.timeLeft;
                saveState();
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-start-btn').classList.add('hidden');
                $('#focus-controls').classList.remove('hidden');
                $('#timer-settings-container').classList.add('hidden');
                updateMiniTimer();
            
                // ã€è¿½åŠ ã€‘Service Workerã«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã‚’é€šçŸ¥
                if (navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.controller.postMessage({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  command: 'focusTimer_start', // â˜… 'startTimer' ã‹ã‚‰å¤‰æ›´
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeLeft: focusTimer.timeLeft,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'âŒ›ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†', // â˜… é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: 'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ã‚¿ã‚¤ãƒãƒ¼ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚' // â˜… é€šçŸ¥æœ¬æ–‡ã‚’è¿½åŠ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
            });
            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â–¼â–¼â–¼ */

            // ã‚¯ã‚¨ã‚¹ãƒˆè¨­å®šãƒ“ãƒ¥ãƒ¼ã®ãƒœã‚¿ãƒ³
            addSectionBtn.addEventListener('click', () => {
                quest.plan.push({
                    id: Date.now(),
                    type: 'section',
                    text: 'æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³',
                    duration: 25 * 60
                });
                renderQuestPlan();
            });

            addBreakBtn.addEventListener('click', () => {
                quest.plan.push({
                    id: Date.now(),
                    type: 'break',
                    duration: 5 * 60
                });
                renderQuestPlan();
            });

            addBreaksBtn.addEventListener('click', () => {
                const interval = parseInt($('#break-interval-input').value) || 2;
                const duration = parseInt($('#break-duration-input').value) || 5;
                const newPlan = [];
                let sectionCount = 0;
                
                // ä¼‘æ†©ã‚’é™¤ã„ãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã®ãƒªã‚¹ãƒˆã‚’å…ƒã«ã™ã‚‹
                const sections = quest.plan.filter(item => item.type === 'section');

                sections.forEach((item, index) => {
                    newPlan.push(item);
                    sectionCount++;
                    // æœ€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä»¥å¤–ã§ã€intervalã®å€æ•°ç•ªç›®ãªã‚‰ä¼‘æ†©ã‚’è¿½åŠ 
                    if (sectionCount % interval === 0 && index !== sections.length - 1) {
                        newPlan.push({
                            id: Date.now() + Math.random(),
                            type: 'break',
                            duration: duration * 60
                        });
                    }
                });
                
                quest.plan = newPlan;
                renderQuestPlan();
            });

            startQuestBtn.addEventListener('click', startQuest);

            // ã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œç”»é¢ã®ãƒœã‚¿ãƒ³
            endQuestBtn.addEventListener('click', () => {
                confirmationModal.style.display = 'flex';
            });

            modalConfirmBtn.addEventListener('click', () => endQuest(false));
            modalCancelBtn.addEventListener('click', () => {
                confirmationModal.style.display = 'none';
            });

           // ä¼‘æ†©ä¸­ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (ã‚¢ã‚¤ã‚³ãƒ³ãƒ›ãƒ¼ãƒ ç”»é¢)
Â  Â  Â  Â  Â  Â  if(breakIconGrid) {
Â  Â  Â  Â  Â  Â  Â  Â  breakIconGrid.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = e.target.closest('.break-content-btn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (btn && btn.dataset.url) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // â˜…ã“ã“ã‹ã‚‰å¤‰æ›´â˜…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (btn.dataset.openMode === 'external') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¤–éƒ¨ã‚¿ãƒ–ã§é–‹ã (å¼·åˆ¶ã‚¯ãƒ­ãƒ¼ã‚ºä¸å¯)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(btn.dataset.url, '_blank');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¾“æ¥é€šã‚Šã‚¢ãƒ—ãƒªå†… (iframe) ã§é–‹ã (å¼·åˆ¶ã‚¯ãƒ­ãƒ¼ã‚ºå¯èƒ½)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openIframe(btn.dataset.url);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // â˜…ã“ã“ã¾ã§å¤‰æ›´â˜…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
            closeIframeBtn.addEventListener('click', closeIframe);

            /* â–²â–²â–² è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â–²â–²â–² */
            
            $('#focus-pause-btn').addEventListener('click', () => { if (focusTimer.isPaused) resumeFocusTimer(); else pauseFocusTimer(); });
            $('#focus-end-btn').addEventListener('click', endFocusTimer);

            $('#stopwatch-start-btn').addEventListener('click', () => {
                stopwatch.isRunning = true; stopwatch.isPaused = false;
                // ä¿®æ­£ï¼šä¿å­˜ã•ã‚ŒãŸæ™‚é–“ã§ã¯ãªãã€å¸¸ã«ç¾åœ¨ã®æ™‚åˆ»ã‹ã‚‰é–‹å§‹
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
            
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = true;
                // ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã®å ´åˆã€é–‹å§‹æ™‚åˆ»ã®ã¿ä¿å­˜
                state.focus.startTime = stopwatch.startTime; 
                saveState();
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-start-btn').classList.add('hidden');
                $('#stopwatch-controls').classList.remove('hidden');
                updateMiniTimer();
            });
            $('#stopwatch-pause-btn').addEventListener('click', () => { if (stopwatch.isPaused) resumeStopwatch(); else pauseStopwatch(); });
            $('#stopwatch-end-btn').addEventListener('click', endStopwatch);
            
            $('#notification-permission-btn').addEventListener('click', async () => {
                if (!('Notification' in window)) { showToast('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚'); return; }
                const permission = await Notification.requestPermission();
                if (permission === 'granted') { showToast('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼'); new Notification('StudyQuestã¸ã‚ˆã†ã“ãï¼', { body: 'é€šçŸ¥è¨­å®šãŒã‚ªãƒ³ã«ãªã‚Šã¾ã—ãŸã€‚' }); $('#notification-settings-card').style.display = 'none';} 
                else { showToast('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ç«¯æœ«ã®è¨­å®šã‚¢ãƒ—ãƒªã‹ã‚‰å¤‰æ›´ã§ãã¾ã™ã€‚'); }
            });
            
            // â–¼â–¼â–¼ ä¿®æ­£ç‰ˆ: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†ï¼ˆæç”»é…å»¶å¯¾å¿œï¼‰ â–¼â–¼â–¼
            let isAnimating = false;

            $$('.tab-btn').forEach(btn => btn.addEventListener('click', e => {
                const nextPageId = e.currentTarget.dataset.page;
                const activePage = document.querySelector('.page.active');
                
                if ((activePage && activePage.id === nextPageId) || isAnimating) return;

                const nextPage = $(`#${nextPageId}`);
                if (!nextPage) return;

                $('main').scrollTop = 0;

                // 1. ã¾ãšUIï¼ˆãƒœã‚¿ãƒ³ï¼‰ã‚’å³åº§ã«æ›´æ–°
                $$('.tab-btn').forEach(b => b.classList.replace('primary-text', 'text-gray-500'));
                e.currentTarget.classList.replace('text-gray-500', 'primary-text');
                $('#header-title').textContent = e.currentTarget.dataset.title;

                isAnimating = true;

                // 2. ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãŒã‚ã‚Œã°ã€Œé€€å‡ºã€é–‹å§‹
                if (activePage) {
                    activePage.classList.add('page-exit');
                    activePage.classList.remove('active');
                    
                    activePage.addEventListener('animationend', () => {
                        activePage.classList.remove('page-exit');
                    }, { once: true });
                }

                // 3. æ¬¡ã®ãƒšãƒ¼ã‚¸ã«ã€Œé€²å…¥ã€ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼‰
                nextPage.classList.add('page-enter');

                // 4. ã€é‡è¦ã€‘æç”»å‡¦ç†ã‚’å°‘ã—ã ã‘é…ã‚‰ã›ã‚‹
                // ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒã€Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹ãƒ•ãƒ¬ãƒ¼ãƒ ã€ã‚’æç”»ã—ãã£ã¦ã‹ã‚‰
                // é‡ã„å‡¦ç†ï¼ˆã‚°ãƒ©ãƒ•æç”»ãªã©ï¼‰ãŒèµ°ã‚‹ãŸã‚ã€ã‚¬ã‚¿ã¤ããŒè»½æ¸›ã•ã‚Œã‚‹ã€‚
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        // ãƒšãƒ¼ã‚¸å›ºæœ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆã‚°ãƒ©ãƒ•æç”»ãªã©ï¼‰
                        if (renderEngine.pages[nextPageId]) { 
                            renderEngine.pages[nextPageId](); 
                        }

                        // é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ç­‰ã®UIæ›´æ–°
                        if (nextPageId === 'focus-page') {
                            miniTimerTemporarilyHidden = false;
                        }
                        updateMiniTimer();
                        lucide.createIcons();

                    }, 10); // 10msç¨‹åº¦ã®é…å»¶ã§ååˆ†åŠ¹æœã‚ã‚Š
                });

                // 5. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã®å‡¦ç†
                nextPage.addEventListener('animationend', () => {
                    nextPage.classList.remove('page-enter');
                    nextPage.classList.add('active');
                    isAnimating = false;
                }, { once: true });

            }));
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            $('#mini-timer-bar').addEventListener('click', (e) => {
                if (e.target.closest('#close-mini-timer-btn')) return;
                document.querySelector('.tab-btn[data-page="focus-page"]').click();
            });

            $('#close-mini-timer-btn').addEventListener('click', () => {
                miniTimerTemporarilyHidden = true; // ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                $('#mini-timer-container').classList.remove('visible'); // éè¡¨ç¤ºã«ã™ã‚‹
            });

            // --- Countdown Logic ---
            function openCountdownModal(id = null) {
                const modal = $('#countdown-modal');
                modal.dataset.editingId = id || '';
                const title = $('#countdown-modal-title');
                const deleteBtn = $('#countdown-delete-btn');
                const nameInput = $('#countdown-name');
                const dateInput = $('#countdown-date');
            
                if (id) {
                    title.textContent = 'ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®ç·¨é›†';
                    deleteBtn.classList.remove('hidden');
                    const countdown = state.countdowns.find(c => c.id === id);
                    nameInput.value = countdown.name;
                    dateInput.value = countdown.date;
                    
                } else {
                    title.textContent = 'ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®è¿½åŠ ';
                    deleteBtn.classList.add('hidden');
                    nameInput.value = '';
                    
                    const defaultDate = new Date();
                    defaultDate.setDate(defaultDate.getDate() + 14);
                    dateInput.value = defaultDate.toISOString().split('T')[0];

                }

                modal.style.display = 'flex';
                lucide.createIcons();

            }

            function saveCountdown() {
                const id = $('#countdown-modal').dataset.editingId;
                const name = $('#countdown-name').value.trim();
                const date = $('#countdown-date').value;

                if (!name || !date) {
                    showToast('ã‚¤ãƒ™ãƒ³ãƒˆåã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const countdownData = {
                    name,
                    date,
                };

                if (id) {
                    const index = state.countdowns.findIndex(c => c.id === id);
                    state.countdowns[index] = { ...state.countdowns[index], ...countdownData };
                } else {
                    countdownData.id = `cd_${Date.now()}`;
                    state.countdowns.push(countdownData);
                }

                state.countdowns.sort((a, b) => new Date(a.date) - new Date(b.date));
                saveState();
                renderEngine.pages['home-page']();
                lucide.createIcons();
                $('#countdown-modal').style.display = 'none';
            }
            
            function deleteCountdown() {
                // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¿½åŠ 
                if (!confirm('æœ¬å½“ã«ã“ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚‰ã€ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
                }
            
                const id = $('#countdown-modal').dataset.editingId;
                state.countdowns = state.countdowns.filter(c => c.id !== id);
                saveState();
                renderEngine.pages['home-page']();
                lucide.createIcons();
                $('#countdown-modal').style.display = 'none';
            }

            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®é–¢æ•°ç¾¤ â–¼â–¼â–¼ */

        // ã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ã®ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        function renderQuestPlan() {
            questPlanListEl.innerHTML = '';
            if (quest.plan.length === 0) {
                questPlanListEl.innerHTML = `<p class="text-center text-sm text-gray-500">ã€Œä»Šæ—¥ã®äºˆå®šã€ã‚’èª­ã¿è¾¼ã‚€ã‹ã€<br>ã€Œã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>`;
            }
            let sectionCounter = 1; 
            
            quest.plan.forEach((item, index) => {
                const itemEl = document.createElement('div');
                // â˜…ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨ã‚¯ãƒ©ã‚¹è¿½åŠ 
                itemEl.className = 'swipe-container relative overflow-hidden rounded-lg mb-2';
                
                let contentHTML = '';
                if (item.type === 'section') {
                    contentHTML = `
                        <span class="font-bold w-6 text-center shrink-0">${sectionCounter}</span>
                        <input type="text" value="${item.text}" data-original-id="${item.originalTaskId || ''}" class="quest-item-text flex-grow bg-transparent p-1 rounded border border-transparent focus:border-gray-400 dark:focus:border-gray-500 focus:outline-none min-w-0 truncate">
                        <input type="number" value="${item.duration / 60}" class="quest-item-duration w-12 p-1 border rounded text-center dark:bg-gray-600 dark:border-gray-500 shrink-0">
                        <span class="text-sm shrink-0">åˆ†</span>
                    `;
                    sectionCounter++;
                } else { // break
                    contentHTML = `
                        <span class="font-bold w-6 text-center shrink-0">â˜•</span>
                        <span class="flex-grow p-1 text-gray-500 dark:text-gray-400 font-semibold">ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ </span>
                        <input type="number" value="${item.duration / 60}" class="quest-item-duration w-12 p-1 border rounded text-center dark:bg-gray-600 dark:border-gray-500 shrink-0">
                        <span class="text-sm shrink-0">åˆ†</span>
                    `;
                }

                itemEl.innerHTML = `
                    <div class="swipe-actions">
                         <div style="width:100%; flex:1;"></div> <button class="btn-delete swipe-btn bg-red-500 w-[70px]">
                            <i data-lucide="trash-2" class="w-6 h-6"></i>
                            <span>å‰Šé™¤</span>
                        </button>
                    </div>

                    <div class="swipe-content flex items-center space-x-2 bg-gray-100 dark:bg-gray-800 p-2 relative z-10 w-full">
                        ${contentHTML}
                        <button class="quest-handle cursor-move text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-opacity shrink-0 p-1">
                            <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                
                questPlanListEl.appendChild(itemEl);

                // â˜…ã‚¹ãƒ¯ã‚¤ãƒ—é©ç”¨
                new SwipeHandler(itemEl, {
                    onDelete: () => {
                        quest.plan = quest.plan.filter(p => p.id !== item.id);
                        // é…åˆ—æ“ä½œå¾Œã«å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†æç”»ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾…ã¡ï¼‰
                        setTimeout(renderQuestPlan, 300);
                    }
                });

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆå¤‰æ›´ãªã—ï¼‰
                itemEl.querySelector('.quest-item-text')?.addEventListener('change', (e) => {
                    item.text = e.target.value;
                    item.originalTaskId = e.target.dataset.originalId || null;
                });
                itemEl.querySelector('.quest-item-duration').addEventListener('change', (e) => {
                    item.duration = parseInt(e.target.value) * 60;
                });
            });
            lucide.createIcons();
        };
            
        // ã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•° (ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è€æ€§å¼·åŒ–ç‰ˆ)
Â  Â  Â  Â  function startQuestTimer(duration, onTick, onEnd) {
Â  Â  Â  Â  Â  Â  // 1. æ—¢å­˜ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
Â  Â  Â  Â  Â  Â  if (quest.timerInterval) {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(quest.timerInterval);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã€Œçµ¶å¯¾çš„ãªçµ‚äº†æ™‚åˆ»ã€ã‚’è¨ˆç®—
Â  Â  Â  Â  Â  Â  const endTime = Date.now() + duration * 1000;

            // 2.5. å‘¼ã³å‡ºã—ç›´å¾Œã«ã€ã¾ãšUIã‚’ç¾åœ¨ã®æ™‚é–“ã§æ›´æ–°ã™ã‚‹
Â  Â  Â  Â  Â  Â  const initialTimeLeft = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
Â  Â  Â  Â  Â  Â  onTick(initialTimeLeft);
Â  Â  Â  Â  Â  Â  quest.timeLeft = initialTimeLeft;

Â  Â  Â  Â  Â  Â  // 3. 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’é–‹å§‹
Â  Â  Â  Â  Â  Â  quest.timerInterval = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  // 4. çµ‚äº†æ™‚åˆ»ã¨ç¾åœ¨æ™‚åˆ»ã‹ã‚‰ã€æœ¬å½“ã®æ®‹ã‚Šæ™‚é–“ã‚’è¨ˆç®— (0ç§’æœªæº€ã«ã¯ã—ãªã„)
Â  Â  Â  Â  Â  Â  Â  Â  const timeLeft = Math.max(0, Math.floor((endTime - now) / 1000));

Â  Â  Â  Â  Â  Â  Â  Â  // 5. ãƒ­ã‚°è¨˜éŒ²ç”¨ã«ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®æ®‹ã‚Šæ™‚é–“ã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  quest.timeLeft = timeLeft; 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 6. UIã‚’æ›´æ–° (onTick)
Â  Â  Â  Â  Â  Â  Â  Â  onTick(timeLeft);

Â  Â  Â  Â  Â  Â  Â  Â  // 7. çµ‚äº†æ™‚åˆ»ã‚’éãã¦ã„ãŸã‚‰ã€ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ onEnd ã‚’å‘¼ã¶
Â  Â  Â  Â  Â  Â  Â  Â  if (now >= endTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(quest.timerInterval);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quest.timerInterval = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onEnd(); // çµ‚äº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 1000); // 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ (å³å¯†ã«ã¯100msç­‰ã®æ–¹ãŒç²¾åº¦ã¯è‰¯ã„ãŒã€1000msã§ã‚‚ååˆ†)
Â  Â  Â  Â  };

        function cancelQuestAlarm() {
Â  Â  Â  Â  Â  Â  if (navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  // 'stopTimer' ã‚³ãƒãƒ³ãƒ‰ã‚’ (é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã¨) å…±æœ‰ã—ã¦ä½¿ç”¨
Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.controller.postMessage({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  command: 'questTimer_stop' 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        function sendQuestAlarm(durationInSeconds, title, body) {
Â  Â  Â  Â  Â  Â  if (Notification.permission === "granted" && navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  // 'startTimer' ã‚³ãƒãƒ³ãƒ‰ã‚’ (é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã¨) å…±æœ‰ã—ã¦ä½¿ç”¨
Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.controller.postMessage({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  command: 'questTimer_start', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeLeft: durationInSeconds,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: title, // é€šçŸ¥ã®ã‚¿ã‚¤ãƒˆãƒ«
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: body Â // é€šçŸ¥ã®æœ¬æ–‡
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        // â–¼â–¼â–¼ æ–°è¦ãƒ»ä¿®æ­£: ã‚¯ã‚¨ã‚¹ãƒˆé€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç¢ºèªç”»é¢ä»˜ãï¼‰ â–¼â–¼â–¼

            const questTransitionView = $('#quest-transition-view');
            const transitionTitle = $('#transition-title');
            const transitionMessage = $('#transition-message');
            const transitionNextText = $('#transition-next-text');
            const transitionNextDuration = $('#transition-next-duration');
            const transitionStartBtn = $('#transition-start-btn');
            const transitionIcon = $('#transition-icon');

            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€æº–å‚™
            function runNextQuestStep() {
                quest.currentIndex++;
                
                // å…¨ã‚¹ãƒ†ãƒƒãƒ—çµ‚äº†æ™‚ã®å‡¦ç†
                if (quest.currentIndex >= quest.plan.length) {
                    endQuest(true);
                    return;
                }

                const nextStep = quest.plan[quest.currentIndex];

                // â˜…è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®çŠ¶æ…‹ã‚’ä¿å­˜ (ç¾åœ¨åœ°ã¨é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²)
                state.savedQuest = {
                    plan: quest.plan,
                    currentIndex: quest.currentIndex,
                    startTime: Date.now(), // ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®é–‹å§‹æ™‚åˆ»ï¼ˆä»®ï¼‰
                    active: true
                };
                saveState();

                // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å³é–‹å§‹ã—ã€ãã‚Œä»¥é™ã¯ç¢ºèªç”»é¢ã‚’å‡ºã™
                if (quest.currentIndex === 0) {
                    executeQuestStep(nextStep);
                } else {
                    showTransitionScreen(nextStep);
                }
            }

            // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ï¼ˆå¾…æ©Ÿï¼‰ç”»é¢ã‚’è¡¨ç¤º
            function showTransitionScreen(step) {
                // å‰ã®ç”»é¢ã‚’éš ã™
                questSectionView.style.display = 'none';
                questBreakView.style.display = 'none';
                $('#break-settings-btn').classList.add('hidden');

                // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ç”»é¢ã‚’è¡¨ç¤º
                questTransitionView.style.display = 'flex';
                
                // å†…å®¹ã®ã‚»ãƒƒãƒˆ
                if (step.type === 'section') {
                    transitionTitle.textContent = "å­¦ç¿’ã‚’å§‹ã‚ã¾ã™ã‹ï¼Ÿ";
                    transitionMessage.textContent = "æº–å‚™ãŒã§ããŸã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
                    transitionIcon.setAttribute('data-lucide', 'book-open');
                    transitionNextText.textContent = step.text;
                    transitionNextDuration.textContent = `${step.duration / 60} åˆ†`;
                    transitionStartBtn.className = "primary-bg primary-bg-hover text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center";
                } else {
                    transitionTitle.textContent = "ä¼‘æ†©ã‚¿ã‚¤ãƒ ";
                    transitionMessage.textContent = "ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼å°‘ã—é ­ã‚’ä¼‘ã‚ã¾ã—ã‚‡ã†ã€‚";
                    transitionIcon.setAttribute('data-lucide', 'coffee');
                    transitionNextText.textContent = "ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ ";
                    transitionNextDuration.textContent = `${step.duration / 60} åˆ†`;
                    transitionStartBtn.className = "bg-green-600 hover:bg-green-700 text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center";
                }

                lucide.createIcons();

                // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¸€åº¦ã ã‘ç™ºç«ã™ã‚‹ã‚ˆã†ã«è¨­å®šï¼‰
                transitionStartBtn.onclick = () => {
                    questTransitionView.style.display = 'none';
                    executeQuestStep(step);
                };
            }

            // å®Ÿéš›ã®ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ã‚’è¡¨ç¤ºã—ã¦é–‹å§‹
            function executeQuestStep(currentStep) {
                cancelQuestAlarm();

                // â˜…è¿½åŠ : å®Ÿéš›ã«ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ãã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ­£ç¢ºãªé–‹å§‹æ™‚åˆ»ã‚’ä¿å­˜
                if(state.savedQuest) {
                    state.savedQuest.startTime = Date.now();
                    // currentStepãŒä¼‘æ†©ã‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹åŒºåˆ¥ã—ã¦ä¿å­˜ã—ã¦ã‚‚è‰¯ã„ãŒã€
                    // å¾©å…ƒæ™‚ã«è¨ˆç®—ã™ã‚‹ã®ã§æœ€ä½é™ Date.now() ãŒã‚ã‚Œã°OK
                    saveState();
                }

                // ã‚¢ãƒ—ãƒª2ã®ãƒˆãƒ¼ã‚¹ãƒˆé–¢æ•°ã¨Notification APIã‚’ä½¿ç”¨
                const showQuestNotification = (title, body) => {
                    showToast(body);
                    if (Notification.permission === "granted" && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            command: 'showQuestNotification',
                            title: title,
                            body: body
                        });
                    }
                };

                if (currentStep.type === 'section') {
                    playBGM();
                    questSectionView.style.display = 'flex';
                    questBreakView.style.display = 'none';
                    $('#break-settings-btn').classList.add('hidden');
                    
                    questSectionTitle.textContent = currentStep.text;
                    // é€²æ—è¡¨ç¤º
                    const totalSections = quest.plan.filter(p => p.type === 'section').length;
                    const currentSectionNumber = quest.plan.slice(0, quest.currentIndex + 1).filter(p => p.type === 'section').length;
                    questProgressEl.textContent = `${currentSectionNumber} / ${totalSections}`;

                    // â˜…ã“ã“ã§SWã«ã€Œäºˆç´„ã€ã‚’å…¥ã‚Œã¦ã„ã‚‹ã®ã§ã€æ™‚é–“ã«ãªã‚Œã°è‡ªå‹•ã§é€šçŸ¥ãŒæ¥ã¾ã™
                    sendQuestAlarm(
                        currentStep.duration,
                        'ğŸ”¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†',
                        'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼'
                    );
                    
                    startQuestTimer(
                        currentStep.duration,
                        (timeLeft) => { questTimerEl.textContent = formatTime(timeLeft); },
                        () => {
                            // --- â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ 1 â–¼â–¼â–¼ ---
                            // ã“ã“ã§ showQuestNotification ã‚’å‘¼ã¶ã¨ã€Œä»Šã™ãé€šçŸ¥ã€ãŒé€ã‚‰ã‚Œã¦é‡è¤‡ã—ã¾ã™ã€‚
                            // ä»£ã‚ã‚Šã« showToast ã ã‘å‘¼ã‚“ã§ã€ç”»é¢å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘è¡¨ç¤ºã—ã¾ã™ã€‚
                            const elapsed = currentStep.duration;
                            if (elapsed > 0) {
                                recordSession(currentStep.text, elapsed);
                                addLP(Math.floor(elapsed / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³');
                                state.focus.totalTime += elapsed;
                                
                                if (currentStep.originalTaskId) {
                                    const taskId = parseInt(currentStep.originalTaskId);
                                    const taskIndex = state.tasks.findIndex(t => t.id === taskId);
                                    if (taskIndex !== -1) {
                                        state.tasks[taskIndex].completed = true;
                                    }
                                }
                                saveState();
                            }
                            // â˜…é€šçŸ¥ã¯SWã®äºˆç´„ã«ä»»ã›ã€ã“ã“ã§ã¯ãƒˆãƒ¼ã‚¹ãƒˆã®ã¿è¡¨ç¤º
                            showToast('ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼'); 
                            // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---

                            runNextQuestStep(); // æ¬¡ï¼ˆãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ç”»é¢ï¼‰ã¸
                        }
                    );
                } else { // break
                    pauseBGM();
                    questSectionView.style.display = 'none';
                    questBreakView.style.display = 'flex';
                    $('#break-settings-btn').classList.remove('hidden');
                    renderBreakIcons();

                    // â˜…ã“ã“ã§SWã«ã€Œäºˆç´„ã€ã‚’å…¥ã‚Œã¦ã„ã¾ã™
                    sendQuestAlarm(
                        currentStep.duration,
                        'â˜•ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ çµ‚äº†',
                        'ä¼‘æ†©æ™‚é–“ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚'
                    );
                    
                    startQuestTimer(
                        currentStep.duration,
                        (timeLeft) => {
                            breakTimerEl.textContent = formatTime(timeLeft);
                            // æ®‹ã‚Š30ç§’ã®é€šçŸ¥ã¯ã€Œäºˆç´„ã€ã—ã¦ã„ãªã„ã®ã§ã€ã“ã“ã‹ã‚‰é€ã£ã¦ã‚‚OKï¼ˆé‡è¤‡ã—ãªã„ï¼‰
                            if (timeLeft === 30) {
                                showQuestNotification('â±ã¾ã‚‚ãªãä¼‘æ†©çµ‚äº†', '30ç§’å¾Œã«çµ‚äº†ã—ã¾ã™ã€‚');
                            }
                        },
                        () => {
                            // --- â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ 2 â–¼â–¼â–¼ ---
                            // ã“ã“ã‚‚åŒæ§˜ã«ä¿®æ­£
                            // showQuestNotification('ä¼‘æ†©çµ‚äº†', 'ä¼‘æ†©ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚'); 
                            showToast('ä¼‘æ†©ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚');
                            // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---

                            closeIframe();
                            runNextQuestStep(); // æ¬¡ï¼ˆãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ç”»é¢ï¼‰ã¸
                        }
                    );
                }
                lucide.createIcons();
            }
            // â–²â–²â–² ã‚¯ã‚¨ã‚¹ãƒˆé€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£å®Œäº† â–²â–²â–²

        // ã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        function startQuest() {
            if (quest.plan.length === 0) {
                showToast('ã‚¯ã‚¨ã‚¹ãƒˆã®äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            quest.active = true;
            quest.currentIndex = -1;
            updateBackgrounds();
            questActiveScreen.style.display = 'flex';
            
            // ã‚¢ãƒ—ãƒª2ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚¿ãƒ–ãƒãƒ¼ã‚’éš ã™
            $('header').style.display = 'none';
            $('nav').style.display = 'none';
            $('#mini-timer-container').classList.remove('visible'); // ãƒŸãƒ‹ã‚¿ã‚¤ãƒãƒ¼ã‚‚éš ã™

            document.body.style.overflow = 'hidden';
            runNextQuestStep();
        };

        // ã‚¯ã‚¨ã‚¹ãƒˆã‚’çµ‚äº†ã™ã‚‹é–¢æ•°
        function endQuest(completed = false) {
            state.savedQuest = null;
            saveState();
            stopBGM();
            $('#break-settings-btn').classList.add('hidden');
            clearInterval(quest.timerInterval);
            quest.timerInterval = null; // å¿˜ã‚Œãšã«ã‚¯ãƒªã‚¢

Â  Â  Â  Â  Â  Â  // --- â˜…è¿½åŠ â˜… ã‚¯ã‚¨ã‚¹ãƒˆçµ‚äº†æ™‚ã«SWã®ã‚¢ãƒ©ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ ---
Â  Â  Â  Â  Â  Â  cancelQuestAlarm();
            if (!completed && quest.currentIndex >= 0 && quest.currentIndex < quest.plan.length) {
                const currentStep = quest.plan[quest.currentIndex];
                // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒ 'section' (å­¦ç¿’ä¸­) ã®å ´åˆã®ã¿è¨˜éŒ²
                if (currentStep.type === 'section') {
                    const elapsed = currentStep.duration - quest.timeLeft; // çµŒéæ™‚é–“
                    if (elapsed > 0) {
                        recordSession(`${currentStep.text} (ä¸­æ–­)`, elapsed);
                        addLP(Math.floor(elapsed / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä¸­æ–­ï¼‰');
                        state.focus.totalTime += elapsed;
                        saveState();
                        showToast(`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® ${formatTime(elapsed)} ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚`);
                    }
                }
            }
            
            quest.active = false;
            questActiveScreen.style.display = 'none';

            // ã‚¢ãƒ—ãƒª2ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚¿ãƒ–ãƒãƒ¼ã‚’å†è¡¨ç¤º
            $('header').style.display = 'flex';
            $('nav').style.display = 'flex';

            document.body.style.overflow = 'auto';
            confirmationModal.style.display = 'none';
            closeIframe();
            if (completed) {
                showToast('ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
            }
        };

        // ä¼‘æ†©ç”¨iframeã‚’é–‹ãé–¢æ•°ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¶å¾¡ä»˜ãï¼‰
        function openIframe(url) {
            const iframe = $('#break-iframe');
            const overlay = $('#iframe-overlay');
            const loader = $('#iframe-loader');
        
            // åˆæœŸçŠ¶æ…‹ï¼šiframeã‚’é€æ˜ã«ã—ã€ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’è¡¨ç¤º
            iframe.classList.remove('opacity-100');
            iframe.classList.add('opacity-0');
            loader.style.display = 'flex';
            
            overlay.style.display = 'flex'; // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
        
            // URLã‚»ãƒƒãƒˆ
            iframe.src = url;
        
            // èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            iframe.onload = () => {
                loader.style.display = 'none'; // ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’éš ã™
                iframe.classList.remove('opacity-0');
                iframe.classList.add('opacity-100'); // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
            };
            
            lucide.createIcons();
        };
        
        function closeIframe() {
            const iframe = $('#break-iframe');
            const overlay = $('#iframe-overlay');
            
            iframe.src = 'about:blank';
            iframe.classList.remove('opacity-100');
            iframe.classList.add('opacity-0');
            overlay.style.display = 'none';
        };
            
        // â˜…ä¿®æ­£å¾Œâ˜… ä¼‘æ†©ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        function renderBreakIcons() {
            if (!breakIconGrid) return;

            // 1. è¡¨ç¤ºãŒã‚ªãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã ã‘ã‚’æŠ½å‡º
            const items = state.breakIcons.filter(icon => icon.visible);

            // 2. HTMLã‚’ç”Ÿæˆ
            breakIconGrid.innerHTML = items.map(icon => `
                <button class="break-content-btn" data-url="${icon.url}" data-open-mode="${icon.openMode || 'external'}" data-id="${icon.id}">
                    <i data-lucide="${icon.icon}" class="w-8 h-8 mb-1"></i>
                    <span>${icon.name}</span>
                </button>
            `).join('');
            
            lucide.createIcons();
        }

        // â˜…æ–°è¦è¿½åŠ â˜… è§£ç¦æ¸ˆã¿ã‚²ãƒ¼ãƒ ã‚’breakIconsã«åŒæœŸã•ã›ã‚‹é–¢æ•°
        function syncGamesToBreakIcons() {
            state.profile.unlockedGames.forEach(gameId => {
                // ã™ã§ã«breakIconsã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const exists = state.breakIcons.find(icon => icon.id === gameId);
                
                if (!exists) {
                    const game = initialData.games[gameId];
                    if (game) {
                        // æ–°ã—ãbreakIconsã«è¿½åŠ  (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤ºON)
                        state.breakIcons.push({
                            id: gameId,
                            name: game.name,
                            icon: game.icon,
                            url: game.url,
                            openMode: 'iframe', // ã‚²ãƒ¼ãƒ ã¯iframeã§é–‹ã
                            type: 'game',
                            visible: true
                        });
                    }
                }
            });
            // ä¿å­˜
            saveState();
        }

        // â˜…ä¿®æ­£å¾Œâ˜… ä¼‘æ†©è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ã‚’æç”»ã™ã‚‹é–¢æ•°
        function renderBreakSettingsModal() {
            const activeContainer = $('#break-active-list');
            const inactiveContainer = $('#break-inactive-list');
            
            if (!activeContainer || !inactiveContainer) return;
        
            activeContainer.innerHTML = '';
            inactiveContainer.innerHTML = '';
        
            // 1. ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºä¸­ã¨éè¡¨ç¤ºã«åˆ†ã‘ã‚‹
            const activeIcons = state.breakIcons.filter(i => i.visible);
            const inactiveIcons = state.breakIcons.filter(i => !i.visible);
        
            // 2. è¡¨ç¤ºä¸­ãƒªã‚¹ãƒˆã®æç”» (å‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ã)
            if (activeIcons.length === 0) {
                activeContainer.innerHTML = '<p class="text-xs text-gray-500 text-center py-2">è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                activeContainer.innerHTML = activeIcons.map(icon => `
                    <div class="break-settings-item flex items-center bg-white/5 p-3 rounded-lg border border-white/10 mb-2 touch-none" data-id="${icon.id}">
                        <div class="break-settings-handle p-2 mr-1 cursor-grab active:cursor-grabbing text-gray-400">
                             <i data-lucide="grip-vertical" class="w-6 h-6"></i>
                        </div>
                        <div class="flex items-center justify-center w-8 h-8 mr-3 text-gray-200">
                            <i data-lucide="${icon.icon}" class="w-6 h-6"></i>
                        </div>
                        <span class="text-gray-200 flex-grow text-sm font-bold truncate">${icon.name}</span>
                        <button class="remove-break-btn p-2 rounded-full text-red-400 hover:bg-red-500/20 transition flex-shrink-0">
                            <i data-lucide="minus-circle" class="w-5 h-5"></i>
                        </button>
                    </div>
                `).join('');
            }
        
            // 3. è¿½åŠ å¯èƒ½ãƒªã‚¹ãƒˆã®æç”» (è¿½åŠ ãƒœã‚¿ãƒ³ä»˜ã)
            if (inactiveIcons.length === 0) {
                inactiveContainer.innerHTML = '<p class="text-xs text-gray-500 w-full text-center">ã™ã¹ã¦è¿½åŠ æ¸ˆã¿ã§ã™</p>';
            } else {
                inactiveContainer.innerHTML = inactiveIcons.map(icon => `
                    <button class="add-break-btn flex items-center space-x-2 bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-2 rounded-full transition" data-id="${icon.id}">
                        <i data-lucide="plus" class="w-4 h-4 text-green-400"></i>
                        <span class="text-sm text-gray-300">${icon.name}</span>
                    </button>
                `).join('');
            }
        
            // â˜…ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç¢ºå®Ÿã«ç”Ÿæˆï¼ˆå¯¾è±¡ã‚³ãƒ³ãƒ†ãƒŠã‚’æŒ‡å®šï¼‰
            lucide.createIcons({ root: activeContainer });
            lucide.createIcons({ root: inactiveContainer });
        
            // 4. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼šå‰Šé™¤ãƒœã‚¿ãƒ³
            activeContainer.querySelectorAll('.remove-break-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = e.target.closest('.break-settings-item').dataset.id;
                    const icon = state.breakIcons.find(i => i.id === itemId);
                    if (icon) {
                        icon.visible = false;
                        saveState();
                        renderBreakSettingsModal(); // å†æç”»
                        renderBreakIcons(); // è¦ªç”»é¢ã‚‚æ›´æ–°
                    }
                });
            });
        
            // 5. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼šè¿½åŠ ãƒœã‚¿ãƒ³
            inactiveContainer.querySelectorAll('.add-break-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = btn.dataset.id;
                    const icon = state.breakIcons.find(i => i.id === itemId);
                    if (icon) {
                        icon.visible = true;
                        saveState();
                        renderBreakSettingsModal(); // å†æç”»
                        renderBreakIcons(); // è¦ªç”»é¢ã‚‚æ›´æ–°
                    }
                });
            });
        
            // 6. Sortable.js ã®é©ç”¨ (é‡è¤‡é˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ )
            // ä»¥å‰ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚Œã°ç ´æ£„ã™ã‚‹
            if (breakSortable) {
                breakSortable.destroy();
            }

            // æ–°ã—ãä½œæˆã™ã‚‹
            breakSortable = Sortable.create(activeContainer, {
                handle: '.break-settings-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                delay: 100, // å°‘ã—ã ã‘é•·æŠ¼ã—åˆ¤å®šã‚’å…¥ã‚Œã‚‹ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨å¹²æ¸‰ã—ã«ãã„
                delayOnTouchOnly: true,
                touchStartThreshold: 5,
                onEnd: (evt) => {
                    // ä¸¦ã³æ›¿ãˆå¾Œã®IDé †åºã‚’å–å¾—
                    const idOrder = Array.from(activeContainer.children).map(child => child.dataset.id);
                    
                    // state.breakIcons ã‚’ä¸¦ã³æ›¿ãˆã‚‹
                    const sortedActive = idOrder.map(id => state.breakIcons.find(i => i.id === id)).filter(Boolean); // filter(Boolean)ã§undefinedæ’é™¤
                    const inactive = state.breakIcons.filter(i => !i.visible);
                    
                    state.breakIcons = [...sortedActive, ...inactive];
                    saveState();
                    renderBreakIcons(); // è¦ªç”»é¢ã®ä¸¦ã³é †ã‚‚æ›´æ–°
                }
            });
        }
            
        // â˜…æ–°è¦è¿½åŠ â˜… ä¼‘æ†©è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
        function openBreakSettingsModal() {
            renderBreakSettingsModal(); // 1. ä¸­èº«ã‚’æç”»
            $('#break-settings-modal').style.display = 'flex'; // 2. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        }

        /* â–²â–²â–² è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®é–¢æ•°ç¾¤ â–²â–²â–² */
        
            
            const restoreFocusState = () => {
            // ä¿å­˜ã•ã‚ŒãŸå®Ÿè¡Œä¸­ã®ã‚¿ã‚¤ãƒãƒ¼/SWãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
            if (!state.focus.isRunning || !state.focus.startTime) {
                setTimer(1800);
                return;
            }
        
            const elapsed = Math.floor((Date.now() - state.focus.startTime) / 1000); // çµŒéæ™‚é–“ï¼ˆç§’ï¼‰
        
            // å¾©å…ƒã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦UIã‚’æ›´æ–°
            updateFocusModeUI();
        
            if (state.focus.mode === 'timer') {
                const timeLeft = state.focus.duration - elapsed;
        
                if (timeLeft <= 0) {
                    // å¾©å…ƒæ™‚ã«ã¯ã‚¿ã‚¤ãƒãƒ¼ãŒæ—¢ã«çµ‚äº†ã—ã¦ã„ã‚‹å ´åˆ
                    showToast('ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã„ã‚‹é–“ã«ã‚¿ã‚¤ãƒãƒ¼ãŒçµ‚äº†ã—ã¾ã—ãŸ');
                    new Notification('StudyQuest', { body: 'é›†ä¸­ã‚¿ã‚¤ãƒãƒ¼ãŒçµ‚äº†ã—ã¦ã„ã¾ã—ãŸã€‚' }); // é€šçŸ¥ã‚‚å‡ºã™
                    recordSession('ã‚¿ã‚¤ãƒãƒ¼', state.focus.duration);
                    addLP(Math.floor(state.focus.duration / 60), 'ã‚¿ã‚¤ãƒãƒ¼å®Œäº†');
                    resetTimerUI();
                    // çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                    state.focus.isRunning = false;
                    state.focus.startTime = null;
                    saveState();
                    setTimer(1800); // æ¬¡ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
                } else {
                    // ã‚¿ã‚¤ãƒãƒ¼ã‚’å¾©å…ƒ
                    focusTimer.timeLeft = timeLeft;
                    focusTimer.defaultTime = state.focus.duration;
                    focusTimer.isRunning = true;
        
                    $('#focus-timer-display').textContent = formatTime(timeLeft);
                    $('#focus-start-btn').classList.add('hidden');
                    $('#focus-controls').classList.remove('hidden');
                    $('#timer-settings-container').classList.add('hidden');
        
                    focusTimer.interval = setInterval(timerTick, 1000);
                    updateMiniTimer();
                }
            } else { // ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã®å ´åˆ
                stopwatch.elapsedTime = elapsed;
                stopwatch.startTime = state.focus.startTime;
                stopwatch.isRunning = true;
        
                $('#stopwatch-display').textContent = formatStopwatchTime(elapsed);
                $('#stopwatch-start-btn').classList.add('hidden');
                $('#stopwatch-controls').classList.remove('hidden');
        
                stopwatch.interval = setInterval(stopwatchTick, 100);
                updateMiniTimer();
            }
        };

            // ==========================================
            // â–¼â–¼â–¼ æ–°è¦è¿½åŠ : ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
            // ==========================================

            // 1. ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®åˆ†å²å‡¦ç† (inité–¢æ•°ã®æœ€å¾Œã§å‘¼ã¶)
            const checkUserRegistration = () => {
                const splash = document.getElementById('splash-screen');
                
                if (!state.user.isRegistered) {
                    $('#app-container').classList.add('hidden');
                    
                } else {
                    // ç™»éŒ²æ¸ˆã¿ãªã‚‰é€šå¸¸é€šã‚Š
                    $('#app-container').classList.remove('hidden');
                    // æ—¢å­˜ã®ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå‡¦ç†ã«ä»»ã›ã‚‹
                }
            };

            // 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            
            // Welcomeç”»é¢
            $('#btn-start-new').addEventListener('click', () => {
                $('#welcome-screen').classList.add('hidden');
                $('#registration-screen').classList.remove('hidden');
            });
            
            $('#btn-transfer-start').addEventListener('click', () => {
                openMigrationModal(true);
            });

            // ç™»éŒ²ç”»é¢
            const emojis = ['ğŸ“','âœï¸','ğŸ”¥','ğŸ±','ğŸ¶','ğŸš€','â­','ğŸ','âš½','ğŸµ','ğŸ¨','ğŸ’»'];
            const getRandomEmoji = () => emojis[Math.floor(Math.random() * emojis.length)];
            
            $('#icon-picker-btn').addEventListener('click', () => {
                $('#reg-icon').value = getRandomEmoji();
            });
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            const checkRegForm = () => {
                const name = $('#reg-name').value.trim();
                const grade = $('#reg-grade').value;
                $('#reg-complete-btn').disabled = !(name && grade);
            };
            $('#reg-name').addEventListener('input', checkRegForm);
            $('#reg-grade').addEventListener('change', checkRegForm);

            $('#reg-complete-btn').addEventListener('click', () => {
                // ä¸€æ™‚ä¿å­˜ã—ã¦ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¸
                state.user.name = $('#reg-name').value.trim();
                state.user.icon = $('#reg-icon').value;
                state.user.grade = $('#reg-grade').value;
                
                $('#registration-screen').classList.add('hidden');
                $('#tutorial-screen').classList.remove('hidden');
                updateTutorialSlide(0);
            });

            $('#reg-back-btn').addEventListener('click', () => {
                $('#registration-screen').classList.add('hidden');
                $('#welcome-screen').classList.remove('hidden');
            });

            // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
            let tutorialIndex = 0;
            const tutorialSlides = 3; 
            
            function updateTutorialSlide(index) {
                tutorialIndex = index;
                const track = document.getElementById('tutorial-track');
                track.style.transform = `translateX(-${index * 100}%)`;
                
                // ãƒ‰ãƒƒãƒˆæ›´æ–°
                const dots = document.getElementById('tutorial-dots').children;
                Array.from(dots).forEach((dot, i) => {
                    dot.className = `w-2 h-2 rounded-full ${i === index ? 'bg-white' : 'bg-gray-600'}`;
                });
                
                const btn = $('#tutorial-next-btn');
                btn.textContent = index === tutorialSlides - 1 ? 'å§‹ã‚ã‚‹' : 'æ¬¡ã¸';
            }

            $('#tutorial-next-btn').addEventListener('click', () => {
                if (tutorialIndex < tutorialSlides - 1) {
                    updateTutorialSlide(tutorialIndex + 1);
                } else {
                    // å®Œäº†å‡¦ç†
                    state.user.isRegistered = true;
                    saveState();
                    
                    $('#tutorial-screen').classList.add('hidden');
                    $('#app-container').classList.remove('hidden');
                    
                    // ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’æ›´æ–°
                    renderEngine.pages['home-page']();
                    showToast(`ã‚ˆã†ã“ãã€${state.user.name}ã•ã‚“ï¼`);
                }
            });

            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ»é–²è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«
            function openProfileModal() {
                const modal = $('#profile-modal');
                // ç¾åœ¨ã®å€¤ã‚’å…¥ã‚Œã‚‹
                $('#edit-profile-icon').value = state.user.icon;
                $('#edit-profile-name').value = state.user.name;
                
                // å­¦å¹´ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒ¼
                const gradeSelect = $('#edit-profile-grade');
                gradeSelect.innerHTML = $('#reg-grade').innerHTML;
                gradeSelect.value = state.user.grade;
                
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            }
            
            $('.close-profile-btn').addEventListener('click', () => {
                $('#profile-modal').style.display = 'none';
            });
            
            $('#edit-icon-random-btn').addEventListener('click', () => {
                $('#edit-profile-icon').value = getRandomEmoji();
            });

            $('#save-profile-btn').addEventListener('click', () => {
                state.user.icon = $('#edit-profile-icon').value;
                state.user.name = $('#edit-profile-name').value;
                state.user.grade = $('#edit-profile-grade').value;
                saveState();
                
                // è¨­å®šç”»é¢ã‚’å†æç”»
                renderEngine.pages['settings-page']();
                $('#profile-modal').style.display = 'none';
                showToast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            });
            
            $('#open-migration-menu-btn').addEventListener('click', () => {
                 openMigrationModal(false);
            });


            // ==========================================
            // â–¼â–¼â–¼ PeerJS ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
            // ==========================================
            
            let peer = null;
            let conn = null;

            // ã€ä¿®æ­£ã€‘å¼•æ•° autoReceive ã‚’è¿½åŠ 
            function openMigrationModal(autoReceive = false) {
                $('#migration-modal').classList.remove('hidden');
                $('#migration-modal').style.display = 'flex';
                
                // ä¸€åº¦å…¨ã¦ã®ãƒ“ãƒ¥ãƒ¼ã‚’éš ã™
                $('#migration-step-1').classList.add('hidden');
                $('#migration-sender-view').classList.add('hidden');
                $('#migration-receiver-view').classList.add('hidden');
            
                if (autoReceive) {
                    // ã‚ˆã†ã“ãç”»é¢ã‹ã‚‰ã®å ´åˆï¼šã„ããªã‚Šã€Œå—ã‘å–ã‚‹ã€ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹
                    $('#migration-receiver-view').classList.remove('hidden');
                    initPeerReceiver(); // å—ä¿¡å¾…æ©Ÿã‚’é–‹å§‹
                } else {
                    // è¨­å®šç”»é¢ã‹ã‚‰ã®å ´åˆï¼šé¸æŠè‚¢ã‚’è¡¨ç¤º
                    $('#migration-step-1').classList.remove('hidden');
                }
                
                lucide.createIcons();
            }

            $('#close-migration-btn').addEventListener('click', () => {
                $('#migration-modal').style.display = 'none';
                if(peer) { peer.destroy(); peer = null; }
            });

            // é€ã‚‹å´ (å¤ã„ã‚¹ãƒãƒ›)
            $('#migration-mode-send').addEventListener('click', () => {
                $('#migration-step-1').classList.add('hidden');
                $('#migration-sender-view').classList.remove('hidden');
                
                // PeeråˆæœŸåŒ–
                initPeerSender();
            });

            // å—ã‘å–ã‚‹å´ (æ–°ã—ã„ã‚¹ãƒãƒ›)
            $('#migration-mode-receive').addEventListener('click', () => {
                $('#migration-step-1').classList.add('hidden');
                $('#migration-receiver-view').classList.remove('hidden');
                
                // PeeråˆæœŸåŒ–
                initPeerReceiver();
            });

            function initPeerSender() {
                // é€ä¿¡å´ã¯IDæŒ‡å®šã›ãšã«Peerä½œæˆ (IDã¯ãªã‚“ã§ã‚‚ã„ã„)
                peer = new Peer(); 
                
                peer.on('open', (id) => {
                    // é€ä¿¡å´ã¯è‡ªåˆ†ã®IDã‚’è¡¨ç¤ºã™ã‚‹å¿…è¦ã¯ãªã„ãŒã€æ¥ç¶šãƒœã‚¿ãƒ³å¾…æ©Ÿ
                    $('#migration-status-send').textContent = "æº–å‚™å®Œäº†ã€‚ç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                });
                
                peer.on('error', (err) => {
                    console.error(err);
                    $('#migration-status-send').textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.type;
                });
            }
            
            $('#migration-connect-btn').addEventListener('click', () => {
                const targetId = $('#migration-target-id').value.trim().toUpperCase();
                if(!targetId) return;
                
                $('#migration-status-send').textContent = "æ¥ç¶šä¸­...";
                
                conn = peer.connect(targetId);
                
                conn.on('open', () => {
                    const isConfirmed = confirm("ã€é‡è¦ã€‘\nãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nã€ŒOKã€ã‚’æŠ¼ã™ã¨ãƒ‡ãƒ¼ã‚¿ãŒé€ä¿¡ã•ã‚Œã€ã“ã®ç«¯æœ«ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰ã•ã‚Œã¾ã™ã€‚");
            
                    if (isConfirmed) {
                        $('#migration-status-send').textContent = "æ¥ç¶šæˆåŠŸï¼ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™...";
                        
                        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                        const dataToSend = JSON.stringify(state);
                        conn.send(dataToSend);
                        
                        setTimeout(() => {
                            alert('ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\nã“ã®ç«¯æœ«ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚');
                            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç† (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ¶ˆå»)
                            localStorage.removeItem('quizAppUltimateV8');
                            location.reload();
                        }, 1000);
                    } else {
                        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆ
                        $('#migration-status-send').textContent = "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚";
                        conn.close(); // æ¥ç¶šã‚’åˆ‡ã‚‹
                    }
                });
                
                conn.on('error', (err) => {
                     $('#migration-status-send').textContent = "é€ä¿¡ã‚¨ãƒ©ãƒ¼";
                });
            });

            function initPeerReceiver() {
                // IDã‚’ç”Ÿæˆ (ãƒ©ãƒ³ãƒ€ãƒ ãª4æ¡ã®è‹±æ•°å­—ãªã©ã§ç°¡æ˜“åŒ–)
                // PeerJS Serverã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ã†å ´åˆã€IDé‡è¤‡ã®å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§å°‘ã—é•·ã‚ã«
                const myPeerId = Math.random().toString(36).substring(2, 6).toUpperCase(); 
                
                peer = new Peer(myPeerId);
                
                peer.on('open', (id) => {
                    $('#migration-my-id').textContent = id;
                    $('#migration-status-receive').textContent = "ã“ã®IDã‚’å¤ã„ã‚¹ãƒãƒ›ã«å…¥åŠ›ã—ã¦ãã ã•ã„";
                });
                
                peer.on('connection', (c) => {
                    // ç›¸æ‰‹ã‹ã‚‰æ¥ç¶šã•ã‚ŒãŸ
                    $('#migration-status-receive').textContent = "æ¥ç¶šã•ã‚Œã¾ã—ãŸï¼ãƒ‡ãƒ¼ã‚¿å—ä¿¡ä¸­...";
                    
                    c.on('data', (data) => {
                        console.log('Received', data);
                        try {
                            // å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ï¼ˆç°¡æ˜“ï¼‰
                            const receivedState = JSON.parse(data);
                            if(receivedState.profile && receivedState.user) {
                                // ä¿å­˜ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
                                localStorage.setItem('quizAppUltimateV8', data);
                                alert('ãƒ‡ãƒ¼ã‚¿ã®å¼•ãç¶™ããŒå®Œäº†ã—ã¾ã—ãŸï¼\nã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¾ã™ã€‚');
                                location.reload();
                            }
                        } catch(e) {
                            console.error(e);
                            alert('ãƒ‡ãƒ¼ã‚¿ã®ç ´æãªã©ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                        }
                    });
                });
                
                peer.on('error', (err) => {
                     // IDãŒè¢«ã£ãŸå ´åˆãªã©ã¯ãƒªãƒˆãƒ©ã‚¤ãŒå¿…è¦
                     if(err.type === 'unavailable-id') {
                         initPeerReceiver(); // IDå¤‰ãˆã¦ãƒªãƒˆãƒ©ã‚¤
                     } else {
                         $('#migration-status-receive').textContent = "ã‚¨ãƒ©ãƒ¼: " + err.type;
                     }
                });
            }

            // ==========================================
            // â–²â–²â–² æ–°è¦è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯çµ‚äº† â–²â–²â–²
            // ==========================================

            // â˜…æ–°è¦è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®å¾©å…ƒãƒã‚§ãƒƒã‚¯é–¢æ•°
            const checkQuestResume = () => {
                if (state.savedQuest && state.savedQuest.active) {
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                    const modal = $('#resume-quest-modal');
                    modal.classList.remove('hidden');
                    
                    // ã€Œå†é–‹ã™ã‚‹ã€ãƒœã‚¿ãƒ³
                    $('#resume-quest-yes-btn').onclick = () => {
                        modal.classList.add('hidden');
                        resumeQuestProcess();
                    };

                    // ã€Œçµ‚äº†ã—ã¦ãƒ›ãƒ¼ãƒ ã¸ã€ãƒœã‚¿ãƒ³
                    $('#resume-quest-no-btn').onclick = () => {
                        modal.classList.add('hidden');

                        // â˜…è¿½åŠ : ä¸­æ–­ã¨ã—ã¦ãƒ­ã‚°ã«è¨˜éŒ²ã™ã‚‹å‡¦ç†
                        const saved = state.savedQuest;
                        const currentStep = saved.plan[saved.currentIndex];
                        
                        // å®Ÿéš›ã«çµŒéã—ãŸæ™‚é–“ï¼ˆé–‹å§‹ã€œç¾åœ¨ï¼‰ã‚’è¨ˆç®—
                        const now = Date.now();
                        const elapsedSeconds = Math.floor((now - saved.startTime) / 1000);
                        
                        // ã‚‚ã—ã‚¹ãƒ†ãƒƒãƒ—ã®äºˆå®šæ™‚é–“ã‚’è¶…ãˆã¦ã„ãŸã‚‰ã€äºˆå®šæ™‚é–“åˆ†ã ã‘è¨˜éŒ²ï¼ˆå®Œäº†æ‰±ã„ï¼‰
                        // è¶…ãˆã¦ã„ãªã‘ã‚Œã°ã€çµŒéæ™‚é–“åˆ†ã ã‘è¨˜éŒ²ï¼ˆä¸­æ–­æ‰±ã„ï¼‰
                        const actualDuration = Math.min(elapsedSeconds, currentStep.duration);

                        if (currentStep.type === 'section' && actualDuration > 0) {
                            const statusText = (elapsedSeconds >= currentStep.duration) ? '(ä¸åœ¨ä¸­å®Œäº†)' : '(ä¸­æ–­)';
                            recordSession(currentStep.text + statusText, actualDuration);
                            
                            // å°‘ã—ã ã‘LPã‚’ã‚ã’ã‚‹ï¼ˆä»»æ„ï¼‰
                            if (actualDuration > 60) {
                                addLP(Math.floor(actualDuration / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆçµ‚äº†');
                            }
                        }
                        
                        state.savedQuest = null;
                        saveState();
                        showToast('ã‚¯ã‚¨ã‚¹ãƒˆã‚’ç ´æ£„ã—ã¾ã—ãŸ');
                    };
                }
            };

            // â˜…æ–°è¦è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆå¾©å…ƒå®Ÿè¡Œãƒ—ãƒ­ã‚»ã‚¹
            const resumeQuestProcess = () => {
                const saved = state.savedQuest;
                quest.plan = saved.plan;
                quest.currentIndex = saved.currentIndex;
                quest.active = true;
                updateBackgrounds();

                // UIåˆ‡ã‚Šæ›¿ãˆ
                $('header').style.display = 'none';
                $('nav').style.display = 'none';
                $('#mini-timer-container').classList.remove('visible');
                $('#quest-active-screen').style.display = 'flex';
                document.body.style.overflow = 'hidden';

                const currentStep = quest.plan[quest.currentIndex];
                
                // çµŒéæ™‚é–“ã‚’è¨ˆç®—
                const now = Date.now();
                const elapsedSinceStart = Math.floor((now - saved.startTime) / 1000);
                const remaining = currentStep.duration - elapsedSinceStart;

                if (remaining <= 0) {
                    // è£ã§çµ‚ã‚ã£ã¦ã„ãŸå ´åˆ
                    showToast('é–‰ã˜ã¦ã„ã‚‹é–“ã«ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚');
                    // ãƒ­ã‚°è¨˜éŒ²ãªã©ã¯çœç•¥ã—ã¦ã€å¼·åˆ¶çš„ã«æ¬¡ã¸é€²ã‚ã‚‹ã‹ã€å®Œäº†æ‰±ã„ã«ã™ã‚‹
                    // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œå®Œäº†ã€ã¨ã—ã¦æ¬¡ã¸
                    if (currentStep.type === 'section') {
                        // ãƒ­ã‚°ã ã‘è¨˜éŒ²ã—ã¦ãŠã
                        recordSession(currentStep.text + '(ä¸­æ–­)', currentStep.duration);
                        state.focus.totalTime += currentStep.duration;
                        addLP(Math.floor(currentStep.duration / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³');
                        saveState();
                    }
                    // æ¬¡ã¸
                    runNextQuestStep();
                } else {
                    // ã¾ã ç¶šã„ã¦ã„ã‚‹å ´åˆ -> ãã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é€”ä¸­ã‹ã‚‰å†é–‹
                    // executeQuestStepã‚’å‘¼ã¶ã¨ã‚¿ã‚¤ãƒãƒ¼ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã®ã§ã€
                    // æ‰‹å‹•ã§UIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ startQuestTimer ã‚’å‘¼ã¶
                    setupResumedStep(currentStep, remaining);
                }
            };

            // â˜…æ–°è¦è¿½åŠ : é€”ä¸­ã‹ã‚‰ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‹å§‹ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
            const setupResumedStep = (step, timeLeft) => {
                cancelQuestAlarm(); // å¿µã®ãŸã‚

                if (step.type === 'section') {
                    playBGM();
                    questSectionView.style.display = 'flex';
                    questBreakView.style.display = 'none';
                    $('#break-settings-btn').classList.add('hidden');
                    questSectionTitle.textContent = step.text;
                    const totalSections = quest.plan.filter(p => p.type === 'section').length;
                    const currentSectionNumber = quest.plan.slice(0, quest.currentIndex + 1).filter(p => p.type === 'section').length;
                    questProgressEl.textContent = `${currentSectionNumber} / ${totalSections}`;
                    
                    // ã‚¿ã‚¤ãƒãƒ¼å†é–‹
                    startQuestTimer(
                        timeLeft, // æ®‹ã‚Šæ™‚é–“ã§é–‹å§‹
                        (t) => { questTimerEl.textContent = formatTime(t); },
                        () => {
                            // çµ‚äº†æ™‚ã®å‡¦ç†ï¼ˆexecuteQuestStepã®ä¸­èº«ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ï¼‰
                            // ç°¡ç•¥åŒ–ã®ãŸã‚å…±é€šéƒ¨åˆ†ã‚’é–¢æ•°åŒ–ã™ã‚‹ã‹ã€ã“ã“ã«ã‚³ãƒ”ãƒ¼
                            const elapsed = step.duration; // æº€äº†æ‰±ã„
                            recordSession(step.text, elapsed);
                            addLP(Math.floor(elapsed / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³');
                            state.focus.totalTime += elapsed;
                            if (step.originalTaskId) {
                                const tIndex = state.tasks.findIndex(t => t.id === parseInt(step.originalTaskId));
                                if (tIndex !== -1) state.tasks[tIndex].completed = true;
                            }
                            saveState();
                            showToast('ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
                            runNextQuestStep();
                        }
                    );
                } else {
                    // ä¼‘æ†©ã®å ´åˆ
                    pauseBGM();
                    questSectionView.style.display = 'none';
                    questBreakView.style.display = 'flex';
                    $('#break-settings-btn').classList.remove('hidden');
                    renderBreakIcons();
                    
                    startQuestTimer(
                        timeLeft,
                        (t) => { breakTimerEl.textContent = formatTime(t); },
                        () => {
                            showToast('ä¼‘æ†©ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚');
                            closeIframe();
                            runNextQuestStep();
                        }
                    );
                }
                lucide.createIcons();
            };

            const init = () => {
Â  Â  Â  Â  Â  Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.register('sw.js')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(registration => console.log('Service Workerç™»éŒ²æˆåŠŸ:', registration))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => console.log('Service Workerç™»éŒ²å¤±æ•—:', error));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â // â˜…è¿½åŠ : ç”»é¢ã®ä»–ã®å ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰é–‹ã„ã¦ã„ã‚‹ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹å‡¦ç†
                document.addEventListener('touchstart', (e) => {
                    // ã‚¿ãƒƒãƒ—ã•ã‚ŒãŸè¦ç´ ãŒã€Œé–‹ã„ã¦ã„ã‚‹ã‚¹ãƒ¯ã‚¤ãƒ—ã‚³ãƒ³ãƒ†ãƒŠã€ã®å†…éƒ¨ã§ãªã‘ã‚Œã°é–‰ã˜ã‚‹
                    const openContainers = document.querySelectorAll('.swipe-container.swiped-open');
                    
                    openContainers.forEach(container => {
                        // ã‚³ãƒ³ãƒ†ãƒŠè‡ªèº«ã‚„ãã®å­è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒœã‚¿ãƒ³æ“ä½œãªã©ã®ãŸã‚ï¼‰
                        if (container.contains(e.target)) return;

                        // ãã‚Œä»¥å¤–ï¼ˆå¤–å´ï¼‰ã‚’ã‚¿ãƒƒãƒ—ã—ãŸå ´åˆã¯é–‰ã˜ã‚‹
                        const content = container.querySelector('.swipe-content');
                        if (content) {
                            content.style.transform = 'translateX(0px)';
                            container.classList.remove('swiped-open');
                        }
                    });
                }, { passive: true });
                
Â  Â  Â  Â  Â  Â  Â  Â  loadState();

                syncGamesToBreakIcons();

                // 1. æ–°ã—ã„DOMè¦ç´ ã‚’å¤‰æ•°ã«å‰²ã‚Šå½“ã¦
                homeTaskListEl = $('#home-task-list');
                newTaskInput = $('#new-task-input');
                newTaskNumberEl = $('#new-task-number');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒšãƒ¼ã‚¸æç”»ã®å‰ã«ã‚¿ã‚¤ãƒãƒ¼ã®çŠ¶æ…‹ã‚’å¾©å…ƒãƒ»è¨­å®šã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  restoreFocusState();
                checkQuestResume();  // â˜…è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®å¾©å…ƒãƒã‚§ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // å…¨ã¦ã®ãƒšãƒ¼ã‚¸ã‚’æç”»
Â  Â  Â  Â  Â  Â  Â  Â  renderEngine.renderAll();
                
                // 2. Sortable.js ã®åˆæœŸåŒ– (ä»Šæ—¥ã®äºˆå®š)
                if (homeTaskListEl) {
                    Sortable.create(homeTaskListEl, {
                        handle: '.task-handle', 
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        delay: 200, // â˜…é‡è¦: 200msé•·æŠ¼ã—ã—ãªã„ã¨ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã—ãªã„
                        delayOnTouchOnly: true, // ã‚¿ãƒƒãƒæ“ä½œã®æ™‚ã ã‘é…å»¶ã•ã›ã‚‹ï¼ˆãƒã‚¦ã‚¹ã¯å³æ™‚ï¼‰
                        touchStartThreshold: 5, // 5pxä»¥ä¸Šå‹•ã„ãŸã‚‰ã‚¿ãƒƒãƒ—ã§ã¯ãªããƒ‰ãƒ©ãƒƒã‚°åˆ¤å®šï¼ˆèª¤å‹•ä½œé˜²æ­¢ï¼‰
                        filter: '.swiped-open, .is-swiping, .swipe-deleting', // â˜…è¿½åŠ : ã“ã‚Œã‚‰ãŒä»˜ã„ã¦ã„ã‚‹è¦ç´ ã¯ä¸¦ã³æ›¿ãˆä¸å¯
                        onEnd: (evt) => { /* ä¸­èº«ã¯å¤‰æ›´ãªã— */
                            const item = state.tasks.splice(evt.oldIndex, 1)[0];
                            state.tasks.splice(evt.newIndex, 0, item);
                            saveState();
                            renderHomeTasks(); 
                        }
                    });

                    // 3. ã‚¿ã‚¹ã‚¯å‰Šé™¤ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»)
                    homeTaskListEl.addEventListener('click', (e) => {
                        const deleteBtn = e.target.closest('.delete-task-btn');
                        if (deleteBtn) {
                            const taskItem = deleteBtn.closest('.task-item');
                            const taskId = parseInt(taskItem.dataset.id);
                            state.tasks = state.tasks.filter(t => t.id !== taskId);
                            saveState();
                            renderHomeTasks();
                        }
                    });
                }

                // 4. æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ  (Enterã‚­ãƒ¼)
                if (newTaskInput) {
                    newTaskInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && e.target.value.trim() !== '') {
                            state.tasks.push({ id: Date.now(), text: e.target.value.trim() });
                            e.target.value = '';
                            saveState();
                            renderHomeTasks();
                        }
                    });
                }

                 // Sortable.js ã®åˆæœŸåŒ– (ã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ©ãƒ³)
                    if (questPlanListEl) { // questPlanListEl ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©æ¸ˆã¿
                        Sortable.create(questPlanListEl, {
                            handle: '.quest-handle', // ã‚¯ã‚¨ã‚¹ãƒˆã®ãƒãƒ³ãƒ‰ãƒ«
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            delay: 200, // â˜…è¿½åŠ 
                            delayOnTouchOnly: true, // â˜…è¿½åŠ 
                            touchStartThreshold: 5, // â˜…è¿½åŠ 
                            filter: '.swiped-open, .is-swiping, .swipe-deleting', // â˜…è¿½åŠ 
                            onEnd: (evt) => {
                                // quest.plan é…åˆ—ã‚’ä¸¦ã³æ›¿ãˆ
                                // (quest.plan ã¯ state ã«ä¿å­˜ã•ã‚Œãªã„ä¸€æ™‚çš„ãªã‚‚ã®)
                                const item = quest.plan.splice(evt.oldIndex, 1)[0];
                                quest.plan.splice(evt.newIndex, 0, item);
                                renderQuestPlan(); // ç•ªå·ã‚’æŒ¯ã‚Šç›´ã™ãŸã‚ã«å†æç”»
                            }
                        });
                    }
                
                // 5. ã€Œä»Šæ—¥ã®äºˆå®šã€èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
Â  Â  Â  Â  Â  Â  Â  Â  const loadTasksBtn = $('#load-tasks-btn');
                if (loadTasksBtn) {
                    loadTasksBtn.addEventListener('click', () => {
                        // å®Œäº†ã—ã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦èª­ã¿è¾¼ã‚€
                        const activeTasks = state.tasks.filter(t => !t.completed);

                        if (activeTasks.length === 0) {
                            showToast('ã€Œä»Šæ—¥ã®äºˆå®šã€ã«æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                            // quest.plan = []; // æ—¢å­˜ã®ãƒ—ãƒ©ãƒ³ã‚’æ¶ˆã—ãŸããªã„å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
                        } else {
                            // state.tasks ã‚’ quest.plan ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                            quest.plan = activeTasks.map(task => ({
                                id: Date.now() + Math.random(),
                                type: 'section',
                                text: task.text,
                                duration: 25 * 60,
                                originalTaskId: task.id
                            }));
                            showToast(`${activeTasks.length} ä»¶ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
                        }
                        renderQuestPlan();
                    });
                }
                
Â  Â  Â  Â  Â  Â  Â  Â  // æœ€å¾Œã«å¤–è¦³ã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  $('#background-scope-toggle').checked = state.settings.backgroundScopeGlobal;
Â  Â  Â  Â  Â  Â  Â  Â  updateAppearance();

                checkUserRegistration();
                
                // â–¼â–¼â–¼ å¤‰æ›´ï¼ˆinitã®æœ€å¾Œã«lucideã‚’1å›å®Ÿè¡Œï¼‰ â–¼â–¼â–¼
                lucide.createIcons();
                    setTimeout(() => {
                        // ã‚‚ã—æœªç™»éŒ²ãªã‚‰ã€ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ãŒæ¶ˆãˆã‚‹ç›´å‰ã«ã€Œã‚ˆã†ã“ãç”»é¢ã€ã‚’è£ã§è¡¨ç¤ºçŠ¶æ…‹ã«ã™ã‚‹
                        if (!state.user.isRegistered) {
                            $('#welcome-screen').classList.remove('hidden');
                        }
                    
                        const splash = document.getElementById('splash-screen');
                        if (splash) {
                            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹
                            splash.classList.add('opacity-0');
                            
                            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤º
                            setTimeout(() => {
                                splash.style.display = 'none';
                            }, 500);
                        }
                    }, 1500); // 1.5ç§’å¾…ã£ã¦ã‹ã‚‰ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹
Â  Â  Â  Â  Â  Â  };
            const renderPointModalContent = () => {
                // 1. ãƒ†ãƒ¼ãƒ
                const themeContainer = $('#modal-theme-selector');
                themeContainer.innerHTML = Object.entries(initialData.themes).map(([id, theme]) => {
                    const isUnlocked = state.profile.unlockedThemes.includes(id);
                    // (æ—¢å­˜ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯...)
                    if (isUnlocked) {
                         return `<div class="text-center"><button class="theme-btn w-12 h-12 rounded-full border-4 ${state.profile.activeTheme === id ? 'border-blue-500' : 'border-transparent'} relative" style="background-color: ${theme.color}" data-theme="${id}"><div class="absolute inset-0 flex items-center justify-center rounded-full"><i data-lucide="check" class="w-6 h-6 text-white"></i></div></button><p class="text-xs mt-1">${theme.name}</p></div>`;
                    } else {
                        return `<div class="text-center"><button class="theme-btn w-12 h-12 rounded-full border-4 border-transparent relative" style="background-color: ${theme.color}" data-theme="${id}"><div class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center rounded-full text-white"><i data-lucide="lock" class="w-5 h-5"></i><span class="text-[10px] font-bold">${theme.cost}</span></div></button><p class="text-xs mt-1">${theme.name}</p></div>`;
                    }
                }).join('');

                // 2. å£ç´™
                const backgroundContainer = $('#modal-background-selector');
                backgroundContainer.innerHTML = Object.entries(initialData.backgrounds).map(([id, bg]) => {
                    const isUnlocked = state.profile.unlockedBackgrounds.includes(id);
                    const style = bg.url ? `background-image: url(${bg.url})` : 'background-color: #6b7280;';
                    // (æ—¢å­˜ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯...)
                     if (isUnlocked) {
                        return `<div class="text-center"><button class="background-btn w-full h-20 rounded-lg border-4 ${state.profile.activeBackground === id ? 'border-blue-500' : 'border-transparent'} relative bg-cover bg-center" style="${style}" data-bg="${id}"><div class="absolute inset-0 flex items-center justify-center rounded-md"><i data-lucide="check" class="w-8 h-8 text-white"></i></div></button><p class="text-xs mt-1">${bg.name}</p></div>`;
                    } else {
                         return `<div class="text-center"><button class="background-btn w-full h-20 rounded-lg border-4 border-transparent relative bg-cover bg-center" style="${style}" data-bg="${id}"><div class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center rounded-md text-white"><i data-lucide="lock" class="w-6 h-6"></i><span class="text-sm font-bold">${bg.cost}</span></div></button><p class="text-xs mt-1">${bg.name}</p></div>`;
                    }
                }).join('');

                // â–¼â–¼â–¼ ã€è¿½åŠ ã€‘ã‚²ãƒ¼ãƒ ï¼†éŸ³æ¥½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æç”»ï¼ˆãƒã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«å‹•çš„ã«è¿½åŠ ï¼‰ â–¼â–¼â–¼
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°æ—¢å­˜ã®å ´æ‰€ã«è¿½åŠ ï¼‰
                const container = $('#point-details-modal .space-y-6');
                
                // æ—¢å­˜ã®ã‚²ãƒ¼ãƒ ãƒ»éŸ³æ¥½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤ï¼ˆäºŒé‡æç”»é˜²æ­¢ï¼‰
                const existingGameSec = container.querySelector('#modal-game-section');
                if(existingGameSec) existingGameSec.remove();
                const existingMusicSec = container.querySelector('#modal-music-section');
                if(existingMusicSec) existingMusicSec.remove();

                // ã‚²ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
                const gameHtml = Object.entries(initialData.games).map(([id, game]) => {
                    const isUnlocked = state.profile.unlockedGames.includes(id);
                    return isUnlocked 
                        ? `<div class="text-center opacity-50"><div class="w-16 h-16 mx-auto bg-gray-200 dark:bg-gray-600 rounded-lg flex items-center justify-center"><i data-lucide="check" class="w-8 h-8"></i></div><p class="text-xs mt-1">${game.name}</p></div>`
                        : `<div class="text-center cursor-pointer game-purchase-btn" data-id="${id}"><div class="w-16 h-16 mx-auto bg-gray-200 dark:bg-gray-600 rounded-lg flex flex-col items-center justify-center relative hover:bg-gray-300 dark:hover:bg-gray-500 transition"><i data-lucide="${game.icon}" class="w-6 h-6 mb-1"></i><span class="text-xs font-bold">${game.cost} LP</span></div><p class="text-xs mt-1">${game.name}</p></div>`;
                }).join('');

                const gameSection = document.createElement('div');
                gameSection.id = 'modal-game-section';
                gameSection.innerHTML = `<h3 class="font-semibold mb-2">ãƒŸãƒ‹ã‚²ãƒ¼ãƒ </h3><div class="grid grid-cols-4 gap-4">${gameHtml || '<p class="text-sm text-gray-400">ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>'}</div>`;
                container.appendChild(gameSection);

                // éŸ³æ¥½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
                const musicHtml = Object.entries(initialData.music).map(([id, music]) => {
                    const isUnlocked = state.profile.unlockedMusic.includes(id);
                    return isUnlocked
                        ? `<div class="text-center opacity-50"><div class="w-16 h-16 mx-auto bg-gray-200 dark:bg-gray-600 rounded-lg flex items-center justify-center"><i data-lucide="check" class="w-8 h-8"></i></div><p class="text-xs mt-1">${music.name}</p></div>`
                        : `<div class="text-center cursor-pointer music-purchase-btn" data-id="${id}"><div class="w-16 h-16 mx-auto bg-gray-200 dark:bg-gray-600 rounded-lg flex flex-col items-center justify-center relative hover:bg-gray-300 dark:hover:bg-gray-500 transition"><i data-lucide="music" class="w-6 h-6 mb-1"></i><span class="text-xs font-bold">${music.cost} LP</span></div><p class="text-xs mt-1">${music.name}</p></div>`;
                }).join('');

                const musicSection = document.createElement('div');
                musicSection.id = 'modal-music-section';
                musicSection.innerHTML = `<h3 class="font-semibold mb-2">BGM</h3><div class="grid grid-cols-4 gap-4">${musicHtml || '<p class="text-sm text-gray-400">ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>'}</div>`;
                container.appendChild(musicSection);

                // ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å†è¨­å®š
                lucide.createIcons();
                
                // è³¼å…¥ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                gameSection.querySelectorAll('.game-purchase-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.id;
                        const item = initialData.games[id];
                        
                        $('#game-purchase-title').textContent = item.name; // ã€Œã€œã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿã€ã¯å‰Šé™¤ã—ã¦ã‚·ãƒ³ãƒ—ãƒ«ã«
                        $('#game-purchase-cost').textContent = `å¿…è¦ãƒã‚¤ãƒ³ãƒˆ: ${item.cost} LP`;
                        
                        // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
                        renderGamePreviews(item);
                        
                        const confirmBtn = $('#game-purchase-confirm');
                        confirmBtn.dataset.itemId = id;
                        confirmBtn.dataset.itemType = 'game';
                        confirmBtn.disabled = state.profile.lp < item.cost;
                        
                        lucide.createIcons(); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…ã®ã‚¢ã‚¤ã‚³ãƒ³æç”»
                        $('#game-purchase-modal').style.display = 'flex';
                    });
                });

                musicSection.querySelectorAll('.music-purchase-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.id;
                        const item = initialData.music[id];
                        
                        $('#music-purchase-title').textContent = item.name;
                        $('#music-purchase-cost').textContent = `å¿…è¦ãƒã‚¤ãƒ³ãƒˆ: ${item.cost} LP`;
                        
                        // â˜…è©¦è´ãƒœã‚¿ãƒ³ã®è¨­å®š
                        const previewBtn = $('#music-preview-btn');
                        // å¤ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã«ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ç½®æ›ï¼ˆç°¡æ˜“çš„ãªæ–¹æ³•ï¼‰
                        const newPreviewBtn = previewBtn.cloneNode(true);
                        previewBtn.parentNode.replaceChild(newPreviewBtn, previewBtn);
                        
                        newPreviewBtn.addEventListener('click', (e) => {
                            // â–¼ä¿®æ­£: ã‚¢ã‚¤ã‚³ãƒ³ã§ã¯ãªããƒœã‚¿ãƒ³è¦ç´ ãã®ã‚‚ã®ã‚’æ¸¡ã™
                            toggleMusicPreview(item.url, newPreviewBtn);
                        });
                
                        const confirmBtn = $('#music-purchase-confirm');
                        confirmBtn.dataset.itemId = id;
                        confirmBtn.dataset.itemType = 'music';
                        confirmBtn.disabled = state.profile.lp < item.cost;
                        
                        $('#music-purchase-modal').style.display = 'flex';
                        lucide.createIcons();
                    });
                });
            };

        /* â–¼â–¼â–¼ è¿½åŠ æ©Ÿèƒ½ç”¨é–¢æ•° â–¼â–¼â–¼ */
        
        // ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç”»åƒãƒ»å‹•ç”»ï¼‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        const renderGamePreviews = (game) => {
            const container = $('#game-preview-container');
            container.innerHTML = ''; // ã‚¯ãƒªã‚¢
        
            if (!game.previews || game.previews.length === 0) {
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒãªã„å ´åˆã®ãƒ€ãƒŸãƒ¼
                container.innerHTML = `
                    <div class="preview-item">
                        <div class="flex flex-col items-center text-gray-400">
                            <i data-lucide="image-off" class="w-12 h-12 mb-2"></i>
                            <span>No Preview</span>
                        </div>
                    </div>`;
                return;
            }
        
            game.previews.forEach(url => {
                const item = document.createElement('div');
                item.className = 'preview-item';
                
                // æ‹¡å¼µå­ã§ç”»åƒã‹å‹•ç”»ã‹ç°¡æ˜“åˆ¤å®š
                const isVideo = url.endsWith('.mp4') || url.endsWith('.webm');
                
                if (isVideo) {
                    item.innerHTML = `<video src="${url}" controls playsinline muted class="pointer-events-auto"></video>`;
                } else {
                    item.innerHTML = `<img src="${url}" alt="preview">`;
                }
                container.appendChild(item);
            });
        };
        
        // BGMè©¦è´ã®å†ç”Ÿãƒ»åœæ­¢åˆ¶å¾¡
        const toggleMusicPreview = (url, btnElement) => {
            // ã™ã§ã«å†ç”Ÿä¸­ã§ã€ã‹ã¤åŒã˜URLãªã‚‰ã€Œåœæ­¢ã€ã¨ã¿ãªã™
            if (!previewAudio.paused && previewAudio.src === url) {
                stopMusicPreview();
                return;
            }

            // åˆ¥ã®æ›²ã‚’å†ç”Ÿã™ã‚‹å ´åˆã€ã¾ãŸã¯æ–°è¦å†ç”Ÿã®å ´åˆ
            // ã¾ãšç¾åœ¨å†ç”Ÿä¸­ã®ã‚‚ã®ã‚’å®Œå…¨ã«åœæ­¢ãƒ»ãƒªã‚»ãƒƒãƒˆã™ã‚‹
            stopMusicPreview();

            // æ–°ã—ãå†ç”Ÿ
            previewAudio.src = url;
            previewAudio.volume = 0.5;
            
            previewAudio.play().then(() => {
                // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã€Œåœæ­¢(square)ã€ã«å¤‰æ›´
                if (btnElement) {
                    btnElement.innerHTML = '<i data-lucide="square" class="w-5 h-5 fill-current"></i>';
                    btnElement.classList.add('playing-icon'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ä»˜ä¸
                    
                    // ã‚¢ã‚¤ã‚³ãƒ³å†ç”Ÿæˆ
                    lucide.createIcons({ root: btnElement });
                }
                
                // 30ç§’å¾Œã«è‡ªå‹•åœæ­¢
                previewTimeout = setTimeout(() => {
                    stopMusicPreview();
                }, 30000); 

            }).catch(e => console.error("è©¦è´ã‚¨ãƒ©ãƒ¼", e));
        };
        
        const stopMusicPreview = () => {
            previewAudio.pause();
            previewAudio.currentTime = 0;
            if (previewTimeout) clearTimeout(previewTimeout);
            
            // â˜…é‡è¦: ãƒšãƒ¼ã‚¸å†…ã®ã™ã¹ã¦ã®ã€Œå†ç”Ÿä¸­ã€ã«ãªã£ã¦ã„ã‚‹ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™

            // 1. ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå†…ã®ãƒœã‚¿ãƒ³(.preview-bgm-btn)ã®ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.preview-bgm-btn').forEach(btn => {
                 btn.innerHTML = '<i data-lucide="play-circle" class="w-5 h-5"></i>';
                 btn.classList.remove('playing-icon');
            });
            
            // 2. ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒœã‚¿ãƒ³(#music-preview-btn)ã®ãƒªã‚»ãƒƒãƒˆ
            const modalBtn = document.getElementById('music-preview-btn');
            if (modalBtn) {
                modalBtn.innerHTML = '<i data-lucide="play" class="w-6 h-6 fill-current"></i>';
                modalBtn.classList.remove('playing-icon');
            }
            
            lucide.createIcons();
        };    
        
            
        // --- è³¼å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ãƒœã‚¿ãƒ³ ---
        $('#theme-purchase-confirm').addEventListener('click', handlePurchase);
        $('#theme-purchase-cancel').addEventListener('click', () => {
            $('#theme-purchase-modal').style.display = 'none';
        });

        $('#background-purchase-confirm').addEventListener('click', handlePurchase);
        $('#background-purchase-cancel').addEventListener('click', () => {
            $('#background-purchase-modal').style.display = 'none';
        });

        // --- ãƒã‚¤ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ ---
        $('#close-point-modal-btn').addEventListener('click', () => {
            $('#point-details-modal').style.display = 'none';
        });

        // --- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ãƒœã‚¿ãƒ³ ---
        $('#add-countdown-btn').addEventListener('click', () => openCountdownModal());
        $('#countdown-save-btn').addEventListener('click', saveCountdown);
        $('#countdown-cancel-btn').addEventListener('click', () => {
            $('#countdown-modal').style.display = 'none';
        });
        $('#countdown-delete-btn').addEventListener('click', deleteCountdown);

        // --- ã‚²ãƒ¼ãƒ ãƒ»éŸ³æ¥½è³¼å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ãƒœã‚¿ãƒ³ ---
        $('#game-purchase-confirm').addEventListener('click', handlePurchase);
        $('#game-purchase-cancel').addEventListener('click', () => { $('#game-purchase-modal').style.display = 'none'; });
        $('#music-purchase-confirm').addEventListener('click', handlePurchase);
        $('#music-purchase-cancel').addEventListener('click', () => { $('#music-purchase-modal').style.display = 'none'; });
        $('#music-purchase-cancel').addEventListener('click', () => { 
            stopMusicPreview(); // â˜…è¿½åŠ : é–‰ã˜ãŸã‚‰åœæ­¢
            $('#music-purchase-modal').style.display = 'none'; 
        });
            
            init();
        });
    </script>
</body>
</html>
